---
"$schema": /metaschema-1.json
version: '1.0'

type: object
additionalProperties: false

properties:
  "$schema":
    type: string
    enum:
    - /app-sre/performance-parameters-1.yml

  labels:
    "$ref": "/common-1.json#/definitions/labels"

  name:
    "$ref": "/common-1.json#/definitions/identifier"

  app:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/app-sre/app-1.yml"

  component:
    description: "generates prometheusRuleName: <component>-slos-<ns>"
    "$ref": "/common-1.json#/definitions/identifier"

  prometheusLabels:
    description: "labels that Prometheus uses to select this rules file"
    type: object

  namespace:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/openshift/namespace-1.yml"

  sloReports:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        date:
          type: string
          pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"

        url:
          type: string
          format: uri
          description: "Link this to some proof of where SLO's are coming from. Not a JIRA ticket"

      required:
      - date
      - url

  volume:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        description:
          type: string

        kind:
          type: string
          enum: ['SLO']

        metric:
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        selectors:
          description: "Metric selectors to be used in Prometheus rule"
          type: object

        threshold:
          description: "Maximum value of the metric"
          type: number

        target:
          description: "SLO target percentage"
          type: number

        httpStatusLabel:
          description: "Name of the label that contains the http status code"
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

      required:
      - kind
      - metric
      - selectors
      - threshold
      - target

  availability:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        description:
          type: string

        kind:
          type: string
          enum: ['SLO']

        metric:
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        selectors:
          description: "Metric selectors to be used in Prometheus rule"
          type: object

        target:
          description: "SLO target percentage"
          type: number

        httpStatusLabel:
          description: "Name of the label that contains the http status code"
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

      required:
      - kind
      - metric
      - selectors
      - target

  latency:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        description:
          type: string

        kind:
          type: string
          enum: ['SLO']

        metric:
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        selectors:
          description: "Metric selectors to be used in Prometheus rule"
          type: object

        threshold:
          description: "threshold in seconds"
          type: number

        percentile:
          type: number

        target:
          description: "SLO target percentage"
          type: number

        httpStatusLabel:
          description: "Name of the label that contains the http status code"
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        handler:
          type: object
          description: "Defines a selector that will be used in availability calculations"
          additionalProperties: false
          properties:
            name:
              type: string
              description: "handler name"
            value:
              type: string
              description: "handler value"
          required:
          - name
          - value

      required:
      - kind
      - metric
      - selectors
      - threshold
      - percentile
      - target

  errors:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        description:
          type: string

        kind:
          type: string
          enum: ['SLO']

        metric:
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        selectors:
          description: "Metric selectors to be used in Prometheus rule"
          type: object

        target:
          description: "SLO target percentage"
          type: number

        httpStatusLabel:
          description: "Name of the label that contains the http status code"
          type: string
          pattern: "^[a-zA-Z_:][a-zA-Z0-9_:]*$"

        handler:
          type: object
          description: "Defines a selector that will be used in availability calculations"
          additionalProperties: false
          properties:
            name:
              type: string
              description: "handler name"
            value:
              type: string
              description: "handler value"
          required:
          - name
          - value

      required:
      - kind
      - metric
      - selectors
      - target

  rawRecording:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        record:
          type: string

        expr:
          type: string

        labels:
          type: object

    required:
    - record
    - expr
    - labels

  rawAlerting:
    type: array
    items:
      type: object
      additionalProperties: false

      properties:
        alert:
          type: string

        expr:
          type: string

        for:
          type: string

        labels:
          type: object

        annotations:
          type: object
          additionalProperties: false

          properties:
            message:
              type: string

            runbook:
              type: string
              pattern: "^https?://"

            dashboard:
              type: string
              pattern: "^https?://"

            link_url:
              type: string
              pattern: "https?://"

          required:
          - message
          - runbook
          - dashboard

      required:
      - alert
      - expr
      - for
      - labels

required:
- labels
- name
- app
- component
- prometheusLabels
- namespace
