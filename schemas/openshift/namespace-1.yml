---
"$schema": /metaschema-1.json
version: '1.0'
type: object

additionalProperties: false
properties:
  "$schema":
    type: string
    enum:
    - /openshift/namespace-1.yml

  labels:
    "$ref": "/common-1.json#/definitions/labels"

  name:
    type: string

  description:
    type: string

  grafanaUrl:
    type: string
    format: uri

  cluster:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/openshift/cluster-1.yml"

  app:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/app-sre/app-1.yml"

  environment:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/app-sre/environment-1.yml"

  limitRanges:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/openshift/limitrange-1.yml"

  quota:
    "$ref": "/common-1.json#/definitions/crossref"
    "$schemaRef": "/openshift/quota-1.yml"

  networkPoliciesAllow:
    type: array
    items:
      "$ref": "/common-1.json#/definitions/crossref"
      "$schemaRef": "/openshift/namespace-1.yml"

  openshiftAcme:
    type: object
    properties:
      config:
        "$ref": "/common-1.json#/definitions/crossref"
        "$schemaRef": "/openshift/acme-1.yml"
      accountSecret:
        type: object
        properties:
          provider:
            type: string
            enum:
            - vault-secret
          name:
            type: string
          path:
            type: string
          version:
            type: integer
        required:
        - path
        - version


  managedRoles:
    type: boolean

  managedResourceTypes:
    type: array
    items:
      type: string
      # For the moment we want to limit this list.
      # A complete list can be obtained from here:
      # oc api-resources --verbs=list --no-headers | awk '{print $NF}' | sort -u
      enum:
      - ClusterLogging
      - ConfigMap
      - Secret
      - Route
      - ServiceAccount
      - ServiceMonitor
      - PrometheusRule
      - Subscription
      - Template
      - Service
      - OperatorGroup
      - Prometheus
      - Project
      - Alertmanager
      - ClusterRole
      - ResourceQuota
      - NetworkPolicy

  managedResourceTypeOverrides:
    type: array
    items:
      type: object
      properties:
        resource:
          type: string
          enum:
          - Project
        override:
          type: string
          enum:
          - project.config.openshift.io

  managedResourceNames:
    type: array
    items:
      type: object
      properties:
        resource:
          type: string
          enum:
          - Secret
          - Template
          - Project
          - Alertmanager
        resourceNames:
          type: array
          items:
            type: string

  openshiftResources:
    type: array
    items:
      type: object
      properties:
        provider:
          type: string
      oneOf:
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - resource
          path:
            type: string
          validate_json:
            type: boolean
        required:
        - path
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - resource-template
          path:
            type: string
          type:
            type: string
            enum:
            - jinja2
            - extracurlyjinja2
          variables:
            type: object
        required:
        - path
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - vault-secret
          name:
            type: string
          path:
            type: string
          version:
            type: integer
          labels:
            "$ref": "/common-1.json#/definitions/labels"
          annotations:
            "$ref": "/common-1.json#/definitions/annotations"
          type:
            type: string
            enum:
            - Opaque
            - kubernetes.io/dockercfg
            - kubernetes.io/dockerconfigjson
            - kubernetes.io/tls
            - kubernetes.io/ssh-auth
        required:
        - path
        - version
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - route
          path:
            type: string
          vault_tls_secret_path:
            type: string
          vault_tls_secret_version:
            type: integer
        required:
        - path
        dependencies:
          vault_tls_secret_path:
          - vault_tls_secret_version
          vault_tls_secret_version:
          - vault_tls_secret_path
      required:
      - provider

  managedTerraformResources:
    type: boolean

  terraformResources:
    type: array
    items:
      type: object
      properties:
        provider:
          type: string
      oneOf:
      - "$ref": "/aws/s3-1.yml"
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - aws-iam-service-account
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          identifier:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          variables:
            type: object
          policies:
            type: array
            items:
              type: string
          user_policy:
            type: object
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
        required:
        - account
        - identifier
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - rds
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          identifier:
            type: string
          availability_zone:
            type: string
            enum:
            - us-east-1a
            - us-east-1b
            - us-east-1c
            - us-east-1d
            - us-east-1f
            - us-east-2a
            - us-east-2b
            - us-east-2c
          defaults:
            type: string
          parameter_group:
            type: string
          overrides:
            type: object
            properties:
              name:
                type: string
              engine:
                type: string
                enum:
                - postgres
                - mysql
              engine_version:
                type: string
              username:
                type: string
              instance_class:
                type: string
                enum:
                - db.t2.micro
                - db.t2.small
                - db.t3.small
                - db.m3.medium
                - db.t3.medium
                - db.m4.large
                - db.m4.xlarge
                - db.m4.2xlarge
                - db.m5.large
                - db.m5.xlarge
                - db.m5.2xlarge
                - db.r4.large
                - db.r4.xlarge
                - db.r4.2xlarge
                - db.r4.4xlarge
                - db.r4.8xlarge
                - db.r4.16xlarge
                - db.r5.large
                - db.r5.xlarge
                - db.r5.2xlarge
              allocated_storage:
                type: integer
              backup_retention_period:
                type: integer
              storage_encrypted:
                type: boolean
              monitoring_interval:
                type: integer
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          enhanced_monitoring:
            type: boolean
          replica_source:
            type: string
        required:
        - account
        - identifier
        - defaults
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - elasticache
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          identifier:
            type: string
          defaults:
            type: string
          parameter_group:
            type: string
          region:
            "$ref": "/aws/regions-1.yml#/properties/region"
          overrides:
            type: object
            properties:
              engine:
                type: string
                enum:
                - redis
              engine_version:
                type: string
              node_type:
                type: string
                enum:
                - cache.m5.large
                - cache.m5.xlarge
                - cache.m5.2xlarge
                - cache.r5.large
                - cache.r5.xlarge
                - cache.r5.2xlarge
                - cache.r3.xlarge
              port:
                type: integer
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
        required:
        - account
        - identifier
        - defaults
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - sqs
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          region:
            "$ref": "/aws/regions-1.yml#/properties/region"
          identifier:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          specs:
            type: array
            items:
              type: object
              properties:
                defaults:
                  type: string
                queues:
                  type: array
                  items:
                    type: object
                    properties:
                      key:
                        "$ref": "/common-1.json#/definitions/secretKey"
                      value:
                        type: string
              required:
              - defaults
              - queues
        required:
        - account
        - identifier
        - specs
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - dynamodb
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          region:
            "$ref": "/aws/regions-1.yml#/properties/region"
          identifier:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          specs:
            type: array
            items:
              type: object
              properties:
                defaults:
                  type: string
                tables:
                  type: array
                  items:
                    type: object
                    properties:
                      key:
                        "$ref": "/common-1.json#/definitions/secretKey"
                      value:
                        type: string
              required:
              - defaults
              - tables
        required:
        - account
        - identifier
        - specs
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - ecr
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          region:
            "$ref": "/aws/regions-1.yml#/properties/region"
          identifier:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
        required:
        - account
        - identifier
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - cloudwatch
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          region:
            "$ref": "/aws/regions-1.yml#/properties/region"
          identifier:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          es_identifier:
            type: string
          filter_pattern:
            type: string
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          defaults:
            type: string
        required:
        - account
        - identifier
        - defaults
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - kms
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          identifier:
            type: string
          region:
            "$ref": "/aws/regions-1.yml#/properties/region"
          defaults:
            type: string
          overrides:
            type: object
            properties:
              name:
                type: string
              key_usage:
                type: string
                enum:
                - encrypt_decrypt
                - sign_verify
              deletion_window_in_days:
                type: integer
              enable_key_rotation:
                type: boolean
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
        required:
        - account
        - identifier
        - defaults
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - elasticsearch
          region:
            "$ref": "/aws/regions-1.yml#/properties/region"
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          identifier:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          defaults:
            type: string
        required:
        - account
        - identifier
        - defaults
      - additionalProperties: false
        properties:
          provider:
            type: string
            enum:
            - acm
          region:
            "$ref": "/aws/regions-1.yml#/properties/region"
          account:
            "$ref": "/aws/tenant_accounts-1.yml#/properties/account"
          identifier:
            "$ref": "/common-1.json#/definitions/longIdentifier"
          secret:
            "$ref": "/common-1.json#/definitions/vaultSecret"
          output_resource_name:
            "$ref": "/common-1.json#/definitions/longIdentifier"
        required:
        - account
        - identifier
        - secret
      required:
      - provider

  openshiftServiceAccountTokens:
    type: array
    items:
      type: object
      properties:
        namespace:
          "$ref": "/common-1.json#/definitions/crossref"
          "$schemaRef": "/openshift/namespace-1.yml"
        serviceAccountName:
          type: string
      required:
      - namespace
      - serviceAccountName

dependencies:
  terraformResources:
    properties:
      managedTerraformResources:
        enum:
        - true
    required:
    - managedTerraformResources

required:
- "$schema"
- labels
- name
- description
- cluster
- app
- environment
