---
$schema: /dependencies/jenkins-config-1.yml

labels:
  service: managed-services

name: ci-int-managed-services-jobs

description: ''

app:
  $ref: /services/managed-services/app.yml

instance:
  $ref: /dependencies/ci-int/ci-int.yml

type: jobs

config:
  - project:
      name: mk-strimzi-operator-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: strimzi-operator
      quay_org: app-sre
      jobs:
        - 'gl-build-master-strimzi':
            branch: mk-release
            display_name: build mk-strimzi-operator mk-release
        - 'gl-pr-check':
            display_name: mk-strimzi-operator pr-check
        - 'managed-kafka-security-scan':
            display_name: mk-strimzi-operator security-scan mk-master
            branch: mk-master
            ci_cmd: 'make scan_project'
            slack_channel_notification: mk-ci-cd
            cron_expression: 'H 6 * * *'

  - project:
      name: mk-apache-kafka-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: apache-kafka
      quay_org: app-sre
      jobs:
        - 'gl-pr-check-apache-kafka':
            display_name: apache-kafka pr-check

  - project:
      name: mk-strimzi-ui-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: strimzi-ui
      jobs:
        - 'gl-pr-check':
            display_name: mk-strimzi-ui pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: mk-strimzi-ui build-mk-release

  - project:
      name: mk-ui-frontend-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: mk-ui-frontend
      jobs:
        - 'gl-pr-check':
            display_name: mk-ui-frontend pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: mk-ui-frontend build-mk-release

  - project:
      name: mk-ui-host-midstream
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: mk-ui-host
      jobs:
        - 'gl-pr-check':
            display_name: mk-ui-host pr-check
            concurrent_build: true
        - 'gl-build-master-managed-services':
            branch: mk-release
            display_name: mk-ui-host build-mk-release

  - project:
      name: strimzi-operator-bundle
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: strimzi-operator-bundle
      jobs:
        - 'gl-pr-check-managed-services':
            display_name: strimzi-operator-bundle pr-check
        - 'gl-build-master':
            branch: staging
            display_name: strimzi-operator-bundle build staging
        - 'strimzi-operator-test':
            display_name: strimzi-operator system-test staging
            branch: staging

  - project:
      name: managed-services-api
      label: managed-services-api
      node: managed-services
      gl_group: service
      gl_project: managed-services-api
      jobs:
        - 'gl-pr-check':
            display_name: managed-services-api pr-check
            concurrent_build: true
        - 'gl-build-master':
            display_name: managed-services-api build master
        - 'managed-services-api-tests':
            display_name: Managed Services API Tests periodic stage
            timeout: 7200
            disable: false
            cron_expression: 'H 6 * * 1-5'
            ci_cmd: './pr_check.sh'
            slack_channel_notification: managed-services-api
        # At the moment, there is no other way to have an OSD cluster running longer than 7 days, hence the automation here.
        # This will be removed once we have a production cluster, or have a better way to have OSD clusters that can last longer.
        # See https://issues.redhat.com/browse/MGDSTRM-878
        - 'managed-services-api-cluster-extension':
            display_name: Managed Services API Extend Staging Cluster Lifetime
            timeout: 7200
            disable: false
            cron_expression: '0 10 * * *' # Every morning at 10am. This will ensure there is always 7 days until the cluster is expired.
            ci_cmd: './scripts/extend_staging_osd.sh'
            slack_channel_notification: managed-services-api

  - project:
      name: managed-services-kafka-performance-tests
      label: managed-services
      node: managed-services
      gl_group: mk-bin-packing
      gl_project: mk-performance-tests
      jobs:
        - 'managed-kafka-performance':
            display_name: 'managed-kafka-performance'
            mk_perf_type: 'value-prod'
            mk_perf_test: 'io.kafka.performance.**'
            timeout: 360
            slack_channel_notification: mk-ci-cd

  - project:
      name: managed-service-ci-tools
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: mk-ci-tools
      jobs:
        - 'gl-pr-check':
            display_name: managed-service-ci-tools pr-check
            pr_check_script_path: './hack/pr_check.sh'
        - 'gl-build-master':
            display_name: managed-service-ci-tools build master
            build_deploy_script_path: './hack/build_deploy.sh'
        - 'managed-services-pull-upstream':
            display_name: managed services pull upstream
            ci_cmd: 'make pull/upstream/all'
            slack_channel_notification: mk-ci-cd
            cron_expression: 'H 1 * * *'

  - project:
      name: managed-services-kafka-chaos-tests
      label: managed-services
      node: managed-services
      gh_org: RHCloudServices
      gh_repo: kafka-monitoring-stuff
      jobs:
        - 'managed-kafka-chaos':
            display_name: 'managed-kafka-chaos pod-delete'
            timeout: 3600
            slack_channel_notification: forum-managed-kafka

  - project:
      name: managed-services-kafka-litmus-test-run
      label: managed-services
      node: managed-services
      gh_org: RHCloudServices
      gh_repo: kafka-monitoring-stuff
      jobs:
        - 'managed-kafka-litmus-test-run':
            display_name: 'managed-kafka-litmus-test-run'
            timeout: 3600

  - project:
      name: mk-e2e-test-suite
      label: managed-services
      node: managed-services
      gl_group: mk-ci-cd
      gl_project: mk-e2e-test-suite
      jobs:
        - 'gl-pr-check':
            display_name: mk-e2e-test-suite pr-check
            pr_check_script_path: './pr_check.sh'
        - 'gl-build-master':
            display_name: mk-e2e-test-suite build master
            build_deploy_script_path: './build_deploy.sh'
