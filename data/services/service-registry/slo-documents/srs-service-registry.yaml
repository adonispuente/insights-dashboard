---
$schema: /app-sre/slo-document-1.yml

labels:
  service: srs-service-registry

name: srs-service-registry

app:
  $ref: /services/service-registry/app.yml

namespaces:
- $ref: /services/service-registry/namespaces/service-registry-stage.yml
- $ref: /services/service-registry/namespaces/service-registry-production.yml

slos:

# === Service Registry API

# = Availability

- name: Service Registry API (All) Availability 99%
  SLIType: availability
  SLISpecification: Percentage of Service Registry API requests that are served successfully (all operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(haproxy_backend_http_responses_total{route="service-registry-bu98",exported_namespace="service-registry-production",code!="5xx"}[{{window}}]))
    /
    sum(rate(haproxy_backend_http_responses_total{route="service-registry-bu98",exported_namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

- name: Service Registry API (Read) Availability 99.95%
  SLIType: availability
  SLISpecification: Percentage of Service Registry API requests that are served successfully (read operations).  This best represents our SLA to RHOSR customers of 99.95% availability of the service.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",status_code_group!="5xx",method="GET",path!~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",method="GET",path!~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.9995
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

- name: Service Registry API (Write) Availability 99%
  SLIType: availability
  SLISpecification: Percentage of Service Registry API requests that are served successfully (write operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",status_code_group!="5xx",method=~"POST|PUT|DELETE",path!~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",method=~"POST|PUT|DELETE",path!~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

- name: Service Registry API (Search) Availability 99%
  SLIType: availability
  SLISpecification: Percentage of Service Registry API requests that are served successfully (search operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",status_code_group!="5xx",path=~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_count_total{job="apicurio-registry",namespace="service-registry-production",path=~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

# = Latency

- name: Service Registry API (All) Latency 99% < 1000ms
  SLIType: latency
  SLISpecification: Percentage of the successful Service Registry API requests served under 1000ms (all operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="apicurio-registry",namespace="service-registry-production",le="1.0",status_code_group!~"5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="apicurio-registry",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

- name: Service Registry API (Read) Latency 99% < 250ms
  SLIType: latency
  SLISpecification: Percentage of the successful Service Registry API requests served under 250ms (read operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="apicurio-registry",namespace="service-registry-production",le="0.25",status_code_group!~"5xx",method="GET",path!~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="apicurio-registry",namespace="service-registry-production",method="GET",path!~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

- name: Service Registry API (Write) Latency 99% < 1000ms
  SLIType: latency
  SLISpecification: Percentage of the successful Service Registry API requests served under 1000ms (write operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="apicurio-registry",namespace="service-registry-production",le="1.0" ,status_code_group!~"5xx",method=~"POST|PUT|DELETE",path!~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="apicurio-registry",namespace="service-registry-production",method=~"POST|PUT|DELETE",path!~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

- name: Service Registry API (Search) Latency 99% < 1000ms
  SLIType: latency
  SLISpecification: Percentage of the successful Service Registry API requests served under 1000ms (search operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-service-registry-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="apicurio-registry",namespace="service-registry-production",le="1.0" ,status_code_group!~"5xx",path=~".*/search/.*"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="apicurio-registry",namespace="service-registry-production",path=~".*/search/.*"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-service-registry-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

# === Tenant Manager API

# = Availability

- name: Tenant Manager API Availability 95%
  SLIType: availability
  SLISpecification: Percentage of Tenant Manager API requests that are served successfully (all operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-tenant-manager-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_count_total{job="tenant-manager",namespace="service-registry-production",status_code_group!="5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_count_total{job="tenant-manager",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-tenant-manager-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-tenant-manager-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

# = Latency

- name: Tenant Manager API Latency 90% < 100ms
  SLIType: latency
  SLISpecification: Percentage of the successful Tenant Manager API requests served under 100ms (all operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-tenant-manager-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="tenant-manager",namespace="service-registry-production",le="0.1",status_code_group!~"5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="tenant-manager",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-tenant-manager-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-tenant-manager-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

- name: Tenant Manager API Latency 99% < 1000ms
  SLIType: latency
  SLISpecification: Percentage of the successful Tenant Manager API requests served under 1000ms (all operations). This currently does not contribute to our customer SLA.
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-tenant-manager-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="tenant-manager",namespace="service-registry-production",le="1.0",status_code_group!~"5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="tenant-manager",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-tenant-manager-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-tenant-manager-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/VRxU14jZ1/service-registry-data-plane-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production&var-datasouce_aws=AWS%20app-sre&var-DBInstanceIdentifier_aws=srs-service-registry-production&var-interval=5m

