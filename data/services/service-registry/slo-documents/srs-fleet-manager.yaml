---
$schema: /app-sre/slo-document-1.yml

labels:
  service: srs-fleet-manager

name: srs-fleet-manager

namespaces:
- $ref: /services/service-registry/namespaces/service-registry-stage.yml
- $ref: /services/service-registry/namespaces/service-registry-production.yml

slos:
- name: API availability
  SLIType: availability
  SLISpecification: Percentage of requests that are served successfully (status code != 5xx)
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-fleet-manager-api-availability.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(haproxy_backend_http_responses_total{route="srs-fleet-manager",exported_namespace="service-registry-production",code!="5xx"}[{{window}}]))
    /
    sum(rate(haproxy_backend_http_responses_total{route="srs-fleet-manager",exported_namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-fleet-manager-slos-availability-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-fleet-manager-slos-availability-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/Tbw1Eg2Mz/srs-fleet-manager-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production


- name: API Latency 90%
  SLIType: latency
  SLISpecification: Percentage of the successful requests served under 100ms
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-fleet-manager-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="srs-fleet-manager-metrics",namespace="service-registry-production",le="0.1",status_code_group!~"5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="srs-fleet-manager-metrics",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-fleet-manager-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-fleet-manager-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/Tbw1Eg2Mz/srs-fleet-manager-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production

- name: API Latency 99%
  SLIType: latency
  SLISpecification: Percentage of the successful requests served under 1000ms
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/docs/service-registry/slos/srs-fleet-manager-api-latency.md
  SLOParameters:
    window: 28d
  expr: |
    sum(rate(rest_requests_seconds_bucket{job="srs-fleet-manager-metrics",namespace="service-registry-production",le="1.0",status_code_group!~"5xx"}[{{window}}]))
    /
    sum(rate(rest_requests_seconds_count{job="srs-fleet-manager-metrics",namespace="service-registry-production"}[{{window}}]))
  SLOTarget: 0.99
  SLOTargetUnit: percent_0_1
  prometheusRules: /observability/prometheusrules/srs-fleet-manager-slos-latency-production.prometheusrules.yaml
  prometheusRulesTests: /observability/prometheusrules/srs-fleet-manager-slos-latency-production.prometheusrulestest.yaml
  dashboard: https://grafana.app-sre.devshift.net/d/Tbw1Eg2Mz/srs-fleet-manager-metrics?var-datasource=app-sre-prod-04-prometheus&var-namespace=service-registry-production

#TODO add registry provisioning latency and creation/deletion correctness metrics
