#TODO - pgough/rhobs - delete all after https://issues.redhat.com/browse/RHOBS-851
---
$schema: /app-sre/saas-file-2.yml

labels:
  service: observatorium

name: saas-observatorium-datahub-migration
description: SaaS tracking file for temporary datahub migration resources

app:
  $ref: /services/rhobs/observatorium-mst/app.yml

pipelinesProvider:
  $ref: /services/rhobs/observatorium/pipelines/observatorium-pipeline.appsrep05ue1.yaml

deployResources:
  requests:
    cpu: 800m
    memory: 1800Mi
  limits:
    cpu: 1200m
    memory: 1800Mi

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: team-monitoring-info

authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all

managedResourceTypes:
  - Secret
  - Job
  - ConfigMap

imagePatterns:
  - quay.io/thanos/thanos
  - quay.io/app-sre/rclone

validateTargetsInApp: true

allowedSecretParameterPaths:
  - app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs
  - rhobs/datahub/rclone-target-secret

resourceTemplates:
  - name: observatorium-datahub-migration-bucket-rclone-job
    path: /resources/operations/rclone-bucket-replicate/job-template.yaml
    url: https://github.com/rhobs/configuration
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/appsrep05ue1/observatorium-datahub-migration.yaml
        ref: a105033fc42780dc4682eb3538abead5306ee81c
        parameters:
          IMAGE: 'quay.io/app-sre/rclone'
          IMAGE_TAG: '1.63'
          SERVICE_ACCOUNT_NAME: 'rclone'
          NAME: rclone-bucket-replicate
          NAMESPACE: observatorium-datahub-migration
          CPU_REQUEST: '4'
          MEMORY_REQUEST: '8Gi'
          CPU_LIMIT: '8'
          MEMORY_LIMIT: '16Gi'
          OBJ_STORE_CONFIG_SECRET_NAME: rclone-bucket-replicate-s3-secret
          RCLONE_CONFIG_MAP_NAME: rclone-config-map
          SOURCE_ENDPOINT: SRC
          SOURCE_BUCKET: DH-SECURE-TELEMETRY-PROD
          TARGET_ENDPOINT: DST
        secretParameters:
          - name: TARGET_BUCKET
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: bucket
  - name: observatorium-rclone-configuration
    path: /resources/operations/rclone-bucket-replicate/rclone-config-template.yaml
    url: https://github.com/rhobs/configuration
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/appsrep05ue1/observatorium-datahub-migration.yaml
        ref: a105033fc42780dc4682eb3538abead5306ee81c
        parameters:
          NAMESPACE: observatorium-datahub-migration
          RCLONE_CONFIG_MAP_NAME:  rclone-config-map
          RCLONE_PARALLEL_TRANSFERS: 32
          RCLONE_S3_UPLOAD_CONCURRENCY: 32
          RCLONE_S3_CHUNK_SIZE: '256M'
          RCLONE_PARALLEL_FILE_CHECKERS: 64
  - name: observatorium-rclone-configuration-secret
    path: /resources/operations/rclone-bucket-replicate/s3-secret-template.yaml
    url: https://github.com/rhobs/configuration
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/appsrep05ue1/observatorium-datahub-migration.yaml
        ref: 5373fd488cec1a49bc74749b8f6e167ea12164c6
        parameters:
          NAMESPACE: observatorium-datahub-migration
          OBJ_STORE_CONFIG_SECRET_NAME: rclone-bucket-replicate-s3-secret
          TARGET_S3_BUCKET_PROVIDER: 'AWS'
          SOURCE_S3_BUCKET_PROVIDER: 'Ceph'
        secretParameters:
          - name: TARGET_ACCESS_KEY_ID
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_access_key_id
          - name: TARGET_SECRET_ACCESS_KEY
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_secret_access_key
          - name: TARGET_S3_BUCKET_NAME
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: bucket
          - name: TARGET_S3_BUCKET_REGION
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_region
          - name: TARGET_S3_BUCKET_ENDPOINT
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: endpoint
          - name: SOURCE_ACCESS_KEY_ID
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: access_key_id
              version: 1
          - name: SOURCE_SECRET_ACCESS_KEY
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: access_secret
              version: 1
          - name: SOURCE_S3_BUCKET_NAME
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: bucket
              version: 1
          - name: SOURCE_S3_BUCKET_REGION
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: region
              version: 1
          - name: SOURCE_S3_BUCKET_ENDPOINT
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: endpoint
              version: 1

