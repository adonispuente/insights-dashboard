#TODO - pgough/rhobs - delete all after https://issues.redhat.com/browse/RHOBS-851
---
$schema: /app-sre/saas-file-2.yml

labels:
  service: observatorium

name: saas-observatorium-datahub-migration
description: SaaS tracking file for temporary datahub migration resources

app:
  $ref: /services/rhobs/observatorium-mst/app.yml

pipelinesProvider:
  $ref: /services/rhobs/observatorium/pipelines/observatorium-pipeline.appsrep05ue1.yaml

deployResources:
  requests:
    cpu: 800m
    memory: 1800Mi
  limits:
    cpu: 1200m
    memory: 1800Mi

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: team-monitoring-info

authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all

managedResourceTypes:
  - Secret
  - Job
  - ConfigMap
  - CronJob

imagePatterns:
  - quay.io/thanos/thanos
  - quay.io/app-sre/rclone

validateTargetsInApp: true

allowedSecretParameterPaths:
  - app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs
  - app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production
  - rhobs/datahub/rclone-target-secret

resourceTemplates:
  - name: thanos-replicate-telemeter-tenant
    url: https://github.com/rhobs/configuration
    path: /resources/operations/bucket-replicate/s3-secret-template.yaml
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/telemeter-prod-01/rhobs.yml
        ref: e776adc8c8e5acd6773b97e2afb54c4c44c8e834
        parameters:
          NAMESPACE: rhobs
          TENANT_ID: FB870BF3-9F3A-44FF-9BF7-D7A047A52F43
          IMAGE_TAG: 'v0.32.0'
        secretParameters:
          - name: SOURCE_ACCESS_KEY_ID
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: aws_access_key_id
          - name: SOURCE_SECRET_ACCESS_KEY
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: aws_secret_access_key
          - name: SOURCE_S3_BUCKET_NAME
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: bucket
          - name: SOURCE_S3_BUCKET_REGION
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: aws_region
          - name: SOURCE_S3_BUCKET_ENDPOINT
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: endpoint
          - name: DESTINATION_ACCESS_KEY_ID
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_access_key_id
          - name: DESTINATION_SECRET_ACCESS_KEY
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_secret_access_key
          - name: DESTINATION_S3_BUCKET_NAME
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: bucket
          - name: DESTINATION_S3_BUCKET_REGION
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_region
          - name: DESTINATION_S3_BUCKET_ENDPOINT
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: endpoint
  - name: observatorium-datahub-migration-thanos-bucket-replicate-secret-source
    url: https://github.com/rhobs/configuration
    path: /resources/operations/bucket-replicate/s3-secret-template.yaml
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/telemeter-prod-01/rhobs.yml
        ref: ba0ab0ced1548812f28bb6e6baa4229cc5e45490
        delete: true
        parameters:
          NAMESPACE: rhobs
          OBJ_STORE_CONFIG_SECRET_NAME: thanos-bucket-replicate-config-source
        secretParameters:
          - name: ACCESS_KEY_ID
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: aws_access_key_id
          - name: SECRET_ACCESS_KEY
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: aws_secret_access_key
          - name: S3_BUCKET_NAME
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: bucket
          - name: S3_BUCKET_REGION
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: aws_region
          - name: S3_BUCKET_ENDPOINT
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-metrics-production/telemeter-thanos-production-s3
              field: endpoint
  - name: observatorium-datahub-migration-thanos-bucket-replicate-secret-destination
    url: https://github.com/rhobs/configuration
    path: /resources/operations/bucket-replicate/s3-secret-template.yaml
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/telemeter-prod-01/rhobs.yml
        ref: ba0ab0ced1548812f28bb6e6baa4229cc5e45490
        delete: true
        parameters:
          NAMESPACE: rhobs
          OBJ_STORE_CONFIG_SECRET_NAME: thanos-bucket-replicate-config-destination
        secretParameters:
          - name: ACCESS_KEY_ID
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_access_key_id
          - name: SECRET_ACCESS_KEY
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_secret_access_key
          - name: S3_BUCKET_NAME
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: bucket
          - name: S3_BUCKET_REGION
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_region
          - name: S3_BUCKET_ENDPOINT
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: endpoint
  - name: observatorium-datahub-migration-bucket-rclone-job
    path: /resources/operations/rclone-bucket-replicate/job-template.yaml
    url: https://github.com/rhobs/configuration
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/appsrep05ue1/observatorium-datahub-migration.yaml
        ref: a105033fc42780dc4682eb3538abead5306ee81c
        delete: true
        parameters:
          IMAGE: 'quay.io/app-sre/rclone'
          IMAGE_TAG: '1.63'
          SERVICE_ACCOUNT_NAME: 'rclone'
          NAME: rclone-bucket-replicate
          NAMESPACE: observatorium-datahub-migration
          CPU_REQUEST: '4'
          MEMORY_REQUEST: '8Gi'
          CPU_LIMIT: '8'
          MEMORY_LIMIT: '16Gi'
          OBJ_STORE_CONFIG_SECRET_NAME: rclone-bucket-replicate-s3-secret
          RCLONE_CONFIG_MAP_NAME: rclone-config-map
          SOURCE_ENDPOINT: SRC
          SOURCE_BUCKET: DH-SECURE-TELEMETRY-PROD
          TARGET_ENDPOINT: DST
        secretParameters:
          - name: TARGET_BUCKET
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: bucket
  - name: observatorium-rclone-configuration
    path: /resources/operations/rclone-bucket-replicate/rclone-config-template.yaml
    url: https://github.com/rhobs/configuration
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/appsrep05ue1/observatorium-datahub-migration.yaml
        ref: 114ffade87a389c460a2f27ed545c367deb2bcdc
        delete: true
        parameters:
          NAMESPACE: observatorium-datahub-migration
          RCLONE_CONFIG_MAP_NAME:  rclone-config-map
          RCLONE_PARALLEL_TRANSFERS: 32
          RCLONE_S3_UPLOAD_CONCURRENCY: 32
          RCLONE_S3_CHUNK_SIZE: '256M'
          RCLONE_PARALLEL_FILE_CHECKERS: 64
          RCLONE_MULTI_THREAD_STREAMS: 32
  - name: observatorium-rclone-configuration-secret
    path: /resources/operations/rclone-bucket-replicate/s3-secret-template.yaml
    url: https://github.com/rhobs/configuration
    targets:
      - namespace:
          $ref: /services/rhobs/observatorium-mst/namespaces/appsrep05ue1/observatorium-datahub-migration.yaml
        ref: 5373fd488cec1a49bc74749b8f6e167ea12164c6
        delete: true
        parameters:
          NAMESPACE: observatorium-datahub-migration
          OBJ_STORE_CONFIG_SECRET_NAME: rclone-bucket-replicate-s3-secret
          TARGET_S3_BUCKET_PROVIDER: 'AWS'
          SOURCE_S3_BUCKET_PROVIDER: 'Ceph'
        secretParameters:
          - name: TARGET_ACCESS_KEY_ID
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_access_key_id
          - name: TARGET_SECRET_ACCESS_KEY
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_secret_access_key
          - name: TARGET_S3_BUCKET_NAME
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: bucket
          - name: TARGET_S3_BUCKET_REGION
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: aws_region
          - name: TARGET_S3_BUCKET_ENDPOINT
            secret:
              path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/rhobs/telemeter-tenant-s3
              field: endpoint
          - name: SOURCE_ACCESS_KEY_ID
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: access_key_id
              version: 1
          - name: SOURCE_SECRET_ACCESS_KEY
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: access_secret
              version: 1
          - name: SOURCE_S3_BUCKET_NAME
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: bucket
              version: 1
          - name: SOURCE_S3_BUCKET_REGION
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: region
              version: 1
          - name: SOURCE_S3_BUCKET_ENDPOINT
            secret:
              path: rhobs/datahub/rclone-target-secret
              field: endpoint
              version: 1
