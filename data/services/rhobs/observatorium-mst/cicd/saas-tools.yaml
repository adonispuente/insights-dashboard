---
$schema: /app-sre/saas-file-2.yml

labels:
  service: observatorium

name: saas-observatorium-tools
description: SaaS tracking file for Observatorium MST tools

app:
  $ref: /services/rhobs/observatorium-mst/app.yml

pipelinesProvider:
  $ref: /services/rhobs/observatorium/pipelines/observatorium-pipeline.appsrep05ue1.yaml

deployResources:
  requests:
    cpu: 800m
    memory: 1800Mi
  limits:
    cpu: 1200m
    memory: 1800Mi

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: team-monitoring-info

authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all

managedResourceTypes:
- Deployment
- Service
- StatefulSet
- ConfigMap
- Role.rbac.authorization.k8s.io
- RoleBinding.rbac.authorization.k8s.io
- ServiceAccount
- PodDisruptionBudget
- PersistentVolumeClaim
- PrometheusRule
- Secret
- LokiStack
- ClusterRole.rbac.authorization.k8s.io
- ClusterRoleBinding.rbac.authorization.k8s.io
- Route

clusterAdmin: true

imagePatterns:
- quay.io/observatorium
- quay.io/app-sre
- quay.io/openshift/origin-oauth-proxy
- quay.io/jpkroehling/all-in-one
- quay.io/jaegertracing/all-in-one

parameters:
  OAUTH_PROXY_IMAGE: quay.io/openshift/origin-oauth-proxy
  OAUTH_PROXY_IMAGE_TAG: 4.8.0 # Pinning version before 4.9.0 due to https://github.com/openshift/oauth-proxy/issues/229.

allowedSecretParameterPaths:
  - app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools
  - app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-tools
  - app-sre/integrations-output/terraform-resources/rhobsp02ue1/observatorium-tools

resourceTemplates:
- name: jaeger
  path: /resources/services/jaeger-template.yaml
  url: https://github.com/rhobs/configuration
  parameters:
    IMAGE: quay.io/jaegertracing/all-in-one
  targets:
  - namespace:
      $ref: /services/rhobs/observatorium-mst/namespaces/rhobsp02ue1/observatorium-tools-production.yml
    ref: 3830f23a4af9f3ce972413c05d2047a95951c001
    parameters:
      NAMESPACE: observatorium-tools-production
      IMAGE_TAG: '1.22.0'
      REPLICAS: '1'
      JAEGER_CPU_REQUEST: '1'
      JAEGER_MEMORY_REQUEST: '4Gi'
      JAEGER_CPU_LIMITS: '2'
      JAEGER_MEMORY_LIMITS: '8Gi'
      SERVICE_ACCOUNT_NAME: observatorium-tools
- name: observatorium-meta-monitoring-logs
  path: /resources/services/meta-monitoring/logging-template.yaml
  url: https://github.com/rhobs/configuration
  targets:
    - namespace:
        $ref: /services/rhobs/observatorium-mst/namespaces/rhobs-testing/observatorium-tools.yml
      ref: cbbcebc396c128ad799a92820adca7373a58be33
      parameters:
        LOKI_STORAGE_SECRET_NAME: minio-test-loki
        LOKI_SIZE: 1x.extra-small
    - namespace:
        $ref: /services/rhobs/observatorium-mst/namespaces/app-sre-stage-01/observatorium-tools.yml
      ref: fa8ef6643a2881d5a81887ceb1536554ceddcdea
      parameters:
        LOKI_STORAGE_SECRET_NAME: observatorium-loki-s3
        LOKI_SIZE: 1x.extra-small
      secretParameters:
        - name: ACCESS_KEY_ID
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-loki
            field: aws_access_key_id
        - name: SECRET_ACCESS_KEY
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-loki
            field: aws_secret_access_key
        - name: S3_BUCKET_NAME
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-loki
            field: bucket
        - name: S3_BUCKET_REGION
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-loki
            field: aws_region
        - name: S3_BUCKET_ENDPOINT
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-loki
            field: endpoint
    - namespace:
        $ref: /services/rhobs/observatorium-mst/namespaces/telemeter-prod-01/observatorium-tools.yml
      ref: fa8ef6643a2881d5a81887ceb1536554ceddcdea
      parameters:
        LOKI_STORAGE_SECRET_NAME: observatorium-loki-s3
        LOKI_SIZE: 1x.small
      secretParameters:
        - name: ACCESS_KEY_ID
          secret:
            path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-tools/observatorium-loki
            field: aws_access_key_id
        - name: SECRET_ACCESS_KEY
          secret:
            path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-tools/observatorium-loki
            field: aws_secret_access_key
        - name: S3_BUCKET_NAME
          secret:
            path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-tools/observatorium-loki
            field: bucket
        - name: S3_BUCKET_REGION
          secret:
            path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-tools/observatorium-loki
            field: aws_region
        - name: S3_BUCKET_ENDPOINT
          secret:
            path: app-sre/integrations-output/terraform-resources/telemeter-prod-01/observatorium-tools/observatorium-loki
            field: endpoint
    - namespace:
        $ref: /services/rhobs/observatorium-mst/namespaces/rhobsp02ue1/observatorium-tools.yml
      ref: fa8ef6643a2881d5a81887ceb1536554ceddcdea
      parameters:
        LOKI_STORAGE_SECRET_NAME: observatorium-loki-s3
        LOKI_SIZE: 1x.extra-small
      secretParameters:
        - name: ACCESS_KEY_ID
          secret:
            path: app-sre/integrations-output/terraform-resources/rhobsp02ue1/observatorium-tools/observatorium-loki
            field: aws_access_key_id
        - name: SECRET_ACCESS_KEY
          secret:
            path: app-sre/integrations-output/terraform-resources/rhobsp02ue1/observatorium-tools/observatorium-loki
            field: aws_secret_access_key
        - name: S3_BUCKET_NAME
          secret:
            path: app-sre/integrations-output/terraform-resources/rhobsp02ue1/observatorium-tools/observatorium-loki
            field: bucket
        - name: S3_BUCKET_REGION
          secret:
            path: app-sre/integrations-output/terraform-resources/rhobsp02ue1/observatorium-tools/observatorium-loki
            field: aws_region
        - name: S3_BUCKET_ENDPOINT
          secret:
            path: app-sre/integrations-output/terraform-resources/rhobsp02ue1/observatorium-tools/observatorium-loki
            field: endpoint
- name: observatorium-meta-monitoring-con-prof
  path: /resources/services/meta-monitoring/profiling-template.yaml
  url: https://github.com/rhobs/configuration
  targets:
    - namespace:
        $ref: /services/rhobs/observatorium-mst/namespaces/app-sre-stage-01/observatorium-tools.yml
      ref: 872a13377e0cd1202764801bdae199c776623100
      parameters:
        NAMESPACE: observatorium-tools
        SD_NAMESPACE_LIST: '["observatorium-mst-stage"]'
        IMAGE_TAG: v0.18.0
      secretParameters:
        - name: ACCESS_KEY_ID
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-parca
            field: aws_access_key_id
        - name: SECRET_ACCESS_KEY
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-parca
            field: aws_secret_access_key
        - name: S3_BUCKET_NAME
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-parca
            field: bucket
        - name: S3_BUCKET_REGION
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-parca
            field: aws_region
        - name: S3_BUCKET_ENDPOINT
          secret:
            path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/observatorium-tools/observatorium-parca
            field: endpoint
