---
$schema: /app-sre/saas-file-2.yml

labels:
  service: telemeter

name: saas-telemeter
description: SaaS tracking file for Telemeter services

app:
  $ref: /services/rhobs/telemeter/app.yml

pipelinesProvider:
  $ref: /services/rhobs/observatorium/pipelines/observatorium-pipeline.appsrep05ue1.yaml

deployResources:
  requests:
    cpu: 800m
    memory: 1500Mi
  limits:
    cpu: 1200m
    memory: 2000Mi


slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: team-monitoring-info

authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all

managedResourceTypes:
- Deployment
- Service
- StatefulSet
- ConfigMap
- Role
- RoleBinding
- ServiceAccount
- PodDisruptionBudget
- PersistentVolumeClaim
- PrometheusRule
- Secret

imagePatterns:
- quay.io/thanos/thanos
- quay.io/cortexproject/cortex
- quay.io/observatorium
- quay.io/app-sre
- quay.io/openshift/origin-oauth-proxy
- quay.io/prometheus/memcached-exporter
- quay.io/app-sre/memcached
- quay.io/jpkroehling/all-in-one
- quay.io/app-sre/gubernator

parameters:
  OAUTH_PROXY_IMAGE: quay.io/openshift/origin-oauth-proxy
  OAUTH_PROXY_IMAGE_TAG: 4.8.0 # Pinning version before 4.9.0 due to https://github.com/openshift/oauth-proxy/issues/229.

allowedSecretParameterPaths:
  - rhobs/rhel/credentials/service-account-observatorium-rhel-write-staging

resourceTemplates:
- name: telemeter-dashboards
  url: https://github.com/rhobs/configuration
  path: /resources/observability/grafana/observatorium
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: main
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: ca5bcec46d6ab980e5f5d670821631e0075a9406
- name: telemeter
  path: /resources/services/telemeter-template.yaml
  url: https://github.com/rhobs/configuration
  parameters:
    # NOTICE: Please specify image tags for each environment separately.
    # And sort them alphabetically.
    IMAGE: quay.io/app-sre/telemeter
    JAEGER_AGENT_IMAGE: quay.io/app-sre/jaegertracing-jaeger-agent
    MEMCACHED_IMAGE: quay.io/app-sre/memcached
    MEMCACHED_EXPORTER_IMAGE: quay.io/prometheus/memcached-exporter
    IMAGE_CANARY: quay.io/app-sre/telemeter
    TELEMETER_SERVER_TOKEN_EXPIRE_SECONDS: 86400
  targets:
  - namespace:
      $ref: /services/rhobs/telemeter/namespaces/telemeter-testing.yml
    ref: main
    parameters:
      NAMESPACE: telemeter-stage
      OBSERVATORIUM_NAMESPACE: observatorium-stage
      OBSERVATORIUM_METRICS_NAMESPACE: observatorium-metrics-stage
      IMAGE_TAG: 'df72531'
      IMAGE_CANARY_TAG: 'b4f226c'
      REPLICAS: 3
      REPLICAS_CANARY: 0
      JAEGER_AGENT_IMAGE_TAG: 1.22.0
      MEMCACHED_EXPORTER_IMAGE_TAG: v0.6.0
      MEMCACHED_IMAGE_TAG: 1.5-146
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_TARGET: 'observatorium-thanos-receive'
      SERVICE_ACCOUNT_NAME: telemeter
      TELEMETER_FORWARD_URL: 'http://observatorium-observatorium-api.observatorium-stage.svc.cluster.local:8080/api/metrics/v1/telemeter/api/v1/receive'
      TELEMETER_LOG_LEVEL: 'warn'
      TELEMETER_SERVER_CPU_LIMIT: 1
      TELEMETER_SERVER_CPU_REQUEST: 100m
      TELEMETER_SERVER_MEMORY_LIMIT: 1Gi
      TELEMETER_SERVER_MEMORY_REQUEST: 100Mi
      TOKEN_REFRESHER_IMAGE_TAG: master-2021-06-17-7761b62
      TOKEN_REFRESHER_LOG_LEVEL: debug
      THANOS_STORE_INDEX_CACHE_CONNECTION_LIMIT: 5000
      THANOS_STORE_INDEX_CACHE_MEMORY_LIMIT_MB: 3072
      THANOS_STORE_INDEX_CACHE_MEMCACHED_CPU_LIMIT: 1
      THANOS_STORE_INDEX_CACHE_MEMCACHED_MEMORY_LIMIT: '3Gi'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_IMAGE: 'quay.io/app-sre/ubi8-nginx-118'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_VERSION: '1-51'
  - namespace:
      $ref: /services/rhobs/telemeter/namespaces/telemeter-integration.yml
    ref: 0d256f4ab0b12d6dcde1a244768fe8bf5044e372
    parameters:
      NAMESPACE: telemeter-integration
      OBSERVATORIUM_NAMESPACE: observatorium-stage
      OBSERVATORIUM_METRICS_NAMESPACE: observatorium-metrics-stage
      IMAGE_TAG: 'df72531'
      IMAGE_CANARY_TAG: 'b4f226c'
      REPLICAS: 3
      REPLICAS_CANARY: 0
      JAEGER_AGENT_IMAGE_TAG: 1.22.0
      MEMCACHED_EXPORTER_IMAGE_TAG: v0.6.0
      MEMCACHED_IMAGE_TAG: 1.5-146
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_TARGET: 'observatorium-thanos-receive'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_PORT: '19291'
      SERVICE_ACCOUNT_NAME: telemeter
      TELEMETER_FORWARD_URL: 'http://observatorium-observatorium-api.observatorium-stage.svc.cluster.local:8080/api/metrics/v1/telemeter/api/v1/receive'
      TELEMETER_LOG_LEVEL: 'warn'
      TELEMETER_SERVER_CPU_LIMIT: 1
      TELEMETER_SERVER_CPU_REQUEST: 100m
      TELEMETER_SERVER_MEMORY_LIMIT: 1Gi
      TELEMETER_SERVER_MEMORY_REQUEST: 100Mi
      TOKEN_REFRESHER_IMAGE_TAG: master-2021-06-17-7761b62
      TOKEN_REFRESHER_LOG_LEVEL: debug
      THANOS_STORE_INDEX_CACHE_CONNECTION_LIMIT: 5000
      THANOS_STORE_INDEX_CACHE_MEMORY_LIMIT_MB: 3072
      THANOS_STORE_INDEX_CACHE_MEMCACHED_CPU_LIMIT: 1
      THANOS_STORE_INDEX_CACHE_MEMCACHED_MEMORY_LIMIT: '3Gi'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_IMAGE: 'quay.io/app-sre/ubi8-nginx-118'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_VERSION: '1-51'
  - namespace:
      $ref: /services/rhobs/telemeter/namespaces/telemeter-stage.yml
    ref: cac4733113cb7f8da6de20bc1e17bed071f0f891
    parameters:
      NAMESPACE: telemeter-stage
      OBSERVATORIUM_NAMESPACE: observatorium-stage
      OBSERVATORIUM_METRICS_NAMESPACE: observatorium-metrics-stage
      IMAGE_TAG: 'a6b4a93'
      IMAGE_CANARY_TAG: 'b4f226c'
      REPLICAS: 3
      REPLICAS_CANARY: 0
      JAEGER_AGENT_IMAGE_TAG: 1.22.0
      MEMCACHED_EXPORTER_IMAGE_TAG: v0.6.0
      MEMCACHED_IMAGE_TAG: 1.5-146
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_TARGET: 'observatorium-thanos-receive'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_PORT: '19291'
      SERVICE_ACCOUNT_NAME: telemeter
      TELEMETER_FORWARD_URL: 'http://observatorium-observatorium-api.observatorium-stage.svc.cluster.local:8080/api/metrics/v1/telemeter/api/v1/receive'
      TELEMETER_LOG_LEVEL: 'warn'
      TELEMETER_SERVER_CPU_LIMIT: 1
      TELEMETER_SERVER_CPU_REQUEST: 100m
      TELEMETER_SERVER_MEMORY_LIMIT: 1Gi
      TELEMETER_SERVER_MEMORY_REQUEST: 100Mi
      TOKEN_REFRESHER_IMAGE_TAG: master-2021-06-17-7761b62
      TOKEN_REFRESHER_LOG_LEVEL: debug
      THANOS_STORE_INDEX_CACHE_CONNECTION_LIMIT: 5000
      THANOS_STORE_INDEX_CACHE_MEMORY_LIMIT_MB: 3072
      THANOS_STORE_INDEX_CACHE_MEMCACHED_CPU_LIMIT: 1
      THANOS_STORE_INDEX_CACHE_MEMCACHED_MEMORY_LIMIT: '3Gi'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_IMAGE: 'quay.io/app-sre/ubi8-nginx-118'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_VERSION: '1-51'
  - namespace:
      $ref: /services/rhobs/telemeter/namespaces/telemeter-production.yml
    ref: cac4733113cb7f8da6de20bc1e17bed071f0f891
    parameters:
      NAMESPACE: telemeter-production
      OBSERVATORIUM_NAMESPACE: observatorium-production
      OBSERVATORIUM_METRICS_NAMESPACE: observatorium-metrics-production
      IMAGE_TAG: 'a6b4a93'
      IMAGE_CANARY_TAG: '8e65e1c'
      REPLICAS: 10
      REPLICAS_CANARY: 0
      JAEGER_AGENT_IMAGE_TAG: 1.22.0
      MEMCACHED_EXPORTER_IMAGE_TAG: v0.6.0
      MEMCACHED_IMAGE_TAG: 1.5
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_TARGET: 'observatorium-thanos-receive'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_PORT: '19291'
      SERVICE_ACCOUNT_NAME: telemeter
      TELEMETER_FORWARD_URL: 'http://observatorium-observatorium-api.observatorium-production.svc.cluster.local:8080/api/metrics/v1/telemeter/api/v1/receive'
      TELEMETER_LOG_LEVEL: 'warn'
      TELEMETER_SERVER_CPU_LIMIT: 1500m
      TELEMETER_SERVER_CPU_REQUEST: 100m
      TELEMETER_SERVER_MEMORY_LIMIT: 1Gi
      TELEMETER_SERVER_MEMORY_REQUEST: 100Mi
      TOKEN_REFRESHER_IMAGE_TAG: master-2021-06-17-7761b62
      TOKEN_REFRESHER_LOG_LEVEL: debug
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_IMAGE: 'quay.io/app-sre/ubi8-nginx-118'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_VERSION: '1-51'
- name: rhelemeter
  parameters:
    RHELEMETER_OIDC_ISSUER: https://sso.redhat.com/auth/realms/redhat-external
  url: https://github.com/rhobs/configuration
  path: /resources/services/rhelemeter-template.yaml
  targets:
  - namespace:
      $ref: /services/rhobs/telemeter/namespaces/rhelemeter-stage.yml
    ref: 391a396f348e21cd6da2930b4a24635130d09577
    parameters:
      NAMESPACE: rhelemeter-stage
      RHELEMETER_FORWARD_URL: http://observatorium-observatorium-mst-api.observatorium-mst-stage.svc.cluster.local:8080/api/metrics/v1/rhel/api/v1/receive
      IMAGE_TAG: bba4a6f
      RHELEMETER_LOG_LEVEL: debug
    secretParameters:
      - name: RHELEMETER_CLIENT_ID
        secret:
          path: rhobs/rhel/credentials/service-account-observatorium-rhel-write-staging
          field: client_id
          version: 1
      - name: RHELEMETER_CLIENT_SECRET
        secret:
          path: rhobs/rhel/credentials/service-account-observatorium-rhel-write-staging
          field: client_secret
          version: 1
