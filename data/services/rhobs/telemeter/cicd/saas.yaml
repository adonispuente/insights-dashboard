---
$schema: /app-sre/saas-file-2.yml

labels:
  service: telemeter

name: saas-telemeter
description: SaaS tracking file for Telemeter services

app:
  $ref: /services/rhobs/telemeter/app.yml

pipelinesProvider:
  $ref: /services/rhobs/observatorium/pipelines/observatorium-pipeline.app-sre-prod-01.yaml

deployResources:
  requests:
    cpu: 600m
    memory: 1200Mi
  limits:
    cpu: 600m
    memory: 1200Mi

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: team-monitoring-info

authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all

managedResourceTypes:
- Deployment
- Service
- StatefulSet
- ConfigMap
- Role
- RoleBinding
- ServiceAccount
- PodDisruptionBudget
- PersistentVolumeClaim
- PrometheusRule # adding everything that exists. this will be moved to a separate saas file

imagePatterns:
- quay.io/conprof/conprof
- quay.io/thanos/thanos
- quay.io/cortexproject/cortex
- quay.io/observatorium
- quay.io/app-sre
- quay.io/openshift/origin-oauth-proxy
- quay.io/prometheus/memcached-exporter
- quay.io/app-sre/memcached
- quay.io/jpkroehling/all-in-one
- quay.io/app-sre/gubernator

parameters:
  OAUTH_PROXY_IMAGE: quay.io/openshift/origin-oauth-proxy
  OAUTH_PROXY_IMAGE_TAG: 4.8.0 # Pinning version before 4.9.0 due to https://github.com/openshift/oauth-proxy/issues/229.

resourceTemplates:
- name: telemeter-dashboards
  url: https://github.com/rhobs/configuration
  path: /resources/observability/grafana/observatorium
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage.yml
    ref: main
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production.yml
    ref: 54041a17fa942faea3a9db84b002e39f83ad663a
- name: telemeter
  path: /resources/services/telemeter-template.yaml
  url: https://github.com/rhobs/configuration
  parameters:
    # NOTICE: Please specify image tags for each environment separately.
    # And sort them alphabetically.
    IMAGE: quay.io/app-sre/telemeter
    JAEGER_AGENT_IMAGE: quay.io/app-sre/jaegertracing-jaeger-agent
    MEMCACHED_IMAGE: quay.io/app-sre/memcached
    MEMCACHED_EXPORTER_IMAGE: quay.io/prometheus/memcached-exporter
    IMAGE_CANARY: quay.io/app-sre/telemeter
    TELEMETER_SERVER_TOKEN_EXPIRE_SECONDS: 86400
  targets:
  - namespace:
      $ref: /services/rhobs/telemeter/namespaces/telemeter-testing.yml
    ref: main
    parameters:
      NAMESPACE: telemeter-stage
      OBSERVATORIUM_NAMESPACE: observatorium-stage
      OBSERVATORIUM_METRICS_NAMESPACE: observatorium-metrics-stage
      OBSERVATORIUM_LOGS_NAMESPACE: observatorium-logs-stage
      IMAGE_TAG: '239dc6f'
      IMAGE_CANARY_TAG: 'b4f226c'
      REPLICAS: 3
      REPLICAS_CANARY: 0
      JAEGER_AGENT_IMAGE_TAG: 1.22.0
      MEMCACHED_EXPORTER_IMAGE_TAG: v0.6.0
      MEMCACHED_IMAGE_TAG: 1.5-146
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_TARGET: 'observatorium-thanos-receive'
      SERVICE_ACCOUNT_NAME: telemeter
      TELEMETER_FORWARD_URL: 'http://observatorium-observatorium-api.observatorium-stage.svc.cluster.local:8080/api/metrics/v1/telemeter/api/v1/receive'
      TELEMETER_LOG_LEVEL: 'debug'
      TELEMETER_SERVER_CPU_LIMIT: 1
      TELEMETER_SERVER_CPU_REQUEST: 100m
      TELEMETER_SERVER_MEMORY_LIMIT: 1Gi
      TELEMETER_SERVER_MEMORY_REQUEST: 100Mi
      TOKEN_REFRESHER_IMAGE_TAG: master-2021-06-17-7761b62
      TOKEN_REFRESHER_LOG_LEVEL: debug
      THANOS_STORE_INDEX_CACHE_CONNECTION_LIMIT: 5000
      THANOS_STORE_INDEX_CACHE_MEMORY_LIMIT_MB: 3072
      THANOS_STORE_INDEX_CACHE_MEMCACHED_CPU_LIMIT: 1
      THANOS_STORE_INDEX_CACHE_MEMCACHED_MEMORY_LIMIT: '3Gi'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_IMAGE: 'quay.io/app-sre/ubi8-nginx-118'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_VERSION: '1-51'
  - namespace:
      $ref: /services/rhobs/telemeter/namespaces/telemeter-stage.yml
    ref: 281029b68aca42fccfb3a9022734e553c408bb4a
    parameters:
      NAMESPACE: telemeter-stage
      OBSERVATORIUM_NAMESPACE: observatorium-stage
      OBSERVATORIUM_METRICS_NAMESPACE: observatorium-metrics-stage
      OBSERVATORIUM_LOGS_NAMESPACE: observatorium-logs-stage
      IMAGE_TAG: '239dc6f'
      IMAGE_CANARY_TAG: 'b4f226c'
      REPLICAS: 3
      REPLICAS_CANARY: 0
      JAEGER_AGENT_IMAGE_TAG: 1.22.0
      MEMCACHED_EXPORTER_IMAGE_TAG: v0.6.0
      MEMCACHED_IMAGE_TAG: 1.5-146
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_TARGET: 'observatorium-thanos-receive'
      SERVICE_ACCOUNT_NAME: telemeter
      TELEMETER_FORWARD_URL: 'http://observatorium-observatorium-api.observatorium-stage.svc.cluster.local:8080/api/metrics/v1/telemeter/api/v1/receive'
      TELEMETER_LOG_LEVEL: 'debug'
      TELEMETER_SERVER_CPU_LIMIT: 1
      TELEMETER_SERVER_CPU_REQUEST: 100m
      TELEMETER_SERVER_MEMORY_LIMIT: 1Gi
      TELEMETER_SERVER_MEMORY_REQUEST: 100Mi
      TOKEN_REFRESHER_IMAGE_TAG: master-2021-06-17-7761b62
      TOKEN_REFRESHER_LOG_LEVEL: debug
      THANOS_STORE_INDEX_CACHE_CONNECTION_LIMIT: 5000
      THANOS_STORE_INDEX_CACHE_MEMORY_LIMIT_MB: 3072
      THANOS_STORE_INDEX_CACHE_MEMCACHED_CPU_LIMIT: 1
      THANOS_STORE_INDEX_CACHE_MEMCACHED_MEMORY_LIMIT: '3Gi'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_IMAGE: 'quay.io/app-sre/ubi8-nginx-118'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_VERSION: '1-51'
  - namespace:
      $ref: /services/rhobs/telemeter/namespaces/telemeter-production.yml
    ref: d82dd26e538a0943c10e7be731db2a98fa1c5618
    parameters:
      NAMESPACE: telemeter-production
      OBSERVATORIUM_NAMESPACE: observatorium-production
      OBSERVATORIUM_METRICS_NAMESPACE: observatorium-metrics-production
      OBSERVATORIUM_LOGS_NAMESPACE: observatorium-logs-production
      IMAGE_TAG: '239dc6f'
      IMAGE_CANARY_TAG: '8e65e1c'
      REPLICAS: 10
      REPLICAS_CANARY: 0
      JAEGER_AGENT_IMAGE_TAG: 1.22.0
      MEMCACHED_EXPORTER_IMAGE_TAG: v0.6.0
      MEMCACHED_IMAGE_TAG: 1.5
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_TARGET: 'observatorium-thanos-receive'
      SERVICE_ACCOUNT_NAME: telemeter
      TELEMETER_FORWARD_URL: 'http://observatorium-observatorium-api.observatorium-production.svc.cluster.local:8080/api/metrics/v1/telemeter/api/v1/receive'
      TELEMETER_LOG_LEVEL: 'warn'
      TELEMETER_SERVER_CPU_LIMIT: 1500m
      TELEMETER_SERVER_CPU_REQUEST: 100m
      TELEMETER_SERVER_MEMORY_LIMIT: 1Gi
      TELEMETER_SERVER_MEMORY_REQUEST: 100Mi
      TOKEN_REFRESHER_IMAGE_TAG: master-2021-06-17-7761b62
      TOKEN_REFRESHER_LOG_LEVEL: debug
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_IMAGE: 'quay.io/app-sre/ubi8-nginx-118'
      PROMETHEUS_AMS_REMOTE_WRITE_PROXY_VERSION: '1-51'
