---
$schema: /openshift/namespace-1.yml

labels: {}

name: assisted-installer-stage
description: namespace for assisted-installer stage

cluster:
  $ref: /openshift/app-sre-stage-01/cluster.yml

app:
  $ref: /services/assisted-installer/app.yml

environment:
  $ref: /products/osdv4/environments/stage.yml

networkPoliciesAllow:
- $ref: /services/ocm/namespaces/uhc-stage.yml
- $ref: /services/observability/namespaces/openshift-customer-monitoring.app-sre-stage-01.yml

managedResourceTypes:
- ServiceAccount
- Role
- RoleBinding

sharedResources:
- $ref: /services/app-sre/shared-resources/quayio-pull-secret.yml

openshiftResources:
- provider: route
  path: /services/assisted-installer/kibana-stage.route.yaml
- provider: resource
  path: /services/assisted-installer/kibana.serviceaccount.yaml
- provider: route
  path: /services/assisted-installer/assisted-service-stage.route.yaml
- provider: route
  path: /services/assisted-installer/assisted-image-service-stage.route.yaml
- provider: route
  path: /services/assisted-installer/assisted-image-service-boot-artifacts-stage.route.yaml
- provider: resource
  path: /services/assisted-installer/assisted-service.serviceaccount.yaml
- provider: resource
  path: /services/assisted-installer/allow-port-forward.yaml
- provider: resource
  path: /services/assisted-installer/allow-port-forward.rolebinding.yaml
- provider: resource
  path: /services/assisted-installer/assisted-service-leader-election.rolebinding.yaml
- provider: resource
  path: /services/assisted-installer/leader-election.role.yaml
- provider: vault-secret
  name: route53-creds
  path: app-interface/hive-integration/assisted-installer/route53-creds
  version: 7
  annotations:
    qontract.recycle: "true"
- provider: vault-secret
  name: assisted-installer-sso
  path: app-interface/assisted-installer/sso/stage
  version: 4
  annotations:
    qontract.recycle: "true"
- provider: vault-secret
  name: jenkins
  path: app-interface/assisted-installer/jenkins/stage
  version: 4
- provider: vault-secret
  name: events-scrape
  path: app-interface/assisted-installer/events-scrape/stage
  version: 1
- provider: vault-secret
  name: kibana-oauth-application
  path: app-interface/assisted-installer/kibana/stage
  version: 2
- provider: vault-secret
  name: elastic-master-credentials
  path: app-interface/assisted-installer/elastic-credentials/stage
  version: 2
- provider: vault-secret
  name: assisted-installer-s3-migration
  path: app-interface/assisted-installer/s3-migration/stage
  version: 2
- provider: vault-secret
  name: auto-report-slack-webhook
  path: app-interface/assisted-installer/auto-report-slack-webhook/stage
  version: 3
- provider: vault-secret
  name: jobs-auto-report-slack-channel-id
  path: app-interface/assisted-installer/jobs-auto-report-slack-channel-id/stage
  version: 2
- provider: vault-secret
  name: jobs-auto-report-slack-bot-token
  path: app-interface/assisted-installer/jobs-auto-report-slack-bot-token/stage
  version: 4
- provider: vault-secret
  name: prow-jobs-scraper-equinix-secret
  path: app-interface/assisted-installer/prow-jobs-scraper-equinix-secret/stage
  version: 1
- provider: vault-secret
  name: insights-kafka-auth
  path: insights/secrets/insights-stage/strimzi-stage/mk-oauth-secret
  version: 5
- provider: vault-secret
  name: assisted-installer-event-stream
  path: app-interface/assisted-installer/kafka/event-stream/stage
  version: 2
  annotations:
    qontract.recycle: "true"
- provider: vault-secret
  name: redis-credentials
  path: app-interface/assisted-installer/redis-credentials/stage
  version: 1
  annotations:
    qontract.recycle: "true"

managedRoles: true

managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/app-sre-stage/account.yml
  resources:
  - provider: s3
    identifier: ai-events-tfstate-stage
    defaults: /terraform/resources/assisted-installer/s3-no-lifecycle.yml
    output_resource_name: ai-events-tfstate
  - provider: s3
    identifier: ai-ccx-integration-stage
    defaults: /terraform/resources/assisted-installer/s3-expire-now.yml
    output_resource_name: ai-ccx-integration
  - provider: aws-iam-role
    identifier: service-account-ai-ccx-stage
    assume_role:
      AWS:
      - arn:aws:iam::192448198553:user/ccx-reporting-pipeline
    inline_policy:
      {
        "Version": "2012-10-17",
        "Statement": [{
          "Effect": "Allow",
          "Action": [
            "s3:ListBucket",
            "s3:GetObject"
          ],
          "Resource": [
            "arn:aws:s3:::ai-ccx-integration-stage",
            "arn:aws:s3:::ai-ccx-integration-stage/*"
          ]
        }]
      }
    output_resource_name: service-account-ai-ccx
  - provider: msk
    identifier: assisted-installer-stage
    defaults: /terraform/resources/assisted-installer/msk-stage-1.yml
    output_resource_name: assisted-installer-msk
    users:
    - name: scram-assisted-service-stage
      secret:
        path: app-interface/assisted-installer/msk-credentials/stage/assisted-service
        field: all
        version: 1
    - name: scram-assisted-events-streams-stage
      secret:
        path: app-interface/assisted-installer/msk-credentials/stage/assisted-events-streams
        field: all
        version: 1
    - name: scram-assisted-service-integration
      secret:
        path: app-interface/assisted-installer/msk-credentials/integration/assisted-service
        field: all
        version: 1
    - name: scram-assisted-events-streams-integration
      secret:
        path: app-interface/assisted-installer/msk-credentials/integration/assisted-events-streams
        field: all
        version: 1

- provider: aws
  provisioner:
    $ref: /aws/app-sre/account.yml
  resources:
  - provider: s3
    identifier: assisted-installer-stage
    defaults: /terraform/resources/assisted-installer/s3-backup-1.yml
    output_resource_name: assisted-installer-s3
  - provider: s3
    identifier: assisted-installer-stage-public
    defaults: /terraform/resources/s3-public-read-1.yml
    bucket_policy:
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "PublicRead",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::assisted-installer-stage-public/*"
          }
        ]
      }
    output_resource_name: assisted-installer-public-s3
  - provider: rds
    identifier: assisted-installer-stage
    defaults: /terraform/resources/assisted-installer/rds-1.yml
    output_resource_name: assisted-installer-rds
    reset_password: APPSRE-4733
    overrides:
      multi_az: false
  - provider: elasticsearch
    identifier: ai-stage-es
    defaults: /terraform/resources/assisted-installer/elasticsearch-stage-1.yml
    output_resource_name: assisted-installer-elasticsearch

glitchtipProjects:
- $ref: /dependencies/glitchtip/projects/glitchtip-production/assisted-service-stage.yml
- $ref: /dependencies/glitchtip/projects/glitchtip-production/assisted-events-scrape-stage.yml
