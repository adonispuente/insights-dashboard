---
$schema: /app-sre/saas-file-2.yml

labels:
  service: assisted-installer

name: assisted-installer
description: 'SaaS tracking file for assisted-installer'

app:
  $ref: /services/assisted-installer/app.yml

pipelinesProvider:
  $ref: /services/assisted-installer/pipelines/tekton.assisted-installer-pipelines.app-sre-prod-01.yaml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: assisted-app-sre-ci

managedResourceTypes:
- Deployment
- Service
- ConfigMap

imagePatterns:
- quay.io/app-sre/bm-inventory
- quay.io/app-sre/assisted-service

resourceTemplates:
- name: assisted-service
  url: https://github.com/openshift/assisted-service
  path: /openshift/template.yaml
  parameters:
    BASE_DNS_DOMAINS: assistedinstaller.sysdeseng.com:Z0705901344NMKJYA5RNZ/route53
    # OCM_BASE_URL is defined at the environment parameters level
    SERVICE_BASE_URL: ${OCM_BASE_URL}
    # SSO_BASE_URL is defined at the environment parameters level
    JWKS_URL: ${SSO_BASE_URL}/protocol/openid-connect/certs
    ALLOWED_DOMAINS: https://qaprodauth.cloud.redhat.com,https://prod.foo.redhat.com:1337,https://console.stage.redhat.com
    AUTH_TYPE: rhsso
    SUPPORT_L2: true
    CHECK_CLUSTER_VERSION: true
    HW_VALIDATOR_REQUIREMENTS: |
      [{
          "version": "default",
          "master": {
            "cpu_cores": 4,
            "ram_mib": 16384,
            "disk_size_gb": 20,
            "installation_disk_speed_threshold_ms": 10,
            "network_latency_threshold_ms": 100,
            "packet_loss_percentage": 0
          },
          "worker": {
            "cpu_cores": 2,
            "ram_mib": 8192,
            "disk_size_gb": 20,
            "installation_disk_speed_threshold_ms": 10,
            "network_latency_threshold_ms": 1000,
            "packet_loss_percentage": 10
          },
          "sno": {
            "cpu_cores": 8,
            "ram_mib": 32768,
            "disk_size_gb": 20,
            "installation_disk_speed_threshold_ms": 10
          }
        }]
    IPV6_SUPPORT: false

  targets:
  - namespace:
      $ref: /services/assisted-installer/namespaces/assisted-installer-integration.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-ext/ci-ext.yml
      name: openshift-assisted-service-gh-build-master
    promotion:
      publish:
      - assisted-installer-integration-deploy-success-channel
    parameters:
      INSTALL_RH_CA: true
      INSTALLER_IMAGE: quay.io/ocpmetal/assisted-installer:latest
      CONTROLLER_IMAGE: quay.io/ocpmetal/assisted-installer-controller:latest
      AGENT_DOCKER_IMAGE: quay.io/ocpmetal/assisted-installer-agent:latest
      OPENSHIFT_INSTALL_RELEASE_IMAGE: ""
      PUBLIC_CONTAINER_REGISTRIES: quay.io,registry-proxy.engineering.redhat.com
      RELEASE_TAG: master
      REGISTRY_CREDS: qa@redhat.com:redhatqa
      OCM_LOG_LEVEL: info
      ADMIN_USERS: gamli75,yuvigold,ecohen+assistedinstaller,mfilanov-ai,alazar+penttest.rw@redhat.com
      WITH_AMS_SUBSCRIPTIONS: true
      ENABLE_AUTH: false
  - namespace:
      $ref: /services/assisted-installer/namespaces/assisted-installer-stage.yml
    ref: adf74fab8fa3235d3c90017d550c23d519d0389c
    promotion:
      publish:
      - assisted-installer-stage-deploy-success-channel
    parameters:
      INSTALL_RH_CA: true
      INSTALLER_IMAGE: registry-proxy.engineering.redhat.com/rh-osbs/openshift4-assisted-installer-rhel8:v1.0.0-72
      CONTROLLER_IMAGE: registry-proxy.engineering.redhat.com/rh-osbs/openshift4-assisted-installer-reporter-rhel8:v1.0.0-74
      AGENT_DOCKER_IMAGE: registry-proxy.engineering.redhat.com/rh-osbs/openshift4-assisted-installer-agent-rhel8:v1.0.0-51
      OPENSHIFT_INSTALL_RELEASE_IMAGE: ""
      PUBLIC_CONTAINER_REGISTRIES: quay.io,registry-proxy.engineering.redhat.com
      RELEASE_TAG: v1.0.23.2
      REGISTRY_CREDS: qa@redhat.com:redhatqa
      AGENT_TIMEOUT_START: 30m
      ADMIN_USERS: yuvigold,ecohen+assistedinstaller,mfilanov-ai,rregev@redhat.com,lgamliel,gamli75,alazar+penttest.rw@redhat.com
      WITH_AMS_SUBSCRIPTIONS: true
      ENABLE_AUTH: true
      ENABLE_DEREGISTER_INACTIVE_GC: 168h
  - namespace:
      $ref: /services/assisted-installer/namespaces/assisted-installer-production.yml
    ref: 4d2c2b6f3ae882e89d895b66041edd2c7cbb849e
    promotion:
      publish:
      - assisted-installer-production-deploy-success-channel
    parameters:
      HW_VALIDATOR_REQUIREMENTS: |
        [{
            "version": "default",
            "master": {
              "cpu_cores": 4,
              "ram_mib": 16384,
              "disk_size_gb": 120,
              "installation_disk_speed_threshold_ms": 10,
              "network_latency_threshold_ms": 100,
              "packet_loss_percentage": 0
            },
            "worker": {
              "cpu_cores": 2,
              "ram_mib": 8192,
              "disk_size_gb": 120,
              "installation_disk_speed_threshold_ms": 10,
              "network_latency_threshold_ms": 1000,
              "packet_loss_percentage": 10
            },
            "sno": {
              "cpu_cores": 8,
              "ram_mib": 32768,
              "disk_size_gb": 120,
              "installation_disk_speed_threshold_ms": 10
            }
          }]
      INSTALL_RH_CA: false
      BASE_DNS_DOMAINS: "" # Emphasize the fact that route53 is disabled on prod.
      ALLOWED_DOMAINS: https://cloud.redhat.com,https://console.redhat.com
      INSTALLER_IMAGE: registry.redhat.io/rhai-tech-preview/assisted-installer-rhel8:v1.0.0-57
      CONTROLLER_IMAGE: registry.redhat.io/rhai-tech-preview/assisted-installer-reporter-rhel8:v1.0.0-59
      AGENT_DOCKER_IMAGE: registry.redhat.io/rhai-tech-preview/assisted-installer-agent-rhel8:v1.0.0-42
      OPENSHIFT_INSTALL_RELEASE_IMAGE: ""
      PUBLIC_CONTAINER_REGISTRIES: quay.io
      OPENSHIFT_VERSIONS: '{"4.6":{"display_name":"4.6.16","release_version": "4.6.16","release_image":"quay.io/openshift-release-dev/ocp-release:4.6.16-x86_64","rhcos_image":"https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.6/4.6.8/rhcos-4.6.8-x86_64-live.x86_64.iso","rhcos_rootfs": "https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.6/4.6.8/rhcos-live-rootfs.x86_64.img","rhcos_version":"46.82.202012051820-0","support_level":"production"},"4.7":{"display_name":"4.7.18","release_version": "4.7.18","release_image":"quay.io/openshift-release-dev/ocp-release:4.7.18-x86_64","rhcos_image":"https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.7/4.7.13/rhcos-4.7.13-x86_64-live.x86_64.iso","rhcos_rootfs": "https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.7/4.7.13/rhcos-live-rootfs.x86_64.img","rhcos_version":"47.83.202105220305-0","support_level":"production","default":true},"4.8":{"display_name":"4.8.0-rc.3","release_version": "4.8.0-rc.3","release_image":"quay.io/openshift-release-dev/ocp-release:4.8.0-rc.3-x86_64","rhcos_image":"https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/pre-release/4.8.0-rc.3/rhcos-4.8.0-rc.3-x86_64-live.x86_64.iso","rhcos_rootfs": "https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/pre-release/4.8.0-rc.3/rhcos-live-rootfs.x86_64.img","rhcos_version":"48.84.202107040900-0","support_level":"beta"}}'
      RELEASE_TAG: v1.0.22.4
      REGISTRY_CREDS: ""
      AGENT_TIMEOUT_START: 30m
      ADMIN_USERS: yuvigold,ecohen+assistedinstaller,mfilanov-ai,lgamliel+assistedinstaller, slavie+assistedinstaller,gamli75,alazar+penttest.rw@redhat.com
      WITH_AMS_SUBSCRIPTIONS: true
      ENABLE_AUTH: true
      DISABLED_HOST_VALIDATIONS: sufficient-network-latency-requirement-for-role,sufficient-packet-loss-requirement-for-role
      IMAGE_BUILDER: quay.io/app-sre/assisted-iso-create  # Deprecated
