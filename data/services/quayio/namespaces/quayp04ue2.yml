---
$schema: /openshift/namespace-1.yml

labels:
  service: quayio

name: quay
description: prod namespace for quayio

cluster:
  $ref: /openshift/quayp04ue2/cluster.yml

app:
  $ref: /services/quayio/app.yml

environment:
  $ref: /products/quay/environments/production-standby.yml

networkPoliciesAllow:
- $ref: /services/observability/namespaces/openshift-customer-monitoring.quayp04ue2.yml

managedRoles: true

managedResourceTypes:
- NetworkPolicy
- Secret

openshiftResources:
- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-secret-readonly
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: true
    standby: true
    log_producer: kinesis_stream
    enable_redis_modelcache: false
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: false
    enable_builders: false

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-py3-config-secret-readonly
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: true
    standby: true
    log_producer: kinesis_stream
    enable_redis_modelcache: false
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: false
    enable_builders: false

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-db-config.secret.yaml
  variables:
    standby: true
    additional_config_vault_secret_version: 2
- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-db-config-gabi.secret.yaml
  variables:
    additional_config_vault_secret_version: 2
- provider: vault-secret
  path: app-interface/quayio-prod-us-east-2/quay/quay-extra-ca-certs
  version: 1
- provider: vault-secret
  path: app-interface/quayio-prod-us-east-2/quay/quay-cloudwatch-iam-user
  version: 2
# ECR image pull secret
- provider: vault-secret
  path: app-sre/integrations-output/aws-ecr-image-pull-secrets/quayio-prod/eu-central-1/dockercfg
  version: 1
  type: kubernetes.io/dockerconfigjson
  name: quayio-backup-image-pull-secret
  annotations:
    qontract.ignore_reconcile_time: "true"
- provider: resource
  path: /quay-p/quay/quay.web-allow-external.networkpolicy.yaml
- provider: resource
  path: /quay-p/quay/quay-py3.web-allow-external.networkpolicy.yaml


managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/quayio-prod/account.yml
  resources:
  - provider: rds
    identifier: quayio-production-57-py3-replica
    availability_zone: us-east-2a
    defaults: /terraform/resources/quayio-production/rds-read-replica-us-east-2.yml
    parameter_group: /terraform/resources/quayio-production/rds-parameter-group-read-replica-1.yml
    replica_source: quayio-production-py3
    overrides:
      apply_immediately: true
  - provider: s3-cloudfront
    identifier: quayio-production-s3-backup
    region: us-east-2
    storage_class: intelligent_tiering
    defaults: /terraform/resources/quayio-production/s3-cloudfront-us-east-2-replication.yml
    output_resource_name: quayio-s3-backup
  - provider: kms
    identifier: quayio-prod-replica
    region: us-east-2
    defaults: /terraform/resources/quayio-production/kms-1.yml
    output_resource_name: quayio-kms
  - provider: kinesis
    region: us-east-2
    identifier: quay-prod-logentry-stream-backup
    defaults: /terraform/resources/quayio-production/kinesis-2.yml
    output_resource_name: quayio-kinesis
    es_identifier: quayio-prod-es-backup
  - provider: elasticache
    region: us-east-2
    identifier: quayio-production-standby
    defaults: /terraform/resources/quayio-production/elasticache-standby-1.yml
    parameter_group: /terraform/resources/quayio-production/elasticache-parameter-group-1.yml
  - provider: acm
    identifier: wildcard-prod-quay-redhat-io-ue2
    region: us-east-2
    domain:
      domain_name: '*.quay.io'
      alternate_names:
      - '*.quay.redhat.io'
      - 'quay.io'
  - provider: acm
    identifier: wildcard-quayio-ue2-1
    region: us-east-2
    domain:
      domain_name: '*.quay.io'
      alternate_names:
      - 'quay.io'
      - '*.quay.redhat.io'
      - '*.q1w2.quay.rhcloud.com'
  - provider: alb
    identifier: quayio-production-alb02
    output_resource_name: quayio-production-alb
    idle_timeout: 3600
    ip_address_type: dualstack
    vpc:
      $ref: /aws/quayio-prod/vpcs/quayio-prod.yml # VPC in us-east-2
    certificate_arn: arn:aws:acm:us-east-2:206170669542:certificate/1ccddcb2-62c1-477c-9c3c-fe67ea028a33
    ingress_cidr_blocks: ["0.0.0.0/0"]
    targets:
    - name: quayio-production-py2
      default: false
      openshift_service: quay-load-balancer-service
    - name: quayio-production-py3
      default: true
      openshift_service: quay-py3-load-balancer-service
    rules: []
  ##############################
  # BEGIN: quayio-ocm-quay-ue2 #
  ##############################
  - provider: alb
    identifier: quayio-ocm-quay-ue2
    idle_timeout: 3600
    ip_address_type: dualstack
    vpc:
      $ref: /aws/quayio-prod/vpcs/quayio-prod.yml # VPC in us-east-2
    certificate_arn: arn:aws:acm:us-east-2:206170669542:certificate/239519f2-2814-41d8-8604-b3c1dc9b519a
    ingress_cidr_blocks: ["0.0.0.0/0"]
    targets:
    - name: quayio-production-py2
      default: false
      openshift_service: quay-load-balancer-service
    - name: quayio-production-py3
      default: true
      openshift_service: quay-py3-load-balancer-service
    rules:
    - condition:
      - type: host-header
        host_header:
        - 'pull.q1w2.quay.rhcloud.com'
      - type: path-pattern
        path_pattern:
        - '/v2'
        - '/v2/'
        - '/v2/auth*'
        - '/v2/openshift-release-dev/*'
      action:
        type: forward
        forward:
          target_group:
          - target: quayio-production-py3
            weight: 100
          # Second target needed due to a bug in the terraform provider. Set with weight of 0 to avoid traffic being sent to it.
          # https://github.com/app-sre/qontract-schemas/blob/14a4747aa72ec931a4e9a025a4e3ea487ce82f60/schemas/aws/terraform-resource-2.yml#L1141
          - target: quayio-production-py2
            weight: 0
    - condition:
      - type: host-header
        host_header:
        - 'pull.q1w2.quay.rhcloud.com'
      action:
        type: fixed-response
        fixed_response:
          status_code: 401
          content_type: application/json
          message_body: '{"errors":[{"code":"UNAUTHORIZED","detail":{},"message":"access to the requested resource is not authorized"}]}'
  ####################################
  # END: quayio-stage-ocm-quay stage #
  ####################################
