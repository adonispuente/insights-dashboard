---
$schema: /openshift/namespace-1.yml

labels:
  service: quayio

name: quay
description: prod namespace for quayio

cluster:
  $ref: /openshift/quayp05ue1/cluster.yml

app:
  $ref: /services/quayio/app.yml

environment:
  $ref: /products/quay/environments/production.yml

networkPoliciesAllow:
- $ref: /services/observability/namespaces/openshift-customer-monitoring.quayp05ue1.yml

managedRoles: true

sharedResources:
- $ref: /services/app-sre/shared-resources/quayio-pull-secret.yml

managedResourceTypes:
- NetworkPolicy
- Secret
- ServiceAccount

openshiftResources:
- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: false
    name: quay-config-secret-readonly
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: true
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: true

- provider: resource-template
  path: /services/common/serviceaccount.yaml
  variables:
    name: quay-db-jobs-sa

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-secret
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: true
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: false

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-py3-config-secret
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: false
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: true

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-secret-blue
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: false
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: true

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-recovery-secret
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: false
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: false
    account_recovery_mode: true
    read_from_rds_replica: false
    enable_clair: false
    enable_builders: false

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-config.secret.yaml
  variables:
    recycle: true
    name: quay-config-secret-readonly-replica
    config_vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: true
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: true
    account_recovery_mode: false
    read_from_rds_replica: true
    enable_clair: true
    enable_builders: true

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-clair-backfill-config.secret.yaml
  variables:
    recycle: true
    name: quay-clair-backfill-config-secret
    vault_secret_version: 37
    additional_config_vault_secret_version: 2
    version_label: v37
    readonly: false
    standby: false
    log_producer: kinesis_stream
    enable_redis_modelcache: false
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_clair: true
    enable_builders: false

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-service-tool-config.secret.yaml
  variables:
    name: quay-service-tool-config
    vault_secret_version: 2
    db_jobs_vault_secret_version: 1
    additional_config_vault_secret_version: 2

- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-db-config.secret.yaml
  variables:
    standby: false
    additional_config_vault_secret_version: 2
- provider: vault-secret
  path: app-interface/quayio-prod-us-east-1/quay/quay-extra-ca-certs
  version: 1
- provider: vault-secret
  path: app-interface/quayio-prod-us-east-1/quay/quay-cloudwatch-iam-user
  version: 2
# ECR image pull secret
- provider: vault-secret
  path: app-sre/integrations-output/aws-ecr-image-pull-secrets/quayio-prod/eu-central-1/dockercfg
  version: 1
  type: kubernetes.io/dockerconfigjson
  name: quayio-backup-image-pull-secret
  annotations:
    qontract.ignore_reconcile_time: "true"
- provider: resource
  path: /quay-p/quay/quay.web-allow-external.networkpolicy.yaml
- provider: resource
  path: /quay-p/quay/quay-recovery.web-allow-external.networkpolicy.yaml
- provider: resource
  path: /quay-p/quay/quay-py3.web-allow-external.networkpolicy.yaml
- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-db-jobs-config.secret.yaml
  variables:
    name: quay-db-jobs-prod-config
    vault_secret_version: 1
- provider: route
  path: /quay-p/quay/quay-service-tool.route.yaml
- provider: resource-template
  type: extracurlyjinja2
  path: /quay-p/quay/quay-osa-analytics-job.secret.yaml
  variables:
    name: quayio-osa-analytics-job-config


managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/quayio-prod/account.yml
  resources:
  - provider: rds
    identifier: quayio-production-py3
    availability_zone: us-east-1a
    defaults: /terraform/resources/quayio-production/rds-1.yml
    parameter_group: /terraform/resources/quayio-production/rds-parameter-group-readwrite-replica-1.yml
    overrides:
      apply_immediately: true
  - provider: elasticache
    identifier: quayio-production
    defaults: /terraform/resources/quayio-production/elasticache-1.yml
    parameter_group: /terraform/resources/quayio-production/elasticache-parameter-group-1.yml
    output_resource_name: quayio-elasticache
  - provider: elasticache
    identifier: quayio-production-builders
    defaults: /terraform/resources/quayio-production/elasticache-builders-1.yml
    parameter_group: /terraform/resources/quayio-production/elasticache-builders-parameter-group-1.yml
  - provider: elasticache
    identifier: quayio-production-modelcache
    defaults: /terraform/resources/quayio-production/elasticache-modelcache-1.yml
    parameter_group: /terraform/resources/quayio-production/elasticache-modelcache-parameter-group-1.yml
    output_resource_name: quayio-production-modelcache
  - provider: s3-cloudfront
    identifier: quayio-production-s3
    storage_class: intelligent_tiering
    defaults: /terraform/resources/quayio-production/s3-cloudfront-us-east-1.yml
    output_resource_name: quayio-s3
  - provider: s3
    identifier: quayio-cloudfront-logs
    defaults: /terraform/resources/s3-all-expires-90-days-external-acl.yml
    output_resource_name: quayio-cloudfront-logs
  - provider: aws-iam-role
    identifier: emr-cloudfront-prod-logs-access-role
    assume_role:
      AWS:
      - arn:aws:iam::942491940283:role/EMR_EC2_DefaultRole
    inline_policy:
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "accessbucket",
            "Effect": "Allow",
            "Action": [
              "s3:GetObject*",
              "s3:GetObject",
              "s3:List*"
            ],
            "Resource": [
              "arn:aws:s3:::quayio-cloudfront-logs",
              "arn:aws:s3:::quayio-cloudfront-logs/*"
            ]
          }
        ]
      }
  - provider: aws-iam-role
    identifier: athena-cloudfront-prod-logs-access-role
    inline_policy:
      {
        "Version": "2012-10-17",
        "Id": "CloudFrontLogsAthenaS3Access",
        "Principal": {
          "AWS": "arn:aws:iam::942491940283:root"
        },
        "Statement": [
          {
            "Sid": "accessbucket",
            "Effect": "Allow",
            "Action": [
              "s3:GetBucketLocation",
              "s3:GetObject",
              "s3:ListBucket",
              "s3:ListBucketMultipartUploads",
              "s3:ListMultipartUploadParts",
              "s3:AbortMultipartUpload"
            ],
            "Resource": [
              "arn:aws:s3:::quayio-cloudfront-logs",
              "arn:aws:s3:::quayio-cloudfront-logs/*"
            ]
          }
        ]
      }
  - provider: ecr
    region: eu-central-1
    identifier: quayio-backup
    output_resource_name: quayio-backup
  - provider: ecr
    region: eu-central-1
    identifier: quayio-py3-backup
    output_resource_name: quayio-py3-backup
  - provider: ecr
    region: eu-central-1
    identifier: syslog-cloudwatch-bridge-backup
    output_resource_name: syslog-cloudwatch-bridge-backup
  - provider: ecr
    region: eu-central-1
    identifier: quayio-frontend-backup
    output_resource_name: quayio-frontend-backup
  - provider: kinesis
    identifier: quay-prod-logentry-stream
    defaults: /terraform/resources/quayio-production/kinesis-1.yml
    output_resource_name: quayio-kinesis
    es_identifier: quayio-prod-elasticsearch
# used in the quay-config secret HEALTH_CHECKER
  - provider: aws-iam-service-account
    identifier: quay-db-monitor
    policies:
    - AmazonRDSReadOnlyAccess
    output_resource_name: quay-db-monitor
  - provider: ecr
    region: eu-central-1
    identifier: quayio-update-py2-db-backup
    output_resource_name: quayio-update-py2-db-backup
  - provider: rds
    identifier: clair-backfiller
    defaults: /terraform/resources/quayio-production/rds-1.yml
    overrides:
      snapshot_identifier: rds:quayio-production-py3-2021-11-16-04-13
      instance_class: db.r4.4xlarge
      backup_retention_period: 0
      timeouts:
        create: 2h
    parameter_group: /terraform/resources/quayio-production/rds-parameter-group-1.yml
    output_resource_name: clair-backfiller
    enhanced_monitoring: true
  - provider: acm
    identifier: wildcard-prod-quay-redhat-io
    domain:
      domain_name: '*.quay.io'
      alternate_names:
      - '*.quay.redhat.io'
      - 'quay.io'
  - provider: acm
    identifier: wildcard-quayio-1
    domain:
      domain_name: '*.quay.io'
      alternate_names:
      - 'quay.io'
      - '*.quay.redhat.io'
      - '*.q1w2.quay.rhcloud.com'
  - provider: alb
    identifier: quayio-production-alb01
    output_resource_name: quayio-production-alb
    idle_timeout: 3600
    ip_address_type: dualstack
    vpc:
      $ref: /aws/quayio-prod/vpcs/QuayVPC.yml
    certificate_arn: arn:aws:acm:us-east-1:206170669542:certificate/8a4a9a8b-d06b-46f6-a234-e7ef2ec657cf
    ingress_cidr_blocks: ["0.0.0.0/0"]
    targets:
    - name: quayio-production-py2
      default: false
      openshift_service: quay-load-balancer-service
    - name: quayio-production-py3
      default: true
      openshift_service: quay-py3-load-balancer-service
    rules: []
  - provider: alb
    identifier: quayio-production-alb01-grpc
    output_resource_name: quayio-production-alb-grpc
    idle_timeout: 3600
    ip_address_type: dualstack
    vpc:
      $ref: /aws/quayio-prod/vpcs/QuayVPC.yml
    certificate_arn: arn:aws:acm:us-east-1:206170669542:certificate/8a4a9a8b-d06b-46f6-a234-e7ef2ec657cf
    ingress_cidr_blocks: ["0.0.0.0/0"]
    targets:
    - name: quayio-py3-grpc
      default: true
      openshift_service: quay-py3-grpc-load-balancer-service
      protocol: "HTTPS"
      protocol_version: "GRPC"
    rules: []
  - provider: alb
    identifier: quayio-production-alb01-recovery
    output_resource_name: quayio-alb-recovery
    idle_timeout: 3600
    ip_address_type: dualstack
    vpc:
      $ref: /aws/quayio-prod/vpcs/QuayVPC.yml
    certificate_arn: arn:aws:acm:us-east-1:206170669542:certificate/8a4a9a8b-d06b-46f6-a234-e7ef2ec657cf
    ingress_cidr_blocks: ["0.0.0.0/0"]
    targets:
    - name: quayio-prod-recovery
      default: true
      openshift_service: quay-py3-recovery-load-balancer-service
    rules: []
  ##########################
  # BEGIN: quayio-ocm-quay #
  ##########################
  - provider: alb
    identifier: quayio-ocm-quay
    idle_timeout: 3600
    ip_address_type: dualstack
    vpc:
      $ref: /aws/quayio-prod/vpcs/QuayVPC.yml
    certificate_arn: arn:aws:acm:us-east-1:206170669542:certificate/940d5156-efe4-4fb0-8466-94af41dffcfc
    ingress_cidr_blocks: ["0.0.0.0/0"]
    targets:
    - name: quayio-production-py2
      default: false
      openshift_service: quay-load-balancer-service
    - name: quayio-production-py3
      default: true
      openshift_service: quay-py3-load-balancer-service
    rules:
    - condition:
      - type: host-header
        host_header:
        - 'pull.q1w2.quay.rhcloud.com'
      - type: path-pattern
        path_pattern:
        - '/v2'
        - '/v2/'
        - '/v2/auth*'
        - '/v2/openshift-release-dev/*'
      action:
        type: forward
        forward:
          target_group:
          - target: quayio-production-py3
            weight: 100
          # Second target needed due to a bug in the terraform provider. Set with weight of 0 to avoid traffic being sent to it.
          # https://github.com/app-sre/qontract-schemas/blob/14a4747aa72ec931a4e9a025a4e3ea487ce82f60/schemas/aws/terraform-resource-2.yml#L1141
          - target: quayio-production-py2
            weight: 0
    - condition:
      - type: host-header
        host_header:
        - 'pull.q1w2.quay.rhcloud.com'
      action:
        type: fixed-response
        fixed_response:
          status_code: 401
          content_type: application/json
          message_body: '{"errors":[{"code":"UNAUTHORIZED","detail":{},"message":"access to the requested resource is not authorized"}]}'
  ####################################
  # END: quayio-stage-ocm-quay stage #
  ####################################

- provider: cloudflare
  provisioner:
    $ref: /cloudflare/quay-prod/account.yml
  resources:
    - provider: zone
      identifier: quayio-production
      zone: quay.io
      plan: enterprise
      type: partial
      cache_reserve:
        enabled: on
      argo:
        smart_routing: true
      settings:
        always_use_https: 'on'
        min_tls_version: '1.2'
        security_level: 'off'
        browser_check: 'off'
      records:
        - identifier: cdn03
          name: cdn03
          type: CNAME
          ttl: 1
          # Dummy value, should be overriden by workers
          value: dummycdn.quay.io
          proxied: true
      workers:
        - identifier: quay-cloudflare-worker
          pattern: cdn03.quay.io/*
          script_name: quay-cloudflare-worker
      certificates:
        - identifier: quayio-production
          type: advanced
          certificate_authority: lets_encrypt
          hosts:
            - quay.io
            - cdn03.quay.io
          validation_method: txt
          validity_days: 90
    - provider: worker_script
      identifier: quay-cloudflare-worker
      name: quay-cloudflare-worker
      content_from_github:
        repo: https://github.com/quay/quay-cloudflare-cdn-worker
        path: index.js
        ref: 6e2344162bc56210e501482546b7b1e3ba3bdf75
      vars:
        - name: QUAY_PRIMARY_REGION
          text: us-east-1
        - name: QUAY_PRIMARY_S3_BUCKET
          text: quayio-production-s3
        - name: QUAY_SECONDARY_REGION
          text: us-east-2
        - name: QUAY_SECONDARY_S3_BUCKET
          text: quayio-production-s3-backup
        - name: CACHE_TTL
          text: "86400"
        - name: CLOUDFLARE_PUBLIC_KEY
          text: |-
            -----BEGIN PUBLIC KEY-----
            MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAzDlPXS12Mu28V7iArKQU
            MN6KD4ErNHBldtg/cqVuzq0R0SiG+BeZKLfwU2ZP4QyFmIYQVogujZRueIpG8Bg3
            yRVdSlvdPa5WhcApjWgeWBN6E8s+ZnrmBszWSxWJjCQ2reTb2pmBFQos3+ehKowa
            1b2cGHVbiMNCqNXw1ENjNbMxpuy0y9NVlVfEGyb3WCKb40JHw2kZiJc5rF6SIr56
            Q/xS3iqgJfD4j8fRkfRoyqujzsxDDxdFv6DlUD3iN0tiADzcUI1u8Q8X13IZtoNS
            lOrreb/R2LAmYu9Dr2ZZQ7ap3U9V4Boc8O4JxdIe52VmU1bL+MX2n6ATyDCwDWuw
            uwIDAQAB
            -----END PUBLIC KEY-----
