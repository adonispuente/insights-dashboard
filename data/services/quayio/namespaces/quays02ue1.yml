---
$schema: /openshift/namespace-1.yml

labels:
  service: quayio

name: quay
description: stage namespace for quayio

cluster:
  $ref: /openshift/quays02ue1/cluster.yml

app:
  $ref: /services/quayio/app.yml

environment:
  $ref: /products/quay/environments/stage.yml

networkPoliciesAllow:
- $ref: /services/observability/namespaces/openshift-customer-monitoring.quays02ue1.yml

managedRoles: true

sharedResources:
- $ref: /services/app-sre/shared-resources/quayio-pull-secret.yml

managedResourceTypes:
- ConfigMap
- NetworkPolicy
- Secret
- ServiceAccount

openshiftResources:
- provider: vault-secret
  path: app-interface/quayio-stage/quayio-stage/quay-pull-secret
  version: 1
  type: kubernetes.io/dockerconfigjson
# ECR image pull secret
- provider: vault-secret
  path: app-sre/integrations-output/aws-ecr-image-pull-secrets/quayio-prod/eu-central-1/dockercfg
  version: 1
  type: kubernetes.io/dockerconfigjson
  name: quayio-backup-image-pull-secret
  annotations:
    qontract.ignore_reconcile_time: "true"

- provider: resource-template
  path: /services/common/serviceaccount.yaml
  variables:
    name: quay-db-jobs-sa

- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-config.secret.yaml
  variables:
    name: quay-config-secret-readonly-replica
    vault_secret_version: 62
    version_label: v62
    enable_redis_modelcache: true
    readonly: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_builders: false
    enable_clair: false
    region: us-east-1
    log_producer: kinesis_stream

- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-config.secret.yaml
  variables:
    name: quay-config-secret-readonly
    vault_secret_version: 62
    version_label: v62
    enable_redis_modelcache: true
    readonly: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_builders: false
    enable_clair: false
    region: us-east-1
    log_producer: kinesis_stream

- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-config.secret.yaml
  variables:
    name: quay-config-secret
    vault_secret_version: 62
    version_label: v62
    enable_redis_modelcache: true
    readonly: true
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_builders: true
    enable_clair: false
    region: us-east-1
    log_producer: kinesis_stream

- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-config.secret.yaml
  variables:
    name: quay-py3-config-secret
    vault_secret_version: 62
    version_label: v62
    enable_redis_modelcache: true
    readonly: false
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_builders: true
    enable_clair: true
    region: us-east-1
    log_producer: kinesis_stream


- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-config.secret.yaml
  variables:
    name: quay-config-secret-blue
    vault_secret_version: 62
    version_label: v62
    enable_redis_modelcache: true
    readonly: false
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_builders: true
    enable_clair: false
    region: us-east-1
    log_producer: kinesis_stream

- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-config.secret.yaml
  variables:
    name: quay-config-secret-v62
    vault_secret_version: 62
    version_label: v62
    enable_redis_modelcache: true
    readonly: false
    account_recovery_mode: false
    read_from_rds_replica: false
    enable_builders: true
    enable_clair: false
    region: us-east-1
    log_producer: kinesis_stream

- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-config.secret.yaml
  variables:
    name: quay-config-recovery-secret
    vault_secret_version: 62
    version_label: v62
    account_recovery_mode: true
    enable_redis_modelcache: false
    readonly: false
    read_from_rds_replica: false
    enable_builders: false
    enable_clair: false
    region: us-east-1
    log_producer: kinesis_stream

- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-service-tool-config.secret.yaml
  variables:
    name: quay-service-tool-config
    vault_secret_version: 11
    db_jobs_vault_secret_version: 1
- provider: resource
  path: /quayio-stage/quay/quay-envoy-proxy-config.configmap.yaml
- provider: vault-secret
  path: app-interface/quayio-stage/quayio-stage/quay-cloudwatch-iam-user
  version: 1
  annotations:
    qontract.recycle: "true"
    qontract.ignore_reconcile_time: "true"
- provider: resource
  path: /quayio-stage/quay/quay.web-allow-external.networkpolicy.yaml
- provider: resource
  path: /quayio-stage/quay/quay-py3.web-allow-external.networkpolicy.yaml
- provider: resource
  path: /quayio-stage/quay/quay-recovery.web-allow-external.networkpolicy.yaml
- provider: route
  path: /quayio-stage/quay/quay-service-tool.route.yaml
  vault_tls_secret_path: app-interface/quayio-stage/quayio-stage/routes/quay-service-tool
  vault_tls_secret_version: 4

- provider: resource-template
  type: extracurlyjinja2
  path: /quayio-stage/quay/quay-db-jobs-config.secret.yaml
  variables:
    name: quay-db-jobs-config
    vault_secret_version: 1

managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/quayio-stage/account.yml
  resources:
  - provider: acm
    identifier: wildcard-stage-quay-io
    domain:
      domain_name: '*.stage.quay.io'
      alternate_names:
      - 'stage.quay.io'
  - provider: acm
    identifier: wildcard-stage-quay-redhat-io
    domain:
      domain_name: '*.stage.quay.io'
      alternate_names:
      - '*.stage.quay.redhat.io'
      - 'stage.quay.io'
      - 'stage.quay.redhat.io'
  - provider: rds
    identifier: quayio-stage-57-py3
    availability_zone: us-east-1a
    defaults: /terraform/resources/quayio-stage/rds-1.yml
    parameter_group: /terraform/resources/quayio-stage/rds-parameter-group-readwrite-replica-1.yml
    overrides:
      apply_immediately: true
  - provider: rds
    identifier: quayio-stage-57-py3-replica-2
    availability_zone: us-east-1a
    defaults: /terraform/resources/quayio-stage/rds-read-replica-us-east-1.yml
    replica_source: quayio-stage-57-py3
    parameter_group: /terraform/resources/quayio-stage/rds-parameter-group-1.yml
  - provider: elasticache
    identifier: quayio-stage
    defaults: /terraform/resources/quayio-stage/elasticache-1.yml
    parameter_group: /terraform/resources/quayio-stage/elasticache-parameter-group-1.yml
  - provider: elasticache
    identifier: quayio-stage-builders
    defaults: /terraform/resources/quayio-stage/elasticache-builders-1.yml
    parameter_group: /terraform/resources/quayio-stage/elasticache-builders-parameter-group-1.yml
  - provider: elasticache
    identifier: quayio-stage-modelcache
    defaults: /terraform/resources/quayio-stage/elasticache-modelcache-1.yml
    parameter_group: /terraform/resources/quayio-stage/elasticache-modelcache-parameter-group-1.yml
  # - provider: rds
  #   identifier: quayio-dev
  #   defaults: /terraform/resources/quayio-stage/rds-2.yml
  # - provider: elasticache
  #   identifier: quayio-dev
  #   defaults: /terraform/resources/quayio-stage/elasticache-2.yml
  #   parameter_group: /terraform/resources/quayio-stage/elasticache-parameter-group-2.yml
  # Quay S3 bucket and CloudFront distribution for us-east-1
  - provider: s3-cloudfront
    identifier: quayio-stage-s3
    defaults: /terraform/resources/quayio-stage/s3-cloudfront-us-east-1.yml
    storage_class: intelligent_tiering
    output_resource_name: quayio-s3
  # Quay S3 bucket and CloudFront distribution for us-east-2
  - provider: s3-cloudfront
    identifier: quayio-stage-s3-backup
    region: us-east-2
    storage_class: onezone_ia
    defaults: /terraform/resources/quayio-stage/s3-cloudfront-us-east-2.yml
    output_resource_name: quayio-s3-backup
  - provider: kms
    identifier: quayio-stage-replica
    region: us-east-2
    defaults: /terraform/resources/quayio-stage/kms-1.yml
    output_resource_name: quayio-kms
  - provider: alb
    identifier: quayio-stage-alb01
    output_resource_name: quayio-alb
    idle_timeout: 3600
    ip_address_type: dualstack
    vpc:
      $ref: /aws/quayio-stage/vpcs/default.yml
    certificate_arn: arn:aws:acm:us-east-1:019044362261:certificate/8e2e34fa-7227-4561-9d7d-d364871f4352
    ingress_cidr_blocks: ["0.0.0.0/0"]
    targets:
    - name: quayio-stage-py3
      default: true
      openshift_service: quay-py3-load-balancer-service
    - name: quayio-stage-debug
      default: false
      openshift_service: quay-py3-cloudflare-debug-load-balancer-service
    rules:
    - condition:
      - type: path-pattern
        path_pattern:
        - /v2/bcaton/push-pull-monitor-debug/*
      action:
        type: forward
        forward:
          target_group:
          - target: quayio-stage-py3
            weight: 0
          - target: quayio-stage-debug
            weight: 100
  - provider: s3
    identifier: quayio-stage-cloudfront-logs
    defaults: /terraform/resources/s3-all-expires-90-days-external-acl.yml
    output_resource_name: quayio-stage-cloudfront-logs
  - provider: aws-iam-role
    identifier: emr-cloudfront-logs-access-role
    assume_role:
      AWS:
      - arn:aws:iam::942491940283:role/EMR_EC2_DefaultRole
    inline_policy:
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "accessbucket",
            "Effect": "Allow",
            "Action": [
              "s3:GetObject*",
              "s3:GetObject",
              "s3:List*"
            ],
            "Resource": [
              "arn:aws:s3:::quayio-stage-cloudfront-logs",
              "arn:aws:s3:::quayio-stage-cloudfront-logs/*"
            ]
          }
        ]
      }
  - provider: cloudwatch
    identifier: quay-service-tool-stage-audit
    defaults: /terraform/resources/quayio-stage/service-tool-cloudwatch-1.yml
    output_resource_name: quay-service-tool-stage-audit-cloudwatch
  - provider: kinesis
    identifier: quay-stage-logentry-stream
    defaults: /terraform/resources/quayio-stage/kinesis-1.yml
    output_resource_name: quayio-stage-logentry-stream
    es_identifier: quayio-stage-elasticsearch
  ######################################
  # BEGIN: quayio-stage-ocm-quay stage #
  ######################################
  - provider: acm
    identifier: quayio-stage-ocm-quay
    region: us-east-1
    domain:
      domain_name: '*.stage.q1w2.quay.rhcloud.com'
  - provider: alb
    identifier: quayio-stage-ocm-quay
    output_resource_name: quayio-stage-ocm-quay
    idle_timeout: 3600
    ip_address_type: dualstack
    vpc:
      $ref: /aws/quayio-stage/vpcs/default.yml
    certificate_arn: arn:aws:acm:us-east-1:019044362261:certificate/aa509131-4bed-4b14-88f8-4826d1f57238
    ingress_cidr_blocks: ["0.0.0.0/0"]
    targets:
    - name: quayio-stage-py3
      default: true
      openshift_service: quay-py3-load-balancer-service
    - name: quayio-stage-debug
      default: false
      openshift_service: quay-py3-cloudflare-debug-load-balancer-service
    rules:
    - condition:
      - type: host-header
        host_header:
        - 'pull.stage.q1w2.quay.devshift.net'
      - type: path-pattern
        path_pattern:
        - '/v2'
        - '/v2/'
        - '/v2/auth*'
        - '/v2/openshift-release-dev/*'
      action:
        type: forward
        forward:
          target_group:
          - target: quayio-stage-py3
            weight: 100
          - target: quayio-stage-debug
            weight: 0
    - condition:
      - type: host-header
        host_header:
        - 'pull.stage.q1w2.quay.devshift.net'
      action:
        type: fixed-response
        fixed_response:
          status_code: 401
          content_type: application/json
          message_body: '{"errors":[{"code":"UNAUTHORIZED","detail":{},"message":"access to the requested resource is not authorized"}]}'
  ####################################
  # END: quayio-stage-ocm-quay stage #
  ####################################

- provider: cloudflare
  provisioner:
    $ref: /cloudflare/quay-stage/account.yml
  resources:
    - provider: zone
      identifier: quayio-stage
      zone: stage.quay.io
      plan: enterprise
      type: partial
      cache_reserve:
        enabled: on
      argo:
        smart_routing: true
        tiered_caching: true
      tiered_cache:
        cache_type: 'smart'
      settings:
        always_use_https: 'on'
        min_tls_version: '1.2'
        security_level: 'off'
        browser_check: 'off'
      records:
        - identifier: cdn03
          name: cdn03
          type: CNAME
          ttl: 1
          # Dummy value, should be overriden by workers
          value: dummycdn.stage.quay.io
          proxied: true
      workers:
        - identifier: quay-cloudflare-worker
          pattern: cdn03.stage.quay.io/*
          script_name: quay-cloudflare-worker
      certificates:
        - identifier: quayio-stage
          type: advanced
          certificate_authority: lets_encrypt
          hosts:
            - stage.quay.io
            - cdn03.stage.quay.io
          validation_method: txt
          validity_days: 90
    - provider: worker_script
      identifier: quay-cloudflare-worker
      name: quay-cloudflare-worker
      content_from_github:
        repo: https://github.com/quay/quay-cloudflare-cdn-worker
        path: index.js
        ref: 6e2344162bc56210e501482546b7b1e3ba3bdf75
      vars:
        - name: QUAY_PRIMARY_REGION
          text: us-east-1
        - name: QUAY_PRIMARY_S3_BUCKET
          text: quayio-stage-s3
        - name: QUAY_SECONDARY_REGION
          text: us-east-1
        - name: QUAY_SECONDARY_S3_BUCKET
          text: quayio-stage-s3
        - name: CACHE_TTL
          text: "43200" # 12 hours (needed for cache reserve to work)
        - name: CLOUDFLARE_PUBLIC_KEY
          text: |-
            -----BEGIN PUBLIC KEY-----
            MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAt0SG2ZRol55hL8DzyPBS
            a/dgS7xKTYN9TTpEjZUxjlAexqwHnTLRHsScwLVcAfn74UDNT9LKfel1ZDRY1pr8
            aCw/NOL61nzaHIdmtotWh/U2eDn9cLt0c2bSB3AAZJZLUQRvICO/jcl0efZpt8TL
            ZnT8hGpsOrWnu5RWgXbXe2/KrpTzsmS12VKAdvcAVki2o0L8N7NvcHS7SREpV6ar
            KvKu1wZ0DDDnPaFihqNbBkZIDOUPdMka9AJEwas2jvtUuuUyv8bEvyOEhCyCEwqm
            qFc4G5TXqPEguI+IcNe7HJiLll7+0VK/0LYbyhWKMXM4Xy94kfXW4cNo15V2qgvU
            TwIDAQAB
            -----END PUBLIC KEY-----
