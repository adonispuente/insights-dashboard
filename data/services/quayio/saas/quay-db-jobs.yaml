---
$schema: /app-sre/saas-file-2.yml

labels:
  service: quayio

name: quay-db-jobs
description: Various db tasks previously done by directly in DB, such as enabling/disabling users.

app:
  $ref: /services/quayio/app.yml

pipelinesProvider:
  $ref: /services/quayio/pipelines/tekton.quayio-pipelines.appsrep05ue1.yaml

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: oncall-quay

managedResourceTypes:
- Job

imagePatterns:
- quay.io/app-sre/quay-db-jobs

authentication:
  code:
    path: app-sre/creds/github-app-sre-bot
    field: openshift-saas-deploy
  image:
    path: app-sre/quay/app-sre-pull
    field: all

parameters:
  IMAGE: "quay.io/app-sre/quay-db-jobs"

resourceTemplates:
- name: quay-db-jobs
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: a20f8b58a4e4f2cfea01cf95c7c7ed33fff0404d
    parameters:
      JOB_NAME: "enable-weaveworks-stage-2021-12-06-4"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quayio-stage-57-py3-rds"
      DB_CREDS_SECRET: "quayio-stage-57-py3-rds"
      SUBCOMMAND: "enable_users"
      USERS: "weaveworks"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-config"
#- name: quay-db-jobs-enable-weaveworks
#  path: /openshift.yml
#  url: https://github.com/quay/quay-db-jobs
#  targets:
#  - namespace:
#      $ref: /services/quayio/namespaces/quayp05ue1.yml
#    ref: 1f8225c897a7f7545e4a93e82bc67c6fee9eb31b
#    parameters:
#      JOB_NAME: "enable-weaveworks-prod-2021-12-06"
#      ACTIVE_DEADLINE_SECONDS: "600"
#      DB_HOST_SECRET: "quay-db-config-secret"
#      DB_CREDS_SECRET: "quay-db-config-secret"
#      SUBCOMMAND: "enable_users"
#      USERS: "weaveworks"
- name: quay-db-jobs-create-database-user
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: d2f71a5a54be22cc580a60bf3d06b966660c9e75
    parameters:
      JOB_NAME: "create-database-user-2022-01-26-1"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quayio-stage-57-py3-rds"
      DB_CREDS_SECRET: "quayio-stage-57-py3-rds"
      SUBCOMMAND: "create_database_user"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-config"
- name: grant-user-service-tool-permission
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: 687c68ed716eaa299cdf79fcf101aece285221e7
    parameters:
      JOB_NAME: "grant-user-service-tool-permission-2022-02-16-1"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quayio-stage-57-py3-rds"
      DB_CREDS_SECRET: "quayio-stage-57-py3-rds"
      SUBCOMMAND: "grant_user_service_tool_permission"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-config"
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: 687c68ed716eaa299cdf79fcf101aece285221e7
    parameters:
      JOB_NAME: "grant-user-service-tool-perms-prod-2022-02-16-1"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quay-db-config-secret"
      DB_CREDS_SECRET: "quayio-production-py3-rds"
      SUBCOMMAND: "grant_user_service_tool_permission"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-prod-config"
- name: quay-db-jobs-prod-create-database-user
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: 6dcdb0e0ea839f5cc7fcc3f4e5edd176fb1f6c23
    parameters:
      JOB_NAME: "create-prod-database-user-2022-01-31-3"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quay-db-config-secret"
      DB_CREDS_SECRET: "quayio-production-py3-rds"
      SUBCOMMAND: "create_database_user"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-prod-config"
- name: quay-db-jobs-reenable-disabled-triggers
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: f1eabb25f0848f0c4858539f532d98043a3f48dd
    parameters:
      JOB_NAME: "reenable-disabled-triggers-2023-05-31-1"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quayio-stage-57-py3-rds"
      DB_CREDS_SECRET: "quayio-stage-57-py3-rds"
      SUBCOMMAND: "reenable_disabled_triggers"
      START_DATETIME: "2023-05-27 00:00:00"
      END_DATETIME: "2023-05-31 20:00:00"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-config"
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: 382436af16d782f4f6246a10b30b8362174c1f48
    parameters:
      JOB_NAME: "reenable-disabled-triggers-2023-05-31-1"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quay-db-config-secret"
      DB_CREDS_SECRET: "quayio-production-py3-rds"
      SUBCOMMAND: "reenable_disabled_triggers"
      START_DATETIME: "2023-05-27 00:00:00"
      END_DATETIME: "2023-05-31 20:00:00"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-prod-config"
- name: quay-db-jobs-stage-change-user-plan
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: c1f44b4a7b71a00731407a744d65baa6159335b3
    parameters:
      JOB_NAME: "unset-stage-user-plan-2023-06-02-7"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quayio-stage-57-py3-rds"
      DB_CREDS_SECRET: "quayio-stage-57-py3-rds"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-config"
      SUBCOMMAND: "set_user_plan"
      QUAY_USER: "kleesc"
      REDHAT_STRIPE_ID: "cus_NhTOd9xKB6j7fC"
      UNSET_USER_PLAN: "true"
- name: quay-db-jobs-prod-add-org-admin-user
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: b7b1a48811999d834592a2e9ba6126f766d19cd9
    parameters:
      JOB_NAME: "add-org-admin-user-2022-04-6-1"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quay-db-config-secret"
      DB_CREDS_SECRET: "quayio-production-py3-rds"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-prod-config"      
      SUBCOMMAND: "add_user_as_admin"
      QUAY_USER: "packethost"
      ORGANIZATION: "equinix"
- name: quay-db-jobs-prod-change-user-email
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: b7b1a48811999d834592a2e9ba6126f766d19cd9
    parameters:
      JOB_NAME: "change-user-email-2022-04-12-1"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quay-db-config-secret"
      DB_CREDS_SECRET: "quayio-production-py3-rds"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-prod-config"
      SUBCOMMAND: "change_user_email"
      QUAY_USER: "saschamueller"
      CHANGE_USER_EMAIL_NEW_EMAIL: "waswollensie@email.de"
- name: quay-db-jobs-cleanup-stale-blobuploads
  path: /openshift.yml
  url: https://github.com/quay/quay-db-jobs
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: e44a7077c4643e749f001997470faf2d6bdab0c0
    parameters:
      JOB_NAME: "cleanup-stale-blobuploads-2022-04-29-2"
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quay-db-config-secret"
      DB_CREDS_SECRET: "quayio-production-py3-rds"
      SUBCOMMAND: "cleanup_stale_blob_uploads"
      START_DATETIME: "2022-01-01 12:00:00"
      END_DATETIME: "2022-03-15 12:00:00"
      NEW_DB_USER_CREDS_SECRET: "quay-db-jobs-prod-config"
