---
$schema: /app-sre/saas-file-1.yml

labels:
  service: quayio

name: quayio-utils
description: quayio utilities

app:
  $ref: /services/quayio/app.yml

instance:
  $ref: /dependencies/ci-int/ci-int.yml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: oncall-quay

managedResourceTypes:
- Job

imagePatterns:
- quay.io/app-sre/quayio-update-banner-job
- quay.io/app-sre/flush-redis

parameters:
  IMAGE: "quay.io/app-sre/quayio-update-banner-job"

resourceTemplates:
- name: quayio-update-banner-job
  path: /openshift.yml
  url: https://github.com/quay/update-banner-job
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: f1491c0657ae75aab55d4ea7faec1e82393dc9af
    parameters:
      JOB_NAME: "2021-04-26-sso-banner-update-1" # provide_a_unique_job_name_to_trigger_job
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quayio-stage-57-rds"
      DB_CREDS_SECRET: "quayio-stage-57-rds"
      MESSAGE: "On July 1st 2021, Quay.io will transition to Red Hat Single Sign-On Services exclusively. You need to link your Quay.io login to a redhat.com account by this date, in order to be able to login to the web interface. CLI tokens and robot accounts are not impacted. Read more about this change in the [FAQ.](https://www.openshift.com/blog/quay.io-will-require-a-red-hat-account-after-june-30-2021...wait-what)"
      SEVERITY: "info"
  - namespace:
      $ref: /services/quayio/namespaces/quayp05ue1.yml
    ref: f1491c0657ae75aab55d4ea7faec1e82393dc9af
    parameters:
      JOB_NAME: "2021-04-26-sso-banner-update-1" # provide_a_unique_job_name_to_trigger_job
      ACTIVE_DEADLINE_SECONDS: "600"
      DB_HOST_SECRET: "quay-db-config-secret"
      DB_CREDS_SECRET: "quay-db-config-secret"
      MESSAGE: "On July 1st 2021, Quay.io will transition to Red Hat Single Sign-On Services exclusively. You need to link your Quay.io login to a redhat.com account by this date, in order to be able to login to the web interface. CLI tokens and robot accounts are not impacted. Read more about this change in the [FAQ.](https://www.openshift.com/blog/quay.io-will-require-a-red-hat-account-after-june-30-2021...wait-what)"
      SEVERITY: "info"
- name: flush-redis
  path: /openshift.yml
  url: https://github.com/app-sre/flush-redis
  targets:
  - namespace:
      $ref: /services/quayio/namespaces/quays02ue1.yml
    ref: b01dcb1e602a909604244eb147a6958978ea7ecd
    parameters:
      JOB_NAME: "2021-04-13" # provide_a_unique_job_name_to_trigger_job
      ACTIVE_DEADLINE_SECONDS: "600"
      REDIS_SECRET: "quayio-stage-elasticache"
      IMAGE: "quay.io/app-sre/flush-redis"
  # ONLY RUN IT ON ONE PROD CLUSTER
  # UNCOMMENT WHEN YOU NEED THIS JOB TO RUN.
  # ONCE UNCOMMENTED IT CAN BE LEFT UNCOMMENTED
  # - namespace:
  #     $ref: /services/quayio/namespaces/quayp05ue1.yml
  #   ref: b01dcb1e602a909604244eb147a6958978ea7ecd
  #   parameters:
  #     ACTIVE_DEADLINE_SECONDS: "600"
  #     REDIS_SECRET: "quayio-elasticache"
  #     IMAGE: "quay.io/app-sre/flush-redis"
  #     JOB_NAME: "flush-redis-prod-2021-04-13"
