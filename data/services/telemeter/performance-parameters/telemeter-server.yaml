---
$schema: /app-sre/performance-parameters-1.yml

labels:
  service: telemeter

name: telemeter-server

app:
  $ref: /services/telemeter/app.yml

# The specific component of the app/service above ^
component: telemeter-server

prometheusLabels: # Dictionary, a bunch of labels that Prometheus uses to select this rules file
  prometheus: app-sre
  role: alert-rules
  type: slo-rules

# Namespaces where the application lives
namespaces:
- namespace:
    $ref: /services/telemeter/namespaces/telemeter-stage.yml
- namespace:
    $ref: /services/telemeter/namespaces/telemeter-production.yml

availability:
- kind: SLO
  metric: http_requests_total
  errorBudget: 0.01
  selectors:
    job: telemeter-server
    handler: upload

- kind: SLA
  metric: http_requests_total
  errorBudget: 5
  selectors:
    job: telemeter-server
    handler: upload

latency:
- kind: SLO
  metric: latency_bucket
  threshold: 3
  percentile: 90
  selectors:
    job: telemeter-server
    handler: upload

rawRecording:
- record: telemeter:capacity
  expr: (sum(telemeter_partitions{namespace="telemeter-production"}) / 5000) * 100
  labels:
    component: telemeter-server

rawAlerting:
- alert: SLO - TelemeterCapacityReached
  annotations:
    message: "Telemeter reached {{ $value }}% of capacity in namespace {{ $labels.namespace }}."
    runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/telemeter/sop"
    dashboard: "https://grafana.app-sre.devshift.net/d/Tg-mH0rizaSJDKSADJ/telemeter?orgId=1&var-datasource=app-sre-prometheus&var-cluster=app-sre&var-namespace=telemeter-prod"
  expr: telemeter:capacity >= 50
  for: 5m
  labels:
    service: telemeter
    severity: medium
    component: telemeter-server