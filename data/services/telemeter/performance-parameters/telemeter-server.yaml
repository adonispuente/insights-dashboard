---
$schema: /app-sre/performance-parameters-1.yml

labels:
  service: telemeter

name: telemeter-server

app:
  $ref: /services/telemeter/app.yml

# The specific component of the app/service above ^
component: telemeter-server

prometheusLabels: # Dictionary, a bunch of labels that Prometheus uses to select this rules file
  prometheus: app-sre
  role: alert-rules
  type: slo-rules

# Namespace where the application lives
namespace:
  $ref: /services/telemeter/namespaces/telemeter-production.yml

SLIRecordingRules:
- name: telemeter_server_http_rates
  kind: http_rate
  metric: http_requests_total
  selectors:
    job: telemeter-server

- name: telemeter_server_upload_latency_rates
  kind: latency_rate
  percentile: 90
  metric: http_request_duration_seconds_bucket
  selectors:
    job: telemeter-server
    handler: upload

volume:
- name: telemeter_server_volume_slo
  kind: SLO
  rules: telemeter_server_http_rates
  target: 5000  # We should validate this with telemeter team

latency:
- name: telemeter_server_upload_latency_slo
  kind: SLO
  rules: telemeter_server_upload_latency_rates
  threshold: 2.5
  target: 99

errors:
- name: telemeter_server_errors_slo
  kind: SLO
  rules: telemeter_server_http_rates
  target: 10  # We should validate this with telemeter team

availability:
- name: telemeter_server_availability_slo
  kind: SLO
  rules:
    latency:
    - telemeter_server_upload_latency_slo
    errors:
    - telemeter_server_errors_slo
  target: 99

rawRecordingRules:
- record: telemeter:capacity
  expr: (sum(telemeter_partitions{namespace="telemeter-production"}) / 5000) * 100
  labels:
    component: telemeter-server

rawAlerting:
- alert: SLO - TelemeterCapacityReached
  annotations:
    message: "Telemeter reached {{ $value }}% of capacity in namespace {{ $labels.namespace }}."
    runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/telemeter/sop"
    dashboard: "https://grafana.app-sre.devshift.net/d/Tg-mH0rizaSJDKSADJ/telemeter?orgId=1&var-datasource=app-sre-prometheus&var-cluster=app-sre&var-namespace=telemeter-prod"
  expr: telemeter:capacity >= 50
  for: 3d
  labels:
    service: telemeter
    severity: medium
    component: telemeter-server
