---
$schema: /app-sre/saas-file-2.yml

labels:
  service: rhsm
  platform: insights

name: rhsm-perf-clowder
description: rhsm app on the Insights Platform via clowder

app:
  $ref: /services/insights/rhsm/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.appsrep05ue1.yaml

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml 
  channel: proj-perf-insights-cluster

managedResourceTypes:
- ClowdApp
- ClowdJobInvocation
# NOTE: Service needed to transition seamlessly from old deployment/service route without taking downtime
- Service
# - HorizontalPodAutoscaler

imagePatterns:
- quay.io/cloudservices
- quay.io/app-sre

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all
    version: 3

parameters:
  CLOWDER_ENABLED: 'true'

resourceTemplates:
- name: swatch-tally
  path: /swatch-tally/deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/rhsm-subscriptions
  targets:
    - namespace:
        $ref: /services/insights/rhsm/namespaces/perf-rhsm-perf.yml
      ref: main
      parameters:
        ENABLE_SPLUNK_HEC: false
        CAPTURE_SNAPSHOT_SCHEDULE: '@yearly'
        CAPTURE_HOURLY_SNAPSHOT_SCHEDULE: '@yearly'
        PURGE_SNAPSHOT_SCHEDULE: '@yearly'
        HAWTIO_BASE_PATH: /app/rhsm-subscriptions/hawtio
        DEVTEST_SUBSCRIPTION_EDITING_ENABLED: true
        DEVTEST_EVENT_EDITING_ENABLED: true
        ENABLE_ACCOUNT_RESET: true
        CLOUDIGRADE_ENABLED: false
        USER_HOST: user.stage.api.redhat.com
        CPU_LIMIT: 1
        CPU_REQUEST: 500m
        MEMORY_REQUEST: 4096Mi
        MEMORY_LIMIT: 6144Mi
        REPLICAS: 1
        KAFKA_MESSAGE_THREADS: 1
        DATABASE_MAX_POOL_SIZE: 3
        INVENTORY_DATABASE_MAX_POOL_SIZE: 3
        INVENTORY_SECRET_KEY_NAME: host-inventory-db-readonly
        INVENTORY_SECRET_KEY_NAME_PREFIX: 'db.'
        POPULATOR_RUN_NUMBER: 2
        ORG_ID_POPULATOR_BATCH_SIZE: 500

- name: swatch-metrics
  path: /swatch-metrics/deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/rhsm-subscriptions
  targets:
  - namespace:
      $ref: /services/insights/rhsm/namespaces/perf-rhsm-perf.yml
    ref: main
    parameters:
      CPU_REQUEST: 250m
      CPU_LIMIT: 1
      MEMORY_REQUEST: 600Mi
      MEMORY_LIMIT: 600Mi
      METRICS_WORKER_HAWTIO_BASE_PATH: /app/rhsm-metrics/hawtio
      USER_HOST: user.stage.api.redhat.com
      INVENTORY_SECRET_KEY_NAME: host-inventory-db-readonly
      INVENTORY_SECRET_KEY_NAME_PREFIX: 'db.'
      DATABASE_MAX_POOL_SIZE: '3'
      REPLICAS: 1
      KAFKA_METERING_TASKS_REPLICAS: 3 
      KAFKA_METERING_TASKS_PARTITIONS: 24
      KAFKA_MESSAGE_THREADS: 1
      ENABLE_SYNCHRONOUS_OPERATIONS: 'true'
      OTEL_JAVAAGENT_ENABLED: 'false'
