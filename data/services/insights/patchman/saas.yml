---
$schema: /app-sre/saas-file-2.yml

labels:
  service: patchman
  platform: insights

name: patchman
description: patchman app on the Insights Platform

app:
  $ref: /services/insights/patchman/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.appsrep05ue1.yaml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: team-clouddot-info

managedResourceTypes:
- Deployment
- DeploymentConfig
- Service

imagePatterns:
- quay.io/cloudservices

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all

parameters:
  LOG_GROUP: platform

resourceTemplates:

- name: patchman-engine-manager
  path: /templates/patchman/patchman-engine-manager.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  parameters:
    MANIFEST_PUSH_BRANCH: stage
  targets:
  - namespace:
      $ref: /services/insights/patchman/namespaces/stage-patchman-engine-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    delete: true
    parameters:
      IMAGE_TAG: 7bec099 # 1.15.3
      ENABLE_CYNDI_TAGS: "true"
      RES_MEMORY: "512Mi"
      CMD_WRAPPER: haberdasher
      HABERDASHER_EMITTER: kafka
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      HABERDASHER_KAFKA_TOPIC: platform.logging.logs
      HABERDASHER_LABELS: {"app": "patchman"}
      HABERDASHER_TAGS: ["patchman"]
      CW_AWS_ACCESS_KEY_ID: ""
      GODEBUG: "x509ignoreCN=0"
      REPLICAS: 0
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-fedramp-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      ENABLE_CYNDI_TAGS: "true"
      ENABLE_RBAC: "false"
      REPLICAS: 1
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-prod.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      ENABLE_CYNDI_TAGS: "true"
      RES_CPU: "1000m"
      RES_MEMORY: "512Mi"
      REPLICAS: 1
      GODEBUG: "x509ignoreCN=0"

- name: patchman-engine-listener
  path: /templates/patchman/patchman-engine-listener.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  targets:
  - namespace:
      $ref: /services/insights/patchman/namespaces/stage-patchman-engine-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    delete: true
    parameters:
      IMAGE_TAG: 7bec099 # 1.15.3
      REPLICAS: 0
      GODEBUG: "x509ignoreCN=0"
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-fedramp-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      REPLICAS: 1
      ENABLE_KAFKA_SSL: "true"
      KAFKA_SSL_SKIP_VERIFY: "false"
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-prod.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      REPLICAS: 0
      CONSUMER_COUNT: "1"
      GODEBUG: "x509ignoreCN=0"

- name: patchman-engine-evaluator-upload
  path: /templates/patchman/patchman-engine-evaluator-upload.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  parameters:
    VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8000
  targets:
  - namespace:
      $ref: /services/insights/patchman/namespaces/stage-patchman-engine-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    delete: true
    parameters:
      IMAGE_TAG: 7bec099 # 1.15.3
      ENABLE_LAZY_PACKAGE_SAVE: "true"
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8000
      REPLICAS: 0
      GODEBUG: "x509ignoreCN=0"
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-fedramp-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      ENABLE_LAZY_PACKAGE_SAVE: "false"
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8080
      REPLICAS: 1
      ENABLE_KAFKA_SSL: "true"
      KAFKA_SSL_SKIP_VERIFY: "false"
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-prod.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      ENABLE_LAZY_PACKAGE_SAVE: "false"
      RES_CPU: "1000m"
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-prod.svc.cluster.local:8080
      ENABLE_PACKAGE_ANALYSIS: "true"
      REPLICAS: 0
      CONSUMER_COUNT: "1"
      GOMAXPROCS: "4"
      GODEBUG: "x509ignoreCN=0"

- name: patchman-engine-evaluator-recalc
  path: /templates/patchman/patchman-engine-evaluator-recalc.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  parameters:
    VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8000
  targets:
  - namespace:
      $ref: /services/insights/patchman/namespaces/stage-patchman-engine-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    delete: true
    parameters:
      IMAGE_TAG: 7bec099 # 1.15.3
      ENABLE_LAZY_PACKAGE_SAVE: "true"
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8000
      ENABLE_STALE_SYSTEM_EVALUATION: "false"
      REPLICAS: 0
      GODEBUG: "x509ignoreCN=0"
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-fedramp-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      ENABLE_LAZY_PACKAGE_SAVE: "false"
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8080
      ENABLE_STALE_SYSTEM_EVALUATION: "false"
      REPLICAS: 1
      ENABLE_KAFKA_SSL: "true"
      KAFKA_SSL_SKIP_VERIFY: "false"
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-prod.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      ENABLE_LAZY_PACKAGE_SAVE: "false"
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-prod.svc.cluster.local:8080
      ENABLE_STALE_SYSTEM_EVALUATION: "false"
      ENABLE_PACKAGE_ANALYSIS: "true"
      REPLICAS: 0
      RES_CPU: "1000m"
      CONSUMER_COUNT: "1"
      GOMAXPROCS: "4"
      GODEBUG: "x509ignoreCN=0"

- name: patchman-engine-vmaas-sync
  path: /templates/patchman/patchman-engine-vmaas-sync.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  parameters:
    VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8000
    VMAAS_WS_ADDRESS: ws://vmaas-websocket.vmaas-stage.svc.cluster.local:10000
  targets:
  - namespace:
      $ref: /services/insights/patchman/namespaces/stage-patchman-engine-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    delete: true
    parameters:
      IMAGE_TAG: 7bec099 # 1.15.3
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8000
      VMAAS_WS_ADDRESS: ws://vmaas-websocket.vmaas-stage.svc.cluster.local:10000
      REPLICAS: 0
      GODEBUG: "x509ignoreCN=0"
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-fedramp-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-stage.svc.cluster.local:8080
      VMAAS_WS_ADDRESS: ws://vmaas-websocket.vmaas-stage.svc.cluster.local:8082
      REPLICAS: 1
      ENABLE_KAFKA_SSL: "true"
      KAFKA_SSL_SKIP_VERIFY: "false"
      ENABLE_SYNC_ON_START: "true" # to test vmaas call with istio enabled
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-prod.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      ENABLE_SYNC_ON_START: "true"
      ENABLE_RECALC_ON_START: "false"
      ENABLE_MODIFIED_SINCE_SYNC: "false"
      DELETE_CULLED_SYSTEMS_LIMIT: "2000"
      ERRATA_PAGE_SIZE: "5000"
      PACKAGES_PAGE_SIZE: "5"
      RES_MEMORY: 1024Mi
      VMAAS_ADDRESS: http://vmaas-webapp.vmaas-prod.svc.cluster.local:8080
      VMAAS_WS_ADDRESS: ws://vmaas-websocket.vmaas-prod.svc.cluster.local:8082
      REPLICAS: 0
      GODEBUG: "x509ignoreCN=0"

- name: patchman-engine-database-admin
  path: /templates/patchman/patchman-engine-database-admin.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  targets:
  - namespace:
      $ref: /services/insights/patchman/namespaces/stage-patchman-engine-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    delete: true
    parameters:
      IMAGE_TAG: 7bec099 # 1.15.3
      REPLICAS: 0
      GODEBUG: "x509ignoreCN=0"
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-fedramp-stage.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      REPLICAS: 1
  - namespace:
      $ref: /services/insights/patchman/namespaces/patchman-engine-prod.yml
    ref: 453a7993ff1930209956ae977baaaed650ccf2cf
    parameters:
      IMAGE_TAG: e38cadf # 1.15.2
      REPLICAS: 0
      GODEBUG: "x509ignoreCN=0"
