---
$schema: /app-sre/saas-file-2.yml
labels:
  service: tower-analytics
  platform: insights
name: tower-analytics-clowder
description: tower-analytics app on the Insights Platform
app:
  $ref: /services/insights/tower-analytics/app.yml
pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.appsrep05ue1.yaml
slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: aa-cicd-events
managedResourceTypes:
- ClowdApp
- Service
- Frontend

imagePatterns:
- quay.io/cloudservices

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all
    version: 3
parameters:
  CLOUD_WATCH_LOG_GROUP: tower-analytics-stage
resourceTemplates:
- name: tower-analytics-frontend
  path: /deploy/frontend.yaml
  url: https://github.com/RedHatInsights/tower-analytics-frontend
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/consoledot-frontend-stage.yml
    ref: e10f6648780fdc00558626840cb67ba33e4b01a7
    parameters:
      ENV_NAME: env-stage
- name: tower-analytics-clowdapp
  path: /saas-templates/clowderapp.yaml
  url: https://gitlab.cee.redhat.com/automation-analytics/automation-analytics-backend
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      RBAC_URL: http://rbac-service:8000
      MEMORY_REQUEST_ONEVIEW: 512Mi
      MEMORY_LIMIT_ONEVIEW: 1Gi
      MEMORY_REQUEST_FASTAPI: 512Mi
      MEMORY_LIMIT_FASTAPI: 1Gi
      MEMORY_REQUEST_PROCESSOR_CONTROLLER: 1Gi
      MEMORY_LIMIT_PROCESSOR_CONTROLLER: 2Gi
      MEMORY_REQUEST_PROCESSOR_INGRESS: 512Mi
      MEMORY_LIMIT_PROCESSOR_INGRESS: 1Gi
      MEMORY_REQUEST_PROCESSOR_REPLAY: 512Mi
      MEMORY_LIMIT_PROCESSOR_REPLAY: 1Gi
      MEMORY_REQUEST_RECOVERY: 1Gi
      MEMORY_LIMIT_RECOVERY: 2Gi
      MEMORY_REQUEST_EXPORTER: 1Gi
      MEMORY_LIMIT_EXPORTER: 2Gi
      MEMORY_REQUEST_USER_METRICS: 512Mi
      MEMORY_LIMIT_USER_METRICS: 1Gi
      MEMORY_REQUEST_ROLLUPS: 512Mi
      MEMORY_LIMIT_ROLLUPS: 1Gi
      MEMORY_REQUEST_DATA_PRUNING: 512Mi
      MEMORY_LIMIT_DATA_PRUNING: 1Gi
  - namespace:
      $ref: /services/insights/tower-analytics/namespaces/stage-tower-analytics-stage.yml
    ref: main
    parameters:
      ENV_NAME: stage
      GUNICORN_PROCESSES: 1
      REPLICAS_API: 15
      REPLICAS_ONEVIEW: 2
      REPLICAS_ROLLUP: 3
      REPLICAS_PROCESSOR_CONTROLLER: 5
      REPLICAS_PROCESSOR_INGRESS: 2
      REPLICAS_EXPORTER: 2
      REPLICAS_DEBUG: 1
      RBAC_ENABLED: 'True'
      PROMETHEUS_PUSH_GATEWAY: ${PROMETHEUS_PUSHGATEWAY}
      # Cron jobs
      CRON_SCHEDULE_MSG_RECOVERY: 0 */2 1 9 5 # TODO: disabled, failed messages are processed by processor-controller
      CRON_SCHEDULE_USER_METRICS: 0 10 * * *
      CRON_SCHEDULE_DATA_PRUNING: 30 19 * * 4
      # S3 buckets
      BUNDLES_BUCKET_NAME: upload-stage
      BUNDLES_SECRET_NAME: upload-s3
      DATA_EXPORT_BUCKET_NAME: tower-analytics-dbdumps-stage-s3
      INGRESS_ANALYTICS_BUCKET_NAME: '' # insights-upload-tower-analytics-stage # ingress/namespaces/stage-ingress-stage/externalResources
      RECOVERY_BUCKET_NAME: tower-analytics-recovery-stage-s3  # tower-analytics/namespaces/<stage/prod>/externalResources
      # Data Exporter Svc
      DATA_EXPORT_ENABLED: 'True'
      # Fast API Svc
      FASTAPI_HOST: automation-analytics-api-fastapi-v2.tower-analytics-stage.svc.cluster.local
      FASTAPI_PORT: 8000
      # Vault settings
      BACKOFFICE_TOKEN_SECRET: backoffice
      RBAC_PSKS_SECRET: rbac-psks
      # Data pruning Job
      DATA_PRUNING_ENABLED: 'True'
      DATA_PRUNING_INTERNAL_DATA_ENABLED: 'True'
      DATA_PRUNING_RAW_TABLE_RETENTION_DAYS: '366'
      DATA_PRUNING_DAILY_ROLLUP_RETENTION_DAYS: '3660'
      DATA_PRUNING_MONTHLY_ROLLUP_RETENTION_DAYS: '3660'
      DATA_PRUNING_YEARLY_ROLLUP_RETENTION_DAYS: '5475'
      # Advisory locks
      LOCK_MESSAGES_RECOVERY_ENABLED: 'true' # Lock per message
      # Messages Recovery Job
      MESSAGE_RECOVERY_STATUSES: 'failed'
      # Processor Controller Svc
      PROCESSOR_CONTROLLER_APP: 'processor-controller' # or processor-controller-kafka (disable processor-ingress)
      PROCESSOR_CONTROLLER_STATUSES: 'new'
      # Processor Ingress Svc
      PROCESSOR_INGRESS_SEND_TO_RECOVERY: 'True'
      # Processor Replay Job
      PROCESSOR_REPLAY_JOB_VERSION: '0' # increase to invoke job run
      PROCESSOR_REPLAY_MODE: 'noop'
      PROCESSOR_REPLAY_REQUEST_ID: ''
      PROCESSOR_REPLAY_REPLAY_SINCE: ''
      PROCESSOR_REPLAY_REPLAY_TO: ''
      PROCESSOR_REPLAY_DOWNLOAD_LINK: 'True'
      PROCESSOR_REPLAY_LINK_EXPIRATION: '24'
      PROCESSOR_REPLAY_PROCESS_PAYLOAD: 'False'
      PROCESSOR_REPLAY_STATUSES: ''
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: automation-analytics-automation-analytics-backend-gl-build-main
    promotion:
      publish:
      - automation-analytics-stage-deploy-success-channel
  - namespace:
      $ref: /services/insights/tower-analytics/namespaces/tower-analytics-prod.yml
    ref: c4891cde4911ff2fd37c7b7bfaa9448ab9bcedeb
    parameters:
      ENV_NAME: prod
      GUNICORN_PROCESSES: 1
      REPLICAS_API: 22
      REPLICAS_ONEVIEW: 2
      REPLICAS_ROLLUP: 0  # was 6 (!77267)
      REPLICAS_PROCESSOR_CONTROLLER: 0  # was 4 (!77256)
      REPLICAS_PROCESSOR_INGRESS: 0  # was 3
      REPLICAS_EXPORTER: 0  # was 3 (!77267)
      REPLICAS_DEBUG: 0
      MEMORY_LIMIT_EXPORTER: 4Gi
      MEMORY_REQUEST_PROCESSOR_CONTROLLER: 512Mi
      MEMORY_LIMIT_PROCESSOR_CONTROLLER: 1Gi
      RBAC_ENABLED: 'True'
      PROMETHEUS_PUSH_GATEWAY: ${PROMETHEUS_PUSHGATEWAY}
      # Vault settings
      RBAC_PSKS_SECRET: rbac-psks
      BACKOFFICE_TOKEN_SECRET: backoffice
      # Cron jobs
      CRON_SCHEDULE_MSG_RECOVERY: 0 8,20 * * *
      CRON_SCHEDULE_USER_METRICS: '* 10 * * *'
      CRON_SCHEDULE_DATA_PRUNING: 0 13 * * 2
      # Data exporter Svc
      DATA_EXPORT_ENABLED: 'True'
      JOBS_LOG_LEVEL: INFO
      # S3 Buckets
      BUNDLES_BUCKET_NAME: insights-ingress-prod # TODO: not used ??
      BUNDLES_SECRET_NAME: upload-s3 # TODO": not used ??
      DATA_EXPORT_BUCKET_NAME: tower-analytics-dbdumps-prod
      INGRESS_ANALYTICS_BUCKET_NAME: '' # insights-upload-tower-analytics-prod # ingress/namespaces/ingress-prod/externalResources
      RECOVERY_BUCKET_NAME: tower-analytics-recovery-prod
      # Fast API svc
      FASTAPI_HOST: automation-analytics-api-fastapi-v2.tower-analytics-prod.svc.cluster.local
      FASTAPI_PORT: 8000
      # Data pruning Job
      DATA_PRUNING_ENABLED: 'False'
      DATA_PRUNING_INTERNAL_DATA_ENABLED: 'True'
      DATA_PRUNING_RAW_TABLE_RETENTION_DAYS: '183'
      DATA_PRUNING_DAILY_ROLLUP_RETENTION_DAYS: '3660'
      DATA_PRUNING_MONTHLY_ROLLUP_RETENTION_DAYS: '3660'
      DATA_PRUNING_YEARLY_ROLLUP_RETENTION_DAYS: '3660'
      # Advisory locks
      LOCK_MESSAGES_RECOVERY_ENABLED: 'True'  # Lock per message
      LOCK_PROCESSOR_CONTROLLER_ENABLED: 'True'  # Lock per message
      LOCK_PROCESSOR_CONTROLLER_EVENTS_ENABLED: 'False'  # Lock per tenant
      # Messages Recovery Job
      MESSAGE_RECOVERY_STATUSES: ''
      # Processor Controller Svc
      PROCESSOR_CONTROLLER_APP: 'processor-controller' # or processor-controller-kafka (disable processor-ingress)
      PROCESSOR_CONTROLLER_STATUSES: 'new'
      # Processor Ingress Svc
      PROCESSOR_INGRESS_SEND_TO_RECOVERY: 'True'
      # Processor Replay Job
      PROCESSOR_REPLAY_JOB_VERSION: '0' # increase to invoke job run
      PROCESSOR_REPLAY_MODE: 'noop'
      PROCESSOR_REPLAY_REQUEST_ID: ''
      PROCESSOR_REPLAY_REPLAY_SINCE: ''
      PROCESSOR_REPLAY_REPLAY_TO: ''
      PROCESSOR_REPLAY_DOWNLOAD_LINK: 'True'
      PROCESSOR_REPLAY_LINK_EXPIRATION: '24'
      PROCESSOR_REPLAY_PROCESS_PAYLOAD: 'False'
      PROCESSOR_REPLAY_STATUSES: ''

