---
$schema: /app-sre/saas-file-2.yml

labels:
  service: ccx-data-pipeline
  platform: insights

name: ccx-data-pipeline-clowder
description: ccx-data-pipeline app on the Insights Platform deployed via Clowder

app:
  $ref: /services/insights/ccx-data-pipeline/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.appsrep05ue1.yaml

deployResources:
  requests:
    cpu: 1500m
    memory: 700Mi
  limits:
    cpu: 1500m
    memory: 700Mi

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: ccx-dev-notifications

managedResourceTypes:
- ClowdApp
- ConfigMap
- HorizontalPodAutoscaler
- Service

imagePatterns:
- quay.io/cloudservices
- quay.io/prometheus/pushgateway

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all
    version: 3

resourceTemplates:
- name: ccx-data-pipeline
  path: /deploy/clowdapp.yaml
  url: https://gitlab.cee.redhat.com/ccx/ccx-data-pipeline
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: ccx-ccx-data-pipeline-gl-build-master
    parameters:
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "3"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
  - namespace:
      $ref:  /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 8a834dd3292ef2ec74df55916e9da8fe25b8ce86
    parameters:
      IMAGE_TAG: 2eb4017
      MIN_REPLICAS: "16"
      MAX_REPLICAS: "16"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true  # do not create an app-sre deploy job for ephemeral namespace
    ref: internal  # populated by bonfire
    parameters:
      MIN_REPLICAS: "1"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      LOGGING_TO_CW_ENABLED: "False"
      ALLOW_UNSAFE_LINKS: "True"
  # ephemeral deployment for OCM qaprodauth
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: ccx-ccx-data-pipeline-gl-build-master
    parameters:
      ENV_NAME: env-ocm
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "3"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      LOGGING_TO_CW_ENABLED: "False"
      ALLOW_UNSAFE_LINKS: "True"

- name: ccx-insights-results
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-results-aggregator
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    delete: false
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-gh-build-master
    parameters:
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
      DB_WRITER_REPLICAS: "1"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    delete: false
    ref: cf26046e36f9b80e2747c38fd5a772ad18268bf3
    parameters:
      IMAGE_TAG: 727e659
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
      DB_WRITER_REPLICAS: "8"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      DB_WRITER_REPLICAS: "1"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      CLOUDWATCH_ENABLED: "false"
  # ephemeral deployment for OCM qaprodauth
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    delete: false
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-gh-build-master
    parameters:
      ENV_NAME: env-ocm
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
      DB_WRITER_REPLICAS: "1"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      CLOUDWATCH_ENABLED: "false"

- name: insights-results-smart-proxy
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-results-smart-proxy
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-smart-proxy-gh-build-master
    parameters:
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      IRSP_ENABLE_INTERNAL_ORGANIZATIONS: true
      IRSP_INTERNAL_RULES_ORGANIZATIONS_CSV_FILE: "/cdapp/internal_rules_organizations.csv"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 037479d4dfc920783f8725a1ee8f7f3a8c130507
    delete: false
    parameters:
      IMAGE_TAG: c9bb293
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      IRSP_ENABLE_INTERNAL_ORGANIZATIONS: true
      IRSP_INTERNAL_RULES_ORGANIZATIONS_CSV_FILE: "/cdapp/internal_rules_organizations.csv"
      AMS_API_URL: https://api.openshift.com
      DEBUG: false
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"
  # ephemeral deployment for OCM qaprodauth
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-smart-proxy-gh-build-master
    parameters:
      ENV_NAME: env-ocm
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      IRSP_ENABLE_INTERNAL_ORGANIZATIONS: false
      IRSP_INTERNAL_RULES_ORGANIZATIONS_CSV_FILE: "/cdapp/internal_rules_organizations.csv"
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"

- name: insights-aggregator-cleaner
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-results-aggregator-cleaner
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    # Note: Automerge latest master version to STAGE env.
    #       Implementation: latest master build is deployed to STAGE.
    #       IMAGE_TAG is not needed here..
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-cleaner-gh-build-master
    parameters:
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 37cd4ab94d59ad9ce9f09cca24848ad044443966
    parameters:
      IMAGE_TAG: a90d26a
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      CLOUDWATCH_ENABLED: "false"

- name: insights-content-service
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-content-service
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-content-service-gh-build-master
    parameters:
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: b56df7efd84f934615c3bd1fb2d8c8ff92a1f1c2
    delete: false
    parameters:
      IMAGE_TAG: bd838ad
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"
  # ephemeral deployment for OCM qaprodauth
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-content-service-gh-build-master
    parameters:
      ENV_NAME: env-ocm
      HABERDASHER_KAFKA_BOOTSTRAP: ${KAFKA_BOOTSTRAP_HOST}:9092
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"

- name: io-gathering-service
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-operator-gathering-conditions-service
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: main
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-operator-gathering-conditions-service-gh-build-main
    parameters:
      IMAGE: "quay.io/cloudservices/io-gathering-conditions-service"
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 87bf2780e6386c3184d84f629ef87abc736d74fe
    parameters:
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"

- name: ccx-sha-extractor
  path: /deploy/clowdapp.yaml
  url: https://gitlab.cee.redhat.com/ccx/ccx-sha-extractor
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: ccx-ccx-sha-extractor-gl-build-master
    parameters:
      IMAGE: "quay.io/cloudservices/ccx-sha-extractor"
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 8db1491a51c87f1b58c108468d4211aa462d3b96
    parameters:
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"


### CCX Notification Services

- name: ccx-notification-writer
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/ccx-notification-writer
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    # FIXME set replicas to 1: https://issues.redhat.com/browse/CCXDEV-7479
    ref: master
    disable: false
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-ccx-notification-writer-gh-build-master
    parameters:
      IMAGE: "quay.io/cloudservices/ccx-notification-writer"
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
      DB_CLEANER_JOB_SCHEDULE: "0 * * * *"
      SUSPEND_JOB: "false"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: eeceb2183f89deba1108b98557537c1eb5a13d60
    # FIXME set replicas to 1: https://issues.redhat.com/browse/CCXDEV-7479
    disable: true
    parameters:
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
      DB_CLEANER_JOB_SCHEDULE: "0 0 * * *"
      SUSPEND_JOB: "true"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    # FIXME set replicas to 1: https://issues.redhat.com/browse/CCXDEV-7479
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
      SUSPEND_JOB: "true"

- name: ccx-notification-db-cleaner
  path: /deploy/clowdapp-db-cleaner.yaml
  url: https://github.com/RedHatInsights/ccx-notification-writer
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    disable: true
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-ccx-notification-writer-gh-build-master
    parameters:
      IMAGE: "quay.io/cloudservices/ccx-notification-writer"
      JOB_SCHEDULE: "0 * * * *"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: eeceb2183f89deba1108b98557537c1eb5a13d60
    disable: true
    parameters:
      JOB_SCHEDULE: "0 0 * * *"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal

- name: ccx-notification-service
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/ccx-notification-service
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    # FIXME set replicas to 1: https://issues.redhat.com/browse/CCXDEV-7479
    disable: true
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-ccx-notification-service-gh-build-master
    parameters:
      IMAGE: "quay.io/cloudservices/ccx-notification-service"
      CONTENT_SERVICE_PORT: 10000
      JOB_SCHEDULE: "*/3 * * * *"
      NOTIFICATION_RESEND_COOLDOWN: "29m"
      SUSPEND_JOB: "true"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    # FIXME set replicas to 1: https://issues.redhat.com/browse/CCXDEV-7479
    disable: true
    ref: 08bda3cc85a2b266e73867acaa0f998f00e57772
    parameters:
      CONTENT_SERVICE_PORT: 10000
      JOB_SCHEDULE: "*/15 * * * *"
      SUSPEND_JOB: "true"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      CONTENT_SERVICE_PORT: 10000
      JOB_SCHEDULE: "*/3 * * * *"
      NOTIFICATION_RESEND_COOLDOWN: "29m"
      SUSPEND_JOB: "true"


### CCX Helpers

- name: ccx-kafka-monitor
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-kafka-monitor
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-kafka-monitor-gh-build-master
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 39e1994057e0b0360f067affa29575a6e07ad1c7
    disable: true


### Grafana Dashboards

- name: grafana-dashboard-ccx-notification-service
  url: https://github.com/RedHatInsights/ccx-notification-service
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production.yml
    ref: 533410bcd3bf719a69801f66fe7a52b6def3b2fb

- name: grafana-dashboard-ccx-notification-writer
  url: https://github.com/RedHatInsights/ccx-notification-writer
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production.yml
    ref: f5de84a20cd3a1de53ea9c361fa8a92fd9c900bb

- name: grafana-dashboard-io-gathering-service
  url: https://github.com/RedHatInsights/insights-operator-gathering-conditions-service
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage.yml
    ref: main
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production.yml
    ref: d7ea5d1169dc45100654769c4f9e973c28c0f7ae

- name: grafana-dashboard-insights-sha-extractor
  url: https://gitlab.cee.redhat.com/ccx/ccx-sha-extractor
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production.yml
    ref: ee1877e7d8f8d447522209bc9feb62a2ec11e394

