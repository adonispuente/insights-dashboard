---
$schema: /app-sre/saas-file-2.yml

labels:
  service: ccx-data-pipeline
  platform: insights

name: ccx-data-pipeline-clowder
description: ccx-data-pipeline app on the Insights Platform deployed via Clowder

app:
  $ref: /services/insights/ccx-data-pipeline/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.appsrep05ue1.yaml

deployResources:
  requests:
    cpu: 1500m
    memory: 700Mi
  limits:
    memory: 2Gi

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: ccx-dev-notifications

managedResourceTypes:
- ClowdApp
- ConfigMap
- HorizontalPodAutoscaler
- Service
- Frontend
- StatefulSet

imagePatterns:
- quay.io/cloudservices
- quay.io/prometheus/pushgateway
- quay.io/edge-infrastructure/redis

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all
    version: 3

resourceTemplates:
- name: ccx-data-pipeline
  path: /deploy/clowdapp.yaml
  url: https://gitlab.cee.redhat.com/ccx/ccx-data-pipeline
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: ccx-ccx-data-pipeline-gl-build-master
    parameters:
      MIN_REPLICAS: "3"
      MAX_REPLICAS: "3"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: da0c541f9774941fd8f3de9ce111cb487de616b1
    parameters:
      MIN_REPLICAS: "32"
      MAX_REPLICAS: "32"
      CPU_LIMIT: "1000m"
      MEMORY_LIMIT: "1024Mi"
      CPU_REQUEST: "500m"
      MEMORY_REQUEST: "512Mi"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true  # do not create an app-sre deploy job for ephemeral namespace
    ref: internal  # populated by bonfire
    parameters:
      MIN_REPLICAS: "1"
      LOGGING_TO_CW_ENABLED: "False"
      ALLOW_UNSAFE_LINKS: "True"
  # ephemeral deployment for OCM qaprodauth
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: ccx-ccx-data-pipeline-gl-build-master
    parameters:
      ENV_NAME: env-ocm
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "3"
      LOGGING_TO_CW_ENABLED: "False"
      ALLOW_UNSAFE_LINKS: "True"

- name: ccx-insights-results
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-results-aggregator
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    delete: false
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-gh-build-master
    parameters:
      MIN_REPLICAS: "3"
      MAX_REPLICAS: "6"
      DB_WRITER_REPLICAS: "3"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    delete: false
    ref: 63f25c91250f8f0c250d97eabec0cd3cc571e294
    parameters:
      MIN_REPLICAS: "3"
      MAX_REPLICAS: "6"
      DB_WRITER_REPLICAS: "16"
      DB_WRITER_CPU_LIMIT: "500m"
      DB_WRITER_MEMORY_LIMIT: "6000Mi"
      DB_WRITER_CPU_REQUEST: "100m"
      DB_WRITER_MEMORY_REQUEST: "3000Mi"
      IRA_CPU_LIMIT: "800m"
      IRA_MEMORY_LIMIT: "4000Mi"
      IRA_CPU_REQUEST: "400m"
      IRA_MEMORY_REQUEST: "2000Mi"
      CLOUDWATCH_ENABLED: "true"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      DB_WRITER_REPLICAS: "1"
      CLOUDWATCH_ENABLED: "false"
      PG_PARAMS: "sslmode=disable"
  # ephemeral deployment for OCM qaprodauth
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    delete: false
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-gh-build-master
    parameters:
      ENV_NAME: env-ocm
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
      DB_WRITER_REPLICAS: "1"
      CLOUDWATCH_ENABLED: "false"
      PG_PARAMS: "sslmode=disable"

- name: insights-results-smart-proxy
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-results-smart-proxy
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-smart-proxy-gh-build-master
    parameters:
      MIN_REPLICAS: "3"
      MAX_REPLICAS: "6"
      IRSP_ENABLE_INTERNAL_ORGANIZATIONS: true
      IRSP_INTERNAL_RULES_ORGANIZATIONS_CSV_FILE: "/internal-rules-organizations/internal_rules_organizations.csv"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 07f01c123e27088bcabd8deabf636bbc7deb1264
    delete: false
    parameters:
      MIN_REPLICAS: "3"
      MAX_REPLICAS: "6"
      IRSP_ENABLE_INTERNAL_ORGANIZATIONS: true
      IRSP_INTERNAL_RULES_ORGANIZATIONS_CSV_FILE: "/internal-rules-organizations/internal_rules_organizations.csv"
      AMS_API_URL: https://api.openshift.com
      DEBUG: false
      LOGGING_TO_CLOUD_WATCH_ENABLED: "true"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"
      AMS_API_URL: http://ccx-mock-ams:8000/
  # ephemeral deployment for OCM qaprodauth
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-smart-proxy-gh-build-master
    parameters:
      ENV_NAME: env-ocm
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
      IRSP_ENABLE_INTERNAL_ORGANIZATIONS: false
      IRSP_INTERNAL_RULES_ORGANIZATIONS_CSV_FILE: "NOT-USED"
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"

- name: insights-aggregator-cleaner
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-results-aggregator-cleaner
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    # Note: Automerge latest master version to STAGE env.
    #       Implementation: latest master build is deployed to STAGE.
    #       IMAGE_TAG is not needed here..
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-cleaner-gh-build-master
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 0fcb9ee504a0d409c72a5de571c434957b2a54bb
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      CLOUDWATCH_ENABLED: "false"
      PG_PARAMS: "sslmode=disable"

- name: insights-content-service
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-content-service
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-content-service-gh-build-master
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 371bc457b20d8beda74203bd540d7fd0b3440638
    delete: false
    parameters:
      CPU_LIMIT: "250m"
      MEMORY_LIMIT: "600Mi"
      CPU_REQUEST: "100m"
      MEMORY_REQUEST: "300Mi"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"
  # ephemeral deployment for OCM qaprodauth
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-content-service-gh-build-master
    parameters:
      ENV_NAME: env-ocm
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"

- name: io-gathering-service
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-operator-gathering-conditions-service
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: main
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-operator-gathering-conditions-service-gh-build-main
    parameters:
      IMAGE: "quay.io/cloudservices/io-gathering-conditions-service"
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 3d576f10660d2a646de384f99520e9fc966842c6
    parameters:
      MIN_REPLICAS: "2"
      MAX_REPLICAS: "6"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      LOGGING_TO_CLOUD_WATCH_ENABLED: "false"

- name: ccx-sha-extractor
  path: /deploy/clowdapp.yaml
  url: https://gitlab.cee.redhat.com/ccx/ccx-sha-extractor
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: ccx-ccx-sha-extractor-gl-build-master
    parameters:
      IMAGE: "quay.io/cloudservices/ccx-sha-extractor"
      MIN_REPLICAS: "3"
      MAX_REPLICAS: "3"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: e1954b357a35942bde611e89e8739bddf40e67b4
    parameters:
      MIN_REPLICAS: "3"
      MAX_REPLICAS: "6"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"

- name: insights-aggregator-exporter
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-results-aggregator-exporter
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    parameters:
      OUTPUT: "S3"
      MEMORY_REQUEST: 5Gi
      MEMORY_LIMIT: 8Gi
      ACTIVE_DEADLINE_SECONDS: "1200" # 20 minutes
      DB_NAME: ccx-insights-results
      ENABLE_ORG_ID_FILTERING: "false" # used for testing with prod data
      ORGANIZATION_IDS_CSV_FILE: "/db-exporter-organization-ids/db_exporter_organization_ids.csv"
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-exporter-gh-build-master
    promotion:
      publish:
      - insights-aggregator-exporter-stage-ready-channel
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 75534d57b10e40e3daa6d53469a8f9727ab472f8
    parameters:
      ENABLE_ORG_ID_FILTERING: "true" # used for testing with prod data
      ORGANIZATION_IDS_CSV_FILE: "/db-exporter-organization-ids/db_exporter_organization_ids.csv"
      OUTPUT: "S3"
      MEMORY_REQUEST: 8G
      MEMORY_LIMIT: 16G
      TABLES_TO_IGNORE: ""
      ACTIVE_DEADLINE_SECONDS: "12000" # 200 minutes
      DB_NAME: ccx-insights-results
      TEST_DATE: 04/05/2023
      SELECT_LIMIT: "-1"
    promotion:
      publish:
      - insights-aggregator-exporter-prod-ready-channel
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      OUTPUT: "file"
      DB_NAME: ccx-insights-results
      PG_PARAMS: "sslmode=disable"

### CCX Notification Services

- name: ccx-notification-writer
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/ccx-notification-writer
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-ccx-notification-writer-gh-build-master
    parameters:
      IMAGE: "quay.io/cloudservices/ccx-notification-writer"
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 5c370f702b6dbba82c10e5a2ce83e95d0ee632ed
    parameters:
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
      DB_MIGRATION_VERSION: "latest"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      MIN_REPLICAS: "1"
      MAX_REPLICAS: "1"
      PG_PARAMS: "sslmode=disable"

- name: ccx-notification-db-cleaner
  path: /deploy/clowdapp-db-cleaner.yaml
  url: https://github.com/RedHatInsights/ccx-notification-writer
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-ccx-notification-writer-gh-build-master
    parameters:
      IMAGE: "quay.io/cloudservices/ccx-notification-writer"
      JOB_SCHEDULE: "0 * * * *"
      OLD_REPORTS_MAX_AGE: '8 days'
      NEW_REPORTS_MAX_AGE: '8 days'
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    disable: false
    ref: 5c370f702b6dbba82c10e5a2ce83e95d0ee632ed
    parameters:
      JOB_SCHEDULE: "0 */3 * * *"
      OLD_REPORTS_MAX_AGE: '8 days'
      NEW_REPORTS_MAX_AGE: '8 days'
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      PG_PARAMS: "sslmode=disable"

- name: ccx-notification-service
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/ccx-notification-service
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-ccx-notification-service-gh-build-master
    parameters:
      IMAGE: "quay.io/cloudservices/ccx-notification-service"
      CONTENT_SERVICE_PORT: 10000
      JOB_SCHEDULE__NOTIFICATION_BACKEND: "*/3 * * * *"
      JOB_SCHEDULE__SERVICE_LOG: "4-59/3 * * * *"
      NOTIFICATION_RESEND_COOLDOWN_NOTIFICATION_BACKEND: "24 hours"
      NOTIFICATION_RESEND_COOLDOWN_SERVICE_LOG: "1 hours"
      PLATFORM_UI_HOSTNAME: console.stage.redhat.com
      TEMPLATE_RENDERER_SERVER: "http://insights-content-template-renderer-svc:8000/"
      SERVICE_LOG__URL: "https://api.stage.openshift.com/api/service_logs/v1/cluster_logs"
      LOG_LEVEL: "debug"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 579c1bc04213607f9b518b6025a28966def97458
    parameters:
      CONTENT_SERVICE_PORT: 10000
      JOB_SCHEDULE__NOTIFICATION_BACKEND: "*/15 * * * *"
      JOB_SCHEDULE__SERVICE_LOG: "8-59/15 * * * *"
      NOTIFICATION_RESEND_COOLDOWN_NOTIFICATION_BACKEND: "1 week"
      NOTIFICATION_RESEND_COOLDOWN_SERVICE_LOG: "1 week"
      PLATFORM_UI_HOSTNAME: console.redhat.com
      TEMPLATE_RENDERER_SERVER: "http://insights-content-template-renderer-svc:8000/"
      SERVICE_LOG__URL: "https://api.openshift.com/api/service_logs/v1/cluster_logs"
      JOB_DEADLINE__SERVICE_LOG: "36000"
      SUSPEND_JOB__SERVICE_LOG: "false"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      CONTENT_SERVICE_PORT: 10000
      JOB_SCHEDULE: "*/3 * * * *"
      NOTIFICATION_RESEND_COOLDOWN: "29m"
      PLATFORM_UI_HOSTNAME: console.redhat.com
      PG_PARAMS: "sslmode=disable"

- name: insights-notification-db-exporter
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-results-aggregator-exporter
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    disable: true
    ref: master
    parameters:
      OUTPUT: "S3"
      MEMORY_REQUEST: 5Gi
      MEMORY_LIMIT: 8Gi
      ACTIVE_DEADLINE_SECONDS: "1200" # 20 minutes
      TABLES_TO_IGNORE: "migration_info,notification_types,states,event_targets,reported"
      SELECT_LIMIT: "100"
      DB_NAME: ccx-notification-writer
      TEST_DATE: 07/04/2023
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-exporter-gh-build-master
    promotion:
      publish:
      - insights-notification-exporter-stage-ready-channel
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    disable: true
    ref: 75534d57b10e40e3daa6d53469a8f9727ab472f8
    parameters:
      OUTPUT: "S3"
      MEMORY_REQUEST: 5Gi
      MEMORY_LIMIT: 8Gi
      ACTIVE_DEADLINE_SECONDS: "10800" # 180 minutes
      TABLES_TO_IGNORE: "migration_info,notification_types,states,event_targets"
      DB_NAME: ccx-notification-writer
      SELECT_LIMIT: "-1"
      TEST_DATE: 01/12/2023
    promotion:
      publish:
      - insights-notification-exporter-prod-ready-channel
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
    parameters:
      OUTPUT: "file"
      DB_NAME: ccx-notification-writer
      PG_PARAMS: "sslmode=disable"

- name: insights-content-template-renderer
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-content-template-renderer
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-content-template-renderer-gh-build-master
    parameters:
      LOG_LEVEL: INFO
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: b6d2564429f2523ab6b7fe81dd92144402544597
    parameters:
      LOG_LEVEL: INFO
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    parameters:
      LOGGING_TO_CW_ENABLED: 'False'
    disable: true # TODO: enable when there is any test running in ephemeral
    ref: internal

### CCX Upgrade Risks Predictions related services

- name: ccx-upgrades-inference
  path: /deploy/clowdapp.yaml
  url: https://gitlab.cee.redhat.com/ccx/ccx-upgrades-inference
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: main
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: ccx-ccx-upgrades-inference-gl-build-main
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 62ebe91b7262bc5c99b28d7132451be7e40ba60e
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    parameters:
      LOGGING_TO_CW_ENABLED: 'False'
    ref: internal
    disable: true  # do not create an app-sre deploy job for ephemeral namespace

- name: ccx-upgrades-data-eng
  path: /deploy/clowdapp.yaml
  url: https://gitlab.cee.redhat.com/ccx/ccx-upgrades-data-eng
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: main
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: ccx-ccx-upgrades-data-eng-gl-build-main
    parameters:
      RHOBS_QUERY_MAX_MINUTES_FOR_DATA: "120"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: b0fad7f76516a896f897a7dd9ce9d0e249dde3e2
    parameters:
      RHOBS_URL: https://observatorium.api.openshift.com
      RHOBS_QUERY_MAX_MINUTES_FOR_DATA: "120"
      CACHE_ENABLED: "1"
      CACHE_TTL: "300"
      CACHE_SIZE: "10000"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    parameters:
      RHOBS_URL: http://rhobs-mock-svc:8080
      RHOBS_QUERY_MAX_MINUTES_FOR_DATA: "120"
      RH_SSO_URL: http://sso-mock-svc:8080/default
      ALLOW_INSECURE: 'True'
      LOGGING_TO_CW_ENABLED: 'False'
    ref: internal
    disable: true  # do not create an app-sre deploy job for ephemeral namespace

# It contains ccx-redis and cache-writer
- name: ccx-redis
  path: /deploy/cache-writer.yaml
  url: https://github.com/RedHatInsights/insights-results-aggregator
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-results-aggregator-gh-build-master
    parameters:
      REDIS_STORAGE: "2Gi"
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 63f25c91250f8f0c250d97eabec0cd3cc571e294
    parameters:
      REDIS_STORAGE: "2Gi"
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    parameters:
      REDIS_STORAGE: "2Gi"
    ref: internal
    disable: true  # do not create an app-sre deploy job for ephemeral namespace

- name: ccx-upgrades-sso-mock
  path: /deploy/sso-mock.yaml
  url: https://gitlab.cee.redhat.com/ccx/ccx-upgrades-data-eng
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    ref: internal
    disable: true  # do not create an app-sre deploy job for ephemeral namespace


- name: ccx-upgrades-rhobs-mock
  path: /deploy/clowdapp.yaml
  url: https://gitlab.cee.redhat.com/ccx/rhobs-mock
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    ref: internal
    disable: true  # do not create an app-sre deploy job for ephemeral namespace

### CCX Helpers

- name: ccx-kafka-monitor
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/insights-kafka-monitor
  targets:
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/stage-ccx-data-pipeline-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-insights-kafka-monitor-gh-build-master
  - namespace:
      $ref: /services/insights/ccx-data-pipeline/namespaces/ccx-data-pipeline-prod.yml
    ref: 22730da7317411b6db2953d426179a7169342f3e


### Grafana Dashboards

- name: grafana-dashboard-ccx-data-pipeline
  url: https://gitlab.cee.redhat.com/ccx/ccx-data-pipeline
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: ed0f0c8006172b4a3b7a5d4b99cc6b81f68aaee6

- name: grafana-dashboard-insights-content-service
  url: https://github.com/RedHatInsights/insights-content-service
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: cefc7fd75fc7bf1cc51b33e9b02224c16e731b41

- name: grafana-dashboard-insights-results-aggregator
  url: https://github.com/RedHatInsights/insights-results-aggregator
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: e7cb6f939526823bcb33000b74a8b6d5c8a66660

- name: grafana-dashboard-insights-results-smart-proxy
  url: https://github.com/RedHatInsights/insights-results-smart-proxy
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: aae154c18e3b6b0bbf3f04f9032cf4b20c9f476b

- name: grafana-dashboard-ccx-notification-service
  url: https://github.com/RedHatInsights/ccx-notification-service
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: c49bf36eb7ef57b7eda0dd5f0d8896d2f568c7fc

- name: grafana-dashboard-ccx-notification-writer
  url: https://github.com/RedHatInsights/ccx-notification-writer
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: f5de84a20cd3a1de53ea9c361fa8a92fd9c900bb

- name: grafana-dashboard-io-gathering-service
  url: https://github.com/RedHatInsights/insights-operator-gathering-conditions-service
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: main
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: ab3facbc9fabc365bd92775605cc62d6b3509bc7

- name: grafana-dashboard-insights-sha-extractor
  url: https://gitlab.cee.redhat.com/ccx/ccx-sha-extractor
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: ee1877e7d8f8d447522209bc9feb62a2ec11e394

- name: grafana-dashboard-ccx-upgrades
  url: https://gitlab.cee.redhat.com/ccx/ccx-upgrades-data-eng
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: main
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: d7f19fb714b20601598f9d039a44aa45baf6f203

- name: grafana-dashboard-insights-content-template-renderer
  url: https://github.com/RedHatInsights/insights-content-template-renderer
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: 1b280a911654503978e117601a3ba841d4b96b30

### OCP Advisor Frontend

- name: ocp-advisor-frontend
  path: /deploy/frontend.yml
  url: https://github.com/RedHatInsights/ocp-advisor-frontend
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: internal
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/consoledot-frontend-stage.yml
    ref: b653a5fb4873330f236012069b1f64a2a6a96500
    parameters:
      ENV_NAME: env-stage


### Mock services. Do NOT add a prod target

- name: ccx-mock-ams
  path: /deploy/clowdapp.yaml
  url: https://gitlab.cee.redhat.com/ccx/mock-ams
  targets:
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true
    ref: main
    parameters:
      IMAGE_TAG: latest  # pin to latest to not worry about failed builds
