---
$schema: /app-sre/saas-file-2.yml

labels:
  service: playbook-dispatcher
  platform: insights

name: playbook-dispatcher-perf
description: The Playbook Dispatcher service enables other services to run Ansible Playbooks on connected hosts

app:
  $ref: /services/insights/playbook-dispatcher/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.appsrep05ue1.yaml
# NOTE jsmejkal: probably outputed here: https://redhat-internal.slack.com/archives/C01B85699P0

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: team-clouddot-info

managedResourceTypes:
- ClowdApp
- ClowdJobInvocation
- Deployment
- KafkaConnect
- KafkaConnector
- Service
- ConfigMap
- CronJob

imagePatterns:
- quay.io/cloudservices

#TODO ????
allowedSecretParameterPaths:
# - insights/secrets/perf/strimzi-perf
- insights/secrets/perf/playbook-dispatcher-perf
- insights/secrets/insights-dev/cloud-connector-perf

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all
    version: 3

resourceTemplates:
- name: playbook-dispatcher
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/playbook-dispatcher
  targets:
  - namespace:
      $ref: /services/insights/playbook-dispatcher/namespaces/perf.yml
    ref: master
    parameters:
      LOG_LEVEL: debug
      RETURN_URL: https://cert.${PLATFORM_HOSTNAME}/api/ingress/v1/upload


- name: playbook-dispatcher-connect
  path: /deploy/connect.yaml
  url: https://github.com/RedHatInsights/playbook-dispatcher
  targets:
  - namespace:
      $ref: /services/insights/playbook-dispatcher/namespaces/perf.yml
    # ref: master
    # parameters:
    #   CONNECTOR_PAUSE: "false"
    #   KAFKA_TOPIC_PREFIX: "platform-mq-perf."
    
    ref: b3dd2e00863770bcc034b28968762a9282f120bb
    # ref: 949b75abac83bd74d4f3a03ab5d05d440be9cfd3
    # NOTE:  The ref above "pins" the deployment config to a version of the config
    # which is NOT configured to use managed kakfa.  This config currently lives
    # in the "prod_connector_config" branch on
    # github.com/RedHatInsights/playbook-dispatcher.
    parameters:
      IMAGE_TAG: 60cd5caa
      # IMAGE_TAG: 6011d85
      # NOTE:  The IMAGE_TAG allows us to use a newer image, while the ref above allows
      # us to use an older config (which is not configured to use managed kafka).
      EVENT_CONSUMER_REPLICAS: 0
      CONNECTOR_PAUSE: "false"
      KAFKA_TOPIC_PREFIX: "platform-mq-perf."

    # secretParameters:
    #   - name: KAFKA_BOOTSTRAP_HOST
    #     secret:
    #       path: insights/secrets/insights-stage/strimzi-stage/clowder-auth
    #       field: hostname
    #       version: 1
    #   - name: KAFKA_BOOTSTRAP_PORT
    #     secret:
    #       path: insights/secrets/insights-stage/strimzi-stage/clowder-auth
    #       field: port
    #       version: 1
    #   - name: KAFKA_USERNAME
    #     secret:
    #       path: insights/secrets/insights-stage/strimzi-stage/clowder-auth
    #       field: username
    #       version: 1
    #   - name: KAFKA_SASL_MECHANISM
    #     secret:
    #       path: insights/secrets/insights-stage/strimzi-stage/client-config
    #       field: sasl_mechanism
    #       version: 3
    #   - name: KAFKA_SASL_SECURITY_PROTOCOL
    #     secret:
    #       path: insights/secrets/insights-stage/strimzi-stage/client-config
    #       field: security_protocol
    #       version: 3

