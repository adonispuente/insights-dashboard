---
$schema: /dependencies/jenkins-config-1.yml

labels:
  service: automation-hub

name: ci-ext-automation-hub-jobs
description: automation-hub ci-ext jobs

app:
  $ref: /services/insights/automation-hub/app.yml

instance:
  $ref: /dependencies/ci-ext/ci-ext.yml

type: jobs

config:
- project:
    name: galaxy_ng
    label: insights
    node: insights
    gh_org: ansible
    gh_repo: galaxy_ng
    quay_org: cloudservices
    jobs:
    - "insights-gh-pr-check":
        display_name: galaxy_ng pr-check
        branch: master
    - "insights-gh-build-master":
        display_name: galaxy_ng build-master
        branch: master
    - "insights-gh-build-master":
        display_name: galaxy_ng build-stable
        branch: stable
- project:
    name: automation-hub-nginx
    label: insights
    node: insights
    gh_org: ansible
    gh_repo: automation-hub-deploy
    quay_org: cloudservices
    jobs:
    - "insights-gh-build-master":
        display_name: automation-hub-nginx build
        branch: master
- project:
    name: ansible-test
    label: insights
    node: insights
    gh_org: ansible
    gh_repo: galaxy-importer
    quay_org: cloudservices
    jobs:
    - "insights-gh-build-master":
        display_name: ansible-test build
        branch: master
- job: 
    name: automation-hub-ephemeral
    label: insights
    node: insights
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
    parameters:
    - string:
        name: APP_NAME
        default: automation-hub
        description: "(REQUIRED) name of app-sre 'application' folder this component lives in"
    - string:
        name: COMPONENT_NAME
        default: automation-hub
        description: "(REQUIRED) name of app-sre 'resourceTemplate' in deploy.yaml for this component"
    - string:
        name: IMAGE
        default: "quay.io/cloudservices/automation-hub-galaxy-ng"
        description: "(REQUIRED) image location on quay"
    - string:
        name: COMPONENTS
        default: ""
        description: "(optional, default: all) space separated components to deploy"
    - string:
        name: COMPONENTS_W_RESOURCES
        default: "all"
        description: "(optional, default: none) space separated components which should preserve resource settings"
    - string:
        name: DEPLOY_TIMEOUT
        default: ""
        description: "(optional, default: 300) bonfire deployment timeout parameter in seconds"
    - string:
        name: GIT_COMMIT_INPUT
        default: 7a70ff118ad599cb29503d56c8caf8e550ecb5fc
        description: "(REQUIRED) full git commit hash of the version being tested"
    - string:
        name: IMAGE_TAG_INPUT
        default: 7a70ff1
        description: "(optional, default matches GIT_COMMIT_INPUT) image tag for the version being tested"
    - choice:
        name: RESERVATION_DURATION
        choices:
          - 1
          - 2
        description: "Number of hours to reserve the environment for"
    builders:
    - shell: |
        #!/bin/bash

        echo "Job started by user: $BUILD_USER, id: $BUILD_USER_ID"

        CICD_URL=https://raw.githubusercontent.com/RedHatInsights/bonfire/master/cicd
        curl -s "$CICD_URL/bootstrap.sh" > .cicd_bootstrap.sh
        source .cicd_bootstrap.sh

        export GIT_COMMIT=$GIT_COMMIT_INPUT
        if [ ! -z "$IMAGE_TAG_INPUT" ]; then
            export IMAGE_TAG=$(echo $GIT_COMMIT_INPUT | head -c7)
        else
            export IMAGE_TAG=$IMAGE_TAG_INPUT
        fi

        # source $CICD_ROOT/deploy_ephemeral_env.sh
        source $CICD_ROOT/_common_deploy_logic.sh
        export NAMESPACE=$(bonfire namespace reserve -d $RESERVATION_DURATION)

        echo "Deploying $APP_NAME to $NAMESPACE"

        bonfire deploy \
            $APP_NAME \
            --source=appsre \
            --ref-env insights-stage \
            --set-template-ref $COMPONENT_NAME=$GIT_COMMIT \
            --set-image-tag $IMAGE=$IMAGE_TAG \
            --namespace $NAMESPACE \
            --timeout $DEPLOY_TIMEOUT \
            $COMPONENTS_ARG \
            $COMPONENTS_RESOURCES_ARG \
            --set-parameter "$COMPONENT_NAME/IMPORTER_JOB_NAMESPACE=$NAMESPACE"
