---
$schema: /app-sre/saas-file-1.yml

labels:
  service: turnpike
  platform: insights

name: turnpike
description: Turnpike API Gateway

app:
  $ref: /services/insights/turnpike/app.yml

instance:
  $ref: /dependencies/ci-int/ci-int.yml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: team-clouddot-info

managedResourceTypes:
- Deployment
- Service
- ConfigMap

imagePatterns:
- quay.io/cloudservices

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all

resourceTemplates:
- name: nginx
  path: /templates/nginx.yml
  url: https://github.com/RedHatInsights/turnpike
  parameters:
    ALLOWED_ROUTES: '["public", "api", "app", "docs"]'
  targets:
  - namespace:
      $ref: /services/insights/turnpike/namespaces/stage-turnpike-stage.yml
    ref: master
    upstream: RedHatInsights-turnpike-gh-build-master
    parameters:
      FLASK_SERVER_NAME: internal.cloud.stage.redhat.com
      FLASK_SERVICE_URL: http://web.turnpike-stage.svc.cluster.local:5000
      NGINX_SERVER_NAME: internal.cloud.stage.redhat.com
  - namespace:
      $ref: /services/insights/turnpike/namespaces/prod-turnpike-prod.yml
    ref: master
    parameters:
      IMAGE_TAG: f450147
      FLASK_SERVER_NAME: internal.cloud.redhat.com
      FLASK_SERVICE_URL: http://web.turnpike-prod.svc.cluster.local:5000
      NGINX_SERVER_NAME: internal.cloud.redhat.com
- name: web
  path: /templates/web.yml
  url: https://github.com/RedHatInsights/turnpike
  targets:
  - namespace:
      $ref: /services/insights/turnpike/namespaces/stage-turnpike-stage.yml
    ref: master
    upstream: RedHatInsights-turnpike-gh-build-master
    parameters:
      AUTH_DEBUG: "1"
      FLASK_SERVER_NAME: internal.cloud.stage.redhat.com
      REDIS_SERVICE_NAME: redis.turnpike-stage.svc.cluster.local
      SETTINGS_JSON: |
        {
          "strict": true,
          "debug": true,
          "sp": {
            "entityId": "https://internal.cloud.stage.redhat.com/saml/metadata.xml",
            "assertionConsumerService": {
              "url": "https://internal.cloud.stage.redhat.com/saml/acs/",
              "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
            },
            "singleLogoutService": {
              "url": "https://internal.cloud.stage.redhat.com/saml/sls/",
              "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
            },
            "NameIDFormat": "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified"
          },
          "idp": {
            "entityId": "https://auth.stage.redhat.com/auth/realms/EmployeeIDP",
            "singleSignOnService": {
              "url": "https://auth.stage.redhat.com/auth/realms/EmployeeIDP/protocol/saml",
              "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
            },
            "singleLogoutService": {
              "url": "https://auth.stage.redhat.com/auth/realms/EmployeeIDP/protocol/saml",
              "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
            },
            "x509cert": "MIIE+zCCA+OgAwIBAgIED/4AJTANBgkqhkiG9w0BAQsFADBBMRAwDgYDVQQKDAdSZWQgSGF0MQ0wCwYDVQQLDARwcm9kMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHhcNMTcwNjIwMTI1MTEwWhcNMjIwNjE5MTI1MTEwWjCBqjELMAkGA1UEBhMCVVMxFzAVBgNVBAgMDk5vcnRoIENhcm9saW5hMRAwDgYDVQQHDAdSYWxlaWdoMRYwFAYDVQQKDA1SZWQgSGF0LCBJbmMuMQwwCgYDVQQLDANJQU0xIzAhBgNVBAMMGlJlZCBIYXQgU3RhZ2UgRW1wbG95ZWUgU1NPMSUwIwYJKoZIhvcNAQkBFhZzZXJ2aWNlZGVza0ByZWRoYXQuY29tMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAwKVe5MH66uvRvs7NnVNrhlEwd45kJmaen5Digf4PcB8IxY4a9MrXD7xuhTPPZuNX0lLNuWDvBkQNzY0DwsHvLW3mTAZLnQG90EWMFWziQJfSAQ60epGkSlMkd4IL9HUuZa2/tGDy9Bt5pdSfqhrbAA932Zg1BGCL9cY20lfc+4arqY1qUyMkMz210RG3yLWq80dXKD8ziEeRbzGv8V1HBJE0M15GsKxcfD/tzx95E3WTcGxJJhqnFFEEdVgB/yvMM4E2WlyI+XWmHhIe2NCmhofD7wdOokpuAKhgdIUlsKi79o760F123DbzWk7sprErG6p0VkJ+LZESv8/mqtlEXHz8zgzTkDhlUH3IJm829ouGXFSRoRDEea6We8VHJbLODSAlIeAAXylnsg9czVdnkXqBBnnHkeERblpccTfMysTFWYMeTykHIitnINBoTOz/7jLNf/TgvTFwHHL6TvD5TSq5FsID9YJ60kyucqWELEVt18VMgy3O8HA4B4kxL4hpSoO+7a2ahOROTvdDEP2ZyE7jsIL4mmSUrsEthM+9jFIPRjDHJD40uTbHEXhImKFPQ3nqHi8SgI4qSoZ5YE+3RO1ZnqtMoSP1C6TvPKo0ymH9xWXpvAmyX5afcKNXD00wcjgAgRkF0oAbSp4IuAO7Zw6wNCKDuc5HmGgW29FSifECAwEAAaOBkDCBjTAfBgNVHSMEGDAWgBR72gn1SV3Z11zJNvhV0huXnhEvfjA7BggrBgEFBQcBAQQvMC0wKwYIKwYBBQUHMAGGH2h0dHA6Ly9vY3NwLnJlZGhhdC5jb20vY2Evb2NzcC8wDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjANBgkqhkiG9w0BAQsFAAOCAQEARAXHV66CAJp8MqvNBw+/I1DRmnpF0J+LDlGBHgYPNJfVSJwVsZVTcQz+0RT267pNJ7grg3iXbiGXf3tA4CAePxBalQM81GwQcHebbQ0ndFEw4TJEBwTx+q9CoIDGt4HH9qPAIZMYFmzZxgToWAyJXuGCfENtHtYWKbfnSZHbMs1Ern8AM3YmP9g7sFzqBkZLjE07LytmkFBx9DOJBdU48IVpCFCrDpyQ49pU/aLYEKWJlCLdbDxDHVPbt6DVQqf6occXOMcg5mDYOTUmMECiADPEojVuOZ9+Qegtd/NA8AZgzX0EAcUxhJqJ+oIGAbQ8lzN1mMc7EqQYLeXOnlA01A=="
          }
        }
      ADVANCED_SETTINGS_JSON: |
        {
          "security": {
            "nameIdEncrypted": false,
            "authnRequestsSigned": true,
            "logoutRequestSigned": false,
            "logoutResponseSigned": false,
            "signMetadata": false,
            "wantMessagesSigned": false,
            "wantAssertionsSigned": false,
            "wantNameId" : true,
            "wantNameIdEncrypted": false,
            "wantAssertionsEncrypted": false,
            "signatureAlgorithm": "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256",
            "digestAlgorithm": "http://www.w3.org/2001/04/xmlenc#sha256"
          },
          "contactPerson": {
            "technical": {
              "givenName": "Cloud Services Platform Infrastructure",
                  "emailAddress": "clouddot-infrastructure@redhat.com"
              },
              "support": {
                  "givenName": "Cloud Services Platform Infrastructure",
                  "emailAddress": "clouddot-infrastructure@redhat.com"
              }
          },
          "organization": {
            "en-US": {
              "name": "Red Hat Cloud Services Platform Staging",
              "displayname": "RH CSP Stage",
              "url": "https://cloud.redhat.com/"
            }
          }
        }
      BACKEND_ROUTES: |
        - name: turnpike
          route: /api/turnpike
          origin: http://web.turnpike-stage.svc.cluster.local:5000/api/turnpike
          auth:
            saml: "True"
            x509: "True"
        - name: healthcheck
          route: /public/healthcheck/
          origin: http://web.turnpike-stage.svc.cluster.local:5000/_healthcheck/
        - name: platform-docs
          route: /docs/
          origin: http://platform-docs.platform-docs-stage.svc.cluster.local/
          auth:
            saml: "True"
        - name: rhsm-subscriptions
          route: /app/rhsm-subscriptions/actuator
          origin: http://rhsm-subscriptions-worker-monitoring.rhsm-stage.svc.cluster.local:8080/actuator
          auth:
            saml: "'subscription-watch-admins' in user['Role']"
            x509: "x509['subject_dn'] == '/DC=com/DC=redhat/OU=messaging/OU=serviceusers/UID=msg-subscription-watch-turnpike/L=stage/CN=msg-subscription-watch-turnpike'"
        - name: rhsm-conduit
          route: /app/rhsm-conduit/actuator
          origin: http://rhsm-conduit.rhsm-stage.svc.cluster.local:8080/actuator
          auth:
            saml: "'subscription-watch-admins' in user['Role']"
            x509: "x509['subject_dn'] == '/DC=com/DC=redhat/OU=messaging/OU=serviceusers/UID=msg-subscription-watch-turnpike/L=stage/CN=msg-subscription-watch-turnpike'"
        - name: policies-engine-stage
          route: /api/policies-engine/
          origin: http://policies-engine.policies-stage.svc.cluster.local:8080/
          auth:
            saml: "'crc-policies-team' in user['Role']"
        - name: policies-ui-backend-stage
          route: /api/policies-ui-backend/
          origin: http://policies-ui-backend.policies-stage.svc.cluster.local:8080/
          auth:
            saml: "'crc-policies-team' in user['Role']"
        - name: cost-management-masu-download
          route: /api/cost-management/v1/download/
          origin: http://koku-masu.hccm-stage.svc.cluster.local:8080/api/cost-management/v1/download/
          auth:
            saml: "'cost-management-team' in user['Role']"
        - name: cost-management-masu-resummary
          route: /api/cost-management/v1/report_data/
          origin: http://koku-masu.hccm-stage.svc.cluster.local:8080/api/cost-management/v1/report_data/
          auth:
            saml: "'cost-management-team' in user['Role']"
        - name: cost-management-masu-acct-hierarchy
          route: /api/cost-management/v1/crawl_account_hierarchy/
          origin: http://koku-masu.hccm-stage.svc.cluster.local:8080/api/cost-management/v1/crawl_account_hierarchy/
          auth:
            saml: "'cost-management-team' in user['Role']"
        - name: cost-management-koku-daily-ui
          route: /api/cost-management/v1/koku-daily
          origin: http://koku-daily.hccm-stage.svc.cluster.local:8080/api/cost-management/v1/koku-daily
          auth:
            saml: "'cost-management-team' in user['Role']"
        - name: module-update-router-events
          route: /api/module-update-router/v1/event
          origin: http://module-update-router.module-update-router-stage.svc.cluster.local:8080/api/module-update-router/v1/event
          auth:
            saml: "'clouddot-data' in user['Role']"
        - name: rbac
          route: /api/rbac
          origin: http://${RBAC_HOST}:8080/_private/api
          auth:
            saml: "'clouddot-infrastructure' in user['Role']"
  - namespace:
      $ref: /services/insights/turnpike/namespaces/prod-turnpike-prod.yml
    ref: master
    parameters:
      IMAGE_TAG: f450147
      FLASK_SERVER_NAME: internal.cloud.redhat.com
      REDIS_SERVICE_NAME: redis.turnpike-prod.svc.cluster.local
      SETTINGS_JSON: |
        {
          "strict": true,
          "debug": true,
          "sp": {
            "entityId": "https://internal.cloud.redhat.com/saml/metadata.xml",
            "assertionConsumerService": {
              "url": "https://internal.cloud.redhat.com/saml/acs/",
              "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
            },
            "singleLogoutService": {
              "url": "https://internal.cloud.redhat.com/saml/sls/",
              "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
            },
            "NameIDFormat": "urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified"
          },
          "idp": {
            "entityId": "https://auth.redhat.com/auth/realms/EmployeeIDP",
            "singleSignOnService": {
              "url": "https://auth.redhat.com/auth/realms/EmployeeIDP/protocol/saml",
              "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
            },
            "singleLogoutService": {
              "url": "https://auth.redhat.com/auth/realms/EmployeeIDP/protocol/saml",
              "binding": "urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect"
            },
            "x509cert": "MIIE+jCCA+KgAwIBAgIED/4AJzANBgkqhkiG9w0BAQsFADBBMRAwDgYDVQQKDAdSZWQgSGF0MQ0wCwYDVQQLDARwcm9kMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHhcNMTcwNjIwMTI1MTQwWhcNMjIwNjE5MTI1MTQwWjCBqTELMAkGA1UEBhMCVVMxFzAVBgNVBAgMDk5vcnRoIENhcm9saW5hMRAwDgYDVQQHDAdSYWxlaWdoMRYwFAYDVQQKDA1SZWQgSGF0LCBJbmMuMQwwCgYDVQQLDANJQU0xIjAgBgNVBAMMGVJlZCBIYXQgUHJvZCBFbXBsb3llZSBTU08xJTAjBgkqhkiG9w0BCQEWFnNlcnZpY2VkZXNrQHJlZGhhdC5jb20wggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQC089RqFDc8mGgKpKy9ZOdH+arhvDg94+kGCNCVFXNQFnBbmxwodtRnF0r2pGFfd+Yw7PRU3cfgD7WVq6cInPnpuVAU3H0+Fni+RrzeoKs2O2WvmVBmxFK4JQ7bzeAnfTd92pCGaua95VnfgqVRt6FzL+bvWc/3YCr+KcgI3lcOZdEPJ3/WMOXWhPpcKYRo7rsu/vI9R19NBHwN+/DjyWeq6kVLp1tjdA07RgcihqeZ5f3BqjcMuKhcEQVjwiwcqKbSUBW2VCJ5YKXmOv1R6asjHMJsiRPBWSPIzhAyhw0GGXvM6F8q3w0EExUDOet08Ffl1Sl73paoKcNQ7hR9ljobpsy7Hhq0j4Ink0XR+pSVUQT+yCeyO4aaSxOc+75CAzvqvMSLrUP+UST0sW+1mv0jCvWJabng63isNyHx0aLTC8p9MWOxskNBZ6ce3+n70kGk3cMbhveAB/RgMs232XhUKcJApsuGjPL83vhE9n23t15IXuv+2X68ECGuoGW4VNq7Diq3QoZSHAa2gwa9bcLYRoOgGtWdysQ++Kks+XXPgL4UHcKWULKJlzOh20Jypi9N2KBU5IGccRve1jCfIQ0w246aRfTthsUF62vMD6T28e5XHijBPlNPAA+Vx3uCECZYpAksmyqK+wuUscOAH3FW0yrbSftROjzNvd0/wpnwXQIDAQABo4GQMIGNMB8GA1UdIwQYMBaAFHvaCfVJXdnXXMk2+FXSG5eeES9+MDsGCCsGAQUFBwEBBC8wLTArBggrBgEFBQcwAYYfaHR0cDovL29jc3AucmVkaGF0LmNvbS9jYS9vY3NwLzAOBgNVHQ8BAf8EBAMCBPAwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUFBwMCMA0GCSqGSIb3DQEBCwUAA4IBAQDBPTR0hAB/LTUWzi5jOG8Ni54gl6GDu/klaoOXjXzOUJY4keiNKKytyec9nEhUrUfuSMXGrteGnUc+8xq1WNmY9qHeaKHU2u8wsA8ekvmhSx550qZ1nocOumbswNKzSknTU9l1TH/GONgZwW99xxpbAmj6g7CjrsfQ2mESNkEzTT373eRUJriz/AgfxxgSyvBoxbNPx6IoekNUL8d/kHy1Jd7rOXbqBmYjeI7tMtidzezWDFAJkoQ05I3pDYvJfL999pYj/ykbqHg8Hkv/P+zLWSUuoI8ReIUCQDIO57+PTUMM9q7LwMX/viyym6jv2dKzDTGrB3AEYkRbBKxKng+u"
          }
        }
      ADVANCED_SETTINGS_JSON: |
        {
          "security": {
            "nameIdEncrypted": false,
            "authnRequestsSigned": true,
            "logoutRequestSigned": false,
            "logoutResponseSigned": false,
            "signMetadata": false,
            "wantMessagesSigned": false,
            "wantAssertionsSigned": false,
            "wantNameId" : true,
            "wantNameIdEncrypted": false,
            "wantAssertionsEncrypted": false,
            "signatureAlgorithm": "http://www.w3.org/2001/04/xmldsig-more#rsa-sha256",
            "digestAlgorithm": "http://www.w3.org/2001/04/xmlenc#sha256"
          },
          "contactPerson": {
            "technical": {
                  "givenName": "Cloud Services Platform Infrastructure",
                  "emailAddress": "clouddot-infrastructure@redhat.com"
              },
              "support": {
                  "givenName": "Cloud Services Platform Infrastructure",
                  "emailAddress": "clouddot-infrastructure@redhat.com"
              }
          },
          "organization": {
            "en-US": {
              "name": "Red Hat Cloud Services Platform",
              "displayname": "RH CSP",
              "url": "https://cloud.redhat.com/"
            }
          }
        }
      BACKEND_ROUTES: |
        - name: turnpike
          route: /api/turnpike
          origin: http://web.turnpike-prod.svc.cluster.local:5000/api/turnpike
          auth:
            saml: "True"
        - name: healthcheck
          route: /public/healthcheck/
          origin: http://web.turnpike-prod.svc.cluster.local:5000/_healthcheck/
        - name: platform-docs
          route: /docs/
          origin: http://platform-docs.platform-docs-prod.svc.cluster.local/
          auth:
            saml: "True"
        - name: rhsm-subscriptions
          route: /app/rhsm-subscriptions/actuator
          origin: http://rhsm-subscriptions-worker-monitoring.rhsm-prod.svc.cluster.local:8080/actuator
          auth:
            saml: "'subscription-watch-admins' in user['Role']"
        - name: rhsm-conduit
          route: /app/rhsm-conduit/actuator
          origin: http://rhsm-conduit.rhsm-prod.svc.cluster.local:8080/actuator
          auth:
            saml: "'subscription-watch-admins' in user['Role']"
        - name: rbac
          route: /api/rbac
          origin: http://${RBAC_HOST}:8080/_private/api
          auth:
            saml: "'clouddot-infrastructure' in user['Role']"
        - name: cost-management-masu-download
          route: /api/cost-management/v1/download/
          origin: http://koku-masu.hccm-prod.svc.cluster.local:8080/api/cost-management/v1/download/
          auth:
            saml: "'cost-management-team' in user['Role']"
        - name: cost-management-masu-resummary
          route: /api/cost-management/v1/report_data/
          origin: http://koku-masu.hccm-prod.svc.cluster.local:8080/api/cost-management/v1/report_data/
          auth:
            saml: "'cost-management-team' in user['Role']"
        - name: cost-management-masu-acct-hierarchy
          route: /api/cost-management/v1/crawl_account_hierarchy/
          origin: http://koku-masu.hccm-prod.svc.cluster.local:8080/api/cost-management/v1/crawl_account_hierarchy/
          auth:
            saml: "'cost-management-team' in user['Role']"
        - name: cost-management-koku-daily-ui
          route: /api/cost-management/v1/koku-daily
          origin: http://koku-daily.hccm-prod.svc.cluster.local:8080/api/cost-management/v1/koku-daily
          auth:
            saml: "'cost-management-team' in user['Role']"
        - name: policies-engine-prod
          route: /api/policies-engine/
          origin: http://policies-engine.policies-prod.svc.cluster.local:8080/
          auth:
            saml: "True"
        - name: policies-ui-backend-prod
          route: /api/policies-ui-backend/
          origin: http://policies-ui-backend.policies-prod.svc.cluster.local:8080/
          auth:
            saml: "True"
        - name: module-update-router-events
          route: /api/module-update-router/v1/event
          origin: http://module-update-router.module-update-router-prod.svc.cluster.local:8080/api/module-update-router/v1/event
          auth:
            saml: "'clouddot-data' in user['Role']"
