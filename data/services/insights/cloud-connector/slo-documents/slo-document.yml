---
$schema: /app-sre/slo-document-1.yml

labels:
  service: cloud-connector

name: cloud-connector

namespaces:
  - namespace:
      $ref: /services/insights/cloud-connector/namespaces/prod.yml

app:
  $ref:  /services/insights/cloud-connector/app.yml

slos:
- name: API requests result in successful (non-5xx) response
  dashboard: https://grafana.app-sre.devshift.net/d/c91dcda039618ded/cloud-connector?orgId=1&var-datasource=crcp01ue1-prometheus
  SLIType: availability
  SLISpecification: Proportion of sucessful API requests with a non-5xx response against all requests on cloud-connector internal API
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  SLOParameters:
    window: 28d
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/cloud-connector/SLO.md
  expr: |
    1 - ( (sum(increase(cloud_connector_http_status_code_counter{status_code=~"5.*", service="cloud-connector-api"}[{{window}}])) or vector(0)) / sum(increase(cloud_connector_http_status_code_counter{service="cloud-connector-api"}[{{window}}]))
        )
  prometheusRules: /resources/insights-prod/cloud-connector/cloud-connector.prometheusrules.yml


- name: Consumed mqtt messages written to kafka
  dashboard: https://grafana.app-sre.devshift.net/d/c91dcda039618ded/cloud-connector?orgId=1&var-datasource=crcp01ue1-prometheus
  SLIType: availability
  SLISpecification: Proportion of consumed mqtt messages written to kafka
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  SLOParameters:
    window: 28d
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/cloud-connector/SLO.md
  expr: |
    sum(rate(cloud_connector_mqtt_message_consumer_kafka_writer_publish_duration_count[{{window}}])) / sum(rate(cloud_connector_mqtt_control_message_received_count[{{window}}]))
  prometheusRules: /resources/insights-prod/cloud-connector/cloud-connector.prometheusrules.yml


- name: Kafka lag for the platform.cloud-connector.rhc-message-ingress topic (less than 100 messages 90% of the time)
  dashboard: https://grafana.app-sre.devshift.net/d/c91dcda039618ded/cloud-connector?orgId=1&var-datasource=crcp01ue1-prometheus
  SLIType: latency
  SLISpecification: message kafka lag
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/cloud-connector/SLO.md
  SLOParameters:
    window: 28d
  expr: quantile_over_time(0.90, cloud_connector:consumer_group_lag:sum[{{window}}]) > 100
  prometheusRules: /resources/insights-prod/cloud-connector/cloud-connector.prometheusrules.yml


- name: Cloud-Connector service availability
  dashboard: https://grafana.app-sre.devshift.net/d/c91dcda039618ded/cloud-connector?orgId=1&var-datasource=crcp01ue1-prometheus
  SLIType: availability
  SLISpecification: The pods are up 95% of the time
  SLOTarget: 0.95
  SLOTargetUnit: percent_0_1
  SLODetails: https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/cloud-connector/SLO.md
  SLOParameters:
    window: 28d
  expr: |
    avg(avg_over_time(up{container=~"cloud-connector-.*"}[{{window}}]))
  prometheusRules: /resources/insights-prod/cloud-connector/cloud-connector.prometheusrules.yml
