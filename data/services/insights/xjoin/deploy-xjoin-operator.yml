---
$schema: /app-sre/saas-file-2.yml

labels:
  service: xjoin-operator
  platform: insights

name: xjoin-operator
description: xjoin operator on the Insights Platform

app:
  $ref: /services/insights/xjoin/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.app-sre-prod-01.yaml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: team-clouddot-info

managedResourceTypes:
- ConfigMap
- OperatorGroup
- CatalogSource
- Subscription
- Service
- XJoinPipeline
- KafkaUser

imagePatterns:
- quay.io/cloudservices

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all
    version: 3
  code:
    path: app-sre/creds/github-app-sre-bot
    field: openshift-saas-deploy

resourceTemplates:
- name: xjoin-operator
  path: /deploy/operator.yml
  url: https://github.com/RedHatInsights/xjoin-operator
  parameters:
    RECONCILE_INTERVAL: "120"
    ES_CONNECTOR_TASKS_MAX: "50"
    KAFKA_TOPIC_PARTITIONS: "500"
    KAFKA_TOPIC_REPLICAS: "2"
  targets:
  - namespace:
      $ref: /services/insights/xjoin/namespaces/stage-xjoin-operator-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-xjoin-operator-gh-build-catalog-master-upstream-RedHatInsights-xjoin-operator-gh-build-master
    parameters:
      HBI_DB_SSL_MODE: "disable"
      TARGET_NAMESPACE: xjoin-operator-stage
      SOURCE_NAMESPACE: xjoin-operator-stage
      LOG_LEVEL: "info"
      VALIDATION_INTERVAL: "1800"
      VALIDATION_ATTEMPTS_THRESHOLD: "2"
      VALIDATION_ATTEMPTS_THRESHOLD_INIT: "30"
      FULL_VALIDATION_NUM_THREADS: "9"
      MANAGER_POD_MEM_LIMIT: "4Gi"
      MANAGER_POD_CPU_LIMIT: "2"
      MANAGER_POD_MEM_REQUESTS: "2Gi"
      MANAGER_POD_CPU_REQUESTS: "1"
      FULL_VALIDATION_ENABLED: "true"
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-operator-prod.yml
    ref: 1d5605b76d4c08e3504965ba9937c46fec8f7269
    parameters:
      HBI_DB_SSL_MODE: "disable"
      TARGET_NAMESPACE: xjoin-operator-prod
      SOURCE_NAMESPACE: xjoin-operator-prod
      VALIDATION_PERIOD_MINUTES: "90"
      VALIDATION_LAG_COMPENSATION_SECONDS: "600"
      VALIDATION_ATTEMPTS_THRESHOLD: "2"
      VALIDATION_INTERVAL: "600"
      VALIDATION_INTERVAL_INIT: "120"
      VALIDATION_ATTEMPTS_THRESHOLD_INIT: "60"
      LOG_LEVEL: "info"
      MANAGER_POD_MEM_LIMIT: "16Gi"
      MANAGER_POD_CPU_LIMIT: "4"
      MANAGER_POD_MEM_REQUESTS: "8Gi"
      MANAGER_POD_CPU_REQUESTS: "2"
      FULL_VALIDATION_ENABLED: "true"
      FULL_VALIDATION_NUM_THREADS: "20"
      FULL_VALIDATION_CHUNK_SIZE: "50"
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-operator-perf.yml
    ref: 8785b0537b286965e7a7f571dda41944e01373a5
    parameters:
      HBI_DB_SSL_MODE: "disable"
      TARGET_NAMESPACE: xjoin-operator-perf
      SOURCE_NAMESPACE: xjoin-operator-perf
      VALIDATION_PERIOD_MINUTES: "90"
      VALIDATION_LAG_COMPENSATION_SECONDS: "600"
      VALIDATION_ATTEMPTS_THRESHOLD: "2"
      VALIDATION_INTERVAL: "600"
      VALIDATION_INTERVAL_INIT: "60"
      VALIDATION_ATTEMPTS_THRESHOLD_INIT: "30"
      LOG_LEVEL: "info"
      MANAGER_POD_MEM_LIMIT: "16Gi"
      MANAGER_POD_CPU_LIMIT: "4"
      MANAGER_POD_MEM_REQUESTS: "8Gi"
      MANAGER_POD_CPU_REQUESTS: "2"
      FULL_VALIDATION_ENABLED: "true"
      ELASTICSEARCH_INDEX_TEMPLATE: '
      {
        "dynamic": false,
        "properties": {
          "ingest_timestamp": {
            "type": "date"
          },
          "id": {
            "type": "keyword"
          },
          "account": {
            "type": "keyword"
          },
          "display_name": {
            "type": "keyword",
            "fields": {
              "lowercase": {
                "type": "keyword",
                "normalizer": "case_insensitive"
              }
            }
          },
          "created_on": {
            "type": "date_nanos"
          },
          "modified_on": {
            "type": "date_nanos"
          },
          "stale_timestamp": {
            "type": "date_nanos"
          },
          "ansible_host": {
            "type": "keyword"
          },
          "canonical_facts": {
            "type": "object",
            "properties": {
              "fqdn": {
                "type": "keyword"
              },
              "insights_id": {
                "type": "keyword"
              },
              "satellite_id": {
                "type": "keyword"
              },
              "provider_type": {
                "type": "keyword"
              },
              "provider_id": {
                "type": "keyword"
              }
            }
          },
          "system_profile_facts": {
            "properties": {
              "owner_id": {
                "type": "keyword"
              },
              "rhc_client_id": {
                "type": "keyword"
              },
              "rhc_config_state": {
                "type": "keyword"
              },
              "cpu_model": {
                "type": "keyword"
              },
              "number_of_cpus": {
                "type": "integer"
              },
              "number_of_sockets": {
                "type": "integer"
              },
              "cores_per_socket": {
                "type": "integer"
              },
              "system_memory_bytes": {
                "type": "integer"
              },
              "infrastructure_type": {
                "type": "keyword"
              },
              "infrastructure_vendor": {
                "type": "keyword"
              },
              "network_interfaces": {
                "type": "object",
                "properties": {
                  "ipv4_addresses": {
                    "type": "keyword"
                  },
                  "ipv6_addresses": {
                    "type": "keyword"
                  },
                  "mtu": {
                    "type": "integer"
                  },
                  "mac_address": {
                    "type": "keyword"
                  },
                  "name": {
                    "type": "keyword"
                  },
                  "state": {
                    "type": "keyword"
                  },
                  "type": {
                    "type": "keyword"
                  }
                }
              },
              "disk_devices": {
                "type": "object",
                "properties": {
                  "device": {
                    "type": "keyword"
                  },
                  "label": {
                    "type": "text"
                  },
                  "mount_point": {
                    "type": "keyword"
                  },
                  "type": {
                    "type": "keyword"
                  }
                }
              },
              "bios_vendor": {
                "type": "keyword"
              },
              "bios_version": {
                "type": "keyword"
              },
              "cpu_flags": {
                "type": "keyword"
              },
              "operating_system": {
                "type": "object",
                "properties": {
                  "major": {
                    "type": "integer"
                  },
                  "minor": {
                    "type": "integer"
                  },
                  "name": {
                    "type": "keyword"
                  }
                }
              },
              "os_release": {
                "type": "keyword"
              },
              "os_kernel_version": {
                "type": "keyword"
              },
              "arch": {
                "type": "keyword"
              },
              "kernel_modules": {
                "type": "keyword"
              },
              "last_boot_time": {
                "type": "keyword"
              },
              "subscription_status": {
                "type": "keyword"
              },
              "subscription_auto_attach": {
                "type": "keyword"
              },
              "katello_agent_running": {
                "type": "boolean"
              },
              "satellite_managed": {
                "type": "boolean"
              },
              "cloud_provider": {
                "type": "keyword"
              },
              "dnf_modules": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "keyword"
                  },
                  "stream": {
                    "type": "keyword"
                  }
                }
              },
              "installed_products": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "keyword"
                  },
                  "id": {
                    "type": "keyword"
                  },
                  "status": {
                    "type": "keyword"
                  }
                }
              },
              "insights_client_version": {
                "type": "keyword"
              },
              "insights_egg_version": {
                "type": "keyword"
              },
              "captured_date": {
                "type": "keyword"
              },
              "installed_packages": {
                "type": "keyword"
              },
              "gpg_pubkeys": {
                "type": "keyword"
              },
              "installed_services": {
                "type": "keyword"
              },
              "enabled_services": {
                "type": "keyword"
              },
              "sap_system": {
                "type": "boolean"
              },
              "sap_sids": {
                "type": "keyword"
              },
              "sap_instance_number": {
                "type": "keyword"
              },
              "sap_version": {
                "type": "keyword"
              },
              "tuned_profile": {
                "type": "keyword"
              },
              "selinux_current_mode": {
                "type": "keyword"
              },
              "selinux_config_file": {
                "type": "keyword"
              },
              "is_marketplace": {
                "type": "boolean"
              },
              "host_type": {
                "type": "keyword"
              },
              "greenboot_status": {
                "type": "keyword"
              },
              "greenboot_fallback_detected": {
                "type": "boolean"
              },
              "rpm_ostree_deployments": {
                "type": "object",
                "properties": {
                  "id": {
                    "type": "keyword"
                  },
                  "checksum": {
                    "type": "keyword"
                  },
                  "origin": {
                    "type": "keyword"
                  },
                  "osname": {
                    "type": "keyword"
                  },
                  "version": {
                    "type": "keyword"
                  },
                  "booted": {
                    "type": "boolean"
                  },
                  "pinned": {
                    "type": "boolean"
                  }
                }
              },
              "rhsm": {
                "type": "object",
                "properties": {
                  "version": {
                    "type": "keyword"
                  }
                }
              },
              "system_purpose": {
                "type": "object",
                "properties": {
                  "usage": {
                    "type": "keyword"
                  },
                  "role": {
                    "type": "keyword"
                  },
                  "sla": {
                    "type": "keyword"
                  }
                }
              },
              "ansible": {
                "type": "object",
                "properties": {
                  "controller_version": {
                    "type": "keyword"
                  },
                  "hub_version": {
                    "type": "keyword"
                  },
                  "catalog_worker_version": {
                    "type": "keyword"
                  },
                  "sso_version": {
                    "type": "keyword"
                  }
                }
              }
            }
          },
          "tags_structured": {
            "type": "nested",
            "properties": {
              "namespace": {
                "type": "keyword",
                "null_value": "$$_XJOIN_SEARCH_NULL_VALUE"
              },
              "key": {
                "type": "keyword"
              },
              "value": {
                "type": "keyword",
                "null_value": "$$_XJOIN_SEARCH_NULL_VALUE"
              }
            }
          },
          "tags_string": {
            "type": "keyword"
          },
          "tags_search": {
            "type": "keyword",
            "fields": {
              "lowercase": {
                "type": "keyword",
                "normalizer": "case_insensitive"
              }
            }
          }
        }
      }'
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-operator-fedramp-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-xjoin-operator-gh-build-catalog-master-upstream-RedHatInsights-xjoin-operator-gh-build-master
    parameters:
      HBI_DB_SSL_MODE: "verify-full"
      CONNECT_CLUSTER: xjoin-connect
      TARGET_NAMESPACE: xjoin-operator-stage
      SOURCE_NAMESPACE: xjoin-operator-stage
      LOG_LEVEL: "info"
      VALIDATION_INTERVAL: "1800"
      VALIDATION_ATTEMPTS_THRESHOLD: "2"
      VALIDATION_ATTEMPTS_THRESHOLD_INIT: "30"
      MANAGER_POD_MEM_LIMIT: "4Gi"
      MANAGER_POD_CPU_LIMIT: "2"
      MANAGER_POD_MEM_REQUESTS: "2Gi"
      MANAGER_POD_CPU_REQUESTS: "1"
      FULL_VALIDATION_ENABLED: "true"

  # Ephemeral cluster
  # Unlike in stable environments where the operator is deployed in SingleNamespace mode,
  # AllNamespaces (i.e. cluster-wide) mode is used in ephemeral environments
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-ephemeral.yml
    ref: master
    parameters:
      LOG_LEVEL: "info"
      TARGET_NAMESPACE: xjoin
      SOURCE_NAMESPACE: xjoin
      # Temporary until https://github.com/RedHatInsights/clowder/pull/390 is merged and released
      DEBEZIUM_CONNECTOR_CONFIG: '{
        "tasks.max": "{{.DebeziumTasksMax}}",
        "database.hostname": "{{.HBIDBHost}}",
        "database.port": "{{.HBIDBPort}}",
        "database.user": "{{.HBIDBUser}}",
        "database.password": "{{.HBIDBPassword}}",
        "database.dbname": "{{.HBIDBName}}",
        "database.server.name": "{{.ResourceNamePrefix}}.{{.Version}}",
        "database.sslmode": "{{.HBIDBSSLMode}}",
        "database.sslrootcert": "{{.HBIDBSSLRootCert}}",
        "table.whitelist": "public.hosts",
        "plugin.name": "pgoutput",
        "transforms": "unwrap",
        "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
        "transforms.unwrap.delete.handling.mode": "rewrite",
        "errors.log.enable": {{.DebeziumErrorsLogEnable}},
        "errors.log.include.messages": true,
        "slot.name": "{{.ReplicationSlotName}}",
        "max.queue.size": {{.DebeziumQueueSize}},
        "max.batch.size": {{.DebeziumMaxBatchSize}},
        "poll.interval.ms": {{.DebeziumPollIntervalMS}}
      }'
      MANAGER_POD_MEM_LIMIT: "8Gi"
      MANAGER_POD_CPU_LIMIT: "2"
      MANAGER_POD_MEM_REQUESTS: "4Gi"
      MANAGER_POD_CPU_REQUESTS: "1"
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-xjoin-operator-gh-build-catalog-master-upstream-RedHatInsights-xjoin-operator-gh-build-master
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-operator-fedramp-prod.yml
    ref: 864ea397209ee24a575358efb3b966cac7384bd6
    parameters:
      HBI_DB_SSL_MODE: "verify-full"
      CONNECT_CLUSTER: xjoin-connect
      TARGET_NAMESPACE: xjoin-operator-prod
      SOURCE_NAMESPACE: xjoin-operator-prod
      LOG_LEVEL: "info"
      VALIDATION_PERIOD_MINUTES: "90"
      VALIDATION_LAG_COMPENSATION_SECONDS: "600"
      VALIDATION_ATTEMPTS_THRESHOLD: "2"
      VALIDATION_INTERVAL: "600"
      VALIDATION_INTERVAL_INIT: "60"
      VALIDATION_ATTEMPTS_THRESHOLD_INIT: "30"
      MANAGER_POD_MEM_LIMIT: "8Gi"
      MANAGER_POD_CPU_LIMIT: "2"
      MANAGER_POD_MEM_REQUESTS: "4Gi"
      MANAGER_POD_CPU_REQUESTS: "1"
      FULL_VALIDATION_ENABLED: "true"

- name: xjoin-pipeline
  path: /deploy/pipeline.yml
  url: https://github.com/RedHatInsights/xjoin-operator
  targets:
  - namespace:
      $ref: /services/insights/xjoin/namespaces/stage-xjoin-operator-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-xjoin-operator-gh-build-master
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-operator-prod.yml
    ref: e7fadc7ac9c5c3d55f097f739d008f5a811f195f
    parameters:
      KAFKA_CLUSTER_NAMESPACE: "platform-mq-prod"
      CONNECT_CLUSTER_NAMESPACE: "xjoin-prod"
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-operator-fedramp-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-xjoin-operator-gh-build-catalog-master-upstream-RedHatInsights-xjoin-operator-gh-build-master
    parameters:
      CONNECT_CLUSTER: "xjoin-connect"
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-operator-fedramp-prod.yml
    ref: e7fadc7ac9c5c3d55f097f739d008f5a811f195f
    parameters:
      CONNECT_CLUSTER: "xjoin-connect"
      KAFKA_CLUSTER_NAMESPACE: "platform-mq-prod"
      CONNECT_CLUSTER_NAMESPACE: "xjoin-prod"
  - namespace:
      $ref: /services/insights/xjoin/namespaces/xjoin-operator-perf.yml
    ref: e7fadc7ac9c5c3d55f097f739d008f5a811f195f
    parameters:
      KAFKA_CLUSTER_NAMESPACE: "platform-mq-perf"
      CONNECT_CLUSTER_NAMESPACE: "xjoin-perf"

- name: xjoin-kafka-user
  path: /deploy/kafka-user.yml
  url: https://github.com/RedHatInsights/xjoin-operator
  targets:
  - namespace:
      $ref: /services/insights/strimzi/namespaces/platform-mq-fedramp-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: RedHatInsights-xjoin-kafka-connect-gh-build-master
  - namespace:
      $ref: /services/insights/strimzi/namespaces/platform-mq-fedramp-prod.yml
    ref: e7fadc7ac9c5c3d55f097f739d008f5a811f195f
