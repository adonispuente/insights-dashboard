---
$schema: /app-sre/saas-file-1.yml

labels:
  service: marketplace
  platform: insights

name: marketplace
description: marketplace app on the Insights Platform

app:
  $ref: /services/insights/marketplace/app.yml

instance:
  $ref: /dependencies/ci-int/ci-int.yml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: team-clouddot-info

timeout: 5

managedResourceTypes:
- Deployment
- DeploymentConfig
- HorizontalPodAutoscaler
- PersistentVolumeClaim
- Service
- CronJob
- Job

imagePatterns:
- quay.io/cloudservices
- quay.io/prometheus/pushgateway

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all

resourceTemplates:
- name: marketplace
  path: /templates/marketplace/marketplace.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  targets:
  - namespace:
      $ref: /services/insights/marketplace/namespaces/stage-marketplace-stage.yml
    ref: 22da8d9185a56858efe78f1d870b0919ccd7d510
    parameters:
      IMAGE_TAG: f914978
      REPLICAS: 3
      MINIMUM_REPLICAS: 3
  - namespace:
      $ref: /services/insights/marketplace/namespaces/marketplace-prod.yml
    ref: 22da8d9185a56858efe78f1d870b0919ccd7d510
    parameters:
      IMAGE_TAG: f914978
      REPLICAS: 3
      MINIMUM_REPLICAS: 3

- name: pendo-prom-emitter
  path: /templates/marketplace/pendo-prom-emitter.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  targets:
  - namespace:
      $ref: /services/insights/marketplace/namespaces/stage-marketplace-stage.yml
    ref: 2fdd8b85766383a53f4dd499aae4fc2c9d3a7017
    parameters:
      IMAGE_TAG: 9abb720
      PROMETHEUS_PUSH_GATEWAY: prometheus-push.insights-push-stage.svc.cluster.local:9091
      PENDO_AGGREGATION_QUERY: '{"response":{"mimeType":"application/json"},"request":{"name":"page-data","pipeline":[{"source":{"pages":{"appId":6245718179446784}}},{"eval":{"pageId":"id"}},{"merge":{"fields":["pageId"],"mappings":{"numVisitors":"numVisitors","numAccounts":"numAccounts","pageLoads":"pageLoads","avgTime":"(totalTime/dailyVisitors)*60*1000"},"pipeline":[{"source":{"pageEvents":{"eventClass":["web","ios"],"appId":6245718179446784},"timeSeries":{"period":"dayRange","first":"now()","count":-1}}},{"identified":"visitorId"},{"group":{"group":["pageId"],"fields":[{"numAccounts":{"count":"accountId"}},{"numVisitors":{"count":"visitorId"}},{"dailyVisitors":{"count":["visitorId","day"]}},{"pageLoads":{"sum":"numEvents"}},{"totalTime":{"sum":"numMinutes"}}]}}]}},{"eval":{"numVisitors":"if(isNil(numVisitors), 0, numVisitors)","numAccounts":"if(isNil(numAccounts), 0, numAccounts)","pageLoads":"if(isNil(pageLoads), 0, pageLoads)","avgTime":"if(isNil(avgTime), 0, avgTime)"}}],"requestId":"page-data"}}'
      PENDO_AGGREGATION_FILTER: '{"name":[{"startswith":"_"},{"in":["cost management","automation"]}],"kind":[{"equal":"Page"}]}'
      PROMETHEUS_METRICS_MAP: '{"numAccounts":{"type":"gauge","metric_name":"pendo_num_accounts_per_day_for_page","description":"The number of accounts viewing a page in a day.","labels":{"page_id":"id","page_name":"name","namespace":"namespace"}},"numVisitors":{"type":"gauge","metric_name":"pendo_num_visitors_per_day_for_page","description":"The number of visitors viewing a page in a day.","labels":{"page_id":"id","page_name":"name","namespace":"namespace"}},"pageLoads":{"type":"gauge","metric_name":"pendo_num_views_per_day_for_page","description":"The number of page views in a day.","labels":{"page_id":"id","page_name":"name","namespace":"namespace"}},"avgTime":{"type":"gauge","metric_name":"pendo_avg_time_per_day_for_page","description":"The average time view a page each day.","labels":{"page_id":"id","page_name":"name","namespace":"namespace"}}}'
      EXECUTE_NAMESPACE: marketplace-stage
      CRON_SCHEDULE: "0 15 * * *"
  - namespace:
      $ref: /services/insights/marketplace/namespaces/marketplace-prod.yml
    ref: 2fdd8b85766383a53f4dd499aae4fc2c9d3a7017
    parameters:
      IMAGE_TAG: 9abb720
      PROMETHEUS_PUSH_GATEWAY: prometheus-push.insights-push-prod.svc.cluster.local:9091
      PENDO_AGGREGATION_QUERY: '{"response":{"mimeType":"application/json"},"request":{"name":"page-data","pipeline":[{"source":{"pages":{"appId":6245718179446784}}},{"eval":{"pageId":"id"}},{"merge":{"fields":["pageId"],"mappings":{"numVisitors":"numVisitors","numAccounts":"numAccounts","pageLoads":"pageLoads","avgTime":"(totalTime/dailyVisitors)*60*1000"},"pipeline":[{"source":{"pageEvents":{"eventClass":["web","ios"],"appId":6245718179446784},"timeSeries":{"period":"dayRange","first":"now()","count":-1}}},{"identified":"visitorId"},{"group":{"group":["pageId"],"fields":[{"numAccounts":{"count":"accountId"}},{"numVisitors":{"count":"visitorId"}},{"dailyVisitors":{"count":["visitorId","day"]}},{"pageLoads":{"sum":"numEvents"}},{"totalTime":{"sum":"numMinutes"}}]}}]}},{"eval":{"numVisitors":"if(isNil(numVisitors), 0, numVisitors)","numAccounts":"if(isNil(numAccounts), 0, numAccounts)","pageLoads":"if(isNil(pageLoads), 0, pageLoads)","avgTime":"if(isNil(avgTime), 0, avgTime)"}}],"requestId":"page-data"}}'
      PENDO_AGGREGATION_FILTER: '{"name":[{"startswith":"_"},{"in":["cost management","automation"]}],"kind":[{"equal":"Page"}]}'
      PROMETHEUS_METRICS_MAP: '{"numAccounts":{"type":"gauge","metric_name":"pendo_num_accounts_per_day_for_page","description":"The number of accounts viewing a page in a day.","labels":{"page_id":"id","page_name":"name","namespace":"namespace"}},"numVisitors":{"type":"gauge","metric_name":"pendo_num_visitors_per_day_for_page","description":"The number of visitors viewing a page in a day.","labels":{"page_id":"id","page_name":"name","namespace":"namespace"}},"pageLoads":{"type":"gauge","metric_name":"pendo_num_views_per_day_for_page","description":"The number of page views in a day.","labels":{"page_id":"id","page_name":"name","namespace":"namespace"}},"avgTime":{"type":"gauge","metric_name":"pendo_avg_time_per_day_for_page","description":"The average time view a page each day.","labels":{"page_id":"id","page_name":"name","namespace":"namespace"}}}'
      EXECUTE_NAMESPACE: marketplace-prod
      CRON_SCHEDULE: "0 15 * * *"
