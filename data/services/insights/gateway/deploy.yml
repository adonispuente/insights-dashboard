---
$schema: /app-sre/saas-file-2.yml

labels:
  service: gateway
  platform: insights

name: gateway
description: gateway app on the Insights Platform

app:
  $ref: /services/insights/gateway/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.appsrep05ue1.yaml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: team-clouddot-info

managedResourceTypes:
- Deployment
- DeploymentConfig
- Service

imagePatterns:
- quay.io/cloudservices

authentication:
  code:
    path: app-sre/creds/github-app-sre-bot
    field: openshift-saas-deploy
  image:
    path: insights/quay/cloudservices-push
    field: all

resourceTemplates:
- name: gateway
  path: /templates/gateway/gateway.yaml
  url: https://gitlab.cee.redhat.com/insights-platform/saas-templates
  parameters:
    API_GATEWAY_PORT: 9091
    API_GATEWAY_PORT_CI: 9192
    API_GATEWAY_PORT_DEV: 9291
    API_GATEWAY_PORT_QA: 9191
    API_GATEWAY_PORT_STAGE: 9092
    APICAST_MEM_REQ: 1024Mi
    INTERNAL_GW_PORT_CI: 8890
    INTERNAL_GW_PORT_QA: 8891
    INTERNAL_GW_PORT_STAGE: 8892
    INTERNAL_GW_PORT: 8893
  targets:
  - namespace:
      $ref: /services/insights/gateway/namespaces/stage-3scale-stage.yml
    ref: cfcf2701c50adb16fc890141f5a6d0f1a0ba8536
    parameters:
      DEPLOYMENT_ENVIRONMENT: production
      IMAGE_TAG: 9ed5217
      INSTANCE_ENVIRONMENT: prod
      SERVICES_LIST: 2555417766312,2555417857543,2555417825389,2555417857567,2555417768850,2555417854177,2555417761380,2555417854178,2555417854634,2555417854179,2555417782669,2555417854060,2555417833974,2555417844626,2555417763855,2555417854542,2555417854180,2555417854181,2555417771926,2555417854182,2555417769046,2555417813958,2555417857565,2555417768536,2555417854183,2555417822595,2555417764516,2555417764366,2555417862922,2555417862930,2555417869277,2555417872679,2555417872865,2555417889130,2555417889772,2555417890511,2555417892808,2555417882381,2555417895247,2555417881384,2555417903760,2555417903761,2555417903764,2555417903762,2555417904347,2555417915115
  - namespace:
      $ref: /services/insights/gateway/namespaces/3scale-fedramp-stage.yml
    ref: cfcf2701c50adb16fc890141f5a6d0f1a0ba8536
    parameters:
      ENFORCE_IDP_AUTH: true
      DEPLOYMENT_ENVIRONMENT: production
      IMAGE_TAG: 9ed5217
      INSTANCE_ENVIRONMENT: prod
      SERVICES_LIST: 2555417766312,2555417857543,2555417825389,2555417857567,2555417768850,2555417854177,2555417761380,2555417854178,2555417854634,2555417854179,2555417782669,2555417854060,2555417833974,2555417844626,2555417763855,2555417854542,2555417854180,2555417854181,2555417771926,2555417854182,2555417769046,2555417813958,2555417857565,2555417768536,2555417854183,2555417822595,2555417764516,2555417764366,2555417862922,2555417862930,2555417869277,2555417872679,2555417872865,2555417889130,2555417889772,2555417890511
  - namespace:
      $ref: /services/insights/gateway/namespaces/3scale-prod.yml
    ref: f839199389c5f2908cf5da8a7e026379121433a9
    parameters:
      DEPLOYMENT_ENVIRONMENT: production
      IMAGE_TAG: 7751e99
      INSTANCE_ENVIRONMENT: prod
      SERVICES_LIST: 2555417795207,2555417795208,2555417795204,2555417795209,2555417795210,2555417766313,2555417778550,2555417825390,2555417775768,2555417768851,2555417766711,2555417761390,2555417846164,2555417784990,2555417833965,2555417794838,2555417849570,2555417790215,2555417782668,2555417778459,2555417847587,2555417761387,2555417810755,2555417854543,2555417847851,2555417848781,2555417771927,2555417838767,2555417766331,2555417813959,2555417782165,2555417768537,2555417824288,2555417761391,2555417822596,2555417761389,2555417766151,2555417784373,2555417825480,2555417869278,2555417872866,2555417885898,2555417889132,2555417889773,2555417881385,2555417898252,2555417882382,2555417900811,2555417903765,2555417905100,2555417907899,2555417918341,2555417918434
      REPLICAS: 3
      ALLOW_EXTERNAL_TRAFFIC: 'true'
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ocm.yml
    ref: 57e13ffb057665e90fab1baadd8454faf2890fca
    parameters:
      REPLICAS: 1
      USE_ENTITLEMENTS_MOCK: 'false'
      INSTANCE_ENVIRONMENT: dev
      IMAGE_TAG: insights-dev
      SERVICES_LIST: 2555417824448,2555417824655,2555417824813,2555417824814,2555417824815,2555417824816,2555417824817,2555417824818,2555417824819,2555417824820,2555417824821,2555417824822,2555417824823,2555417824824,2555417824825,2555417824826,2555417824827,2555417824828,2555417824829,2555417824830,2555417824831,2555417824832,2555417824833,2555417824834,2555417824835,2555417824836,2555417824837,2555417824838,2555417824839,2555417824840,2555417825386,2555417889027,2555417895248,2555417900810,2555417903766,2555417903763,2555417907919,2555417917991
      LOG_LEVEL: 'debug'
  - namespace:
      $ref: /services/insights/ephemeral/namespaces/ephemeral-base.yml
    disable: true  # do not create an app-sre deploy job for ephemeral namespace
    ref: internal  # populated by bonfire
    parameters:
      REPLICAS: 1
      USE_ENTITLEMENTS_MOCK: 'false'
      INSTANCE_ENVIRONMENT: dev
      IMAGE_TAG: insights-dev
      SERVICES_LIST: 2555417824448,2555417824655,2555417824813,2555417824814,2555417824815,2555417824816,2555417824817,2555417824818,2555417824819,2555417824820,2555417824821,2555417824822,2555417824823,2555417824824,2555417824825,2555417824826,2555417824827,2555417824828,2555417824829,2555417824830,2555417824831,2555417824832,2555417824833,2555417824834,2555417824835,2555417824836,2555417824837,2555417824838,2555417824839,2555417824840,2555417825386,2555417889027,2555417895248,2555417900810,2555417903766,2555417903763,2555417907919,2555417917991
      LOG_LEVEL: 'debug'
- name: cloudwatch-aggregator
  path: /templates/cloudwatch-aggregator.yml
  url: https://github.com/RedHatInsights/cloudwatch-aggregator
  parameters:
    REPLICAS: 2
  targets:
  - namespace:
      $ref: /services/insights/gateway/namespaces/stage-3scale-stage.yml
    ref: main
    parameters:
      CLOUD_WATCH_ALLOWED_STREAMS: 3scale-staging
  - namespace:
      $ref: /services/insights/gateway/namespaces/3scale-fedramp-stage.yml
    ref: master
    parameters:
      CLOUD_WATCH_ALLOWED_STREAMS: 3scale-staging
  - namespace:
      $ref: /services/insights/gateway/namespaces/3scale-prod.yml
    ref: 8d0fb8f2edd53dbd965d52bc923dd0f6ec8b9049
    parameters:
      CLOUD_WATCH_ALLOWED_STREAMS: 3scale
- name: apicast-test-services
  path: /template-source.yml
  url: https://github.com/RedHatInsights/apicast-test-services
  targets:
  - namespace:
      $ref: /services/insights/gateway/namespaces/apicast-test-services-stage.yml
    ref: master
  - namespace:
      $ref: /services/insights/gateway/namespaces/3scale-fedramp-stage.yml
    ref: master
  - namespace:
      $ref: /services/insights/gateway/namespaces/apicast-test-services-prod.yml
    ref: 3322262ac864e37dede7fd20ead0359f9b9caf26
