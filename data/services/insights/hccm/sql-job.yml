---
$schema: /app-interface/app-interface-sql-query-1.yml
name: 2021-03-11-staging-dbs-and-roles
labels: {}
namespace:
  $ref: /services/insights/hccm/namespaces/stage-hccm-stage.yml
identifier: koku-stage
output: stdout
# Required if output is encrypted
# requestor: 
#   $ref: <user-1.yml with public_gpg_key>
# schedule: <if defined the output resource will be a CronJob instead of a Job>
queries: 
  - SELECT current_user;
  - |
    SELECT d.datname as name,
          pg_catalog.pg_get_userbyid(d.datdba) as owner
    FROM pg_catalog.pg_database d
    WHERE d.datname !~ 'template'
    ORDER BY 1;
  - |
    SELECT r.rolname, r.rolsuper, r.rolinherit,
      r.rolcreaterole, r.rolcreatedb, r.rolcanlogin,
      r.rolconnlimit, r.rolvaliduntil,
      ARRAY(SELECT b.rolname
            FROM pg_catalog.pg_auth_members m
            JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
            WHERE m.member = r.oid) as memberof
    , r.rolreplication
    , r.rolbypassrls
    FROM pg_catalog.pg_roles r
    WHERE r.rolname !~ '^pg_'
    ORDER BY 1;
