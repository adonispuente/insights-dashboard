---
$schema: /app-sre/saas-file-2.yml

labels:
  service: hccm
  platform: insights

name: hccm-perf
description: hccm app on the Insights Platform deployed with Clowder

app:
  $ref: /services/insights/hccm/app.yml

pipelinesProvider:
  $ref: /services/insights/pipelines/tekton.crc-pipelines.appsrep05ue1.yaml

slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: cost-mgmt-bots

managedResourceTypes:
- ClowdApp
- ConfigMap
- ClowdJobInvocation
- Frontend

imagePatterns:
- quay.io/cloudservices
- quay.io/app-sre

authentication:
  image:
    path: insights/quay/cloudservices-push
    field: all
    version: 3

parameters:
  CLOWDER_ENABLED: true
  ACCOUNT_ENHANCED_METRICS: False

resourceTemplates:
- name: koku-cji
  # repo deploy file: https://github.com/project-koku/koku/blob/main/deploy/koku-cji.yaml
  # container image: quay.io/cloudservices/koku
  # container repo:  https://quay.io/repository/cloudservices/koku
  path: /deploy/koku-cji.yaml
  url: https://github.com/project-koku/koku
  targets:
  # Performance:
  - namespace:
      $ref: /services/insights/hccm/namespaces/perf-hccm-perf.yml
    ref: dbfe096de9624982d8c80db8cbce7da6312681f9
    parameters:
      CJI_INVOCATION: "01"

- name: koku
  # repo deploy file: https://github.com/project-koku/koku/blob/main/deploy/clowdapp.yaml
  # container image: quay.io/cloudservices/koku
  # container repo:  https://quay.io/repository/cloudservices/koku
  path: /deploy/clowdapp.yaml
  url: https://github.com/project-koku/koku
  targets:
  # Performance:
  - namespace:
      $ref: /services/insights/hccm/namespaces/perf-hccm-perf.yml
    ref: 2ba568457eaf9b5a93ddae48a67d8068178f3dc0
    parameters:
      ############# MIGRATIONS #############
      # Change these settings when deploying migrations to Performance
      # Migrations Image Tag
      DBM_IMAGE_TAG: c4a98f1
      # Migrations Invocation
      DBM_INVOCATION: "00"
      # Migration directive is optional and should be in the form of:
      # <app>[:<migration>][,<app>[:<migration>]...]
      # Ex: "reporting:0200,api:0050"
      # Ex: "reporting:0200"
      # Ex: "reporting"
      # Ex: ""
      _MIGRATION_DIRECTIVE: ""
      ######################################
      APP_DOMAIN: apps.crcp01ue1.o9m8.p1.openshiftapps.com
        #ROS_OCP_API: ros-ocp-backend-api.ros-stage.svc.cluster.local
      S3_BUCKET_NAME: hccm-perf-s3
      S3_ROS_BUCKET_NAME: hccm-ros-perf-s3
      KOKU_SENTRY_ENV: perf
      ENABLE_API_SENTRY: True
      ENABLE_CELERY_SENTRY: True
      ENABLE_PARQUET_PROCESSING: True
      ENABLE_S3_ARCHIVING: True
      TRINO_DATE_STEP: 3  # 5
      AUTO_DATA_INGEST: True
      RETAIN_NUM_MONTHS: 5
      # INITIAL_INGEST_OVERRIDE: 'True'
      # INITIAL_INGEST_NUM_MONTHS: 1
      SCHEDULE_CHECK_INTERVAL: 720
      SOURCE_STATUS_FREQUENCY_MINUTES: 60
      UPDATE_TIMEOUT: 14400
      VACUUM_DATA_DAY_OF_WEEK: 0

      TENANT_MULTIPROCESSING_MAX_PROCESSES: "4"
      TENANT_MULTIPROCESSING_CHUNKS: "1"
      REPORT_DOWNLOAD_SCHEDULE: "0 22 * * *" # 1 time a day
      POLLING_TIMER: 72000 # 20 hours
      POLLING_BATCH_SIZE: 25 # Polling provider count

      TRINO_HOST: trino-coordinator
      GUNICORN_THREADS: False
      GUNICORN_WORKERS: 2
      # Deployment specific variables:
      # koku-api
      KOKU_REPLICAS: 3
      KOKU_CPU_REQUEST: 250m
      KOKU_CPU_LIMIT: 1
      KOKU_MEMORY_REQUEST: 2Gi
      KOKU_MEMORY_LIMIT: 4Gi
      # listener
      LISTENER_REPLICAS: 3
      LISTENER_CPU_REQUEST: 200m
      LISTENER_CPU_LIMIT: 500m
      LISTENER_MEMORY_REQUEST: 1Gi
      LISTENER_MEMORY_LIMIT: 2Gi
      # masu
      MASU_REPLICAS: 1
      MASU_MEMORY_REQUEST: 512Mi
      MASU_MEMORY_LIMIT: 1Gi
      # scheduler
      SCHEDULER_REPLICAS: 1  # 1
      SCHEDULER_MEMORY_REQUEST: 256Mi
      SCHEDULER_MEMORY_LIMIT: 512Mi
      # sources-client
      SOURCES_CLIENT_REPLICAS: 3
      SOURCES_CLIENT_CPU_REQUEST: 250m
      SOURCES_CLIENT_CPU_LIMIT: 500m
      SOURCES_CLIENT_MEMORY_REQUEST: 256Mi
      SOURCES_CLIENT_MEMORY_LIMIT: 512Mi
      # sources-listener
      SOURCES_LISTENER_REPLICAS: 1
      SOURCES_LISTENER_CPU_REQUEST: 250m
      SOURCES_LISTENER_CPU_LIMIT: 500m
      SOURCES_LISTENER_MEMORY_REQUEST: 256Mi
      SOURCES_LISTENER_MEMORY_LIMIT: 512Mi
      # workers global
      WORKER_PROC_ALIVE_TIMEOUT: 9
      # worker-celery
      WORKER_CELERY_REPLICAS: 3
      WORKER_CELERY_CPU_REQUEST: 200m
      WORKER_CELERY_CPU_LIMIT: 1
      WORKER_CELERY_MEMORY_REQUEST: 512Mi
      WORKER_CELERY_MEMORY_LIMIT: 1Gi
      # worker-cost-model
      WORKER_COST_MODEL_REPLICAS: 2
      WORKER_COST_MODEL_CPU_REQUEST: 100m
      WORKER_COST_MODEL_CPU_LIMIT: 300m
      WORKER_COST_MODEL_MEMORY_REQUEST: 512Mi
      WORKER_COST_MODEL_MEMORY_LIMIT: 1Gi
      # worker-download
      WORKER_DOWNLOAD_REPLICAS: 3
      WORKER_DOWNLOAD_CPU_REQUEST: 700m
      WORKER_DOWNLOAD_CPU_LIMIT: 1500m
      WORKER_DOWNLOAD_MEMORY_REQUEST: 4Gi
      WORKER_DOWNLOAD_MEMORY_LIMIT: 8Gi
      # worker-ocp
      WORKER_OCP_REPLICAS: 3
      WORKER_OCP_CPU_REQUEST: 300m
      WORKER_OCP_CPU_LIMIT: 500m
      WORKER_OCP_MEMORY_REQUEST: 512Mi
      WORKER_OCP_MEMORY_LIMIT: 1Gi
      # worker-priority
      WORKER_PRIORITY_REPLICAS: 1
      WORKER_PRIORITY_CPU_REQUEST: 500m
      WORKER_PRIORITY_CPU_LIMIT: 1
      WORKER_PRIORITY_MEMORY_REQUEST: 3Gi
      WORKER_PRIORITY_MEMORY_LIMIT: 5Gi
      # worker-refresh
      WORKER_REFRESH_REPLICAS: 2
      WORKER_REFRESH_CPU_REQUEST: 100m
      WORKER_REFRESH_CPU_LIMIT: 200m
      WORKER_REFRESH_MEMORY_REQUEST: 300Mi
      WORKER_REFRESH_MEMORY_LIMIT: 600Mi
      # worker-summary
      WORKER_SUMMARY_REPLICAS: 3
      WORKER_SUMMARY_CPU_REQUEST: 100m
      WORKER_SUMMARY_CPU_LIMIT: 200m
      WORKER_SUMMARY_MEMORY_REQUEST: 512Mi
      WORKER_SUMMARY_MEMORY_LIMIT: 1Gi
      # worker-hcs
      WORKER_HCS_REPLICAS: 1
      WORKER_HCS_CPU_REQUEST: 100m
      WORKER_HCS_CPU_LIMIT: 200m
      WORKER_HCS_MEMORY_REQUEST: 500Mi
      WORKER_HCS_MEMORY_LIMIT: 1Gi


- name: hive-metastore
  # repo deploy file: https://github.com/RedHatInsights/ubi-hive/blob/main/deploy/clowdapp.yaml
  # container image: quay.io/cloudservices/ubi-hive
  # container repo:  https://quay.io/repository/cloudservices/ubi-hive
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/ubi-hive
  targets:
  - namespace:
      $ref: /services/insights/hccm/namespaces/perf-hccm-perf.yml
    ref: 9581ee241767cb01340d80ae1c80bb56291b8757
    parameters:
      IMAGE_TAG: 3.1.3-metastore-021
      MIN_REPLICAS: 1
      S3_BUCKET_NAME: hccm-perf-s3
      CPU_REQUEST: 200m
      CPU_LIMIT: 500m
      MEMORY_REQUEST: 6Gi
      MEMORY_LIMIT: 10Gi
      MAX_HEAP_SIZE: 6G

- name: presto
  # repo deploy file: https://github.com/RedHatInsights/ubi-trino/blob/main/deploy/clowdapp.yaml
  # container image: quay.io/cloudservices/ubi-trino
  # container repo:  https://quay.io/repository/cloudservices/ubi-trino
  path: /deploy/clowdapp.yaml
  url: https://github.com/RedHatInsights/ubi-trino
  targets:
  # Performance
  - namespace:
      $ref: /services/insights/hccm/namespaces/perf-hccm-perf.yml
    ref: 86057d901989d623787281190413ea6da7f4321d
    parameters:
      CONFIGMAP_HASH: 'gffsf6' # when a `ref` update only contains changes to ConfigMaps, randomize this value to cause trino to redeploy
      IMAGE_TAG: 418-004
      S3_BUCKET_NAME: hccm-perf-s3
      MACHINE_POOL_OPTION: memory-optimized
      COORDINATOR_REPLICAS: 1 # 1
      WORKER_REPLICAS: 3
      COORDINATOR_CPU_REQUEST: 1
      COORDINATOR_CPU_LIMIT: 2
      COORDINATOR_MEMORY_REQUEST: 12Gi
      COORDINATOR_MEMORY_LIMIT: 36Gi
      WORKER_CPU_REQUEST: 400m
      WORKER_CPU_LIMIT: 2
      WORKER_MEMORY_REQUEST: 6Gi
      WORKER_MEMORY_LIMIT: 10Gi
      QUERY_MAX_MEMORY_PER_NODE: 10GB # (jvm max - heap headroom)
      QUERY_MAX_MEMORY: 20GB # (max per node * worker count)
      QUERY_MAX_TOTAL_MEMORY: 40GB # (max-memory * 2)
      MEMORY_HEAP_HEADROOM_PER_NODE: 10GB
      MAX_HEAP_SIZE: 51200M # 51200 == 50 GiB
      LIVENESS_PROBE_PERIOD: 120
      LIVENESS_PROBE_TIMEOUT: 120
