---
$schema: /app-sre/slo-document-1.yml

labels:
  service: image-builder

name: image-builder

namespaces:
- $ref: /services/insights/image-builder/namespaces/prod-image-builder-prod.yml

slos:
- name: image-builder compose-latency
  SLIType: latency
  SLISpecification: p90 of the latency of compose requests must be under 12 seconds
  SLODetails: https://gitlab.cee.redhat.com/osbuild/internal-guides/-/blob/main/src/image-builder/architecture/image-builder-crc.md
  SLOParameters:
    window: 28d
  expr: sum(rate(image_builder_http_duration_seconds_bucket{path=~".*/compose",le="12"}[{{window}}])) / sum(rate(image_builder_http_duration_seconds_count{path=~".*/compose"}[{{window}}]))
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  prometheusRules: /insights-prod/image-builder-prod/image-builder-prometheusrules.yml
  dashboard: https://grafana.app-sre.devshift.net/d/91_RmVCMk/image-builder

- name: image-builder non-compose-latency
  SLIType: latency
  SLISpecification: p90 of the latency of non-compose requests must be under 200 milliseconds
  SLODetails: https://gitlab.cee.redhat.com/osbuild/internal-guides/-/blob/main/src/image-builder/architecture/image-builder-crc.md
  SLOParameters:
    window: 28d
  expr: sum(rate(image_builder_http_duration_seconds_bucket{path!~".*/compose",le="0.2"}[{{window}}])) / sum(rate(image_builder_http_duration_seconds_count{path!~".*/compose"}[{{window}}]))
  SLOTarget: 0.90
  SLOTargetUnit: percent_0_1
  prometheusRules: /insights-prod/image-builder-prod/image-builder-prometheusrules.yml
  dashboard: https://grafana.app-sre.devshift.net/d/91_RmVCMk/image-builder

- name: image-builder compose success
  SLIType: latency
  SLISpecification: 85% of compose requests must succeed
  SLODetails: https://gitlab.cee.redhat.com/osbuild/internal-guides/-/blob/main/src/image-builder/architecture/image-builder-crc.md
  SLOParameters:
    window: 28d
  expr: (sum by (job) (increase(image_builder_compose_errors[{{window}}])) / sum by (job) (increase(image_builder_compose_requests_total[{{window}}])))
  SLOTarget: 0.85
  SLOTargetUnit: percent_0_1
  prometheusRules: /insights-prod/image-builder-prod/image-builder-prometheusrules.yml
  dashboard: https://grafana.app-sre.devshift.net/d/91_RmVCMk/image-builder
