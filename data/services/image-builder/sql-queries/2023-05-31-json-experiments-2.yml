---
$schema: /app-interface/app-interface-sql-query-1.yml
labels: {}
name: 2023-05-31-json-experiments-2
namespace:
  $ref: /services/image-builder/namespaces/composer-stage.yml
identifier: image-builder-composer-db-stage
output: stdout
queries:
# benchmarks
- |
  EXPLAIN ANALYZE
  SELECT type, channel, result, queued_at, started_at, finished_at, canceled
  FROM jobs
  WHERE id = 'a34c1bf1-5268-445c-9a8a-e508ecd091ea';
- |
  EXPLAIN ANALYZE
  SELECT result
  FROM jobs
  WHERE id = 'a34c1bf1-5268-445c-9a8a-e508ecd091ea';
# one big one
- |
  EXPLAIN ANALYZE
  SELECT
    jsonb_build_object('success', (SELECT result->'success')) ||
    jsonb_build_object('job_error', (SELECT result->'job_error')) ||
    jsonb_build_object('target_results', (SELECT result->'target_results')) ||
    jsonb_build_object('pipeline_names',
                       (SELECT jsonb_build_object('build', (SELECT result->'pipeline_names'->'build')))) ||
    jsonb_build_object('osbuild_output',
                       (SELECT jsonb_build_object('log', (SELECT result->'osbuild_output'->'log')))) ||
    jsonb_build_object('osbuild_output',
                       (SELECT jsonb_build_object('type', (SELECT result->'osbuild_output'->'type')))) ||
    jsonb_build_object('osbuild_output',
                       (SELECT jsonb_build_object('metadata', (SELECT result->'osbuild_output'->'metadata'))))
  FROM (SELECT result FROM jobs WHERE id='a34c1bf1-5268-445c-9a8a-e508ecd091ea') result;
- |
  EXPLAIN ANALYZE
  SELECT
    jsonb_build_object('success', (SELECT result->'success')) ||
    jsonb_build_object('job_error', (SELECT result->'job_error')) ||
    jsonb_build_object('target_results', (SELECT result->'target_results')) ||
    jsonb_build_object('pipeline_names',
                       (SELECT jsonb_build_object('build', (SELECT result->'pipeline_names'->'build')))) ||
    jsonb_build_object('pipeline_names',
                       (SELECT jsonb_build_object('payload', (SELECT result->'pipeline_names'->'payload'))))
  FROM (SELECT result FROM jobs WHERE id='a34c1bf1-5268-445c-9a8a-e508ecd091ea') result;
- |
  EXPLAIN ANALYZE
  SELECT
    result -> 'osbuild_output' -> 'error', result -> 'osbuild_output' -> 'success'
  FROM jobs
  WHERE id='a34c1bf1-5268-445c-9a8a-e508ecd091ea';
