---
$schema: /openshift/namespace-1.yml

labels: {}

name: workers-stage
description: staging namespace for image-builder

cluster:
  $ref: /openshift/app-sre-stage-01/cluster.yml

app:
  $ref: /services/image-builder/app.yml

environment:
  $ref: /products/osdv4/environments/stage.yml

networkPoliciesAllow:
  - $ref: /services/observability/namespaces/openshift-customer-monitoring.app-sre-stage-01.yml

limitRanges:
  $ref: /dependencies/openshift/limitranges/standard-resource-limits.yml

quota:
  $ref: /services/insights/default-quota.yml

managedRoles: true

managedResourceTypes: []

managedTerraformResources: true

terraformResources:
- provider: secrets-manager
  account: image-builder-stage
  identifier: aws-account
  secret:
    path: app-interface/image-builder/stage/aws-account
    version: 1
    field: all
  output_resource_name: aws-account
- provider: secrets-manager
  account: image-builder-stage
  identifier: azure-service-account
  secret:
    path: app-interface/image-builder/stage/azure-service-account
    version: 1
    field: all
  output_resource_name: azure-service-account
- provider: secrets-manager
  account: image-builder-stage
  identifier: gcp-service-account
  secret:
    path: app-interface/image-builder/stage/gcp-service-account
    version: 1
    field: all
  output_resource_name: gcp-service-account
- provider: secrets-manager
  account: image-builder-stage
  identifier: offline-token
  secret:
    path: app-interface/image-builder/stage/offline-token
    version: 1
    field: all
  output_resource_name: offline-token
- provider: secrets-manager
  account: image-builder-stage
  identifier: subscription-manager-command
  secret:
    path: app-interface/image-builder/stage/subscription-manager-command
    version: 1
    field: all
  output_resource_name: subscription-manager-command
- provider: cloudwatch
  account: image-builder-stage
  identifier: workers-aoc-staging
  defaults: /terraform/resources/image-builder/stage/cloudwatch-1.yml
  output_resource_name: workers-aoc-staging
- provider: aws-iam-role
  account: image-builder-stage
  identifier: workers-aoc-staging-role
  assume_role:
    Service:
    - ec2.amazonaws.com
  inline_policy:
    {
      Version: "2012-10-17",
      Statement: [
        {
          "Sid": "WorkerReadSecrets",
          "Effect": "Allow",
          "Action": [
            "secretsmanager:GetResourcePolicy",
            "secretsmanager:GetSecretValue",
            "secretsmanager:DescribeSecret",
            "secretsmanager:ListSecretVersionIds"
          ],
          "Resource": [
            "arn:aws:secretsmanager:us-east-1:920877988636:secret:aws-account-xFcPpj",
            "arn:aws:secretsmanager:us-east-1:920877988636:secret:azure-service-account-IF93Wk",
            "arn:aws:secretsmanager:us-east-1:920877988636:secret:gcp-service-account-IF93Wk",
            "arn:aws:secretsmanager:us-east-1:920877988636:secret:offline-token-4RDjer",
            "arn:aws:secretsmanager:us-east-1:920877988636:secret:subscription-manager-command-xFcPpj"
          ]
        },
        {
          "Sid": "BasicCloudWatchUsage",
          "Effect": "Allow",
          "Action": [
            "cloudwatch:PutMetricData",
            "ec2:DescribeVolumes",
            "ec2:DescribeTags",
          ],
          "Resource": "*",
        },
        {
          "Sid": "CloudWatchDescribeLogStreams",
          "Effect": "Allow",
          "Action": [
            "logs:PutLogEvents",
            "logs:DescribeLogStreams",
            "logs:CreateLogStream",
          ],
          "Resource": "arn:aws:logs:us-east-1:920877988636:log-group:workers-aoc-staging:*"
        }
      ]
    }
  output_resource_name: workers-aoc-staging-role
- provider: asg
  account: image-builder-stage
  identifier: imagebuilder-workers-aoc-x86-staging
  defaults: /terraform/resources/image-builder/stage/asg/asg-1.yml
  cloudinit_configs:
  - content: /terraform/resources/image-builder/stage/asg/worker_aoc.cfg
  variables:
    workspace_name: staging
    osbuild_commit: f7bf23fabaae6027b1e1147b27870d90d4b1911f
    composer_commit: c6c311cc3d7c748ce77e697b2f4c8074fcf09019
    composer_host_aoc: api.openshift.com
    composer_host_aoc_staging: api.stage.openshift.com
