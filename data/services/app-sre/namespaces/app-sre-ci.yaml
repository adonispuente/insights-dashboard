---
$schema: /openshift/namespace-1.yml

labels: {}

name: app-sre-ci
description: app-sre ci namespace

cluster:
  $ref: /openshift/app-sre-prod-01/cluster.yml

app:
  $ref: /services/app-sre/app.yml

environment:
  $ref: /products/app-sre/environments/production.yml

managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/app-sre-ci/account.yml
  resources:
  - provider: aws-iam-service-account
    identifier: packer
    user_policy:
      {
        "Version": "2012-10-17",
        "Statement":[
          {
            "Effect": "Allow",
            "Action": [
              "ec2:AttachVolume",
              "ec2:AuthorizeSecurityGroupIngress",
              "ec2:CopyImage",
              "ec2:CreateImage",
              "ec2:CreateKeypair",
              "ec2:CreateSecurityGroup",
              "ec2:CreateSnapshot",
              "ec2:CreateTags",
              "ec2:CreateVolume",
              "ec2:DeleteKeyPair",
              "ec2:DeleteSecurityGroup",
              "ec2:DeleteSnapshot",
              "ec2:DeleteVolume",
              "ec2:DeregisterImage",
              "ec2:DescribeImageAttribute",
              "ec2:DescribeImages",
              "ec2:DescribeInstances",
              "ec2:DescribeInstanceStatus",
              "ec2:DescribeRegions",
              "ec2:DescribeSecurityGroups",
              "ec2:DescribeSnapshots",
              "ec2:DescribeSubnets",
              "ec2:DescribeTags",
              "ec2:DescribeVolumes",
              "ec2:DetachVolume",
              "ec2:GetPasswordData",
              "ec2:ModifyImageAttribute",
              "ec2:ModifyInstanceAttribute",
              "ec2:ModifySnapshotAttribute",
              "ec2:RegisterImage",
              "ec2:RunInstances",
              "ec2:StopInstances",
              "ec2:TerminateInstances",
              "ec2:CreateLaunchTemplate",
              "ec2:DeleteLaunchTemplate",
              "ec2:CreateFleet",
              "ec2:DescribeSpotPriceHistory",
              "ec2:DescribeVpcs"
            ],
            "Resource": "*",
          }
        ]
      }
    output_resource_name: packer
- provider: aws
  provisioner:
    $ref: /aws/app-sre/account.yml
  resources:
  - provider: aws-iam-service-account
    identifier: ansible-ec2-inventory
    user_policy:
      {
        "Version": "2012-10-17",
        "Statement": [{
          "Action": [
            "autoscaling:DescribeAutoScalingGroups",
            "ec2:DescribeInstances",
            "ec2:DescribeImages"
          ],
          "Effect": "Allow",
          "Resource": "*"
        }]
      }
    output_resource_name: ansible-ec2-inventory
  - provider: asg
    identifier: ci-int-jenkins-worker-app-interface
    defaults: /terraform/resources/app-sre/production/ci-int-asg-1.yml
    overrides:
      min_size: 0
      max_size: 10
      instance_types: ["c6i.4xlarge"]
      iam_role_name: ci-instances-read-secrets
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
      - provider: git
        tag_name: infra_commit
        url: https://gitlab.cee.redhat.com/app-sre/infra
        ref: a017f57da7a599eb5bfded08242e3d97f8286764
      - provider: static
        tag_name: type
        value: ci-int-jenkins-worker-app-interface
    extra_tags:
      os: centos
      jenkins_controller: ci-int
  - provider: asg
    identifier: ci-int-jenkins-worker-app-sre
    defaults: /terraform/resources/app-sre/production/ci-int-asg-1.yml
    overrides:
      max_size: 3
      iam_role_name: ci-instances-read-secrets
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
      - provider: git
        tag_name: infra_commit
        url: https://gitlab.cee.redhat.com/app-sre/infra
        ref: a017f57da7a599eb5bfded08242e3d97f8286764
      - provider: static
        tag_name: type
        value: ci-int-jenkins-worker-app-sre
    extra_tags:
      os: centos
      jenkins_controller: ci-int
  - provider: asg
    identifier: ci-int-jenkins-worker-service-development
    defaults: /terraform/resources/app-sre/production/ci-int-asg-1.yml
    overrides:
      iam_role_name: ci-instances-read-secrets
      max_size: 2
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
    - provider: git
      tag_name: infra_commit
      url: https://gitlab.cee.redhat.com/app-sre/infra
      ref: a017f57da7a599eb5bfded08242e3d97f8286764
    - provider: static
      tag_name: type
      value: ci-int-jenkins-worker-service-development
    extra_tags:
      os: centos
      jenkins_controller: ci-int
  - provider: asg
    identifier: ci-int-jenkins-worker-insights
    defaults: /terraform/resources/app-sre/production/ci-int-asg-1.yml
    overrides:
      iam_role_name: ci-instances-read-secrets
      max_size: 3
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
    - provider: git
      tag_name: infra_commit
      url: https://gitlab.cee.redhat.com/app-sre/infra
      ref: a017f57da7a599eb5bfded08242e3d97f8286764
    - provider: static
      tag_name: type
      value: ci-int-jenkins-worker-insights
    extra_tags:
      os: centos
      jenkins_controller: ci-int
  - provider: asg
    identifier: ci-int-jenkins-worker-rhel7
    defaults: /terraform/resources/app-sre/production/ci-int-asg-1.yml
    overrides:
      iam_role_name: ci-instances-read-secrets
      max_size: 2
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
    - provider: git
      tag_name: infra_commit
      url: https://gitlab.cee.redhat.com/app-sre/infra
      ref: a017f57da7a599eb5bfded08242e3d97f8286764
    - provider: static
      tag_name: type
      value: ci-int-jenkins-worker-rhel7
    extra_tags:
      os: rhel7
      jenkins_controller: ci-int
  - provider: asg
    identifier: ci-int-jenkins-worker-rhel8
    defaults: /terraform/resources/app-sre/production/ci-int-asg-1.yml
    overrides:
      iam_role_name: ci-instances-read-secrets
      max_size: 3
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
    - provider: git
      tag_name: infra_commit
      url: https://gitlab.cee.redhat.com/app-sre/infra
      ref: a017f57da7a599eb5bfded08242e3d97f8286764
    - provider: static
      tag_name: type
      value: ci-int-jenkins-worker-rhel8
    extra_tags:
      os: rhel8
      jenkins_controller: ci-int
  - provider: asg
    identifier: ci-ext-jenkins-worker-app-sre
    defaults: /terraform/resources/app-sre/production/ci-ext-asg-1.yml
    overrides:
      iam_role_name: ci-instances-read-secrets
      max_size: 2
      instance_types: ["c5.2xlarge"]
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
      - provider: git
        tag_name: infra_commit
        url: https://gitlab.cee.redhat.com/app-sre/infra
        ref: a017f57da7a599eb5bfded08242e3d97f8286764
      - provider: static
        tag_name: type
        value: ci-ext-jenkins-worker-app-sre
    extra_tags:
      os: centos
      jenkins_controller: ci-ext
  - provider: asg
    identifier: ci-ext-jenkins-worker-codeready-analytics
    defaults: /terraform/resources/app-sre/production/ci-ext-asg-1.yml
    overrides:
      iam_role_name: ci-instances-read-secrets
      max_size: 2
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
      - provider: git
        tag_name: infra_commit
        url: https://gitlab.cee.redhat.com/app-sre/infra
        ref: a017f57da7a599eb5bfded08242e3d97f8286764
      - provider: static
        tag_name: type
        value: ci-ext-jenkins-worker-codeready-analytics
    extra_tags:
      os: rhel7
      jenkins_controller: ci-ext
  - provider: asg
    identifier: ci-ext-jenkins-worker-rhel8
    defaults: /terraform/resources/app-sre/production/ci-ext-asg-1.yml
    overrides:
      iam_role_name: ci-instances-read-secrets
      max_size: 3
    cloudinit_configs:
      - content: /terraform/resources/app-sre/production/asg/ci-instances.sh
    image:
      - provider: git
        tag_name: infra_commit
        url: https://gitlab.cee.redhat.com/app-sre/infra
        ref: a017f57da7a599eb5bfded08242e3d97f8286764
      - provider: static
        tag_name: type
        value: ci-ext-jenkins-worker-rhel8
    extra_tags:
      os: rhel8
      jenkins_controller: ci-ext
  - provider: secrets-manager
    identifier: ci-instances-splunk-token
    secret:
      path: app-interface/app-sre/ci-instances/splunk-token
      version: 1
      field: all
    output_resource_name: ci-instances-splunk-token
  - provider: aws-iam-role
    identifier: ci-instances-read-secrets
    assume_role:
      Service:
      - ec2.amazonaws.com
    inline_policy:
      {
        Version: "2012-10-17",
        Statement: [
          {
            "Sid": "CiInstancesReadSecrets",
            "Effect": "Allow",
            "Action": [
              "secretsmanager:GetResourcePolicy",
              "secretsmanager:GetSecretValue",
              "secretsmanager:DescribeSecret",
              "secretsmanager:ListSecretVersionIds"
            ],
            "Resource": [
              # The secret is defined on the same file, and the ARN can be checked in the AWS account
              # after the secret is created
              "arn:aws:secretsmanager:us-east-1:950916221866:secret:ci-instances-splunk-token-DQTxkM",
            ]
          },
        ]
      }
    output_resource_name: ci-instances-read-secrets
