---
$schema: /openshift/namespace-1.yml

labels: {}

name: dev-cloudflare
description: Dummy namespace to associate Cloudflare resources to for internal testing

cluster:
  $ref: /openshift/app-sre-stage-01/cluster.yml

app:
  $ref: /services/app-sre/app.yml

environment:
  $ref: /products/app-sre/environments/stage.yml

managedExternalResources: true

externalResources:
- provider: cloudflare
  provisioner:
    $ref: /cloudflare/app-sre/account.yml
  resources:
    - provider: zone
      identifier: cloudflare-dev-app-sre
      zone: cloudflare-dev.app-sre.devshift.net
      plan: enterprise
      type: partial
      settings:
        always_use_https: 'on'
        min_tls_version: '1.2'
      records:
        - identifier: cdn01
          name: cdn01
          type: CNAME
          ttl: 1
          # Dummy value, should be overriden by workers
          value: visual-app-interface.devshift.net
          proxied: true
      workers:
        - identifier: test-worker
          pattern: cdn01.cloudflare-dev.app-sre.devshift.net/*
          script_name: dev-worker
      certificates:
        - identifier: app-sre-dev
          type: advanced
          certificate_authority: lets_encrypt
          hosts:
            - cloudflare-dev.app-sre.devshift.net
            - cdn01.cloudflare-dev.app-sre.devshift.net 
          validation_method: txt
          validity_days: 90
    - provider: worker_script
      identifier: dev-worker
      name: dev-worker
      content_from_github:
        repo: https://github.com/app-sre/cfworkerdemo
        path: script.js
        ref: 8c5e715a2ab1d23bdd4be9aef43bc9171eddf91b
      vars:
        - name: some-var
          text: some-value
    - provider: logpush_ownership_challenge
      identifier: app-sre-cloudflare-audit-logs
      destination_conf: s3://app-sre-cloudflare-audit-logs/?region=us-east-1&sse=AES256

- provider: aws
  provisioner:
    $ref: /aws/app-sre/account.yml
  resources:
  - provider: s3
    identifier: app-sre-cloudflare-audit-logs
    defaults: /terraform/resources/s3-private-1.yml
    bucket_policy:
      {
        "Id": "Policy1506627184792",
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "Stmt1506627150918",
            "Action": ["s3:PutObject"],
            "Effect": "Allow",
            "Resource": "arn:aws:s3:::app-sre-cloudflare-audit-logs/*",
            "Principal": {
              "AWS": ["arn:aws:iam::391854517948:user/cloudflare-logpush"]
            }
          }
        ]
      }
