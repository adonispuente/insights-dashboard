---
$schema: /dependencies/jenkins-config-1.yml

labels:
  service: uhc

name: ci-int-uhc-jobs

description: ''

instance:
  $ref: /dependencies/ci-int/ci-int.yml

type: jobs

config:
- project:
    name: uhc-clusters-service
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: uhc-clusters-service
    quay_org: app-sre
    jobs:
    - 'ocm-pr-check':
        display_name: UHC clusters service check merge request
        html_publisher_dir: '.'
        concurrent_build: false
    - 'gl-build-master':
        display_name: UHC clusters service build master branch
    - 'gl-build-master':
        display_name: UHC clusters service build next branch
        branch: 'next'

- project:
    name: uhc-integration-tests
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: uhc-clusters-service
    jobs:
    - 'uhc-integration-tests':
        display_name: UHC integration tests
        environment: staging

- project:
    name: uhc-gateway
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: uhc-gateway
    quay_org: app-sre
    jobs:
    - 'gl-pr-check':
        display_name: UHC API gateway check merge request
    - 'gl-build-master':
        display_name: UHC API gateway deploy to staging

- project:
    name: uhc-gateway-cd
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: saas-uhc-gateway
    kube_cluster: app-sre-prod-04
    kube_namespace: uhc-production
    saasherder_context: uhc-gateway
    image_pattern: '^quay\.io/app-sre/(uhc-gateway|uhc-apache-exporter)'
    quay_org: app-sre
    jobs:
    - 'saas-deploy':
        display_name: UHC API gateway deploy to production
    - 'saas-pr-check':
        display_name: UHC API gateway deploy to production test

- project:
    name: uhc-account-manager
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: uhc-account-manager
    kube_cluster: app-sre-stage-01
    kube_namespace: uhc-stage
    saasherder_context: uhc-account-manager
    saasherder_services: uhc-account-manager
    saas_git: https://gitlab.cee.redhat.com/service/saas-uhc-account-manager.git
    quay_org: app-sre
    jobs:
    - 'ocm-pr-check':
        display_name: UHC Account Manager check merge request
        concurrent_build: true
        timeout: 60
    - 'gl-build-master':
        display_name: UHC Account Manager deploy to staging
    - 'gl-build-master-with-upstream':
        display_name: UHC Account Manager deploy to integration
        kube_namespace: uhc-integration
        saas_env: integration
        kube_cluster: hive-integration
        upstream: service-uhc-account-manager-gl-build-master
        build_deploy_script_path: 'true'
        disable: 'true'

- project:
    name: uhc-account-manager-cd
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: saas-uhc-account-manager
    kube_cluster: app-sre-prod-04
    kube_namespace: uhc-production
    saasherder_context: uhc-account-manager
    image_pattern: '^quay\.io/app-sre/uhc-account-manager'
    quay_org: app-sre
    jobs:
    - 'saas-deploy':
        display_name: UHC Account Manager deploy to production
    - 'saas-pr-check':
        display_name: UHC Account Manager deploy to production test

- project:
    name: uhc-portal
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: uhc-portal
    kube_cluster: app-sre-stage-01
    kube_namespace: uhc-stage
    saasherder_context: uhc-portal
    saasherder_services: uhc-portal
    saas_git: https://gitlab.cee.redhat.com/service/saas-uhc-portal.git
    quay_org: app-sre
    jobs:
    - 'ocm-pr-check-selenium':
        display_name: UHC portal check merge request
        # Runs services on fixed ports and container names
        concurrent_build: false
    - 'uhc-cloud-redhat-com-push-insights':
        display_name: UHC portal deploy to cloud.redhat.com/beta
        mode: beta
    - 'uhc-cloud-redhat-com-push-insights':
        display_name: UHC portal deploy to cloud.redhat.com prod-stable
        mode: stable
        branch: "stable"
    # TODO: add for uhc-integration

- project:
    name: uhc-apache-exporter
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: uhc-apache-exporter
    kube_cluster: app-sre-stage-01
    kube_namespace: uhc-stage
    quay_org: app-sre
    jobs:
    - 'gl-pr-check':
        display_name: UHC apache-exporter check merge request
    - 'gl-build-master':
        display_name: UHC apache-exporter build image

- project:
    name: uhc-portal-redirector
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: uhc-portal-redirector
    kube_cluster: app-sre-stage-01
    kube_namespace: uhc-stage
    saasherder_context: uhc-portal
    saasherder_services: uhc-portal-redirector
    saas_git: https://gitlab.cee.redhat.com/service/saas-uhc-portal.git
    quay_org: app-sre
    jobs:
    - 'gl-build-master':
        display_name: UHC portal redirector deploy to staging
    - 'gl-build-master-with-upstream':
        display_name: UHC portal redirector deploy to integration
        kube_namespace: uhc-integration
        saas_env: integration
        kube_cluster: hive-integration
        upstream: service-uhc-portal-redirector-gl-build-master
        build_deploy_script_path: 'true'

- project:
    name: uhc-clusters-cleaner
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: uhc-clusters-cleaner
    quay_org: app-sre
    jobs:
    - 'gl-pr-check':
        display_name: UHC clusters cleaner check merge request
    - 'gl-build-master':
        display_name: UHC clusters cleaner build master

- project:
    name: ocm-resources
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: ocm-resources
    jobs:
    - 'ocm-pr-check':
        display_name: OCM Resources check merge request
    - 'ocm-build-master':
        display_name: OCM Resources run master
        concurrent_build: false
    - 'ocm-build-master-timed-stage':
        display_name: OCM Resources run master timed against stage
        concurrent_build: false
    - 'ocm-build-master-timed-production':
        display_name: OCM Resources run master timed against production
        concurrent_build: false

- project:
    name: api-tests
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: api-tests
    jobs:
    - 'ocm-build-image':
        display_name: API Tests build image
        concurrent_build: false
    - 'ocm-pr-check':
        display_name: API Tests check merge request
        concurrent_build: false
    - 'ocm-api-tests-timed':
        display_name: API Tests periodic stage
        environment: stage
        tests: 'readonly-single'
        cron_expression: '0 * * * *'
        ci_cmd: ./periodic_check.sh periodic-readonly-single https://api.stage.openshift.com 1 1
        disable: true
    - 'ocm-api-tests-timed':
        display_name: API Tests periodic int
        environment: integration
        tests: 'readonly-single'
        cron_expression: '20 * * * *'
        ci_cmd: ./periodic_check.sh periodic-readonly-single https://api-integration.6943.hive-integration.openshiftapps.com  1 1
        disable: true
    - 'ocm-api-tests-timed':
        display_name: API Tests periodic prod
        environment: production
        tests: 'readonly-single'
        cron_expression: '40 * * * *'
        ci_cmd: ./periodic_check.sh periodic-readonly-single https://api.openshift.com  1 1
        disable: true

- project:
    name: ocm-service-log
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: ocm-service-log
    saasherder_context: ocm-service-log
    saasherder_services: ocm-service-log
    saas_git: https://gitlab.cee.redhat.com/service/saas-ocm.git
    kube_cluster: app-sre-stage-01
    kube_namespace: uhc-stage
    quay_org: app-sre
    jobs:
    - 'ocm-pr-check':
        display_name: OCM service log check merge request
        concurrent_build: true
    - 'gl-build-master':
        display_name: OCM service log deploy to staging
    - 'gl-build-master-with-upstream':
        display_name: OCM service log deploy to integration
        kube_namespace: uhc-integration
        saas_env: integration
        kube_cluster: hive-integration
        upstream: service-ocm-service-log-gl-build-master
        build_deploy_script_path: 'true'
        disable: true

- project:
    name: ocm-service-log-cd
    label: sd-uhc
    node: sd-uhc
    gl_group: service
    gl_project: saas-ocm
    kube_cluster: app-sre-prod-04
    kube_namespace: uhc-production
    saasherder_context: ocm-service-log
    image_pattern: '^quay\.io/app-sre/ocm-service-log'
    quay_org: app-sre
    jobs:
    - 'saas-deploy':
        display_name: OCM service log deploy to production
        disable: true
    - 'saas-pr-check':
        display_name: OCM service log deploy to production test
        disable: true
