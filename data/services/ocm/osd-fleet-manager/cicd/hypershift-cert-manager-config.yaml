---
$schema: /app-sre/saas-file-2.yml
labels:
  service: ocm
name: hypershift-cert-manager-config
description: SaaS file for Hypershift cert-manager configuration

# copied from osd-fleet-manager
app:
  $ref: /services/ocm/osd-fleet-manager/app.yml

pipelinesProvider:
  $ref: /services/ocm/pipelines/tekton.ocm-pipelines.appsrep05ue1.yaml

# copied from osd-fleet-manager
slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: team-uhc-info

managedResourceTypes:
- SelectorSyncSet

imagePatterns: []

allowedSecretParameterPaths:
- osd-sre/hive-integration/certman-operator/lets-encrypt-account
- app-sre/integrations-output/terraform-resources/hivei01ue1/osd-fleet-manager-integration/hypershift-cert-manager-route53
- osd-sre/hive-stage/certman-operator/lets-encrypt-account
- app-sre/integrations-output/terraform-resources/hive-stage-01/osd-fleet-manager-stage/hypershift-cert-manager-route53

resourceTemplates:
- name: hypershift-cert-manager-config-integration
  url: https://gitlab.cee.redhat.com/service/osd-fleet-manager
  path: /templates/cert-manager-config.yaml
  parameters:
    # value taken from resources/hive-integration/certman-operator/certman-operator.configmap.yaml
    CLUSTER_ISSUER_EMAIL: sd-sre-platform@redhat.com
  secretParameters:
  # not used according to https://community.letsencrypt.org/t/locating-the-mac-key-for-a-letsencrypt-account-created-by-cert-manager/129567/5
  # - name: LETSENCRYPT_ACCOUNT_URL_B64
  #   secret:
  #     path: osd-sre/hive-integration/certman-operator/lets-encrypt-account
  #     field: account-url_qb64
  #     version: 1
  - name: LETSENCRYPT_PRIVATE_KEY_B64
    secret:
      path: osd-sre/hive-integration/certman-operator/lets-encrypt-account
      field: private-key_qb64
      version: 1
  - name: ROUTE53_ACCESS_KEY_ID
    secret:
      path: app-sre/integrations-output/terraform-resources/hivei01ue1/osd-fleet-manager-integration/hypershift-cert-manager-route53
      field: aws_access_key_id
      version: 1
  - name: ROUTE53_SECRET_ACCESS_KEY
    secret:
      path: app-sre/integrations-output/terraform-resources/hivei01ue1/osd-fleet-manager-integration/hypershift-cert-manager-route53
      field: aws_secret_access_key
      version: 1
  targets:
  - name: hypershift-cert-manager-config-integration-hivei01ue1
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/hive/osd-fleet-manager-integration-hivei01ue1.yml
    ref: main
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-osd-fleet-manager-gl-build-main
    promotion:
      publish:
      - hypershift-cert-manager-config-integration-hivei01ue1

- name: hypershift-cert-manager-config-stage
  url: https://gitlab.cee.redhat.com/service/osd-fleet-manager
  path: /templates/cert-manager-config.yaml
  parameters:
    # this should probably be updated to something else
    CLUSTER_ISSUER_EMAIL: sd-sre-platform@redhat.com
  secretParameters:
  - name: LETSENCRYPT_PRIVATE_KEY_B64
    secret:
      path: osd-sre/hive-stage/certman-operator/lets-encrypt-account
      field: private-key_qb64
      version: 1
  - name: ROUTE53_ACCESS_KEY_ID
    secret:
      path: app-sre/integrations-output/terraform-resources/hive-stage-01/osd-fleet-manager-stage/hypershift-cert-manager-route53
      field: aws_access_key_id
      version: 1
  - name: ROUTE53_SECRET_ACCESS_KEY
    secret:
      path: app-sre/integrations-output/terraform-resources/hive-stage-01/osd-fleet-manager-stage/hypershift-cert-manager-route53
      field: aws_secret_access_key
      version: 1
  targets:
  - name: hypershift-cert-manager-config-stage-hive-stage-01
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/hive/osd-fleet-manager-stage-hive-stage-01.yml
    ref: 32db5bbc0231508b998b7c8d99c590d182b9033b
    promotion:
      subscribe:
      - hypershift-cert-manager-config-integration-hivei01ue1
      publish:
      - hypershift-cert-manager-config-stage-hive-stage-01
  - name: hypershift-cert-manager-config-stage-hives02ue1
    namespace:
      $ref: /services/ocm/osd-fleet-manager/namespaces/hive/osd-fleet-manager-stage-hives02ue1.yml
    ref: 32db5bbc0231508b998b7c8d99c590d182b9033b
    promotion:
      subscribe:
      - hypershift-cert-manager-config-integration-hivei01ue1
      publish:
      - hypershift-cert-manager-config-stage-hives02ue1
