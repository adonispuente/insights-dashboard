---
$schema: /app-sre/saas-file-2.yml

labels:
  service: uhc

name: saas-uhc-account-manager
description: SaaS tracking file for UHC Account manager

app:
  $ref: /services/ocm/ams/app.yml

pipelinesProvider:
  $ref: /services/ocm/pipelines/tekton.ocm-pipelines.appsrep05ue1.yaml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: team-uhc-info

managedResourceTypes:
- Deployment
- Service
- CronJob
- HorizontalPodAutoscaler

imagePatterns:
- quay.io/app-sre/uhc-account-manager
- quay.io/centos/centos
- quay.io/app-sre/envoyproxy

authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all

resourceTemplates:
- name: uhc-account-manager
  url: https://gitlab.cee.redhat.com/service/uhc-account-manager
  path: /templates/service-template.yml
  parameters:
    ENVIRONMENT: production
    IMAGE_REGISTRY: quay.io
    IMAGE_REPOSITORY: app-sre/uhc-account-manager
    JWKS_URL: https://api.openshift.com/.well-known/jwks.json
    # UHC_BASE_URL applies only to API pods with envoy running
    UHC_BASE_URL: http://127.0.0.1:9090
    CRONJOB_UHC_BASE_URL: ${OCM_BASE_URL}
    # SSO_BASE_URL is defined at the environment parameters level
    UHC_TOKEN_URL: ${SSO_BASE_URL}/protocol/openid-connect/token
    RHIT_BASE_USER_URL: https://user.api.redhat.com/v2/
    RHIT_BASE_SUBSCRIPTION_URL: https://subscription.api.redhat.com/svcrest/subscription/v5/
    RHIT_BASE_REGISTRY_URL: https://container-registry-authorizer.api.redhat.com/v1/
    RHIT_BASE_REGNUM_URL: https://subscription.api.redhat.com/svcrest/regnum/v5/
    RHIT_BASE_EXPORT_COMPLIANCE_URL: https://export-compliance.api.redhat.com/v1/
    RHIT_BASE_TERMS_URL: https://terms.api.redhat.com/svcrest/terms/
    RHIT_BASE_TNC_URL: "https://www.redhat.com/wapps/tnc"
    # All environments use the same Quay org
    QUAY_REGISTRY_ORG_NAME: "openshift-release-dev"
    AUTOMATIC_BAN: "true"
    REPLICAS: 4
    # Set replica min and max to the same value to essentially disable the HPA due to https://bugzilla.redhat.com/show_bug.cgi?id=1867477
    API_REPLICA_COUNT_MIN: "4"
    API_REPLICA_COUNT_MAX: "4"
    SUBSCRIPTION_BASED_DATA_RECONCILER_DRY_RUN: "false"
    DEPROVISION_OLD_SUBSCRIPTIONS_DRY_RUN: "false"
    SUBSCRIPTION_STATUS_RECONCILER_DRY_RUN: "false"
    EBS_ACCOUNT_RECONCILER_DRY_RUN: "false"
    OCP_SKU_LIST_FILE: /configs/subscription-skus/ocp-skus.yaml
    RHM_SKU_LIST_FILE: /configs/subscription-skus/rhm-skus-enhanced.yaml
    USE_CANDLEPIN_BASIC_AUTH: "false"
    ENABLE_SENTRY: "true"
    ENABLE_TERMS_ENFORCEMENT: "true"
    RHIT_TIMEOUT: "30s"
    RH_MARKETPLACE_QUOTA_RECONCILER_WORKER_COUNT: "1"
    RH_MARKETPLACE_QUOTA_RECONCILER_CLIENT_CARDINALITY: "1"
    OCP_USAGE_RECONCILER_WORKER_COUNT: "1"
    OCP_USAGE_CLEANER_WORKER_COUNT: "1"
    OCP_USAGE_RECONCILER_ACTIVE_DEADLINE_SECONDS: "21600"
    OCP_USAGE_CLEANER_ACTIVE_DEADLINE_SECONDS: "30000"
    HYDRA_FETCH_ORGANIZATIONS_DATA_CACHE_EXP: "24"
    HYDRA_FETCH_ORGANIZATIONS_DATA_CARDINALITY: "500"
    HYDRA_FETCH_ORGANIZATIONS_DATA_WORKER_COUNT: "3"
    # After openshift upgrade, we're seeing sporadic "http2: server: error reading preface"
    # errors in log, source IP is openshift router.
    GODEBUG: http2server=0
    CENTOS_IMAGE_REPOSITORY: centos/centos
    FETCH_TELEMETER_METRICS_WORKER_COUNT: "16"
    FETCH_TELEMETER_METRICS_STALE_METRICS_DURATION: "1440h"
    MOA_ENTITLEMENT_RECONCILER_DRY_RUN: "true"
    MOA_ENTITLEMENT_RECONCILER_WORKER_COUNT: "1"
    MOA_SKU: "MW01369"
    MOA_ENTITLEMENT_RENEW_DURATION: "120h"
    AUTO_ENTITLEMENT_RECONCILER_DRY_RUN: "true"
    AUTO_ENTITLEMENT_RECONCILER_WORKER_COUNT: "1"
    AUTO_ENTITLEMENT_RENEW_DURATION: "120h"
    API_TARGET_AVERAGE_CPU_UTILIZATION: "80"
    API_TARGET_AVERAGE_MEMORY_UTILIZATION: "75"
    TARGET_CPU_UTILIZATION: "80"
    SUBSCRIPTION_STATUS_RECONCILER_RELEASED_UNRELEASED_TRIGGER_DURATION: "120h"
    SUBSCRIPTION_STATUS_RECONCILER_OSDTRIAL_EXPIRY_REMINDER_1_DURATION: "720h"
    SUBSCRIPTION_STATUS_RECONCILER_OSDTRIAL_EXPIRY_REMINDER_2_DURATION: "336h"
    SUBSCRIPTION_STATUS_RECONCILER_OSDTRIAL_EXPIRY_REMINDER_3_DURATION: "72h"
    # group cron schedules here
    SUBSCRIPTION_STATUS_RECONCILER_SCHEDULE_EXPRESSION: "6 * * * *"
    EBS_ACCOUNT_RECONCILER_CRON_SCHEDULE: "11 * * * *"
    HYDRA_FETCH_ORGANIZATIONS_DATA_CRON_SCHEDULE: "16 * * * *"
    OCP_USAGE_CLEANER_CRON_SCHEDULE: "21 */5 * * *"
    OCP_USAGE_RECONCILER_CRON_SCHEDULE: "26 */2 * * *"
    MOA_ENTITLEMENT_RECONCILER_CRON_SCHEDULE: "31 11 * * *"
    AUTO_ENTITLEMENT_RECONCILER_CRON_SCHEDULE: "31 11 * * *"
    RH_MARKETPLACE_QUOTA_RECONCILER_CRON_SCHEDULE: "*/5 * * * *"
  targets:
  - namespace:
      $ref: /services/ocm/namespaces/uhc-integration-v3.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    parameters:
      UHC_BASE_URL: http://127.0.0.1:9090
      SUSPEND_FETCH_TELEMETER_METRICS_CRON: "true"
      FETCH_TELEMETER_METRICS_DRY_RUN: "true"
      TELEMETER_BASE_URL: "https://infogw-proxy.api.stage.openshift.com/"
      TELEMETER_DEBUG: "true"
      SUSPEND_HYDRA_FETCH_ORGANIZATIONS_DATA_CRON: "true"
      HYDRA_DEBUG: "false"
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.stage.redhat.com/candlepin
      USE_CANDLEPIN_BASIC_AUTH: "true"
      CLUSTER_REG_RATE_LIMIT: 30000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: "sentry.autom8.in"
      SENTRY_PROJECT: "9"
      GLOG_V: 5
      ORG_CLUSTER_REG_RATE_LIMIT: 50
      # Update the value to any random string to perform a rolling update of the deployment.
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_2
      SUBSCRIPTION_STATUS_RECONCILER_EVALUATION_DURATION: "24h"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CLIENT_CARDINALITY: "1"
      # Don't run OCP Usage reconciliation jobs in int, since they just fail anyway without a public rhsm stage endpoint
      # Suspension params should always be env specific
      SUSPEND_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_DEPROVISION_OLD_SUBSCRIPTIONS_CRON: "false"
      SUSPEND_OCP_USAGE_RECONCILER_CRON: "true"
      SUSPEND_OCP_USAGE_CLEANER_CRON: "true"
      SUSPEND_SUBSCRIPTION_BASED_DATA_RECONCILER_CRON: "false"
      SUSPEND_RH_MARKETPLACE_QUOTA_RECONCILER_CRON: "false"
      SUSPEND_EBS_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_SUBSCRIPTION_STATUS_RECONCILER_CRON: "false"
      # TODO un-suspend reg cred pool loader once issues are resolved
      SUSPEND_REGISTRY_CREDENTIAL_POOL_LOADER_CRON: "false"
      SUSPEND_MOA_ENTITLEMENT_RECONCILER_CRON: "false"
      SUSPEND_AUTO_ENTITLEMENT_RECONCILER_CRON: "false"
      MOA_SKU: "SER0579"
      ACCOUNT_RECONCILER_DRY_RUN: "false"
      RH_MARKETPLACE_QUOTA_RECONCILER_DRY_RUN: "true"
      REGISTRY_CREDENTIAL_POOL_LOADER_DRY_RUN: "false"
      REGISTRY_CREDENTIAL_POOL_LOADER_WORKER_COUNT: "1"
      REGISTRY_CREDENTIAL_POOL_LOADER_CARDINALITY: "5"
      REGISTRY_CREDENTIAL_POOL_LOADER_HIGH_WATERMARK: "10"
      UNLEASH_URL: "https://ocm-integration.unleash.devshift.net/api"
      QUAY_REGISTRY_TEAM_NAME: "integrationinstallers"
      # group cron schedules here
      FETCH_TELEMETER_METRICS_CRON_SCHEDULE: "*/30 * * * *"
      # Deprovision old subs only every friday in INT since it will break test subscriptions for CS when it runs
      DEPROVISION_OLD_SUBSCRIPTIONS_CRON_SCHEDULE: "0 23 * * 5"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CRON_SCHEDULE: "*/30 * * * *"
      ACCOUNT_RECONCILER_CRON_SCHEDULE: "30 18 * * *"
      REGISTRY_CREDENTIAL_POOL_LOADER_CRON_SCHEDULE: "0 * * * *"
      METRICS_BASE_URL: "uhc-acct-mngr-metrics.uhc-integration.svc.cluster.local"
  - namespace:
      $ref: /services/ocm/namespaces/uhc-integration.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    parameters:
      UHC_BASE_URL: http://127.0.0.1:9090
      API_REPLICA_COUNT_MIN: "2"
      API_REPLICA_COUNT_MAX: "6"
      SUSPEND_FETCH_TELEMETER_METRICS_CRON: "true"
      FETCH_TELEMETER_METRICS_DRY_RUN: "true"
      TELEMETER_BASE_URL: "https://infogw-proxy.api.stage.openshift.com/"
      TELEMETER_DEBUG: "true"
      SUSPEND_HYDRA_FETCH_ORGANIZATIONS_DATA_CRON: "true"
      HYDRA_DEBUG: "false"
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.stage.redhat.com/candlepin
      USE_CANDLEPIN_BASIC_AUTH: "true"
      # Set rate limits fairly high in integration to allow for scalability testing.
      CLUSTER_REG_RATE_LIMIT: 30000
      ORG_CLUSTER_REG_RATE_LIMIT: 30000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: "sentry.autom8.in"
      SENTRY_PROJECT: "9"
      GLOG_V: 5
      # Update the value to any random string to perform a rolling update of the deployment.
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
      SUBSCRIPTION_STATUS_RECONCILER_EVALUATION_DURATION: "24h"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CLIENT_CARDINALITY: "1"
      # Don't run OCP Usage reconciliation jobs in int, since they just fail anyway without a public rhsm stage endpoint
      # Suspension params should always be env specific
      SUSPEND_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_DEPROVISION_OLD_SUBSCRIPTIONS_CRON: "false"
      SUSPEND_OCP_USAGE_RECONCILER_CRON: "true"
      SUSPEND_OCP_USAGE_CLEANER_CRON: "true"
      SUSPEND_SUBSCRIPTION_BASED_DATA_RECONCILER_CRON: "false"
      SUSPEND_RH_MARKETPLACE_QUOTA_RECONCILER_CRON: "false"
      SUSPEND_EBS_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_SUBSCRIPTION_STATUS_RECONCILER_CRON: "false"
      SUSPEND_REGISTRY_CREDENTIAL_POOL_LOADER_CRON: "false"
      SUSPEND_MOA_ENTITLEMENT_RECONCILER_CRON: "false"
      SUSPEND_AUTO_ENTITLEMENT_RECONCILER_CRON: "false"
      MOA_SKU: "SER0579"
      RH_MARKETPLACE_QUOTA_RECONCILER_DRY_RUN: "false"
      ACCOUNT_RECONCILER_DRY_RUN: "false"
      REGISTRY_CREDENTIAL_POOL_LOADER_DRY_RUN: "false"
      REGISTRY_CREDENTIAL_POOL_LOADER_WORKER_COUNT: "1"
      REGISTRY_CREDENTIAL_POOL_LOADER_CARDINALITY: "5"
      REGISTRY_CREDENTIAL_POOL_LOADER_HIGH_WATERMARK: "10"
      UNLEASH_URL: "https://ocm-integration.unleash.devshift.net/api"
      # group cron schedules here
      FETCH_TELEMETER_METRICS_CRON_SCHEDULE: "*/30 * * * *"
      # Deprovision old subs only every friday in INT since it will break test subscriptions for CS when it runs
      DEPROVISION_OLD_SUBSCRIPTIONS_CRON_SCHEDULE: "0 23 * * 5"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CRON_SCHEDULE: "*/30 * * * *"
      ACCOUNT_RECONCILER_CRON_SCHEDULE: "30 18 * * *"
      REGISTRY_CREDENTIAL_POOL_LOADER_CRON_SCHEDULE: "0 * * * *"
      METRICS_BASE_URL: "uhc-acct-mngr-metrics.uhc-integration.svc.cluster.local"
  - namespace:
      $ref: /services/ocm/namespaces/uhc-stage.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    parameters:
      UHC_BASE_URL: http://127.0.0.1:9090
      REPLICAS: 6
      # Set replica min and max to the same value to essentially disable the HPA due to https://bugzilla.redhat.com/show_bug.cgi?id=1867477
      API_REPLICA_COUNT_MIN: "6"
      API_REPLICA_COUNT_MAX: "6"
      # Temporarily increase the CPU limit to 2 for stage AMS during scale testing the replicas were also increased for ^
      CPU_LIMIT: "2"
      SUSPEND_FETCH_TELEMETER_METRICS_CRON: "false"
      FETCH_TELEMETER_METRICS_DRY_RUN: "false"
      TELEMETER_BASE_URL: "https://infogw-proxy.api.stage.openshift.com/"
      TELEMETER_DEBUG: "true"
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.stage.redhat.com/candlepin
      # These rate limit values are purposefully insanely high to ensure they do not get in the way of scale testing in stage
      CLUSTER_REG_RATE_LIMIT: 500000
      ORG_CLUSTER_REG_RATE_LIMIT: 750000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: "sentry.stage.devshift.net"
      SENTRY_PROJECT: "10"
      CRONJOB_SENTRY_PROJECT: "23"
      GLOG_V: 5
      SUSPEND_HYDRA_FETCH_ORGANIZATIONS_DATA_CRON: "false"
      HYDRA_FETCH_ORGANIZATONS_DATA_DRY_RUN: "false"
      HYDRA_DEBUG: "false"
      # Update the value to any random string to perform a rolling update of the deployment.
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_2
      SUBSCRIPTION_BASED_DATA_RECONCILER_CLIENT_CARDINALITY: "1"
      SUBSCRIPTION_STATUS_RECONCILER_RELEASED_UNRELEASED_TRIGGER_DURATION: "1h"
      SUBSCRIPTION_STATUS_RECONCILER_OSDTRIAL_EXPIRY_REMINDER_1_DURATION: "1440h"
      SUBSCRIPTION_STATUS_RECONCILER_OSDTRIAL_EXPIRY_REMINDER_2_DURATION: "1439h"
      SUBSCRIPTION_STATUS_RECONCILER_OSDTRIAL_EXPIRY_REMINDER_3_DURATION: "1438h"
      # Don't run OCP Usage reconciliation jobs in stage, since they just fail anyway without a public rhsm stage endpoint
      # Suspension params should always be env specific
      SUSPEND_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_DEPROVISION_OLD_SUBSCRIPTIONS_CRON: "true"
      SUSPEND_OCP_USAGE_RECONCILER_CRON: "true"
      SUSPEND_OCP_USAGE_CLEANER_CRON: "true"
      SUSPEND_SUBSCRIPTION_BASED_DATA_RECONCILER_CRON: "false"
      SUSPEND_RH_MARKETPLACE_QUOTA_RECONCILER_CRON: "false"
      SUSPEND_EBS_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_SUBSCRIPTION_STATUS_RECONCILER_CRON: "false"
      SUSPEND_REGISTRY_CREDENTIAL_POOL_LOADER_CRON: "false"
      SUSPEND_MOA_ENTITLEMENT_RECONCILER_CRON: "false"
      SUSPEND_AUTO_ENTITLEMENT_RECONCILER_CRON: "false"
      MOA_ENTITLEMENT_RECONCILER_DRY_RUN: "false"
      AUTO_ENTITLEMENT_RECONCILER_DRY_RUN: "false"
      RH_MARKETPLACE_QUOTA_RECONCILER_DRY_RUN: "false"
      MOA_SKU: "SER0579"
      REGISTRY_CREDENTIAL_POOL_LOADER_DRY_RUN: "false"
      REGISTRY_CREDENTIAL_POOL_LOADER_WORKER_COUNT: "1"
      REGISTRY_CREDENTIAL_POOL_LOADER_CARDINALITY: "5"
      REGISTRY_CREDENTIAL_POOL_LOADER_HIGH_WATERMARK: "10"
      UHC_DEBUG: "true"
      UNLEASH_URL: "https://ocm-stage.unleash.devshift.net/api"
      QUAY_REGISTRY_TEAM_NAME: "staginginstallers"
      # group cron schedules here
      FETCH_TELEMETER_METRICS_CRON_SCHEDULE: "*/5 * * * *"
      DEPROVISION_OLD_SUBSCRIPTIONS_CRON_SCHEDULE: "30 17 * * *"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CRON_SCHEDULE: "*/30 * * * *"
      REGISTRY_CREDENTIAL_POOL_LOADER_CRON_SCHEDULE: "0 * * * *"
      METRICS_BASE_URL: "uhc-acct-mngr-metrics.uhc-stage.svc.cluster.local"
  - namespace:
      $ref: /services/ocm/namespaces/uhc-stage-appsres04ue2.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    parameters:
      UHC_BASE_URL: http://127.0.0.1:9090
      SUSPEND_FETCH_TELEMETER_METRICS_CRON: "true"
      FETCH_TELEMETER_METRICS_DRY_RUN: "false"
      TELEMETER_BASE_URL: "https://infogw-proxy.api.stage.openshift.com/"
      TELEMETER_DEBUG: "true"
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.stage.redhat.com/candlepin
      # These rate limit values are purposefully insanely high to ensure they do not get in the way of scale testing in stage
      CLUSTER_REG_RATE_LIMIT: 500000
      ORG_CLUSTER_REG_RATE_LIMIT: 750000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: "sentry.stage.devshift.net"
      SENTRY_PROJECT: "10"
      CRONJOB_SENTRY_PROJECT: "23"
      GLOG_V: 5
      SUSPEND_HYDRA_FETCH_ORGANIZATIONS_DATA_CRON: "true"
      HYDRA_FETCH_ORGANIZATONS_DATA_DRY_RUN: "false"
      HYDRA_DEBUG: "false"
      # Update the value to any random string to perform a rolling update of the deployment.
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
      SUBSCRIPTION_BASED_DATA_RECONCILER_CLIENT_CARDINALITY: "1"
      SUBSCRIPTION_STATUS_RECONCILER_RELEASED_UNRELEASED_TRIGGER_DURATION: "1h"
      # Don't run OCP Usage reconciliation jobs in stage, since they just fail anyway without a public rhsm stage endpoint
      # Suspension params should always be env specific
      SUSPEND_ACCOUNT_RECONCILER_CRON: "true"
      SUSPEND_DEPROVISION_OLD_SUBSCRIPTIONS_CRON: "true"
      SUSPEND_OCP_USAGE_RECONCILER_CRON: "true"
      SUSPEND_OCP_USAGE_CLEANER_CRON: "true"
      SUSPEND_SUBSCRIPTION_BASED_DATA_RECONCILER_CRON: "true"
      SUSPEND_RH_MARKETPLACE_QUOTA_RECONCILER_CRON: "true"
      SUSPEND_EBS_ACCOUNT_RECONCILER_CRON: "true"
      SUSPEND_SUBSCRIPTION_STATUS_RECONCILER_CRON: "true"
      SUSPEND_REGISTRY_CREDENTIAL_POOL_LOADER_CRON: "true"
      SUSPEND_MOA_ENTITLEMENT_RECONCILER_CRON: "true"
      SUSPEND_AUTO_ENTITLEMENT_RECONCILER_CRON: "true"
      MOA_SKU: "SER0579"
      RH_MARKETPLACE_QUOTA_RECONCILER_DRY_RUN: "false"
      REGISTRY_CREDENTIAL_POOL_LOADER_DRY_RUN: "false"
      REGISTRY_CREDENTIAL_POOL_LOADER_WORKER_COUNT: "1"
      REGISTRY_CREDENTIAL_POOL_LOADER_CARDINALITY: "5"
      REGISTRY_CREDENTIAL_POOL_LOADER_HIGH_WATERMARK: "10"
      UHC_DEBUG: "true"
      UNLEASH_URL: "https://ocm-stage.unleash.devshift.net/api"
      QUAY_REGISTRY_TEAM_NAME: "staginginstallers"
      # group cron schedules here
      FETCH_TELEMETER_METRICS_CRON_SCHEDULE: "*/5 * * * *"
      DEPROVISION_OLD_SUBSCRIPTIONS_CRON_SCHEDULE: "30 17 * * *"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CRON_SCHEDULE: "*/30 * * * *"
      REGISTRY_CREDENTIAL_POOL_LOADER_CRON_SCHEDULE: "0 * * * *"
      METRICS_BASE_URL: "uhc-acct-mngr-metrics.uhc-stage.svc.cluster.local"
  - namespace:
      $ref: /services/ocm/namespaces/uhc-production.yml
    ref: d213f3c92c3decd89146cf69a8d2988520c25bf3
    parameters:
      REPLICAS: 6
      # Set replica min and max to the same value to essentially disable the HPA due to https://bugzilla.redhat.com/show_bug.cgi?id=1867477
      API_REPLICA_COUNT_MIN: "6"
      API_REPLICA_COUNT_MAX: "6"
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.redhat.com/candlepin
      CLUSTER_REG_RATE_LIMIT: 250
      ORG_CLUSTER_REG_RATE_LIMIT: 50
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: "sentry.devshift.net"
      SENTRY_PROJECT: "2"
      CRONJOB_SENTRY_PROJECT: "17"
      GLOG_V: 5 # Set this back to 1 after SDB-2101 and related issues
      ACCOUNT_RECONCILER_DRY_RUN: "false"
      ACCOUNT_RECONCILER_WORKER_COUNT: "2"
      STALE_SCREEN_PERIOD: "72h"
      HYDRA_FETCH_ORGANIZATONS_DATA_DRY_RUN: "false"
      HYDRA_DEBUG: "false"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CLIENT_CARDINALITY: "1"
      REGISTRY_CREDENTIAL_POOL_LOADER_DRY_RUN: "false"
      REGISTRY_CREDENTIAL_POOL_LOADER_WORKER_COUNT: "1"
      REGISTRY_CREDENTIAL_POOL_LOADER_CARDINALITY: "100"
      REGISTRY_CREDENTIAL_POOL_LOADER_HIGH_WATERMARK: "3000"
      # Suspension params should always be env specific
      SUSPEND_DEPROVISION_OLD_SUBSCRIPTIONS_CRON: "true"
      SUSPEND_OCP_USAGE_RECONCILER_CRON: "false"
      SUSPEND_OCP_USAGE_CLEANER_CRON: "false"
      SUSPEND_SUBSCRIPTION_STATUS_RECONCILER_CRON: "false"
      SUSPEND_SUBSCRIPTION_BASED_DATA_RECONCILER_CRON: "false"
      SUSPEND_RH_MARKETPLACE_QUOTA_RECONCILER_CRON: "false"
      SUSPEND_EBS_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_REGISTRY_CREDENTIAL_POOL_LOADER_CRON: "false"
      SUSPEND_MOA_ENTITLEMENT_RECONCILER_CRON: "false"
      SUSPEND_AUTO_ENTITLEMENT_RECONCILER_CRON: "false"
      SUSPEND_HYDRA_FETCH_ORGANIZATIONS_DATA_CRON: "false"
      SUSPEND_FETCH_TELEMETER_METRICS_CRON: "false"
      MOA_ENTITLEMENT_RECONCILER_DRY_RUN: "false"
      AUTO_ENTITLEMENT_RECONCILER_DRY_RUN: "false"
      RH_MARKETPLACE_QUOTA_RECONCILER_DRY_RUN: "false"
      MOA_SKU: "MW01369"
      # Update the value to any random string to perform a rolling update of the deployment.
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: roll_for_ocp_skus
      UNLEASH_URL: "https://ocm.unleash.devshift.net/api"
      FETCH_TELEMETER_METRICS_DRY_RUN: "false"
      TELEMETER_BASE_URL: "https://infogw-proxy.api.openshift.com/"
      TELEMETER_DEBUG: "true"
      QUAY_REGISTRY_TEAM_NAME: "installers"
      # group cron schedules
      ACCOUNT_RECONCILER_CRON_SCHEDULE: "36 18 * * *"
      DEPROVISION_OLD_SUBSCRIPTIONS_CRON_SCHEDULE: "36 17 * * *"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CRON_SCHEDULE: "3-59/30 * * * *"
      REGISTRY_CREDENTIAL_POOL_LOADER_CRON_SCHEDULE: "46 * * * *"
      FETCH_TELEMETER_METRICS_CRON_SCHEDULE: "*/5 * * * *"
      METRICS_BASE_URL: "uhc-acct-mngr-metrics.uhc-production.svc.cluster.local"
      # 5 minutes, 300 seconds in milliseconds
      DB_QUERY_READ_TIMEOUT_SERVER: "300000"
      # 1 minute, 60 seconds in milliseconds
      DB_QUERY_WRITE_TIMEOUT_SERVER: "60000"
  - namespace:
      $ref: /services/ocm/namespaces/uhc-stage-sso-test.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    parameters:
      UHC_BASE_URL: http://127.0.0.1:9090
      RHIT_BASE_TERMS_URL: https://terms.stage.api.redhat.com/svcrest/terms/
      RHIT_BASE_TNC_URL: "https://www.stage.redhat.com/wapps/tnc"
      # SSO_BASE_URL is defined at the environment parameters level
      UHC_TOKEN_URL: ${SSO_BASE_URL}/protocol/openid-connect/token
      JWKS_URL: ${SSO_BASE_URL}/protocol/openid-connect/certs
      ENABLE_PENDO_MOCK: "true"
      RHIT_BASE_USER_URL: https://user.stage.api.redhat.com/v2/
      RHIT_BASE_SUBSCRIPTION_URL: https://subscription.stage.api.redhat.com/svcrest/subscription/v5/
      RHIT_BASE_REGNUM_URL: https://subscription.stage.api.redhat.com/svcrest/regnum/v5/
      RHIT_BASE_REGISTRY_URL: https://container-registry-authorizer.stage.api.redhat.com/v1/
      RHIT_BASE_EXPORT_COMPLIANCE_URL: https://export-compliance.stage.api.redhat.com/v1/
      SUSPEND_FETCH_TELEMETER_METRICS_CRON: "false"
      FETCH_TELEMETER_METRICS_DRY_RUN: "false"
      TELEMETER_BASE_URL: "https://infogw-proxy.api.stage.openshift.com/"
      TELEMETER_DEBUG: "true"
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.stage.redhat.com/candlepin
      CLUSTER_REG_RATE_LIMIT: 30000
      ORG_CLUSTER_REG_RATE_LIMIT: 50
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: "sentry.stage.devshift.net"
      SENTRY_PROJECT: "19"
      CRONJOB_SENTRY_PROJECT: "23"
      GLOG_V: 5
      SUSPEND_HYDRA_FETCH_ORGANIZATIONS_DATA_CRON: "true"
      HYDRA_FETCH_ORGANIZATONS_DATA_DRY_RUN: "false"
      HYDRA_DEBUG: "false"
      # Update the value to any random string to perform a rolling update of the deployment.
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
      SUBSCRIPTION_BASED_DATA_RECONCILER_CLIENT_CARDINALITY: "1"
      # Don't run OCP Usage reconciliation jobs in stage, since they just fail anyway without a public rhsm stage endpoint
      # Suspension params should always be env specific
      SUSPEND_ACCOUNT_RECONCILER_CRON: "false"
      SUSPEND_DEPROVISION_OLD_SUBSCRIPTIONS_CRON: "true"
      SUSPEND_OCP_USAGE_RECONCILER_CRON: "true"
      SUSPEND_OCP_USAGE_CLEANER_CRON: "true"
      # Suspend RHIT-based reconciliation jobs in sso-test since they won't work anyway without proper certs
      SUSPEND_SUBSCRIPTION_BASED_DATA_RECONCILER_CRON: "true"
      SUSPEND_RH_MARKETPLACE_QUOTA_RECONCILER_CRON: "true"
      SUSPEND_EBS_ACCOUNT_RECONCILER_CRON: "true"
      SUSPEND_SUBSCRIPTION_STATUS_RECONCILER_CRON: "false"
      SUSPEND_REGISTRY_CREDENTIAL_POOL_LOADER_CRON: "false"
      SUSPEND_MOA_ENTITLEMENT_RECONCILER_CRON: "true"
      SUSPEND_AUTO_ENTITLEMENT_RECONCILER_CRON: "true"
      MOA_SKU: "SER0579"
      REGISTRY_CREDENTIAL_POOL_LOADER_DRY_RUN: "false"
      REGISTRY_CREDENTIAL_POOL_LOADER_WORKER_COUNT: "1"
      REGISTRY_CREDENTIAL_POOL_LOADER_CARDINALITY: "5"
      REGISTRY_CREDENTIAL_POOL_LOADER_HIGH_WATERMARK: "10"
      UHC_DEBUG: "true"
      UNLEASH_URL: "https://ocm-stage.unleash.devshift.net/api"
      QUAY_REGISTRY_TEAM_NAME: "staginginstallers"
      # group cron schedules here
      FETCH_TELEMETER_METRICS_CRON_SCHEDULE: "*/5 * * * *"
      DEPROVISION_OLD_SUBSCRIPTIONS_CRON_SCHEDULE: "30 17 * * *"
      SUBSCRIPTION_BASED_DATA_RECONCILER_CRON_SCHEDULE: "*/30 * * * *"
      REGISTRY_CREDENTIAL_POOL_LOADER_CRON_SCHEDULE: "0 * * * *"
      METRICS_BASE_URL: "uhc-acct-mngr-metrics.uhc-stage.svc.cluster.local"
