---
$schema: /app-sre/saas-file-2.yml
labels:
  service: uhc
name: saas-uhc-account-manager
description: SaaS tracking file for UHC Account manager
app:
  $ref: /services/ocm/ams/app.yml
pipelinesProvider:
  $ref: /services/ocm/pipelines/tekton.ocm-pipelines.appsrep05ue1.yaml
deployResources:
  requests:
    cpu: 600m
    memory: 2000Mi
  limits:
    memory: 2000Mi
slack:
  workspace:
    $ref: /dependencies/slack/redhat-internal.yml
  channel: team-uhc-info
managedResourceTypes:
- Deployment
- Service
- CronJob
- ConfigMap
imagePatterns:
- quay.io/app-sre/uhc-account-manager
- quay.io/centos/centos
- quay.io/app-sre/envoyproxy
authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all
resourceTemplates:
- name: uhc-account-manager-green
  url: https://gitlab.cee.redhat.com/service/uhc-account-manager
  path: /templates/named-service-template.yml
  parameters:
    DEPLOYMENT_NAME: uhc-acct-mngr-green
    IMAGE_REGISTRY: quay.io
    IMAGE_REPOSITORY: app-sre/uhc-account-manager
    JWKS_URL: https://api.openshift.com/.well-known/jwks.json
    UHC_BASE_URL: http://127.0.0.1:9090
    UHC_TOKEN_URL: ${SSO_BASE_URL}/protocol/openid-connect/token
    RHIT_BASE_USER_URL: https://user.api.redhat.com/v2/
    RHIT_BASE_SUBSCRIPTION_URL: https://subscription.api.redhat.com/svcrest/subscription/v5/
    RHIT_BASE_REGISTRY_URL: https://container-registry-authorizer.api.redhat.com/v1/
    RHIT_BASE_REGNUM_URL: https://subscription.api.redhat.com/svcrest/regnum/v5/
    RHIT_BASE_EXPORT_COMPLIANCE_URL: https://export-compliance.api.redhat.com/v1/
    RHIT_BASE_TERMS_URL: https://terms.api.redhat.com/svcrest/terms/
    RHIT_BASE_TNC_URL: https://www.redhat.com/wapps/tnc
    QUAY_REGISTRY_ORG_NAME: openshift-release-dev
    REPLICAS: 1
    RHM_SKU_LIST_FILE: /configs/subscription-skus/rhm-skus-enhanced.yaml
    ENABLE_SENTRY: 'true'
    ENABLE_TERMS_ENFORCEMENT: 'true'
    RHIT_TIMEOUT: 30s
    MANDRILL_TIMEOUT: 60s
    GODEBUG: http2server=0
    PPROF_SERVER_BINDADDRESS: ''
    TELEMETER_URL: ${TELEMETER_BASE_URL}
    ULOG_V: info
  targets:
  - namespace:
      $ref: /services/ocm/namespaces/uhc-integration.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    promotion:
      publish:
      - ocm-ams-deployed-int-green
    parameters:
      GATE_NAME: ocm-ams-int-canary
      TELEMETER_DEBUG: 'true'
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.stage.redhat.com/candlepin
      USE_CANDLEPIN_BASIC_AUTH: 'true'
      CLUSTER_REG_RATE_LIMIT: 30000
      ORG_CLUSTER_REG_RATE_LIMIT: 30000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: sentry.autom8.in
      SENTRY_PROJECT: '9'
      GLOG_V: 5
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_2
      MOA_SKU: SER0579
      UNLEASH_URL: https://ocm-integration.unleash.devshift.net/api
      METRICS_BASE_URL: uhc-acct-mngr-metrics.uhc-integration.svc.cluster.local
      ENABLE_ORG_SERVICE_ACCT_EMAIL_VALIDATION: 'true'
      PPROF_SERVER_BINDADDRESS: 'localhost:8085'
  - namespace:
      $ref: /services/ocm/namespaces/uhc-stage.yml
    ref: cad44f5cfe34f833c8a5c1c5284cd29400b55b14
    promotion:
      auto: true
      subscribe:
      - ocm-ams-deployed-int-green
      publish:
      - ocm-ams-deployed-stage-green
    parameters:
      GATE_NAME: ocm-ams-stage-canary
      REPLICAS: 1
      CPU_LIMIT: '2'
      MEMORY_LIMIT: 2.5Gi
      CLUSTER_REG_RATE_LIMIT: 500000
      ORG_CLUSTER_REG_RATE_LIMIT: 750000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: glitchtip.devshift.net
      SENTRY_PROJECT: '10'
      GLOG_V: 5
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_2
      MOA_SKU: SER0579
      UHC_DEBUG: 'true'
      UNLEASH_URL: https://ocm-stage.unleash.devshift.net/api
      QUAY_REGISTRY_TEAM_NAME: staginginstallers
      METRICS_BASE_URL: uhc-acct-mngr-metrics.uhc-stage.svc.cluster.local
      RBAC_BASE_URL: https://mtls.internal.console.redhat.com
      RBAC_PROXY: ''
      RBAC_RECONCILER_WORKER_COUNT: 2
      ENABLE_ORG_SERVICE_ACCT_EMAIL_VALIDATION: 'true'
      PPROF_SERVER_BINDADDRESS: 'localhost:8085'
  - namespace:
      $ref: /services/ocm/namespaces/uhc-production.yml
    ref: cad44f5cfe34f833c8a5c1c5284cd29400b55b14
    parameters:
      GATE_NAME: ocm-ams-prod-canary
      CPU_LIMIT: '2'
      MEMORY_LIMIT: 4Gi
      REPLICAS: 1
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.redhat.com/candlepin
      CLUSTER_REG_RATE_LIMIT: 250
      ORG_CLUSTER_REG_RATE_LIMIT: 50
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: glitchtip.devshift.net
      SENTRY_PROJECT: '49'
      GLOG_V: 5
      ENABLE_CERTIFICATE_MOCK: 'false'
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_for_vault_secret_21
      UNLEASH_URL: https://ocm.unleash.devshift.net/api
      TELEMETER_DEBUG: 'true'
      QUAY_REGISTRY_TEAM_NAME: installers
      METRICS_BASE_URL: uhc-acct-mngr-metrics.uhc-production.svc.cluster.local
      DB_QUERY_READ_TIMEOUT_SERVER: '300000'
      DB_QUERY_WRITE_TIMEOUT_SERVER: '60000'
      RBAC_BASE_URL: https://mtls.internal.console.redhat.com
      RBAC_PROXY: ''
      AUTOMATIC_BAN: 'true'
      ENVOY_CPU_LIMIT: 750m

- name: uhc-account-manager-blue
  url: https://gitlab.cee.redhat.com/service/uhc-account-manager
  path: /templates/named-service-template.yml
  parameters:
    DEPLOYMENT_NAME: uhc-acct-mngr
    DEPLOYMENT_RING: blue
    IMAGE_REGISTRY: quay.io
    IMAGE_REPOSITORY: app-sre/uhc-account-manager
    TELEMETER_DEBUG: 'true'
    TELEMETER_URL: ${TELEMETER_BASE_URL}
    RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.stage.redhat.com/candlepin
    JWKS_URL: https://api.openshift.com/.well-known/jwks.json
    UHC_BASE_URL: http://127.0.0.1:9090
    UHC_TOKEN_URL: ${SSO_BASE_URL}/protocol/openid-connect/token
    RHIT_BASE_USER_URL: https://user.api.redhat.com/v2/
    RHIT_BASE_SUBSCRIPTION_URL: https://subscription.api.redhat.com/svcrest/subscription/v5/
    RHIT_BASE_REGISTRY_URL: https://container-registry-authorizer.api.redhat.com/v1/
    RHIT_BASE_REGNUM_URL: https://subscription.api.redhat.com/svcrest/regnum/v5/
    RHIT_BASE_EXPORT_COMPLIANCE_URL: https://export-compliance.api.redhat.com/v1/
    RHIT_BASE_TERMS_URL: https://terms.api.redhat.com/svcrest/terms/
    RHIT_BASE_TNC_URL: https://www.redhat.com/wapps/tnc
    QUAY_REGISTRY_ORG_NAME: openshift-release-dev
    REPLICAS: 4
    RHM_SKU_LIST_FILE: /configs/subscription-skus/rhm-skus-enhanced.yaml
    ENABLE_SENTRY: 'true'
    ENABLE_TERMS_ENFORCEMENT: 'true'
    RHIT_TIMEOUT: 30s
    MANDRILL_TIMEOUT: 60s
    GODEBUG: http2server=0
    PPROF_SERVER_BINDADDRESS: ''
    ULOG_V: info
  targets:
  - namespace:
      $ref: /services/ocm/namespaces/uhc-integration.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    promotion:
      publish:
      - ocm-ams-deployed-int
    parameters:
      GATE_NAME: ocm-ams-int-main
      USE_CANDLEPIN_BASIC_AUTH: 'true'
      CLUSTER_REG_RATE_LIMIT: 30000
      ORG_CLUSTER_REG_RATE_LIMIT: 30000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: sentry.autom8.in
      SENTRY_PROJECT: '9'
      GLOG_V: 5
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
      MOA_SKU: SER0579
      METRICS_BASE_URL: uhc-acct-mngr-metrics.uhc-integration.svc.cluster.local
      ENABLE_ORG_SERVICE_ACCT_EMAIL_VALIDATION: 'true'
      PPROF_SERVER_BINDADDRESS: 'localhost:8085'
  - namespace:
      $ref: /services/ocm/namespaces/uhc-stage.yml
    ref: cad44f5cfe34f833c8a5c1c5284cd29400b55b14
    promotion:
      auto: true
      subscribe:
      - ocm-ams-deployed-int
      publish:
      - ocm-ams-deployed-stage
    parameters:
      GATE_NAME: ocm-ams-stage-main
      SEGMENT_EMAIL_NAME: 'true'
      REPLICAS: 6
      CPU_LIMIT: '2'
      MEMORY_LIMIT: 2.5Gi
      RBAC_BASE_URL: https://mtls.internal.console.redhat.com
      RBAC_PROXY: ''
      CLUSTER_REG_RATE_LIMIT: 500000
      ORG_CLUSTER_REG_RATE_LIMIT: 750000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: glitchtip.devshift.net
      SENTRY_PROJECT: '10'
      GLOG_V: 5
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_2
      MOA_SKU: SER0579
      UHC_DEBUG: 'true'
      UNLEASH_URL: https://ocm-stage.unleash.devshift.net/api
      QUAY_REGISTRY_TEAM_NAME: staginginstallers
      ENABLE_ORG_SERVICE_ACCT_EMAIL_VALIDATION: 'true'
      PPROF_SERVER_BINDADDRESS: 'localhost:8085'
  - namespace:
      $ref: /services/ocm/namespaces/uhc-stage-appsres04ue2.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    parameters:
      API_LIVENESS_PROBE_INITIAL_DELAY_SECONDS: 45
      API_LIVENESS_PROBE_PERIOD_SECONDS: 15
      API_READINESS_PROBE_INITIAL_DELAY_SECONDS: 45
      API_READINESS_PROBE_PERIOD_SECONDS: 15
      CPU_LIMIT: '2'
      MEMORY_LIMIT: 2Gi
      RBAC_BASE_URL: https://mtls.internal.console.redhat.com
      RBAC_PROXY: ''
      CLUSTER_REG_RATE_LIMIT: 500000
      ORG_CLUSTER_REG_RATE_LIMIT: 750000
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: glitchtip.devshift.net
      SENTRY_PROJECT: '10'
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
      MOA_SKU: SER0579
      UHC_DEBUG: 'true'
      UNLEASH_URL: https://ocm-stage.unleash.devshift.net/api
      QUAY_REGISTRY_TEAM_NAME: staginginstallers
      ENABLE_ORG_SERVICE_ACCT_EMAIL_VALIDATION: 'true'
  - namespace:
      $ref: /services/ocm/namespaces/uhc-stage-sso-test.yml
    ref: master
    upstream:
      instance:
        $ref: /dependencies/ci-int/ci-int.yml
      name: service-uhc-account-manager-gl-build-master
    parameters:
      JWKS_URL: ${SSO_BASE_URL}/protocol/openid-connect/certs
      RHIT_BASE_USER_URL: https://user.stage.api.redhat.com/v2/
      RHIT_BASE_SUBSCRIPTION_URL: https://subscription.stage.api.redhat.com/svcrest/subscription/v5/
      RHIT_BASE_REGNUM_URL: https://subscription.stage.api.redhat.com/svcrest/regnum/v5/
      RHIT_BASE_REGISTRY_URL: https://container-registry-authorizer.stage.api.redhat.com/v1/
      RHIT_BASE_EXPORT_COMPLIANCE_URL: https://export-compliance.stage.api.redhat.com/v1/
      CLUSTER_REG_RATE_LIMIT: 30000
      ORG_CLUSTER_REG_RATE_LIMIT: 50
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: glitchtip.devshift.net
      SENTRY_PROJECT: '10'
      GLOG_V: 5
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
      MOA_SKU: SER0579
      UHC_DEBUG: 'true'
      UNLEASH_URL: https://ocm-stage.unleash.devshift.net/api
      QUAY_REGISTRY_TEAM_NAME: staginginstallers
      ENABLE_ORG_SERVICE_ACCT_EMAIL_VALIDATION: 'true'
  - namespace:
      $ref: /services/ocm/namespaces/uhc-production.yml
    ref: cad44f5cfe34f833c8a5c1c5284cd29400b55b14
    promotion:
      publish:
      - ocm-ams-deployed-prod
    parameters:
      GATE_NAME: ocm-ams-prod-main
      SEGMENT_EMAIL_NAME: 'true'
      CPU_LIMIT: '2'
      MEMORY_LIMIT: 4Gi
      REPLICAS: 6
      RHIT_BASE_CANDLEPIN_URL: https://admin.rhsm.redhat.com/candlepin
      RBAC_BASE_URL: https://mtls.internal.console.redhat.com
      RBAC_PROXY: ''
      CLUSTER_REG_RATE_LIMIT: 250
      ORG_CLUSTER_REG_RATE_LIMIT: 50
      DB_MAX_OPEN_CONNS: 250
      SENTRY_URL: glitchtip.devshift.net
      SENTRY_PROJECT: '49'
      GLOG_V: 5
      ENABLE_CERTIFICATE_MOCK: 'false'
      UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_for_vault_secret_21
      UNLEASH_URL: https://ocm.unleash.devshift.net/api
      TELEMETER_DEBUG: 'true'
      QUAY_REGISTRY_TEAM_NAME: installers
      METRICS_BASE_URL: uhc-acct-mngr-metrics.uhc-production.svc.cluster.local
      DB_QUERY_READ_TIMEOUT_SERVER: '300000'
      DB_QUERY_WRITE_TIMEOUT_SERVER: '60000'
      AUTOMATIC_BAN: 'true'
      ENVOY_CPU_LIMIT: 750m

- name: uhc-account-manager-dashboards
  url: https://gitlab.cee.redhat.com/service/uhc-account-manager
  path: /dashboards
  provider: directory
  targets:
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-stage-int.yml
    ref: master
  - namespace:
      $ref: /services/observability/namespaces/app-sre-observability-production-int.yml
    ref: cad44f5cfe34f833c8a5c1c5284cd29400b55b14
