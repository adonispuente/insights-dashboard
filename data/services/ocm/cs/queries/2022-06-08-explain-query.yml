---
$schema: /app-interface/app-interface-sql-query-1.yml
name: 2022-06-08-explain-query
labels: {}
namespace:
  $ref: /services/ocm/namespaces/uhc-production.yml
identifier: clusters-service-production
output: stdout
query: |
  EXPLAIN ANALYZE SELECT clusters.id, clusters.name, clusters.display_name, clusters.managed, clusters.creation_timestamp, clusters.activity_timestamp, clusters.expiration_timestamp, clusters.cloud_provider_id, clusters.openshift_version, clusters.region, clusters.console_url, clusters.api_url, clusters.api_listening, clusters.master_nodes, clusters.infra_nodes, clusters.compute_nodes, clusters.autoscale_compute_min, clusters.autoscale_compute_max, clusters.compute_labels, clusters.availability_zones, clusters.master_machine_type_id, clusters.compute_machine_type_id, clusters.infra_machine_type_id, clusters.state, clusters.properties, clusters.flavour_id, clusters.state_description, clusters.dns_base_domain, clusters.aws_subnet_ids, clusters.aws_private_link, clusters.aws_sts_role_arn, clusters.aws_sts_external_id, clusters.aws_sts_support_role_arn, clusters.aws_sts_oidc_endpoint_url, clusters.aws_sts_operator_iam_roles, clusters.aws_sts_master_iam_role, clusters.aws_sts_worker_iam_role, clusters.aws_sts_auto_creation_mode, clusters.aws_tags, clusters.aws_kms_key_arn, clusters.external_id, clusters.network_type, clusters.network_machine_cidr, clusters.network_service_cidr, clusters.network_pod_cidr, clusters.network_host_prefix, clusters.http_proxy, clusters.https_proxy, clusters.no_proxy, clusters.additional_trust_bundle, clusters.subscription_id, clusters.multi_az, clusters.access_token, clusters.version_id, clusters.infra_id, clusters.storage_quota, clusters.load_balancer_quota, clusters.provision_shard_id, clusters.product_id, clusters.organization_id, clusters.dns_ready, clusters.oidc_ready, clusters.channel_group, clusters.ccs_enabled, clusters.ccs_disable_scp_checks, clusters.install_error_condition_type, clusters.install_error_condition_reason, clusters.node_drain_grace_period_minutes, clusters.fips, clusters.etcd_encryption, clusters.cd_namespace, clusters.cd_name, clusters.billing_model, clusters.gcp_vpc_name, clusters.gcp_control_plane_subnet_name, clusters.gcp_compute_subnet_name, clusters.gcp_key_name, clusters.gcp_key_ring, clusters.gcp_key_location, clusters.gcp_kms_key_service_account, clusters.gcp_project_id, clusters.disable_user_workload_monitoring, clusters.managed_service_enabled, clusters.security_group_filters, clusters.hypershift_enabled, coalesce(metrics.state, ''), coalesce(metrics.openshift_version, ''), coalesce(metrics.query_timestamp, timestamp '0001-01-01'), coalesce(metrics.upgrade_timestamp, timestamp '0001-01-01'), coalesce(metrics.version_update_available, 'f'), coalesce(metrics.upgrade_state, ''), coalesce(metrics.upgrade_version, ''), metrics.master_nodes, metrics.infra_nodes, metrics.compute_nodes, versions.available_upgrades, versions.raw_id, versions.end_of_life_timestamp, provision_shards.status, limited_support_reasons_count
       FROM clusters
       LEFT JOIN metrics ON metrics.external_id = clusters.external_id
       LEFT JOIN versions ON versions.id = clusters.version_id
       LEFT JOIN provision_shards ON provision_shards.id = clusters.provision_shard_id
       LEFT JOIN (select count(limited_support_reasons.id) as limited_support_reasons_count, cluster_id from limited_support_reasons group by cluster_id) as limited_support_reasons on clusters.id = limited_support_reasons.cluster_id
       WHERE ((clusters.external_id = '3d0773cc-6f3a-44b8-b124-9835f43b6b93' OR clusters.display_name = '3d0773cc-6f3a-44b8-b124-9835f43b6b93') AND (clusters.organization_id = ANY('{}') OR clusters.id = ANY('{1dr44hqkjq8oeu1koovu1bd5qisvpreh,1j5iuv92djcs58f72khr7dis8uuc1leu,1rrl0savi0o7kgsqe967g6bv8t349tup}')))
       ORDER BY clusters.display_name asc LIMIT 100;
