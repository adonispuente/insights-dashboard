---
$schema: /app-sre/saas-file-2.yml

labels:
  service: ocm

name: saas-job-queue-service
description: 'SaaS tracking file for OCM Job Queue Service'

app:
  $ref: /services/ocm/app.yml

pipelinesProvider:
  $ref: /services/ocm/pipelines/tekton.ocm-pipelines.appsrep05ue1.yaml

slack:
  workspace:
    $ref: /dependencies/slack/coreos.yml
  channel: service-development-b

managedResourceTypes:
  - Deployment
  - Service

imagePatterns:
  - quay.io/app-sre/job-queue-service

authentication:
  image:
    path: app-sre/quay/app-sre-pull
    field: all

resourceTemplates:
  - name: job-queue-service
    url: https://gitlab.cee.redhat.com/service/job-queue-service
    path: /templates/service-template.yml
    parameters:
      ENVIRONMENT: production
      IMAGE_REGISTRY: quay.io
      IMAGE_REPOSITORY: app-sre/job-queue-service
      JWKS_URL: https://api.openshift.com/.well-known/jwks.json
      REPLICAS: 1
      RATE_LIMIT: 1000
      # After openshift upgrade, we're seeing sporadic "http2: server: error reading preface"
      # errors in log, source IP is openshift router.
      GODEBUG: http2server=0
    targets:
      - namespace:
          $ref: /services/ocm/namespaces/uhc-production.yml
        ref: ee9f468df17e9aec3438c40287f19671783243ce
        parameters:
          GLOG_V: 1
          ENABLE_SENTRY: true
          SENTRY_URL: sentry.devshift.net
          SENTRY_PROJECT: 18
          UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
          WEBHOOK_ADDITIONAL_CA_FILE: "/config/service-ca/service-ca.crt"
          RATE_LIMIT: 1000
          REPLICAS: 3
      - namespace:
          $ref: /services/ocm/namespaces/uhc-stage.yml
        ref: master
        upstream:
          instance:
            $ref: /dependencies/ci-int/ci-int.yml
          name: service-job-queue-service-gl-build-master
        parameters:
          GLOG_V: 5
          ENABLE_SENTRY: true
          SENTRY_URL: sentry.stage.devshift.net
          SENTRY_PROJECT: 22
          UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
          WEBHOOK_ADDITIONAL_CA_FILE: "/config/service-ca/service-ca.crt"
          RATE_LIMIT: 1000
          REPLICAS: 3
      - namespace:
          $ref: /services/ocm/namespaces/uhc-stage-appsres04ue2.yml
        ref: master
        upstream:
          instance:
            $ref: /dependencies/ci-int/ci-int.yml
          name: service-job-queue-service-gl-build-master
        parameters:
          GLOG_V: 5
          ENABLE_SENTRY: true
          SENTRY_URL: sentry.stage.devshift.net
          SENTRY_PROJECT: 22
          UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
          WEBHOOK_ADDITIONAL_CA_FILE: "/config/service-ca/service-ca.crt"
          RATE_LIMIT: 1000
      - namespace:
          $ref: /services/ocm/namespaces/uhc-integration.yml
        ref: master
        upstream:
          instance:
            $ref: /dependencies/ci-int/ci-int.yml
          name: service-job-queue-service-gl-build-master
        parameters:
          GLOG_V: 5
          UPDATE_DEPLOYMENT_CONFIG_CHANGE: update_1
          WEBHOOK_ADDITIONAL_CA_FILE: "/config/service-ca/service-ca.crt"
