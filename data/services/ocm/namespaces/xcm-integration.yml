---
$schema: /openshift/namespace-1.yml

labels:
  enableDynatraceLogging: ""

name: xcm-integration
description: Namespace for the XCM core in Integration

cluster:
  $ref: /openshift/app-sre-stage-01/cluster.yml

app:
  $ref: /services/ocm/app.yml

environment:
  $ref: /products/osdv4/environments/integration-xcm-hivei01ue1.yml

networkPoliciesAllow:
  - $ref: /services/observability/namespaces/openshift-customer-monitoring.app-sre-stage-01.yml

managedRoles: true

managedResourceTypes:
  - ConfigMap
  - Secret
  - ServiceAccount

sharedResources:
  - $ref: /services/app-sre/shared-resources/quayio-pull-secret.yml
  - $ref: /services/ocm/shared-resources/ecr.yml
  - $ref: /services/ocm/shared-resources/service-accounts.yml
  - $ref: /services/ocm/shared-resources/common.yml
  - $ref: /services/ocm/shared-resources/qe.yml

openshiftResources:
  # Shared dependencies
  - provider: resource
    path: /services/ocm/integration/authentication.configmap.yaml
  # Shared dependencies

  # CS dependencies
  - provider: vault-secret
    path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/uhc-integration/rh-oidc-s3-secret
    version: 1
  - provider: vault-secret
    path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/uhc-integration/sts-credentials
    version: 1
  - provider: vault-secret
    path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/uhc-integration/route53-creds
    version: 1
  - provider: vault-secret
    path: app-sre/integrations-output/terraform-resources/app-sre-stage-01/uhc-integration/rh-osd-network-verifier-s3-secret
    version: 1
  - provider: resource
    path: /services/ocm/integration/region-constraints.configmap.yaml
  - provider: route
    path: /services/ocm/xcm-integration/clusters-service.route.yaml
  - provider: resource
    path: /services/ocm/xcm-integration/cluster-proxy-service.configmap.yaml
  - provider: resource
    path: /services/ocm/xcm-integration/clusters-service-envoy.configmap.yaml

  - provider: vault-secret
    path: app-interface/app-sre-stage/uhc-integration/clusters-service
    version: 9
    annotations:
      qontract.recycle: "true"
  - provider: resource-template
    type: extracurlyjinja2
    path: /services/ocm/integration/provision-shards.secret.yaml
    variables:
      # hive
      aws_base_domain: i1.devshift.org
      gcp_base_domain: i2.devshift.org
      shards:
        - id: e6bc4f5c-bb10-46e4-99d1-fc92b9f3df91
          status: active
          hive_cluster_name: hivei01ue1
          hive_cluster_api_url: https://api.hivei01ue1.f7i5.p1.openshiftapps.com:6443
          hive_cluster_api_url_slug: api-hivei01ue1-f7i5-p1-openshiftapps-com:6443
      # this is a workaround to use the vault function inside the for loop in the template
      current_hive_cluster:
        name: 'workaround'

      # hypershift
      hypershift_shards: []
      # this is a workaround to use the vault function inside the for loop in the template
      current_hypershift_cluster:
        name: 'hypershift_workaround'
  # CS dependencies

  # OSL dependencies
  - provider: vault-secret
    path: app-interface/app-sre-stage/uhc-integration/ocm-service-log
    version: 2
  - provider: route
    path: /services/ocm/xcm-integration/ocm-service-logs.route.yaml
  - provider: resource
    path: /services/ocm/xcm-integration/ocm-service-logs-envoy.configmap.yaml
  # OSL dependencies

openshiftServiceAccountTokens:
  # telemeter
  - name: telemeter-bearer
    namespace:
      $ref: /services/rhobs/telemeter/namespaces/telemeter-integration.yml
    serviceAccountName: uhc-prometheus-access
  # hivei01ue1
  - namespace:
      $ref: /services/hive/namespaces/hivei01ue1/hive-integration.yml
    serviceAccountName: hive-frontend
  - namespace:
      $ref: /services/osd-operators/namespaces/hivei01ue1/aws-account-operator.yml
    serviceAccountName: aws-account-operator-client

managedExternalResources: true

externalResources:
  - provider: aws
    provisioner:
      $ref: /aws/app-sre/account.yml
    resources:
      - provider: rds
        identifier: clusters-service-integration-v4-xcm-int
        defaults: /terraform/resources/app-sre/integration/rds-1.yml
        output_resource_name: clusters-service-rds
        overrides:
          apply_immediately: true
          engine_version: '15.3'
          performance_insights_enabled: true
      - provider: rds
        identifier: ocm-service-log-integration-v4-xcm-int
        defaults: /terraform/resources/app-sre/integration/rds-1.yml
        output_resource_name: ocm-service-log-rds
        overrides:
          apply_immediately: true
          engine_version: '15.3'
          performance_insights_enabled: true
