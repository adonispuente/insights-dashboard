---
$schema: /dependencies/jenkins-config-1.yml

labels:
  service: app-interface

name: ci-int-app-interface-jobs

description: ''

app:
  $ref: /services/app-interface/app.yml

instance:
  $ref: /dependencies/ci-int/ci-int.yml

type: jobs

config:
- project:
    name: app-interface
    label: app-interface
    node: app-interface
    gl_group: service
    gl_project: app-interface
    environment: production
    jobs:
    - 'gl-build-master-app-interface':
        display_name: build master - deploy to prod only
        build_deploy_script_path: ./hack/build_deploy.sh
        job_type: ''
        slack_channel_notification: sd-app-sre-reconcile
    - 'gl-build-master-app-interface':
        node: app-interface-long-running
        display_name: build master - deploy to stage only
        build_deploy_script_path: ./hack/build_deploy.sh
        environment: stage
        job_type: -deploy-stage-only
        slack_channel_notification: sd-app-sre-reconcile-stage
    - 'gl-pr-check-app-interface':
        display_name: schema validator pr-check
        concurrent_build: true
        # This is a temporary workaround to prevent changes to the hack directory from running MR checks
        pr_check_script_path: |
            if git diff --quiet --exit-code origin/master..HEAD -- ./hack/; then
                ./hack/pr_check.sh
            else
                echo "Found unauthorized hack/ folder change, MR will not run."
                exit 2
            fi
        job_type: ''
    - 'gl-periodic-job-app-interface':
        node: app-interface-long-running
        display_name: periodic e2e tests
        job_type: e2e-tests
        ci_cmd: ./hack/e2e_tests.sh
        cron_expression: 'H 10 * * *'
        timeout: 120

- project:
    name: app-interface-dwan-test
    label: app-interface
    node: app-interface
    gl_group: dwan
    gl_project: app-interface
    environment: stage
    jobs:
    # This job is for testing changes to gl-pr-check-app-interface
    - 'gl-pr-check-app-interface':
        display_name: schema validator pr-check manual testing
        concurrent_build: true
        # This is a temporary workaround to prevent changes to the hack directory from running MR checks
        pr_check_script_path: |
            #!/bin/bash
            set -evo pipefail
            if ! git diff --quiet origin/master HEAD -- ./hack/; then
              echo "Checking permission for user: ${{gitlabMergedByUser}} ..."
              GITLAB_API_URL=https://gitlab.cee.redhat.com/api/v4
              USER_ID=$(curl -s --header "PRIVATE-TOKEN: ${{GITLAB_API_TOKEN}}" ${{GITLAB_API_URL}}/users?username="${{gitlabMergedByUser}}" | jq '.[0].id')
              if [ "$USER_ID" == "null" ]; then
                echo "User ${{gitlabMergedByUser}} not found!"
                exit 2
              fi

              echo "Checking if user ${{gitlabMergedByUser}} (${{USER_ID}}) is a member of app-sre ..."
              STATUS_CODE=$(curl -s -o /dev/null -w "%{{http_code}}" --header "PRIVATE-TOKEN: ${{GITLAB_API_TOKEN}}" ${{GITLAB_API_URL}}/groups/app-sre/members/"${{USER_ID}}")
              if [ "$STATUS_CODE" == "200" ]; then
                echo "Found authorized hack/ folder change, MR will run."
              else
                echo "Found unauthorized hack/ folder change, MR will not run."
                exit 2
              fi
            fi
            ./hack/pr_check.sh
        job_type: '-manual-testing'

- project:
    name: qontract-api
    label: app-interface
    node: app-interface
    gl_group: service
    gl_project: qontract-api
    quay_org: app-sre
    jobs:
    - 'gl-build-master':
        display_name: qontract-api build master
    - 'gl-pr-check':
        display_name: qontract-api pr-check

- project:
    name: app-interface-output
    label: app-interface
    node: app-interface
    gl_group: service
    gl_project: app-interface-output
    jobs:
    - 'app-interface-output-run':
        display_name: app-interface-output run
        commands: 'clusters-network quay-mirrors ocm-aws-infrastructure-access-switch-role-links terraform-users-credentials clusters namespaces clusters-egress-ips version-history cluster-upgrade-policies clusters-aws-account-ids cluster-openshift-resources aws-terraform-resources app-interface-review-queue app-interface-merge-queue app-interface-merge-history app-interface-open-selfserviceable-mr-queue ocm-fleet-upgrade-policies ocm-addon-upgrade-policies change-types'

- project:
    name: container-images-internal
    label: app-interface
    node: app-interface
    gl_group: app-sre
    gl_project: container-images
    quay_org: app-sre
    jobs:
    - 'gl-build-master':
        display_name: container-images build master
    - 'gl-pr-check':
        display_name: container-images pr-check
