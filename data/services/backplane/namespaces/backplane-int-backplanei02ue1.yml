---
$schema: /openshift/namespace-1.yml

labels: {}

name: backplane
description: integration namespace for backplane-api

cluster:
  $ref: /openshift/backplanei02ue1/cluster.yml

app:
  $ref: /services/backplane/app.yaml

environment:
  $ref:  /products/osdv4/environments/integration-backplane.yml

managedRoles: true

managedResourceTypes:
- Route
- Certificate.cert-manager.io
- Service
- NetworkPolicy

sharedResources:
- $ref: /services/backplane/shared-resources/int.yml
- $ref: /services/backplane/shared-resources/networkpolicy.yml
- $ref: /services/app-sre/shared-resources/quayio-pull-secret.yml

openshiftResources:
# This resource should move to a shared-resource once the POC is completed (OSD-16620)
- provider: resource
  path: /services/backplane/api-int-public-certs.yaml
- provider: resource
  path: /services/backplane/backplane-api-int-public.service.yaml

managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/sd-infra-stage-01/account.yml
  resources:
  - provider: aws-iam-role
    identifier: backplane-backplanei02ue1
    assume_role:
      Federated: arn:aws:iam::611491592236:oidc-provider/rh-oidc.s3.us-east-1.amazonaws.com/247jc96vf02mfg61aot9nveceifbokvi
    assume_action: "AssumeRoleWithWebIdentity"
    assume_condition:
      StringEquals:
        "rh-oidc.s3.us-east-1.amazonaws.com/247jc96vf02mfg61aot9nveceifbokvi:sub": "system:serviceaccount:backplane:backplane"
    inline_policy:
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::277304166082:role/backplanei02ue1"
          }
        ]
      }
    output_resource_name: backplane-aws-access
    output_format:
      provider: generic-secret
      data:
        credentials: >-
          [default]
          role_arn = {{ role_arn }}
          web_identity_token_file = /var/run/secrets/openshift/serviceaccount/token
