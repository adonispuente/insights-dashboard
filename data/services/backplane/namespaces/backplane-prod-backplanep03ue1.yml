---
$schema: /openshift/namespace-1.yml

labels: {}

name: backplane
description: production namespace for backplane-api

cluster:
  $ref: /openshift/backplanep03ue1/cluster.yml

app:
  $ref: /services/backplane/app.yaml

environment:
  $ref:  /products/osdv4/environments/prod-backplane.yml

managedRoles: true

managedResourceTypes:
- Route
- Certificate.cert-manager.io
- Service
- Issuer
- NetworkPolicy

sharedResources:
- $ref: /services/backplane/shared-resources/prod.yml
- $ref: /services/app-sre/shared-resources/quayio-pull-secret.yml
- $ref: /services/backplane/shared-resources/networkpolicy.yml

openshiftResources:
# This resource should move to a shared-resource once the POC is completed (OSD-16620)
- provider: resource
  path: /services/backplane/api-prod-public-certs.yaml
- provider: resource
  path: /services/backplane/backplane-api-prod-public.service.yaml

managedExternalResources: true

externalResources:
- provider: aws
  provisioner:
    $ref: /aws/sd-infra-prod-01/account.yml
  resources:
  - provider: aws-iam-role
    identifier: backplane-backplanep03ue1
    assume_role:
      Federated: arn:aws:iam::049267941105:oidc-provider/rh-oidc.s3.us-east-1.amazonaws.com/24k36ugrll3c9jmdem8rhkuq5a5cd0ut
    assume_action: "AssumeRoleWithWebIdentity"
    assume_condition:
      StringEquals:
        "rh-oidc.s3.us-east-1.amazonaws.com/24k36ugrll3c9jmdem8rhkuq5a5cd0ut:sub": "system:serviceaccount:backplane:backplane"
    inline_policy:
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::922711891673:role/backplanep03ue1"
          }
        ]
      }
    output_resource_name: backplane-aws-access
    output_format:
      provider: generic-secret
      data:
        credentials: >-
          [default]
          role_arn = {{ role_arn }}
          web_identity_token_file = /var/run/secrets/openshift/serviceaccount/token
