---
$schema: /openshift/namespace-1.yml

labels:
  service: stonesoup

name: stonesoup-infra-production

description: Production namespace for StoneSoup infra (RDS databases)

cluster:
  $ref: /openshift/app-sre-prod-01/cluster.yml

app:
  $ref: /services/stonesoup/app.yml

environment:
  $ref: /products/stonesoup/environments/stage.yml

managedExternalResources: true

externalResources:

- provider: aws
  provisioner:
    $ref: /aws/stonesoup-prod/account.yml

  resources:

  # Pipeline Service Resources
  - provider: rds
    identifier: redhat-prod-plnsvc
    defaults: /terraform/resources/stonesoup/prod/redhat/plnsvc-rds.yml
    overrides:
      apply_immediately: true
  - provider: rds
    identifier: multi-tenant-prod-plnsvc
    defaults: /terraform/resources/stonesoup/prod/multi-tenant/plnsvc-rds.yml
    overrides:
      apply_immediately: true
  - provider: kms
    identifier: redhat-prod-plnsvc
    region: us-east-1
    defaults: /terraform/resources/stonesoup/prod/redhat/plnsvc-kms.yml
  - provider: kms
    identifier: multi-tenant-prod-plnsvc
    region: us-east-1
    defaults: /terraform/resources/stonesoup/prod/multi-tenant/plnsvc-kms.yml
  - provider: s3
    identifier: redhat-prod-plnsvc
    defaults: /terraform/resources/s3-all-expires-90-days.yml
    bucket_policy:
      {
        "Version": "2012-10-17",
        "Statement":
          [
            {
              "Sid": "allow-stonesoup-rh-prod-only",
              "Effect": "Deny",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": ["arn:aws:s3:::redhat-prod-plnsvc", "arn:aws:s3:::redhat-prod-plnsvc/*"],
              "Condition": {
                "StringNotEquals": {"aws:sourceVpc": "vpc-0a739553ebdc041bc"},
                "StringNotEquals": {"aws:username": "arn:aws:iam::520050076864:user/terraform"}
              },
            },
          ],
      }
  - provider: s3
    identifier: multi-tenant-prod-plnsvc
    defaults: /terraform/resources/s3-all-expires-90-days.yml
    bucket_policy:
      {
        "Version": "2012-10-17",
        "Statement":
          [
            {
              "Sid": "allow-stonesoup-mt-prod-only",
              "Effect": "Deny",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": ["arn:aws:s3:::multi-tenant-prod-plnsvc", "arn:aws:s3:::multi-tenant-prod-plnsvc/*"],
              "Condition": {
                "StringNotEquals": {"aws:sourceVpc": "vpc-09e085263d4357c3e"},
                "StringNotEquals": {"aws:username": "arn:aws:iam::520050076864:user/terraform"}
              },
            },
          ],
      }

  # GitOps Service Resources
  - provider: rds
    identifier: redhat-prod-gitopsvc
    defaults: /terraform/resources/stonesoup/prod/redhat/gitopsvc-rds.yml
  - provider: rds
    identifier: multi-tenant-prod-gitopsvc
    defaults: /terraform/resources/stonesoup/prod/multi-tenant/gitopsvc-rds.yml
  - provider: kms
    identifier: redhat-prod-gitopsvc
    region: us-east-1
    defaults: /terraform/resources/stonesoup/prod/redhat/gitopsvc-kms.yml
  - provider: kms
    identifier: multi-tenant-prod-gitopsvc
    region: us-east-1
    defaults: /terraform/resources/stonesoup/prod/multi-tenant/gitopsvc-kms.yml
