---
$schema: /app-interface/app-interface-sql-query-1.yml
name: 2022-03-25-get-duplicate-principal-records-for-removal
labels: {}
namespace:
  $ref: /services/insights/rbac/namespaces/rbac-prod.yml
identifier: rbac-prod
output: stdout
queries:
  - |
    SELECT id,
           uuid,
           username,
           cross_account,
           tenant_id
    FROM management_principal
    WHERE LOWER(username) IN
        (SELECT LOWER(username)
         FROM management_principal
         GROUP BY LOWER(username) HAVING COUNT(id) > 1)
      AND id NOT IN
        (SELECT principal_id
         FROM management_group_principals);
