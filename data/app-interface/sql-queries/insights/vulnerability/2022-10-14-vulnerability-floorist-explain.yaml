---
$schema: /app-interface/app-interface-sql-query-1.yml
labels: {}
name: 2022-10-14-vulnerability-floorist-explain 
namespace:
  $ref: /services/insights/vulnerability/namespaces/vulnerability-engine-prod.yml
identifier: vulnerability-engine
output: stdout
queries:
  - EXPLAIN ANALYZE SELECT rha.account_number AS rh_account_id, cm.cve AS cve, sp.inventory_id AS inventory_id, br.name AS business_risk, DATE(sv.first_reported) AS first_reported, DATE(sv.when_mitigated) AS when_mitigated FROM system_vulnerabilities_active AS sv JOIN rh_account AS rha ON sv.rh_account_id = rha.id JOIN cve_metadata AS cm ON sv.cve_id = cm.id JOIN cve_account_data AS cad ON sv.cve_id = cad.cve_id AND sv.rh_account_id = cad.rh_account_id JOIN business_risk AS br ON cad.business_risk_id = br.id JOIN system_platform as sp ON sv.system_id = sp.id AND sv.rh_account_id = sp.rh_account_id AND sp.opt_out = false AND sp.stale = false AND sp.when_deleted IS NULL JOIN inventory.hosts as ih ON sp.inventory_id = ih.id WHERE (sv.mitigation_reason IS NULL OR sv.rule_id IN ( SELECT ir.id FROM insights_rule AS ir WHERE ir.active = false AND NOT ir.rule_only )) AND (sv.when_mitigated IS NULL OR sv.rule_id IN ( SELECT ir.id FROM insights_rule AS ir WHERE ir.active = true AND NOT ir.rule_only)) AND br.name != 'Not Defined';
