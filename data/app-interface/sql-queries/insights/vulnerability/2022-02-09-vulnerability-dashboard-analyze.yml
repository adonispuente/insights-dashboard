---
$schema: /app-interface/app-interface-sql-query-1.yml
labels: {}
name: 2022-02-09-vulnerability-dashboard-analyze
namespace:
  $ref: /services/insights/vulnerability/namespaces/vulnerability-engine-prod.yml
identifier: vulnerability-engine
output: stdout
queries:
  - EXPLAIN ANALYZE SELECT "t1"."cve", COALESCE("t1"."cvss3_score", "t1"."cvss2_score") AS "cvss_score", "t1"."public_date", "t1"."id", "t1"."exploits" FROM "cve_metadata" AS "t1" INNER JOIN (SELECT Distinct("t2"."cve_id") AS "cve_id_" FROM "system_vulnerabilities_active" AS "t2" INNER JOIN "system_platform" AS "t3" ON ((((("t2"."system_id" = "t3"."id") AND ("t3"."rh_account_id" = 3552)) AND ("t3"."opt_out" = FALSE)) AND ("t3"."stale" = FALSE)) AND ("t3"."when_deleted" IS NULL)) WHERE ((("t2"."rh_account_id" = 3552) AND (("t2"."mitigation_reason" IS NULL) OR ("t2"."rule_id" IN (SELECT "t4"."id" FROM "insights_rule" AS "t4" WHERE (("t4"."active" = FALSE) AND NOT "t4"."rule_only"))))) AND (("t2"."when_mitigated" IS NULL) OR ("t2"."rule_id" IN (SELECT "t4"."id" FROM "insights_rule" AS "t4" WHERE (("t4"."active" = TRUE) AND NOT "t4"."rule_only")))))) AS "t5" ON ("t1"."id" = "t5"."cve_id_");
  - EXPLAIN ANALYZE SELECT COUNT(Distinct("t1"."cve_id")) AS "rules_cves_count" FROM "system_vulnerabilities_active" AS "t1" INNER JOIN "cve_rule_mapping" AS "t2" ON ("t1"."cve_id" = "t2"."cve_id") INNER JOIN "insights_rule" AS "t3" ON ((("t2"."rule_id" = "t3"."id") AND ("t3"."active" = TRUE)) AND NOT "t3"."rule_only") INNER JOIN "system_platform" AS "t4" ON (((((("t1"."system_id" = "t4"."id") AND ("t4"."rh_account_id" = 3552)) AND ("t4"."when_deleted" IS NULL)) AND ("t4"."stale" = FALSE)) AND ("t4"."opt_out" = FALSE)) AND (("t4"."last_evaluation" IS NOT NULL) OR ("t4"."advisor_evaluated" IS NOT NULL))) WHERE (("t1"."rh_account_id" = 3552) AND ("t1"."mitigation_reason" IS NULL));
  - EXPLAIN ANALYZE SELECT "t1"."description_text" AS "name", "t1"."summary_text" AS "description", "t2"."systems_affected_" AS "systems_affected", "t1"."rule_impact" AS "severity", "t1"."kbase_node_id" AS "node_id", ARRAY_AGG(Distinct("t3"."cve")) AS "associated_cves", "t1"."name" AS "id", "t1"."publish_date" AS "public_date" FROM "insights_rule" AS "t1" INNER JOIN "cve_rule_mapping" AS "t4" ON ("t1"."id" = "t4"."rule_id") INNER JOIN (SELECT "t5"."rule_id" AS "rule_id_", Count(Distinct("t5"."system_id")) AS "systems_affected_" FROM "system_vulnerabilities_active" AS "t5" INNER JOIN "system_platform" AS "t6" ON ((((("t5"."system_id" = "t6"."id") AND ("t6"."rh_account_id" = 3552)) AND ("t6"."opt_out" = FALSE)) AND ("t6"."stale" = FALSE)) AND ("t6"."when_deleted" IS NULL)) WHERE (("t5"."rh_account_id" = 3552) AND (("t5"."rule_id" IN (SELECT "t1"."id" FROM "insights_rule" AS "t1" WHERE (("t1"."active" = TRUE) AND NOT "t1"."rule_only"))) AND ("t5"."mitigation_reason" IS NULL))) GROUP BY "t5"."rule_id") AS "t2" ON ("t1"."id" = "t2"."rule_id_") INNER JOIN "cve_metadata" AS "t3" ON ("t4"."cve_id" = "t3"."id") WHERE ((("t1"."publish_date" >= '2022-01-09 00:00:00+00:00') AND ("t1"."active" = TRUE)) AND NOT "t1"."rule_only") GROUP BY "t1"."description_text", "t1"."publish_date", "t1"."rule_impact", "t1"."kbase_node_id", systems_affected, "t1"."name", "t1"."publish_date", "t1"."summary_text" ORDER BY "t1"."publish_date" DESC, "t1"."rule_impact", "t1"."description_text";
