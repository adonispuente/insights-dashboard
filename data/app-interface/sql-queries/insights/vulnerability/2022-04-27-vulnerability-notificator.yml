---
$schema: /app-interface/app-interface-sql-query-1.yml
labels: {}
name: 2022-04-27-vulnerability-notificator 
namespace:
  $ref: /services/insights/vulnerability/namespaces/vulnerability-engine-prod.yml
identifier: vulnerability-engine
output: stdout
queries:
  - EXPLAIN ANALYZE SELECT "t1"."name" AS "account_id", "t2"."rh_account_id", "t3"."cve", "t3"."id" AS "cve_id" FROM "system_vulnerabilities_active" AS "t2" INNER JOIN "rh_account" AS "t1" ON ("t2"."rh_account_id" = "t1"."id") INNER JOIN "system_platform" AS "t4" ON (((((("t2"."system_id" = "t4"."id") AND ("t2"."rh_account_id" = "t4"."rh_account_id")) AND ("t4"."opt_out" = FALSE)) AND ("t4"."stale" = FALSE)) AND ("t4"."when_deleted" IS NULL)) AND (("t4"."last_evaluation" IS NOT NULL) AND ("t4"."last_evaluation" < '2022-04-27 11:00:22.281634+00:00'))) INNER JOIN "cve_metadata" AS "t3" ON ("t2"."cve_id" = "t3"."id") INNER JOIN "inventory"."hosts" AS "t5" ON ("t4"."inventory_id" = "t5"."id") WHERE ((((((("t2"."mitigation_reason" IS NULL) OR ("t2"."rule_id" IN (SELECT "t7"."id" FROM "insights_rule" AS "t7" WHERE (("t7"."active" = FALSE) AND NOT "t7"."rule_only")))) AND (("t2"."when_mitigated" IS NULL) OR ("t2"."rule_id" IN (SELECT "t7"."id" FROM "insights_rule" AS "t7" WHERE (("t7"."active" = TRUE) AND NOT "t7"."rule_only"))))) AND ("t2"."first_reported" < (CURRENT_TIMESTAMP - INTERVAL '30 MINUTES'))) AND (COALESCE("t3"."cvss2_score", "t3"."cvss3_score", 0.0) >= 7.0)) AND "t2"."cve_id" IN (SELECT DISTINCT("t1"."id") AS "cve_id" FROM "cve_metadata" AS "t1" LEFT OUTER JOIN "cve_rule_mapping" AS "t2" ON ("t1"."id" = "t2"."cve_id") LEFT OUTER JOIN "insights_rule" AS "t3" ON ("t2"."rule_id" = "t3"."id") WHERE ((("t1"."modified_date" BETWEEN '2022-04-24' AND '2022-04-28') AND (((COALESCE("t1"."cvss3_score", "t1"."cvss2_score", 0.0) >= 7.0) OR ("t1"."impact_id" = 7)) OR (COALESCE("t3"."active", FALSE) = TRUE))) OR ("t1"."exploits" = TRUE))))) GROUP BY "t1"."name", "t2"."rh_account_id", "t3"."cve", "t3"."id";
  - EXPLAIN ANALYZE SELECT "t1"."name" AS "account_id", "t2"."rh_account_id", "t3"."cve", "t3"."id" AS "cve_id" FROM "system_vulnerabilities_active" AS "t2" INNER JOIN "rh_account" AS "t1" ON ("t2"."rh_account_id" = "t1"."id") INNER JOIN "system_platform" AS "t4" ON (((((("t2"."system_id" = "t4"."id") AND ("t2"."rh_account_id" = "t4"."rh_account_id")) AND ("t4"."opt_out" = FALSE)) AND ("t4"."stale" = FALSE)) AND ("t4"."when_deleted" IS NULL)) AND (("t4"."last_evaluation" IS NOT NULL) AND ("t4"."last_evaluation" < '2022-04-27 11:00:22.285035+00:00'))) INNER JOIN "cve_metadata" AS "t3" ON ("t2"."cve_id" = "t3"."id") INNER JOIN "inventory"."hosts" AS "t5" ON ("t4"."inventory_id" = "t5"."id") WHERE ((((((("t2"."mitigation_reason" IS NULL) OR ("t2"."rule_id" IN (SELECT "t7"."id" FROM "insights_rule" AS "t7" WHERE (("t7"."active" = FALSE) AND NOT "t7"."rule_only")))) AND (("t2"."when_mitigated" IS NULL) OR ("t2"."rule_id" IN (SELECT "t7"."id" FROM "insights_rule" AS "t7" WHERE (("t7"."active" = TRUE) AND NOT "t7"."rule_only"))))) AND ("t2"."first_reported" < (CURRENT_TIMESTAMP - INTERVAL '30 MINUTES'))) AND ("t3"."exploits" = TRUE)) AND "t2"."cve_id" IN (SELECT DISTINCT("t1"."id") AS "cve_id" FROM "cve_metadata" AS "t1" LEFT OUTER JOIN "cve_rule_mapping" AS "t2" ON ("t1"."id" = "t2"."cve_id") LEFT OUTER JOIN "insights_rule" AS "t3" ON ("t2"."rule_id" = "t3"."id") WHERE ((("t1"."modified_date" BETWEEN '2022-04-24' AND '2022-04-28') AND (((COALESCE("t1"."cvss3_score", "t1"."cvss2_score", 0.0) >= 7.0) OR ("t1"."impact_id" = 7)) OR (COALESCE("t3"."active", FALSE) = TRUE))) OR ("t1"."exploits" = TRUE))))) GROUP BY "t1"."name", "t2"."rh_account_id", "t3"."cve", "t3"."id";
  - EXPLAIN ANALYZE SELECT "t1"."name" AS "account_id", "t2"."rh_account_id", "t3"."cve", "t3"."id" AS "cve_id" FROM "system_vulnerabilities_active" AS "t2" INNER JOIN "rh_account" AS "t1" ON ("t2"."rh_account_id" = "t1"."id") INNER JOIN "system_platform" AS "t4" ON (((((("t2"."system_id" = "t4"."id") AND ("t2"."rh_account_id" = "t4"."rh_account_id")) AND ("t4"."opt_out" = FALSE)) AND ("t4"."stale" = FALSE)) AND ("t4"."when_deleted" IS NULL)) AND (("t4"."last_evaluation" IS NOT NULL) AND ("t4"."last_evaluation" < '2022-04-27 11:00:22.286874+00:00'))) INNER JOIN "cve_metadata" AS "t3" ON ("t2"."cve_id" = "t3"."id") INNER JOIN "inventory"."hosts" AS "t5" ON ("t4"."inventory_id" = "t5"."id") INNER JOIN "cve_rule_mapping" AS "t7" ON ("t2"."cve_id" = "t7"."cve_id") INNER JOIN "insights_rule" AS "t8" ON ("t7"."rule_id" = "t8"."id") WHERE ((((((("t2"."mitigation_reason" IS NULL) OR ("t2"."rule_id" IN (SELECT "t8"."id" FROM "insights_rule" AS "t8" WHERE (("t8"."active" = FALSE) AND NOT "t8"."rule_only")))) AND (("t2"."when_mitigated" IS NULL) OR ("t2"."rule_id" IN (SELECT "t8"."id" FROM "insights_rule" AS "t8" WHERE (("t8"."active" = TRUE) AND NOT "t8"."rule_only"))))) AND ("t2"."first_reported" < (CURRENT_TIMESTAMP - INTERVAL '30 MINUTES'))) AND ("t8"."active" = TRUE)) AND "t2"."cve_id" IN (SELECT DISTINCT("t1"."id") AS "cve_id" FROM "cve_metadata" AS "t1" LEFT OUTER JOIN "cve_rule_mapping" AS "t2" ON ("t1"."id" = "t2"."cve_id") LEFT OUTER JOIN "insights_rule" AS "t3" ON ("t2"."rule_id" = "t3"."id") WHERE ((("t1"."modified_date" BETWEEN '2022-04-24' AND '2022-04-28') AND (((COALESCE("t1"."cvss3_score", "t1"."cvss2_score", 0.0) >= 7.0) OR ("t1"."impact_id" = 7)) OR (COALESCE("t3"."active", FALSE) = TRUE))) OR ("t1"."exploits" = TRUE))))) GROUP BY "t1"."name", "t2"."rh_account_id", "t3"."cve", "t3"."id";
  - EXPLAIN ANALYZE SELECT "t1"."name" AS "account_id", "t2"."rh_account_id", "t3"."cve", "t3"."id" AS "cve_id" FROM "system_vulnerabilities_active" AS "t2" INNER JOIN "rh_account" AS "t1" ON ("t2"."rh_account_id" = "t1"."id") INNER JOIN "system_platform" AS "t4" ON (((((("t2"."system_id" = "t4"."id") AND ("t2"."rh_account_id" = "t4"."rh_account_id")) AND ("t4"."opt_out" = FALSE)) AND ("t4"."stale" = FALSE)) AND ("t4"."when_deleted" IS NULL)) AND (("t4"."last_evaluation" IS NOT NULL) AND ("t4"."last_evaluation" < '2022-04-27 11:00:22.288701+00:00'))) INNER JOIN "cve_metadata" AS "t3" ON ("t2"."cve_id" = "t3"."id") INNER JOIN "inventory"."hosts" AS "t5" ON ("t4"."inventory_id" = "t5"."id") WHERE ((((((("t2"."mitigation_reason" IS NULL) OR ("t2"."rule_id" IN (SELECT "t7"."id" FROM "insights_rule" AS "t7" WHERE (("t7"."active" = FALSE) AND NOT "t7"."rule_only")))) AND (("t2"."when_mitigated" IS NULL) OR ("t2"."rule_id" IN (SELECT "t7"."id" FROM "insights_rule" AS "t7" WHERE (("t7"."active" = TRUE) AND NOT "t7"."rule_only"))))) AND ("t2"."first_reported" < (CURRENT_TIMESTAMP - INTERVAL '30 MINUTES'))) AND ("t3"."impact_id" = 7)) AND "t2"."cve_id" IN (SELECT DISTINCT("t1"."id") AS "cve_id" FROM "cve_metadata" AS "t1" LEFT OUTER JOIN "cve_rule_mapping" AS "t2" ON ("t1"."id" = "t2"."cve_id") LEFT OUTER JOIN "insights_rule" AS "t3" ON ("t2"."rule_id" = "t3"."id") WHERE ((("t1"."modified_date" BETWEEN '2022-04-24' AND '2022-04-28') AND (((COALESCE("t1"."cvss3_score", "t1"."cvss2_score", 0.0) >= 7.0) OR ("t1"."impact_id" = 7)) OR (COALESCE("t3"."active", FALSE) = TRUE))) OR ("t1"."exploits" = TRUE))))) GROUP BY "t1"."name", "t2"."rh_account_id", "t3"."cve", "t3"."id";
