---
$schema: /app-interface/app-interface-sql-query-1.yml
labels: {}
name: prod-monthly-report
namespace:
  $ref: /services/insights/sources/namespaces/sources-prod.yml
identifier: sources-prod
output: stdout
delete: true
# Run on the 1st of every month
schedule: "0 0 1 * *"
queries:
###                                                               ###
## Unfiltered queries including unavailable sources/applications   ##
##                                                                 ##
## The queries are:                                                ##
##                                                                 ##
## 1. Count all the sources from the database.                     ##
## 2. Group sources per source type, and count them.               ##
## 3. Group the sources per application type, and count them.      ##
## 4. Group the applications per application type, and count them. ##
###                                                               ###
  - |
    SELECT
      count("s".*) AS "number_sources_all"
    FROM
      "sources" AS "s";
  - |
    SELECT
      "st"."product_name" AS "source_type", count("s".*) AS "number_sources_all"
    FROM
      "sources" AS "s"
    INNER JOIN
     "source_types" AS "st" ON "st"."id" = "s"."source_type_id"
    GROUP BY
      "st"."product_name"
    ORDER BY
      "st"."product_name" ASC;
  - |
    SELECT
      "at"."display_name" AS "application_type", count(distinct "a"."source_id") AS "number_sources_all"
    FROM
      "applications" AS "a"
    INNER JOIN
      "application_types" AS "at" ON "at"."id" = "a"."application_type_id"
    GROUP BY
      "at"."display_name"
    ORDER BY
      "at"."display_name" ASC;
  - |
    SELECT
      "at"."display_name" AS "application_type", count("a".*) AS "number_applications_all"
    FROM
      "applications" AS "a"
    INNER JOIN
      "application_types" AS "at" ON "at"."id" = "a"."application_type_id"
    GROUP BY
      "at"."display_name"
    ORDER BY
      "at"."display_name" ASC;
###                                                               ###
## Queries including only available sources/applications           ##
##                                                                 ##
## The queries are:                                                ##
##                                                                 ##
## 1. Count all the sources from the database.                     ##
## 2. Group sources per source type, and count them.               ##
## 3. Group the sources per application type, and count them.      ##
## 4. Group the applications per application type, and count them. ##
###                                                               ###
  - |
    SELECT
      count("s".*) AS "number_sources_available"
    FROM
      "sources" AS "s"
    WHERE
      "s"."availability_status" = 'available';
  - |
    SELECT
      "st"."product_name" AS "source_type", count("s".*) AS "number_sources_available"
    FROM
      "sources" AS "s"
    INNER JOIN
      "source_types" AS "st" ON "st"."id" = "s"."source_type_id"
    WHERE
      "s"."availability_status" = 'available'
    GROUP BY
      "st"."product_name"
    ORDER BY
      "st"."product_name" ASC;
  - |
    SELECT
      "at"."display_name" AS "application_type", count(distinct "a"."source_id") AS "number_sources_available"
    FROM
      "applications" AS "a"
    INNER JOIN
      "application_types" AS "at" ON "at"."id" = "a"."application_type_id"
    INNER JOIN
      "sources" AS "s" ON "s"."id" = "a"."source_id"
    WHERE
      "s"."availability_status" = 'available'
    GROUP BY
      "at"."display_name"
    ORDER BY
      "at"."display_name" ASC;
  - |
    SELECT
      "at"."display_name" AS "application_type", count("a".*) AS "number_applications_available"
    FROM
      "applications" AS "a"
    INNER JOIN
      "application_types" AS "at" ON "at"."id" = "a"."application_type_id"
    WHERE
      "a"."availability_status" = 'available'
    GROUP BY
      "at"."display_name"
    ORDER BY
      "at"."display_name" ASC;
