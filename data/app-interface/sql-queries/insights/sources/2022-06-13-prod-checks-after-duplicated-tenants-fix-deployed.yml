---
$schema: /app-interface/app-interface-sql-query-1.yml
labels: {}
name: 2022-06-13-prod-checks-after-duplicated-tenants-fix-deployed
namespace:
  $ref: /services/insights/sources/namespaces/sources-prod.yml
identifier: sources-prod
output: stdout
queries:
# These queries attempt to double check that the duplicated tenants got
# effectively taken care of. The last of the queries grabs all the duplicated
# tenants that were processed by the fix.
#
# Get all the application authentications from any duplicated tenants from the
# database.
  - |
    SELECT
      "t"."id" AS "t_id",
      "t"."external_tenant" AS "t_external_tenant",
      "t"."org_id" AS "t_org_id",
      "t"."created_at" AS "t_created_at",
      "t"."updated_at" AS "t_updated_at",
      "aa"."id" AS "aa_id",
      "aa"."tenant_id" AS "aa_tenant_id",
      "aa"."application_id" AS "aa_application_id",
      "aa"."authentication_id" AS "aa_authentication_id",
      "aa"."created_at" AS "aa_created_at",
      "aa"."updated_at" AS "aa_updated_at"
    FROM
      "tenants" AS "t"
    LEFT JOIN
      "application_authentications" "aa" ON "t"."id" = "aa"."tenant_id"
    WHERE
      "t"."external_tenant" IN (
        SELECT
          "texten"."external_tenant"
        FROM
          "tenants" AS "texten"
        GROUP BY
          "texten"."external_tenant"
        HAVING
          count("texten"."external_tenant") > 1
      )
    OR
      "t"."org_id" IN (
        SELECT
          "torgid"."org_id"
        FROM
          "tenants" AS "torgid"
        GROUP BY
          "torgid"."org_id"
        HAVING
          count("torgid"."org_id") > 1
      );
# Get all the applications from any duplicated tenants from the database.
  - |
    SELECT
      "t"."id" AS "t_id",
      "t"."external_tenant" AS "t_external_tenant",
      "t"."org_id" AS "t_org_id",
      "t"."created_at" AS "t_created_at",
      "t"."updated_at" AS "t_updated_at",
      "a"."id" AS "a_id",
      "a"."tenant_id" AS "a_tenant_id",
      "a"."application_type_id" AS "a_application_type_id",
      "a"."created_at" AS "a_created_at",
      "a"."updated_at" AS "a_updated_at"
    FROM
      "tenants" AS "t"
    LEFT JOIN
      "applications" "a" ON "t"."id" = "a"."tenant_id"
    WHERE
      "t"."external_tenant" IN (
        SELECT
          "texten"."external_tenant"
        FROM
          "tenants" AS "texten"
        GROUP BY
          "texten"."external_tenant"
        HAVING
          count("texten"."external_tenant") > 1
      )
    OR
      "t"."org_id" IN (
        SELECT
          "torgid"."org_id"
        FROM
          "tenants" AS "torgid"
        GROUP BY
          "torgid"."org_id"
        HAVING
          count("torgid"."org_id") > 1
      );
# Get all the duplicated tenants from the database.
  - |
    SELECT
      "t"."id", "t"."name", "t"."description", "t"."external_tenant", "t"."org_id", "t"."created_at", "t"."updated_at"
    FROM
      "tenants" "t"
    WHERE
      "t"."external_tenant" IN (
        SELECT
          "texten"."external_tenant"
        FROM
          "tenants" "texten"
        GROUP BY
          "texten"."external_tenant"
        HAVING
          count("texten"."external_tenant") > 1
      )
    OR
      "t"."org_id" IN (
        SELECT
          "torgid"."org_id"
        FROM
          "tenants" "torgid"
        GROUP BY
          "torgid"."org_id"
        HAVING
          count("torgid"."org_id") > 1
      );
# Get all the processed duplicated tenants.
  - |
    SELECT
      "t"."id",
      "t"."name",
      "t"."description",
      "t"."external_tenant",
      "t"."org_id",
      "t"."created_at",
      "t"."updated_at"
    FROM
      "tenants" AS "t"
    WHERE
      "t"."external_tenant" LIKE 'processed-duplicate-tenant-of%'
    OR
      "t"."org_id" LIKE 'processed-duplicate-tenant-of%';
