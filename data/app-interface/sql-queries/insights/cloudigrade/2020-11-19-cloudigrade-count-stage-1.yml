---
$schema: /app-interface/app-interface-sql-query-1.yml
labels: {}
name: 2020-11-19-cloudigrade-count-stage-1
namespace:
  $ref: /services/insights/cloudigrade/namespaces/stage-cloudigrade-stage.yml
identifier: cloudigrade-stage
output: stdout
query: |
  SELECT l.id AS lock_id,
       l.created_at AS lock_created_at,
       l.updated_at AS lock_updated_at,
       l.locked,
       l.user_id,
       u.username,
       u.email,
       ca.id AS cloudaccount_id,
       ca.created_at AS cloudaccount_created_at,
       ca.updated_at AS cloudaccount_updated_at,
       ca.platform_application_id,
       ca.platform_authentication_id,
       ca.platform_source_id,
       ca.is_enabled AS cloudaccount_is_enabled,
       aca.aws_account_id,
       aca.account_arn,
       aca.verify_task_id
  FROM api_usertasklock l
  JOIN auth_user u ON l.user_id = u.id
  LEFT JOIN api_cloudaccount ca ON u.id = ca.user_id
  LEFT JOIN django_content_type ct ON ca.content_type_id = ct.id
  LEFT JOIN api_awscloudaccount aca ON ca.object_id = aca.id
  WHERE COALESCE(ct.app_label, 'api') = 'api'
    AND COALESCE(ct.model, 'awscloudaccount') = 'awscloudaccount';

