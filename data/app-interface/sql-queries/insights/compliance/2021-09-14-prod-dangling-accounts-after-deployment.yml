$schema: /app-interface/app-interface-sql-query-1.yml
name: 2021-09-14-prod-dangling-accounts-after-deployment
labels: {}
namespace:
  $ref: /services/insights/compliance/namespaces/compliance-prod.yml
identifier: compliance-prod
output: stdout
query: >-
  SELECT COUNT("id") from "accounts"
  WHERE "accounts"."id" NOT IN (( 
  (SELECT DISTINCT account_id FROM "policies") UNION 
  (SELECT DISTINCT account_id FROM "profiles" WHERE "profiles"."parent_profile_id" IS NOT NULL)
  )) AND
  "accounts"."account_number" NOT IN (
    SELECT DISTINCT "inventory"."hosts"."account" FROM "inventory"."hosts" WHERE 
    ("inventory"."hosts"."id" IN 
      (SELECT "policy_hosts"."host_id" FROM "policy_hosts") OR 
      "inventory"."hosts"."id" IN (SELECT "test_results"."host_id" FROM "test_results")));
