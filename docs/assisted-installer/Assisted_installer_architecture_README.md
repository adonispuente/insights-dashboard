# Assisted Installer Architecture

## Service Description

Assisted Installer is a graphical, guided, OpenShift installer for creating a cluster on any platform.
The user provides information to the service about their infrastructure and the cluster they want to install, and then download a live-ISO image customized for their specific installation.
This ISO contains an agent that reports host information back to the service and eventually triggers the installation.
Install progress is monitored and the user can download their cluster credentials (kubeconfig) and installation logs from the service when installation completes.

## Components

### Hosted by Red Hat

* Assisted Installer REST API (backend service)
    * Mainly implements the REST API service, invoked by both users and agents.
    * A single replica also runs monitors that periodically calculate the correct cluster and host statuses and update them when necessary.

* Assisted Image Service
    * Customizes and serves RHCOS images for the Assisted Installer
    * Pre-signed URLs pointing to the image service route are generated by the assisted service and given to users
    * API is accessed using presigned URLs from Assisted Service
    * Deployed using a Stateful Set in order to store "base" RHCOS images

* Assisted Installer UI, integrated with OCM

### Runs in customer environment

* Agent 
    * Runs on-prem on each server
    * Communicates back to the assisted service

* Assisted controller 
    * Job that runs on a newly-created cluster 
    * Approves nodes and reports final progress to the assisted service

## Routes

Three routes exist to handle routing for a single hostname.
The routes are all bound to the same host (`zoscaru4s08w1mz.api.openshift.com`).

The OCM API gateway is configured to route two path prefixes to this host:
    * `/api/assisted-images`
        * Requests are of the form `/api/assisted-images/images/...` or `/api/assisted-images/boot-artifacts/...`
        * `/api/assisted-images` prefix is stripped at the gateway.
        * `/images` requests must contain authentication - these serve customized, cluster-specific, image files (ISO or initrd)
        * `/boot-artifacts` serves unaltered RHCOS iPXE resources (kernel or rootfs)
    * `/api/assisted-install`
        * All other requests
        * Requests are typically of the form `/api/assisted-install/v2/<resource>...`
        * Handled by the assisted-service route

## Dependencies

* AMS is contacted for authorization
    * If AMS is not available users will not be able to access the application.

## Service Diagram

```
         ------  --------------        ------------------        ------------------------
         | UI |  | API Clients|        | Pre-signed URLs|        | Unauthenticated URLs |
         ------  --------------        ------------------        ------------------------
            |           |                      |                          |
            V           V                      V                          V
      --------------------------    -------------------------- -----------------------------------------
      | assisted-service Route |    | assisted-image-service | | assisted-image-service-boot-artifacts |
      --------------------------    |     Route (/images)    | |          Route (/boot-artifacts)      |
                  |                 -------------------------- -----------------------------------------
                  |                            |                       |
                  |                            |                       |
                  |                            |                       |
                  V                            V                       |
             --------------------             -----------------        |
             | Assisted Service |             | Image Service |<-------|
             --------------------             -----------------
              |  |  |       ^                    |          |
        S3<----  |  |       |                    |          |
                 |  |       |                    |      ---------------
       RDS<-------  |       ----------------------      | Base ISO PV |
                    |       Image service requests      ---------------
       AMS<----------       data from assisted
                            service
```

## State

* PostgreSQL DB 
    * Stores all application data (e.g. clusters, hosts, and  events)
    * If the database is not available the web service will not function, but installs that have already started will continue

* AWS bucket
    * Stores data such as kubeconfig, ignition, and logs 
    * All data for a cluster is deleted when the cluster is inactive for 3 weeks
    * If AWS is not available most basic APIs will continue to be available, but users will not be able to download credentials or run installations

* Image Service PVs
    * The image service stateful set requests persistent storage
    * These are just to avoid writing excessive data to the node or pod filesystem
    * If these are lost the data will be recreated on the next deploy

## Load Testing

Load tests are periodically performed on the staging environemnt and results for installation success rate as well as individual API response times are recorded.
A load test involves installing a significant number of clusters (recent tests have ranged from 300 to 3000) and comparing success rate and API response time between different versions.
These results are posted to the assisted-installer@redhat.com mailing list.

## Capacity

TODO

## Notes

More data about architecture & design can be found in the [upstream documentation](https://github.com/openshift/assisted-service/blob/master/docs/architecture.md)
