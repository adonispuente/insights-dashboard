---
$schema: /app-interface/prometheus-rule-test-1.yml

rule_files:
- /services/backplane/backplane-api-int-common.prometheusrules.yml

evaluation_interval: 1m

tests:
- interval: 1m
  input_series:
  - series: up{job="backplane-api"}
    values: 1+0x30 0+0x30 # 1 for the first 30 minutes, 0 for the next 30 minutes

  alert_rule_test:
  - eval_time: 25m
    alertname: Backplane API Target Down
    exp_alerts:
  - eval_time: 55m
    alertname: Backplane API Target Down
    exp_alerts:
    - exp_labels:
        severity: critical
        service: srep
      exp_annotations:
        message: "No targets found for Backplane API on integration - {{{shard_name}}}"
        runbook: "https://github.com/openshift/ops-sop/blob/master/v4/alerts/BackplaneTargetDown.md"
- interval: 1m
  input_series:
  # If value > (14.4*(1-0.95))=0.72 and last for 2 mins
  - series: sum(http_requests_total:burnrate5m{job="backplane-api",handler="login"})
    values: 0.5+0x5 0.73+0x5 
  - series: sum(http_requests_total:burnrate1h{job="backplane-api",handler="login"})
    values: 0.5+0x5 0.73+0x5  
  # If value > (6*(1-0.95))=0.3 and last for 15 mins
  - series: sum(http_requests_total:burnrate30m{job="backplane-api",handler="login"})
    values: 0.2+0x15 0.4+0x30 
  - series: sum(http_requests_total:burnrate6h{job="backplane-api",handler="login"})
    values: 0.2+0x15 0.4+0x30       
  # If value > (3*(1-0.95))=0.15 and last for 1 hour
  - series: sum(http_requests_total:burnrate2h{job="backplane-api",handler="login"})
    values: 0.1+0x60 0.2+0x600 
  - series: sum(http_requests_total:burnrate1d{job="backplane-api",handler="login"})
    values: 0.1+0x60 0.2+0x600   
  # If value > (1*(1-0.95))=0.05 and last for 3 hour
  - series: sum(http_requests_total:burnrate6h{job="backplane-api",handler="login"})
    values: 0.04+0x10 0.06+0x200 
  - series: sum(http_requests_total:burnrate3d{job="backplane-api",handler="login"})
    values: 0.04+0x10 0.06+0x200    
  alert_rule_test:
  - eval_time: 5m
    alertname: BackplaneLoginSLOBudgetBurn
    exp_alerts:
  - eval_time: 8m
    alertname: BackplaneLoginSLOBudgetBurn
    exp_alerts:
    - exp_labels:
        severity: critical
        service: srep
      exp_annotations:
        message: "High error budget burn for backplane-api logins (current value: {{ $value }})  on integration - {{{shard_name}}}"
        runbook: "https://github.com/openshift/ops-sop/blob/master/v4/alerts/BackplaneTargetDown.md"    
  - eval_time: 35m
    alertname: BackplaneLoginSLOBudgetBurn
    exp_alerts:
    - exp_labels:
        severity: critical
        service: srep
      exp_annotations:
        message: "High error budget burn for backplane-api logins (current value: {{ $value }})  on integration - {{{shard_name}}}"
        runbook: "https://github.com/openshift/ops-sop/blob/master/v4/alerts/BackplaneTargetDown.md" 
  - eval_time: 135m
    alertname: BackplaneLoginSLOBudgetBurn
    exp_alerts:
    - exp_labels:
        severity: warning
        service: srep
      exp_annotations:
        message: "High error budget burn for backplane-api logins (current value: {{ $value }})  on integration - {{{shard_name}}}"
        runbook: "https://github.com/openshift/ops-sop/blob/master/v4/alerts/BackplaneTargetDown.md"         
  - eval_time: 195m
    alertname: BackplaneLoginSLOBudgetBurn
    exp_alerts:
    - exp_labels:
        severity: critical
        service: srep
      exp_annotations:
        message: "High error budget burn for backplane-api logins (current value: {{ $value }})  on integration - {{{shard_name}}}"
        runbook: "https://github.com/openshift/ops-sop/blob/master/v4/alerts/BackplaneTargetDown.md"        

