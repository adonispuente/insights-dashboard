---
$schema: /app-interface/prometheus-rule-test-1.yml

rule_files:
- /services/hive/hive-production-common.prometheusrules.yaml

evaluation_interval: 1m

tests:

- interval: 1m
  input_series:
  - series: up{job="hive-controllers"}
    values: 1+0x10 0+0x10 # 1 for the first 10 minutes, 0 for the next 10 minutes
  alert_rule_test:
  - eval_time: 3m
    alertname: HiveControllersDown - production - {{{shard_name}}}
    exp_alerts:
  - eval_time: 18m
    alertname: HiveControllersDown - production - {{{shard_name}}}
    exp_alerts:
    - exp_labels:
        severity: critical
        team: appsre
        service: hive
      exp_annotations:
        message: "No targets found for hive-controllers in namespace . hive-controllers is down."
        runbook: "https://github.com/openshift/hive-sops/blob/master/sop"
        dashboard: "https://grafana.app-sre.devshift.net/d/hivemetrics/hive-metrics?orgId=1&var-datasource={{{grafana_datasource}}}&var-instance=hive-controllers-{{{shard_name}}}"

- interval: 1m
  input_series:
  - series: csv_abnormal{exported_namespace="hive", name="hive-operator", reason="Pending"}
    values: 0+0x10 1+0x30 # 0 for the first 10 minutes, 1 for the next 30 minutes
  alert_rule_test:
  - eval_time: 9m
    alertname: ClusterServiceVersionStuck - production - {{{shard_name}}}
    exp_alerts:
  # TODO: why is this test failing? at 13 minutes, we've been down for 3, which is less than the required
  # 5 minutes for the alert to fire...
  #  - eval_time: 13m
  #    alertname: ClusterServiceVersionStuck - production - {{{shard_name}}}
  #  exp_alerts:
  - eval_time: 16m
    alertname: ClusterServiceVersionStuck - production - {{{shard_name}}}
    exp_alerts:
    - exp_labels:
        severity: medium
        service: hive
        exported_namespace: hive
        name: hive-operator
        reason: Pending
      exp_annotations:
        message: "ClusterServiceVersion hive-operator stuck in abnormal state: Pending"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/hive/sop/hive-olm-dance.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/hivemetrics/hive-metrics?orgId=1&var-datasource={{{grafana_datasource}}}&var-instance=hive-controllers-{{{shard_name}}}"

- interval: 1m
  input_series:
  - series: hive_cluster_deployment_provision_underway_seconds{job="hive-controllers", cluster_type="managed", cluster_deployment="busted-cluster", exported_namespace="uhc-production-something", condition="ProvisionFailed", reason="EIPAllocation"}
    values: 0+60x240 # install starts at t0, increases 600 seconds every interval (10 mins), should be alerted after 120m
  alert_rule_test:
  - eval_time: 30m
    alertname: ClusterProvisioningDelaySREP - production - {{{shard_name}}}
    exp_alerts:
  - eval_time: 140m # after 2 hours we should get alerted
    alertname: ClusterProvisioningDelaySREP - production - {{{shard_name}}}
    exp_alerts:
    - exp_labels:
        severity: medium
        service: hive
        team: srep
        job: hive-controllers
        cluster_type: managed
        cluster_deployment: busted-cluster
        exported_namespace: uhc-production-something
        condition: ProvisionFailed
        reason: EIPAllocation
      exp_annotations:
        message: "cluster busted-cluster in namespace uhc-production-something provisioning taking over 2 hours. Condition/Reason: ProvisionFailed / EIPAllocation. SOP: https://github.com/openshift/hive-sops/blob/master/sop/ClusterProvisioningDelay.md"
        runbook: "https://github.com/openshift/hive-sops/blob/master/sop/ClusterProvisioningDelay.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/hivemetrics/hive-metrics?orgId=1&var-datasource={{{grafana_datasource}}}&var-instance=hive-controllers-{{{shard_name}}}"

- interval: 1m
  input_series:
  - series: hive_cluster_deployment_provision_underway_seconds{job="hive-controllers", cluster_type="managed", cluster_deployment="busted-cluster-unknown", exported_namespace="uhc-production-something", condition="ProvisionFailed", reason="Unknown"}
    values: 0+60x240 # install starts at t0, increases 600 seconds every interval (10 mins), should be alerted after 120m
  # No hive team alert if the reason was auto-detected
  - series: hive_cluster_deployment_provision_underway_seconds{job="hive-controllers", cluster_type="managed", cluster_deployment="busted-cluster-known", exported_namespace="uhc-production-something", condition="ProvisionFailed", reason="KnownReason"}
    values: 0+60x240 # install starts at t0, increases 600 seconds every interval (10 mins), should be alerted after 120m
  alert_rule_test:
  - eval_time: 30m
    alertname: ClusterProvisioningDelayHive - production - {{{shard_name}}}
    exp_alerts:
  - eval_time: 140m # after 2 hours we should get alerted
    alertname: ClusterProvisioningDelayHive - production - {{{shard_name}}}
    exp_alerts:
    - exp_labels:
        severity: medium
        service: hive
        team: hive
        job: hive-controllers
        cluster_type: managed
        cluster_deployment: busted-cluster-unknown
        exported_namespace: uhc-production-something
        condition: ProvisionFailed
        reason: Unknown
      exp_annotations:
        message: "cluster busted-cluster-unknown in namespace uhc-production-something provisioning taking over 2 hours. Condition/Reason: ProvisionFailed / Unknown."
        runbook: "https://github.com/openshift/hive-sops/blob/master/sop/ClusterProvisioningDelay.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/hivemetrics/hive-metrics?orgId=1&var-datasource={{{grafana_datasource}}}&var-instance=hive-controllers-{{{shard_name}}}"

