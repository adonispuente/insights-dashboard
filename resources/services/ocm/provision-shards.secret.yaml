apiVersion: v1
kind: Secret
metadata:
  name: provision-shards
  annotations:
    qontract.recycle: "true"
    qontract.ignore_reconcile_time: "true"
data:
  config:
    {{% b64encode %}}
    provision_shards:
    {{%- for shard in shards %}}
    {{%- if current_hive_cluster.update({'name': shard.hive_cluster_name}) %}}{{%- endif %}}
    - id: {{{ shard.id }}}
      hive_config: |
        apiVersion: v1
        clusters:
        - cluster:
            server: {{{ shard.hive_cluster_api_url }}}
          name: {{{ shard.hive_cluster_api_url_slug }}}
        contexts:
        - context:
            cluster: {{{ shard.hive_cluster_api_url_slug }}}
            user: system:serviceaccount:hive:hive-frontend/{{{ shard.hive_cluster_api_url_slug }}}
          name: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:hive:hive-frontend
        current-context: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:hive:hive-frontend
        kind: Config
        preferences: {}
        users:
        - name: system:serviceaccount:hive:hive-frontend/{{{ shard.hive_cluster_api_url_slug }}}
          user:
            token: {{{ vault('app-sre/integrations-output/openshift-serviceaccount-tokens/shared-resources/{{ current_hive_cluster.name }}-hive-hive-frontend', 'token') }}}
      aws_account_operator_config: |
        apiVersion: v1
        clusters:
        - cluster:
            server: {{{ shard.hive_cluster_api_url }}}
          name: {{{ shard.hive_cluster_api_url_slug }}}
        contexts:
        - context:
            cluster: {{{ shard.hive_cluster_api_url_slug }}}
            user: system:serviceaccount:aws-account-operator:aws-account-operator-client/{{{ shard.hive_cluster_api_url_slug }}}
          name: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:aws-account-operator:aws-account-operator-client
        current-context: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:aws-account-operator:aws-account-operator-client
        kind: Config
        preferences: {}
        users:
        - name: system:serviceaccount:aws-account-operator:aws-account-operator-client/{{{ shard.hive_cluster_api_url_slug }}}
          user:
            token: {{{ vault('app-sre/integrations-output/openshift-serviceaccount-tokens/shared-resources/{{ current_hive_cluster.name }}-aws-account-operator-aws-account-operator-client', 'token') }}}
      gcp_project_operator_config: |
        apiVersion: v1
        clusters:
        - cluster:
            server: {{{ shard.hive_cluster_api_url }}}
          name: {{{ shard.hive_cluster_api_url_slug }}}
        contexts:
        - context:
            cluster: {{{ shard.hive_cluster_api_url_slug }}}
            user: system:serviceaccount:gcp-project-operator:gcp-project-operator-client/{{{ shard.hive_cluster_api_url_slug }}}
          name: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:gcp-project-operator:gcp-project-operator-client
        current-context: /{{{ shard.hive_cluster_api_url_slug }}}/system:serviceaccount:gcp-project-operator:gcp-project-operator-client
        kind: Config
        preferences: {}
        users:
        - name: system:serviceaccount:gcp-project-operator:gcp-project-operator-client/{{{ shard.hive_cluster_api_url_slug }}}
          user:
            token: {{{ vault('app-sre/integrations-output/openshift-serviceaccount-tokens/shared-resources/{{ current_hive_cluster.name }}-gcp-project-operator-gcp-project-operator-client', 'token') }}}
      aws_base_domain: {{{ aws_base_domain }}}
      gcp_base_domain: {{{ gcp_base_domain }}}
      status: {{{ shard.status }}}
    {{%- endfor %}}
    {{%- for shard in hypershift_shards %}}
    {{%- if current_hypershift_cluster.update({'name': shard.hypershift_cluster_name}) %}}{{%- endif %}}
    - id: {{{ shard.id }}}
      hypershift_config: |
        apiVersion: v1
        kind: Config
        clusters:
        - name: default
          cluster:
            server: {{{ shard.hypershift_cluster_api_url }}}
        users:
        - name: default
          user:
            token: {{{ vault('app-sre/integrations-output/openshift-serviceaccount-tokens/shared-resources/{{ current_hypershift_cluster.name }}-ocm-ocm', 'token') }}}
        contexts:
        - name: default
          context:
            cluster: default
            user: default
        current-context: default
      base_domain: {{{ shard.base_domain }}}
      cloud_provider: {{{ shard.cloud_provider }}}
      region: {{{ shard.region }}}
      issuer_base_url: https://{{{ vault('app-sre/integrations-output/terraform-resources/{{ current_hypershift_cluster.name }}/multicluster-engine/hypershift-oidc-s3-creds', 'bucket') }}}.{{{ vault('app-sre/integrations-output/terraform-resources/{{ current_hypershift_cluster.name }}/multicluster-engine/hypershift-oidc-s3-creds', 'endpoint') }}}
      status: {{{ shard.status }}}
    {{%- endfor %}}
    {{% endb64encode %}}
