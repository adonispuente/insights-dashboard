---
apiVersion: v1
kind: Template
metadata:
  name: cloudwatch-exporter-template
objects:
- apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: cloudwatch-exporter
  spec:
    replicas: 1
    minReadySeconds: 10
    progressDeadlineSeconds: 600
    revisionHistoryLimit: 3
    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxUnavailable: 0
        maxSurge: 1
    selector:
      matchLabels:
        app: cloudwatch-exporter
    template:
      metadata:
        labels:
          app: cloudwatch-exporter
        annotations:
          cloudwatch-exporter-version: latest
      spec:
        volumes:
        - name: cloudwatch-exporter-config
          configMap:
            name: cloudwatch-exporter-config
        containers:
        - name: cloudwatch-exporter
          image:  prom/cloudwatch-exporter:latest
          volumeMounts:
          - name: cloudwatch-exporter-config
            mountPath: /config
          ports:
          - containerPort: 9106
            protocol: TCP
          env:
          - name: AWS_REGION
            value: us-east-1
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: iam-creds
                key: AWS_ACCESS_KEY_ID
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: iam-creds
                key: AWS_SECRET_ACCESS_KEY
          resources:
            limits:
              cpu: 500m
              memory: 1G
            requests:
              cpu: 500m
              memory: 1G
          readinessProbe:
            httpGet:
              path: /
              port: 9106
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 10
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /
              port: 9106
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 15
            successThreshold: 1
            failureThreshold: 3
