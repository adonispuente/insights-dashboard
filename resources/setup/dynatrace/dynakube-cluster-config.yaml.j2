---
# DynaKube for log ingestion.
# DynaKube is the monitoring configuration object.
# The Dynatrace Operator detects this object
# and reconciles monitoring agents accordingly.
# Note, that a cluster can have multiple DynaKube
# objects, i.e., multiple ActiveGates and OneAgent
# Daemonsets each with different configurations.
# This file is aligned with https://gitlab.cee.redhat.com/service/dynatrace-config
apiVersion: template.openshift.io/v1
kind: Template
parameters:
- name: ACTIVEGATE_CPU_REQUEST
  value: 500m
- name: ACTIVEGATE_MEM_REQUEST
  value: 512Mi
- name: ACTIVEGATE_CPU_LIMIT
  value: 1000m
- name: ACTIVEGATE_MEM_LIMIT
  value: 1.5Gi
- name: DT_API_URL
  required: true
metadata:
  name: dynakube-config
objects:
- apiVersion: dynatrace.com/v1beta1
  kind: DynaKube
  metadata:
    name: log-and-metric-ingestion
    namespace: dynatrace
    annotations:
      feature.dynatrace.com/automatic-kubernetes-api-monitoring: "true"
      feature.dynatrace.com/oneagent-readonly-host-fs: "false"
  spec:
    apiUrl: ${DT_API_URL}
    skipCertCheck: false
    tokens: dynatrace-tokens
    oneAgent:
      hostMonitoring:
        args:
        # https://www.dynatrace.com/support/help/setup-and-configuration/dynatrace-oneagent/oneagent-configuration-via-command-line-interface
        - --set-host-group={{ resource.namespace.cluster.name }}
        # TODO: align env and cluster-id
        - --set-host-tag=env={{ resource.namespace.cluster.name }}
        - --set-host-tag=cluster-id={{ resource.namespace.cluster.name }}
        - --set-infra-only=true
        tolerations:
          - effect: NoSchedule
            key: node-role.kubernetes.io/master
            operator: Exists
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            operator: Exists
          - effect: NoSchedule
            key: node-role.kubernetes.io/control-plane
            operator: Exists
        autoUpdate: true
    activeGate:
      capabilities:
        # All available capabilities:
        # - routing
        # - kubernetes-monitoring
        # - dynatrace-api
        # - metrics-ingest
        - routing
        - kubernetes-monitoring
        - dynatrace-api
        - metrics-ingest
      replicas: 1
      tolerations:
        - effect: NoSchedule
          key: node-role.kubernetes.io/infra
          operator: Exists          
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      resources:
        requests:
          cpu: ${ACTIVEGATE_CPU_REQUEST}
          memory: ${ACTIVEGATE_MEM_REQUEST}
        limits:
          cpu: ${ACTIVEGATE_CPU_LIMIT}
          memory: ${ACTIVEGATE_MEM_LIMIT}
