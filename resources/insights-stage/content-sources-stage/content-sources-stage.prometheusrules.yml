---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: content-sources-stage
spec:
  groups:
    - name: content-sources-down
      rules:
        - alert: ContentSourcesBackendDown
          annotations:
            message: "content-sources-backend-service pod down for 5 minutes."
          expr: up{service="content-sources-backend-service", namespace="content-sources-stage"} == 0
          labels:
            service: insights
            severity: medium
    - name: content-sources-availability-stage
      rules:
        - alert: ContentSources5mto1hErrorBudgetBurn
          annotations:
            message: "High error budget burn in the last hour (error rate: {{ $value | humanizePercentage }})"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesAvailabilityAlert.md"
          expr: |
            sum(content_sources_availability_error_ratio:burnrate5m) > (13.44 * (1-0.95000))
            and
            sum(content_sources_availability_error_ratio:burnrate1h) > (13.44 * (1-0.95000))
          for: 2m
          labels:
            service: insights
            severity: medium
        - alert: ContentSources30mto6hErrorBudgetBurn
          annotations:
            message: "High error budget burn in the last 6 hours (error rate: {{ $value | humanizePercentage }})"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesAvailabilityAlert.md"
          expr: |
            sum(content_sources_availability_error_ratio:burnrate30m) > (5.6 * (1-0.95000))
            and
            sum(content_sources_availability_error_ratio:burnrate6h) > (5.6 * (1-0.95000))
          for: 15m
          labels:
            service: insights
            severity: medium
        - alert: ContentSources2hto1dErrorBudgetBurn
          annotations:
            message: "High error budget burn in the last day (error rate: {{ $value | humanizePercentage }})"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesAvailabilityAlert.md"
          expr: |
            sum(content_sources_availability_error_ratio:burnrate2h) > (2.8 * (1-0.95000))
            and
            sum(content_sources_availability_error_ratio:burnrate1d) > (2.8 * (1-0.95000))
          for: 1h
          labels:
            service: insights
            severity: medium
        - alert: ContentSources6hto3dErrorBudgetBurn
          annotations:
            message: "High error budget burn in the last 3 days (error rate: {{ $value | humanizePercentage }})"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesAvailabilityAlert.md"
          expr: |
            sum(content_sources_availability_error_ratio:burnrate6h) > (1.00 * (1-0.95000))
            and
            sum(content_sources_availability_error_ratio:burnrate3d) > (1.00 * (1-0.95000))
          for: 1m
          labels:
            service: insights
            severity: medium
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[1d]))
            /
            sum(rate(content_sources_http_status_histogram_count[1d]))
          labels:
            service: insights
          record: content_sources_availability_error_ratio:burnrate1d
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[1h]))
            /
            sum(rate(content_sources_http_status_histogram_count[1h]))
          labels:
            service: insights
          record: content_sources_availability_error_ratio:burnrate1h
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[2h]))
            /
            sum(rate(content_sources_http_status_histogram_count[2h]))
          labels:
            service: insights
          record: content_sources_availability_error_ratio:burnrate2h
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[30m]))
            /
            sum(rate(content_sources_http_status_histogram_count[30m]))
          labels:
            service: insights
          record: content_sources_availability_error_ratio:burnrate30m
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[3d]))
            /
            sum(rate(content_sources_http_status_histogram_count[3d]))
          labels:
            service: insights
          record: content_sources_availability_error_ratio:burnrate3d
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[5m]))
            /
            sum(rate(content_sources_http_status_histogram_count[5m]))
          labels:
            service: insights
          record: content_sources_availability_error_ratio:burnrate5m
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[6h]))
            /
            sum(rate(content_sources_http_status_histogram_count[6h]))
          labels:
            service: insights
          record: content_sources_availability_error_ratio:burnrate6h
    - name: content-sources-latency-stage
      rules:
        - alert: ContentSourcesLatency5mto1hrOr30mto6hBudgetBurn
          annotations:
            message: 'High requests latency budget burn: {{ $value | humanizePercentage }} of requests slower than 100ms.'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesLatencyAlert.md"
          expr: |
            (
              content_sources_http_status_histogram_bucket:rate1h{latency="0.1"} > (13.44 * (1-0.95000))
              and
              content_sources_http_status_histogram_bucket:rate5m{latency="0.1"} > (13.44 * (1-0.95000))
            )
            or
            (
              content_sources_http_status_histogram_bucket:rate6h{latency="0.1"} > (5.6 * (1-0.95000))
              and
              content_sources_http_status_histogram_bucket:rate30m{latency="0.1"} > (5.6 * (1-0.95000))
            )
          labels:
            service: insights
            severity: medium
            latency: "0.1"
        - alert: ContentSourcesLatency2hto1dOr6hto3dBudgetBurn
          annotations:
            message: 'High requests latency budget burn: {{ $value | humanizePercentage }} of requests slower than 100ms.'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesLatencyAlert.md"
          expr: |
            (
              content_sources_http_status_histogram_bucket:rate1d{latency="0.1"} > (2.8 * (1-0.95000))
              and
              content_sources_http_status_histogram_bucket:rate2h{latency="0.1"} > (2.8 * (1-0.95000))
            )
            or
            (
              content_sources_http_status_histogram_bucket:rate3d{latency="0.1"} > (1 * (1-0.95000))
              and
              content_sources_http_status_histogram_bucket:rate6h{latency="0.1"} > (1 * (1-0.95000))
            )
          labels:
            service: insights
            severity: medium
            latency: "0.1"
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.1"}[5m]))
              /
              sum(rate(content_sources_http_status_histogram_bucket_count[5m]))
            )
          labels:
            latency: "0.1"
          record: content_sources_http_status_histogram_bucket:rate5m
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.1"}[30m]))
              /
              sum(rate(content_sources_http_status_histogram_bucket_count[30m]))
            )
          labels:
            latency: "0.1"
          record: content_sources_http_status_histogram_bucket:rate30m
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.1"}[1h]))
              /
              sum(rate(content_sources_http_status_histogram_bucket_count[1h]))
            )
          labels:
            latency: "0.1"
          record: content_sources_http_status_histogram_bucket:rate1h
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.1"}[2h]))
              /
              sum(rate(content_sources_http_status_histogram_bucket_count[2h]))
            )
          labels:
            latency: "0.1"
          record: content_sources_http_status_histogram_bucket:rate2h
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.1"}[6h]))
              /
              sum(rate(content_sources_http_status_histogram_bucket_count[6h]))
            )
          labels:
            latency: "0.1"
          record: content_sources_http_status_histogram_bucket:rate6h
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.1"}[1d]))
              /
              sum(rate(content_sources_http_status_histogram_bucket_count[1d]))
            )
          labels:
            latency: "0.1"
          record: content_sources_http_status_histogram_bucket:rate1d
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.1"}[3d]))
              /
              sum(rate(content_sources_http_status_histogram_bucket_count[3d]))
            )
          labels:
            latency: "0.1"
          record: content_sources_http_status_histogram_bucket:rate3d
