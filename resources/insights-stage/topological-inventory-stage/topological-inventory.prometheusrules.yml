---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: insights-topological-inventory-stage
  labels:
    prometheus: app-sre
    role: alert-rules
spec:
  groups:
  - name: topology-services-up-stage # TODO: Targeted refresh
    rules:
      - alert: TopologyApiSvcAbsent
        expr: absent(up{job="topological-inventory-api",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/qRvAZLAMk/topological-inventory-apis?orgId=1&from=now-30m&to=now&refresh=10s&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-api"
          message: "[Stage] Topological Inventory: API: All pods have been down for two minutes"
      - alert: TopologyIngressApiSvcAbsent
        expr: absent(up{job="topological-inventory-ingress-api",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/qRvAZLAMk/topological-inventory-apis?orgId=1&from=now-30m&to=now&refresh=10s&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-ingress-api"
          message: "[Stage] Topological Inventory: Ingress API: All pods have been down for two minutes"
      - alert: TopologyPersisterSvcAbsent
        expr: absent(up{job="topological-inventory-persister",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-persister"
          message: "[Stage] Topological Inventory: Persister: All pods have been down for two minutes"
      - alert: TopologyOrchestratorSvcAbsent
        expr: absent(up{job="topological-inventory-orchestrator",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-orchestrator"
          message: "[Stage] Topological Inventory: Orchestrator: All pods have been down for two minutes"
      - alert: TopologySourcesSyncSvcAbsent
        expr: absent(up{job="topological-inventory-sources-sync",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-sources-sync"
          message: "[Stage] Topological Inventory: Sources Sync: All pods have been down for two minutes"
      - alert: TopologyHostInventorySyncSvcAbsent
        expr: absent(up{job="topological-inventory-host-inventory-sync",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-host-inventory-sync"
          message: "[Stage] Topological Inventory: Host Inventory Sync: All pods have been down for two minutes"
      - alert: TopologyAmazonOperationsSvcAbsent
        expr: absent(up{job="topological-inventory-amazon-operations",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-30m&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All&refresh=30s"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-amazon-operations"
          message: "[Stage] Topological Inventory: Amazon Operations: All pods have been down for two minutes"
      - alert: TopologyAnsibleTowerOperationsSvcAbsent
        expr: absent(up{job="topological-inventory-ansible-tower-operations",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-30m&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All&refresh=30s"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-ansible-tower-operations"
          message: "[Stage] Topological Inventory: Ansible Tower Operations: All pods have been down for two minutes"
      - alert: TopologyAzureOperationsSvcAbsent
        expr: absent(up{job="topological-inventory-azure-operations",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-30m&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All&refresh=30s"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-azure-operations"
          message: "[Stage] Topological Inventory: Azure Operations: All pods have been down for two minutes"
      - alert: TopologyOpenshiftOperationsSvcAbsent
        expr: absent(up{job="topological-inventory-openshift-operations",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-30m&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All&refresh=30s"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-openshift-operations"
          message: "[Stage] Topological Inventory: OpenShift Operations: All pods have been down for two minutes"
      - alert: TopologySatelliteOperationsSvcAbsent
        expr: absent(up{job="topological-inventory-satellite-operations",namespace="topological-inventory-stage"}==1)
        for: 2m
        labels:
          severity: info # high
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-30m&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All&refresh=30s"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-satellite-operations"
          message: "[Stage] Topological Inventory: Satellite Operations: All pods have been down for two minutes"
  - name: topology-kafka-lag-stage
    rules:
      - alert: TopologyKafkaLagPersister
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.persister'}) > 500
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources # Slack channel for app_team defined in resources/observability/alertmanager/alertmanager-instance.secret.yaml
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-persister"
          message: "[Stage] Topo Persister: Kafka Lag is bigger than 500 for the last 10 minutes"
      - alert: TopologyKafkaLagPersisterOutputStream
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.persister-output-stream'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-host-inventory-sync"
          message: "[Stage] Topo Host Inventory Sync: Kafka Lag is bigger than 200 for the last 10 minutes"
      - alert: TopologyKafkaLagCollectorAnsibleTower
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.collector-ansible-tower'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-ansible-tower-targeted-collector"
          message: "[Stage] Topo Targeted Collector (Tower): Kafka Lag is bigger than 200 for the last 10 minutes"
      - alert: TopologyKafkaLagTaskOutputStream
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.task-output-stream'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-api"
          message: "[Stage] Catalog Task Minion: Kafka Lag (task-output-stream) is bigger than 200 for the last 10 minutes"
      - alert: TopologyKafkaLagOperationsAmazon
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.operations-amazon'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-amazon-operations"
          message: "[Stage] Topo Amazon Operations: Kafka Lag is bigger than 200 for the last 10 minutes"
      - alert: TopologyKafkaLagOperationsAnsibleTower
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.operations-ansible-tower'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-ansible-tower-operations"
          message: "[Stage] Topo Ansible Tower Operations: Kafka Lag is bigger than 200 for the last 10 minutes"
      - alert: TopologyKafkaLagOperationsAzure
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.operations-azure'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-azure-operations"
          message: "[Stage] Topo Azure Operations: Kafka Lag is bigger than 200 for the last 10 minutes"
      - alert: TopologyKafkaLagOperationsOpenshift
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.operations-openshift'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-openshift-operations"
          message: "[Stage] Topo OpenShift Operations: Kafka Lag is bigger than 200 for the last 10 minutes"
      - alert: TopologyKafkaLagOperationsSatellite
        expr: sum(kafka_consumergroup_group_lag{topic='platform.topological-inventory.operations-satellite'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-satellite-operations"
          message: "[Stage] Topo Satellite Operations: Kafka Lag is bigger than 200 for the last 10 minutes"
      - alert: TopoKafkaLagEventStreamOrchestrator
        expr: sum(kafka_consumergroup_group_lag{topic='platform.sources.event-stream', group='topological-inventory-orchestrator'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/zxZKNnAMz/sources?orgId=1&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-orchestrator"
          message: "[Stage] Topo Orchestrator: Kafka Lag is bigger than 200 for the last 10 minutes"
      - alert: TopoKafkaLagEventStreamSourcesSync
        expr: sum(kafka_consumergroup_group_lag{topic='platform.sources.event-stream', group='topological-inventory-sync-sources'}) > 200
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/zxZKNnAMz/sources?orgId=1&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-sources-sync"
          message: "[Stage] Topo Sources Sync: Kafka Lag is bigger than 200 for the last 10 minutes"
  - name: topology-restarts-stage # TODO: Collectors & Targeted
    rules:
      - alert: TopologyApiRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-api"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/qRvAZLAMk/topological-inventory-apis?orgId=1&from=now-1h&to=now&refresh=10s&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-api"
          message: "[Stage] Topo API: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologyIngressApiRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-ingress-api"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/qRvAZLAMk/topological-inventory-apis?orgId=1&from=now-1h&to=now&refresh=10s&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-ingress-api"
          message: "[Stage] Topo Ingress API: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologyOrchestratorRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-orchestrator"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-orchestrator"
          message: "[Stage] Topo Orchestrator: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologyPersisterRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-persister"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-persister"
          message: "[Stage] Topo Persister: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologySourcesSyncRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-sources-sync"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-sources-sync"
          message: "[Stage] Topo Sources Sync: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologyHostInvSyncRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-host-inventory-sync"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-host-inventory-sync"
          message: "[Stage] Topo Host Inventory Sync: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologyAmazonOperationsRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-amazon-operations"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-amazon-operations"
          message: "[Stage] Topo Amazon Operations: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologyAnsibleTowerOperationsRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-ansible-tower-operations"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-ansible-tower-operations"
          message: "[Stage] Topo Ansible Tower Operations: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologyAzureOperationsRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-azure-operations"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-azure-operations"
          message: "[Stage] Topo Azure Operations: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologyOpenShiftOperationsRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-openshift-operations"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-openshift-operations"
          message: "[Stage] Topo OpenShift Operations: Restarted at least 5x/1h for the last 30 minutes"
      - alert: TopologySatelliteOperationsRestarts
        expr: sum(increase(kube_pod_container_status_restarts_total{container="topological-inventory-satellite-operations"}[1h])) > 5
        for: 30m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/aanIgg0Mz/topological-inventory-collectors-and-operations?orgId=1&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-satellite-operations"
          message: "[Stage] Topo Satellite Operations: Restarted at least 5x/1h for the last 30 minutes"
  - name: topology-api-stage
    rules:
      - alert: TopologyApi5xxErrors
        expr: sum(rate(topological_inventory_api_http_requests_total{status=~"^[5].*"}[5m])) * 100 > 50
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/qRvAZLAMk/topological-inventory-apis?orgId=1&from=now-15m&to=now&refresh=10s&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-api"
          message: "[Stage] Topology API has been throwing 5xx errors more than 50% of the time for the last 10 minutes"
      - alert: TopologyApiRequestDuration
        expr: avg(rate(topological_inventory_api_http_duration_seconds_sum{controller!="status"}[5m]) / rate(topological_inventory_api_http_duration_seconds_count{controller!="status"}[5m]) > 0) > 500
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/qRvAZLAMk/topological-inventory-apis?orgId=1&from=now-15m&to=now&refresh=10s&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-api"
          message: "[Stage] Topology API's Average Request Duration > 500 ms for the last 10 minutes"
  - name: topology-ingress-stage
    rules:
      - alert: TopologyIngressApi5xxErrors
        expr: sum(rate(topological_inventory_ingress_api_http_requests_total{status=~"^[5].*"}[5m])) * 100 > 50
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/qRvAZLAMk/topological-inventory-apis?orgId=1&from=now-15m&to=now&refresh=10s&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-ingress-api"
          message: "[Stage] Topology Ingress API has been throwing 5xx errors more than 50% of the time for the last 10 minutes"
      - alert: TopologyIngressApiRequestDuration
        expr: avg(rate(topological_inventory_ingress_api_http_duration_seconds_sum{controller!="status"}[5m]) / rate(topological_inventory_ingress_api_http_duration_seconds_count{controller!="status"}[5m]) > 0) > 500
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/qRvAZLAMk/topological-inventory-apis?orgId=1&from=now-15m&to=now&refresh=10s&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-ingress-api"
          message: "[Stage] Topology Ingress API's Average Request Duration > 500 ms for the last 10 minutes"
  - name: topology-persister-stage
    rules:
      - alert: TopologyPersisterMessageDuration
        expr: avg(rate(topological_inventory_persister_message_process_seconds_sum[5m]) / rate(topological_inventory_persister_message_process_seconds_count[5m]) > 0) > 500
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-persister"
          message: "[Stage] Topology Persister's Average Payload Processing Duration > 500 ms for the last 10 minutes"
      - alert: TopologyPersisterErrors
        expr: sum(increase(topological_inventory_persister_messages_total{result='error'}[10m])) > 50
        for: 10m
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-persister"
          message: "[Stage] Topology Persister: Average number of errors was > 50 per 10 mins for the last 10 minutes"
  - name: topology-orchestrator-stage
    rules:
      - alert: TopologyOrchestratorErrors
        expr: sum(increase(topological_inventory_orchestrator_errors_total[10m])) > 10
        labels:
          severity: info
          service: insights
          env: stage
          app_team: topo-sources
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/MnHGlz5Mk/topological-inventory-core?orgId=1&refresh=30s&from=now-1h&to=now&var-Datasource=crcs02ue1-prometheus&var-controller=All&var-action=All"
          link_url: "https://console-openshift-console.apps.crcs02ue1.urby.p1.openshiftapps.com/k8s/ns/topological-inventory-stage/deployments/topological-inventory-orchestrator"
          message: "[Stage] Topology Orchestrator: Average number of errors was > 10 per 10 mins for the last 10 minutes"
