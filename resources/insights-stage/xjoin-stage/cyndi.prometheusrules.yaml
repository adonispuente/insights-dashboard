---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: cyndi-stage
  labels:
    prometheus: app-sre
    role: alert-rules
spec:
  groups:
  - name: cyndi-stage
    rules:
    - alert: CyndiLagTooHigh
      expr: |
        min(sum(label_replace(kafka_consumergroup_group_lag{topic="platform.inventory.events", group=~"connect-syndication-sink-.*"}, "cyndi_application", "$1", "group", "connect-syndication-sink-(.*)\\.v.*")) by (group, cyndi_application, namespace)) by (cyndi_application, namespace) > 10000
      for: 15m
      labels:
        severity: info
        service: insights
        env: stage
        app_team: inventory
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/fF9U-h7Mk/cyndi?orgId=1&refresh=1m&var-datasource=crc-stg-01-prometheus"
        link_url: "https://console-openshift-console.apps.crc-stg-01.o4v9.p1.openshiftapps.com/k8s/ns/xjoin-stage/deployments/xjoin-kafka-connect/pods"
        message: "Consumer lag for {{ $labels.cyndi_application }} reached {{ $value }} messages (limit is 10000)"

    - alert: CyndiErrorDLQ
      expr: |
        sum(increase(kafka_server_brokertopicmetrics_messagesin_total{kubernetes_namespace=~"platform-mq-.*", topic="platform.cyndi.dlq"}[5m])) by (kubernetes_namespace) > 0
      labels:
        severity: info
        service: insights
        env: stage
        app_team: inventory
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/fF9U-h7Mk/cyndi?orgId=1&refresh=1m&var-datasource=crc-stg-01-prometheus"
        link_url: "https://console-openshift-console.apps.crc-stg-01.o4v9.p1.openshiftapps.com/k8s/ns/xjoin-stage/deployments/xjoin-kafka-connect/pods"
        message: "{{ $value }} new messages written to DLQ topic"

    - alert: CyndiNoRunningConnectors
      expr: |
        sum(label_replace(kafka_connect_connect_worker_metrics_connector_running_task_count{connector=~"syndication-sink-.*"}, "cyndi_application", "$1", "connector", "syndication-sink-(.*)\\.v.*")) by (cyndi_application) == 0
      for: 5m
      labels:
        severity: info
        service: insights
        env: stage
        app_team: inventory
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/fF9U-h7Mk/cyndi?orgId=1&refresh=1m&var-datasource=crc-stg-01-prometheus"
        link_url: "https://console-openshift-console.apps.crc-stg-01.o4v9.p1.openshiftapps.com/k8s/ns/xjoin-stage/deployments/xjoin-kafka-connect/pods"
        message: "No connectors are running for {{ $labels.cyndi_application }}"
