---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: insights-platform-mq
  labels:
    prometheus: app-sre
    role: alert-rules
spec:
  groups:
  - name: insights-platform-mq-stage
    rules:
    # MQ_MIN_LEADER_COUNT: Minimum number of Kafka leaders before triggering alert
    #    for a given strimzi_io_cluster
    #    strimzi_io_cluster's that are not given a minimum do not alert
    - record: MQ_MIN_LEADER_COUNT
      labels:
        severity: info
        service: insights
        strimzi_io_cluster: platform-mq-stage
      expr: '3'

    - alert: MQBrokerDown
      expr: |
        count(kafka_server_replicamanager_leadercount)  < on (strimzi_io_cluster) MQ_MIN_LEADER_COUNT
      labels:
        alert_team: insights_sre_alerts
        severity: info
        service: insights
      annotations:
        message: '{{ $labels.strimzi_io_cluster }} Broker Down'
        runbook: "https://gitlab.cee.redhat.com/service"
    - alert: StageMQAllBrokersDown
      expr: |
        count(kafka_server_replicamanager_leadercount{strimzi_io_cluster=~'platform-mq-stage'}) == 0
      labels:
        alert_team: insights_sre_alerts
        severity: info
        service: insights
      annotations:
        message: 'All Stage MQ Brokers Down'
        runbook: "https://gitlab.cee.redhat.com/service"
    - alert: DevMQAllBrokersDown
      expr: |
        count(kafka_server_replicamanager_leadercount{strimzi_io_cluster!~'platform-mq-stage'}) == 0
      labels:
        alert_team: insights_sre_alerts
        severity: info
        service: insights
      annotations:
        message: 'All {{ $labels.strimzi_io_cluster }} Brokers Down'
        runbook: "https://gitlab.cee.redhat.com/service"

    # MQ_MIN_VOLUME_AVAILABLE: Minimum amount of free space on Kafka topic before triggering alert
    #    for a given (namespace, persistentvolumeclaim) pair
    #    pairs not listed will not alert
    - record: MQ_MIN_VOLUME_AVAILABLE
      labels:
        namespace: platform-mq-stage
        persistentvolumeclaim: data-platform-mq-stage-kafka-0
        severity: info
        service: insights
      expr: '50000000000'
    - record: MQ_MIN_VOLUME_AVAILABLE
      labels:
        namespace: platform-mq-stage
        persistentvolumeclaim: data-platform-mq-stage-kafka-1
        severity: info
        service: insights
      expr: '50000000000'
    - record: MQ_MIN_VOLUME_AVAILABLE
      labels:
        namespace: platform-mq-stage
        persistentvolumeclaim: data-platform-mq-stage-kafka-2
        severity: info
        service: insights
      expr: '50000000000'

    - alert: MQStorageLow
      expr: |
        kubelet_volume_stats_available_bytes < on (namespace, persistentvolumeclaim) MQ_MIN_VOLUME_AVAILABLE
      labels:
        alert_team: insights_sre_alerts
        severity: info
        service: insights
        env: stage
      annotations:
        message: 'MQ Volume Storage Low {{ $labels.persistentvolumeclaim }} in {{ $labels.namespace }}'
        runbook: "https://gitlab.cee.redhat.com/service"
