---
$schema: /app-interface/prometheus-rule-test-1.yml

rule_files:
- /insights-stage/image-builder-stage/image-builder-prometheusrules.yml

evaluation_interval: 5m

tests:

# ImagebuilderNoPodsFound
- interval: 5m
  input_series:
  - series: up{namespace="image-builder-stage"}
    values: 0+0x4
  alert_rule_test:
  - eval_time: 5m
    alertname: ImageBuilderNoPodsFound
    exp_alerts:
    - exp_labels:
        severity: info
        service: insights
        env: stage
        app_team: image-builder
      exp_annotations:
        message: "No pods found in the namespace"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderNoPodsUp.rst"

- interval: 5m
  input_series:
  - series: up{namespace="image-builder-stage"}
    values: 1+1x4
  alert_rule_test:
  - eval_time: 5m
    alertname: ImageBuilderNoPodsFound
    exp_alerts: []

# ImageBuilderPodDown
- interval: 5m
  input_series:
  - series: up{namespace="image-builder-stage", pod="pod-1"}
    values: 1+1x4
  - series: up{namespace="image-builder-stage", pod="pod-2"}
    values: 0+0x4
  alert_rule_test:
  - eval_time: 5m
    alertname: ImageBuilderPodDown
    exp_alerts:
    - exp_labels:
        severity: info
        service: insights
        env: stage
        app_team: image-builder
        pod: pod-2
      exp_annotations:
        message: "Pod (pod-2) down!"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderNoPodsUp.rst"

- interval: 5m
  input_series:
  - series: up{namespace="image-builder-stage", pod="pod-1"}
    values: 1+1x4
  - series: up{namespace="image-builder-stage", pod="pod-2"}
    values: 1+1x4
  alert_rule_test:
  - eval_time: 5m
    alertname: ImageBuilderPodDown
    exp_alerts: []

# ImageBuilderInternalErrors 100% failure rate
- interval: 5m
  input_series:
  - series: image_builder_compose_errors
    values: 10+10x4
  - series: image_builder_compose_requests_total
    values: 10+10x4
  alert_rule_test:
  - eval_time: 24h
    alertname: ImageBuilderInternalErrors
    exp_alerts:
    - exp_labels:
        severity: info
        service: insights
        env: stage
        app_team: image-builder
      exp_annotations:
        message: "Less than 85% of compose requests are successful"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.rst"

# ImageBuilderInternalErrors 10% failure rate
- interval: 5m
  input_series:
  - series: image_builder_compose_errors
    values: 1+1x4
  - series: image_builder_compose_requests_total
    values: 10+10x4
  alert_rule_test:
  - eval_time: 24h
    alertname: ImageBuilderInternalErrors
    exp_alerts: []

# ImageBuilderSlowResponse: 89% <= 0.2
- interval: 5m
  input_series:
  - series: image_builder_http_duration_seconds_bucket{le="0.2",path="/api/image-builder/v1/distributions"}
    values: 0+89x5
  - series: image_builder_http_duration_seconds_bucket{le="0.4",path="/api/image-builder/v1/distributions"}
    values: 0+11x5
  - series: image_builder_http_duration_seconds_bucket{le="+inf",path="/api/image-builder/v1/distributions"}
    values: 0+100x5
  alert_rule_test:
  - eval_time: 1h
    alertname: ImageBuilderSlowResponse
    exp_alerts:
    - exp_labels:
        severity: info
        service: insights
        env: stage
        app_team: image-builder
      exp_annotations:
        message: Non-compose requests are slow
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.rst"

# ImageBuilderSlowResponse: 90% <= 0.2
- interval: 5m
  input_series:
  - series: image_builder_http_duration_seconds_bucket{le="0.2",path="/api/image-builder/v1/distributions"}
    values: 0+9x5
  - series: image_builder_http_duration_seconds_bucket{le="0.4",path="/api/image-builder/v1/distributions"}
    values: 0+1x5
  - series: image_builder_http_duration_seconds_bucket{le="+inf",path="/api/image-builder/v1/distributions"}
    values: 0+10x5
  alert_rule_test:
  - eval_time: 1h
    alertname: ImageBuilderSlowResponse
    exp_alerts: []

# TODO upstream buckets have to be adjusted
# # ImageBuilderSlowResponse: 89% <= 12
# - interval: 5m
#   input_series:
#   - series: image_builder_http_duration_seconds_bucket{le="12",path="/api/image-builder/v1/compose"}
#     values: 0+89x5
#   - series: image_builder_http_duration_seconds_bucket{le="24",path="/api/image-builder/v1/compose"}
#     values: 0+11x5
#   - series: image_builder_http_duration_seconds_bucket{le="+inf",path="/api/image-builder/v1/compose"}
#     values: 0+100x5
#   alert_rule_test:
#   - eval_time: 1h
#     alertname: ImageBuilderSlowComposeResponse
#     exp_alerts:
#     - exp_labels:
#         severity: info
#         service: insights
#         env: stage
#         app_team: image-builder
#       exp_annotations:
#         message: Compose requests are slow
#         runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.rst"

# # ImageBuilderSlowResponse: 90% <= 12
# - interval: 5m
#   input_series:
#   - series: image_builder_http_duration_seconds_bucket{le="12",path="/api/image-builder/v1/compose"}
#     values: 0+9x5
#   - series: image_builder_http_duration_seconds_bucket{le="24",path="/api/image-builder/v1/compose"}
#     values: 0+1x5
#   - series: image_builder_http_duration_seconds_bucket{le="+inf",path="/api/image-builder/v1/compose"}
#     values: 0+10x5
#   alert_rule_test:
#   - eval_time: 1h
#     alertname: ImageBuilderSlowComposeResponse
#     exp_alerts: []
