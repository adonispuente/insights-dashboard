---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: image-builder
spec:
  groups:
  - name: aws.aws-resources.rules
    interval: 5m
    rules:
      - alert: ImageBuilderStageStorageLow1Percent
        labels:
          service: image-builder
          severity: critical
          env: stage
        expr: image_builder_db_storage < 0.01
        for: 5m
        annotations:
          runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/aws/aws-rds-resources.md#rdsstoragelow"
          dashboard: "https://grafana.app-sre.devshift.net"
          message: "Database image-builder-composer-db-stage has less than 1% of free space"
      - alert: ImageBuilderStageStorageLow10Percent
        labels:
          service: image-builder
          severity: medium
          env: stage
        expr: image_builder_db_storage < 0.1
        for: 5m
        annotations:
          runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/aws/aws-rds-resources.md#rdsstoragelow"
          dashboard: "https://grafana.app-sre.devshift.net"
          message: "Database image-builder-composer-db-stage has less than 10% of free space"
      - alert: ImageBuilderStageStorageLow30Percent
        labels:
          service: image-builder
          severity: info
          env: stage
        expr: image_builder_db_storage < 0.3
        for: 5m
        annotations:
          runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/aws/aws-rds-resources.md#rdsstoragelow"
          dashboard: "https://grafana.app-sre.devshift.net"
          message: "Database image-builder-composer-db-stage has less than 30% of free space"
      - expr: |
          (
            sum(aws_rds_free_storage_space_sum{dbinstance_identifier="image-builder-composer-db-stage"} offset 10m)
            /
            sum(aws_rds_free_storage_space_sum{dbinstance_identifier="image-builder-composer-db-stage"})
          )
        labels:
          env: stage
        record: image_builder_db_storage
    
