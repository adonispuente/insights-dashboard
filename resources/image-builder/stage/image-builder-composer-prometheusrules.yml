---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: image-builder
spec:
  groups:
  - name: image-builder.openshiftio.rules
    interval: 1m
    rules:
    - alert: ComposerErrors_2PercentBurn
      annotations:
        message: "High burn rate: 2% of the period's compose error budget has been consumed"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
      expr: |
        sum(image_builder_compose_errors:burnrate5m) > (13.44 * (1-0.95))
        and
        sum(image_builder_compose_errors:burnrate1h) > (13.44 * (1-0.95))
      for: 2m
      labels:
        severity: high
        service: image-builder
        env: stage
        app_team: image-builder
    - alert: ComposerErrors_5PercentBurn
      annotations:
        message: "High burn rate: 5% of the period's compose error budget has been consumed"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
      expr: |
        sum(image_builder_compose_errors:burnrate30m) > (5.6 * (1-0.95))
        and
        sum(image_builder_compose_errors:burnrate6h) > (5.6 * (1-0.95))
      for: 15m
      labels:
        severity: high
        service: image-builder
        env: stage
        app_team: image-builder
    - alert: ComposerErrors_10PercentBurn
      annotations:
        message: "High burn rate: 10% of the period's compose error budget has been consumed"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
      expr: |
        (
          sum(image_builder_compose_errors:burnrate2h) > (2.8 * (1-0.95))
          and
          sum(image_builder_compose_errors:burnrate1d) > (2.8 * (1-0.95))
        )
        or
        (
          sum(image_builder_compose_errors:burnrate6h) > (1.00 * (1-0.95))
          and
          sum(image_builder_compose_errors:burnrate3d) > (1.00 * (1-0.95))
        )
      for: 1h
      labels:
        severity: info
        service: image-builder
        env: stage
        app_team: image-builder
    - expr: |
        1 - sum(rate(total_successful_compose_requests[1d]))
        /
        sum(rate(total_compose_requests[1d]))
      record: image_builder_compose_errors:burnrate1d
    - expr: |
        1 - sum(rate(total_successful_compose_requests[1h]))
        /
        sum(rate(total_compose_requests[1h]))
      record: image_builder_compose_errors:burnrate1h
    - expr: |
        1 - sum(rate(total_successful_compose_requests[2h]))
        /
        sum(rate(total_compose_requests[2h]))
      record: image_builder_compose_errors:burnrate2h
    - expr: |
        1 - sum(rate(total_successful_compose_requests[30m]))
        /
        sum(rate(total_compose_requests[30m]))
      record: image_builder_compose_errors:burnrate30m
    - expr: |
        1 - sum(rate(total_successful_compose_requests[3d]))
        /
        sum(rate(total_compose_requests[3d]))
      record: image_builder_compose_errors:burnrate3d
    - expr: |
        1 - sum(rate(total_successful_compose_requests[5m]))
        /
        sum(rate(total_compose_requests[5m]))
      record: image_builder_compose_errors:burnrate5m
    - expr: |
        1 - sum(rate(total_successful_compose_requests[6h]))
        /
        sum(rate(total_compose_requests[6h]))
      record: image_builder_compose_errors:burnrate6h
