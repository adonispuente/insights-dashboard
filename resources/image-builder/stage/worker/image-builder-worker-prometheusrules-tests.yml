---
$schema: /app-interface/prometheus-rule-test-1.yml

rule_files:
- /image-builder/stage/worker/image-builder-worker-prometheusrules.yml

evaluation_interval: 5m

tests:
# Worker build latency fast burn rate
- interval: 5m
  input_series:
  - series: image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type="osbuild:x86_64"}
    values: 0+4x5
  - series: image_builder_composer_worker_job_duration_seconds_count
    values: 5+10x5
  alert_rule_test:
  - eval_time: 30m
    alertname: WorkerBuildSlowResponse_FastBurn
    exp_alerts:
    - exp_labels:
        latency: "1536"
        severity: medium
        service: image-builder
        env: stage
        app_team: image-builder
      exp_annotations:
        message: 'High burn rate: 63.64% of requests are slower than 26m'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"

- interval: 5m
  input_series:
  - series: image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type="osbuild:x86_64"}
    values: 0+9.89x5
  - series: image_builder_composer_worker_job_duration_seconds_count
    values: 5+10x5
  alert_rule_test:
  - eval_time: 1h
    alertname: WorkerBuildSlowResponse_FastBurn
    exp_alerts: []

# Worker build latency slow burn rate
- interval: 5m
  input_series:
  - series: image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type="osbuild:x86_64"}
    values: 0+7x5
  - series: image_builder_composer_worker_job_duration_seconds_count
    values: 5+10x5
  alert_rule_test:
  - eval_time: 1h
    alertname: WorkerBuildSlowResponse_SlowBurn
    exp_alerts:
    - exp_labels:
        latency: "1536"
        severity: info
        service: image-builder
        env: stage
        app_team: image-builder
      exp_annotations:
        message: 'Slow burn rate: 35.83% of requests are slower than 26m'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"

- interval: 5m
  input_series:
  - series: image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type="osbuild:x86_64"}
    values: 0+9.89x5
  - series: image_builder_composer_worker_job_duration_seconds_count
    values: 5+10x5
  alert_rule_test:
  - eval_time: 1h
    alertname: WorkerBuildSlowResponse_SlowBurn
    exp_alerts: []

# Worker depsolve latency fast burn rate
- interval: 5m
  input_series:
  - series: image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}
    values: 0+4x5
  - series: image_builder_composer_worker_job_duration_seconds_count
    values: 5+10x5
  alert_rule_test:
  - eval_time: 30m
    alertname: WorkerDepsolveSlowResponse_FastBurn
    exp_alerts:
    - exp_labels:
        latency: "32"
        severity: medium
        service: image-builder
        env: stage
        app_team: image-builder
      exp_annotations:
        message: 'High burn rate: 63.64% of requests are slower than 30s'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"

- interval: 5m
  input_series:
  - series: image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}
    values: 0+9.89x5
  - series: image_builder_composer_worker_job_duration_seconds_count
    values: 5+10x5
  alert_rule_test:
  - eval_time: 1h
    alertname: WorkerDepsolveSlowResponse_FastBurn
    exp_alerts: []

# Worker depsolve latency slow burn rate
- interval: 5m
  input_series:
  - series: image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}
    values: 0+7x5
  - series: image_builder_composer_worker_job_duration_seconds_count
    values: 5+10x5
  alert_rule_test:
  - eval_time: 1h
    alertname: WorkerDepsolveSlowResponse_SlowBurn
    exp_alerts:
    - exp_labels:
        latency: "32"
        severity: info
        service: image-builder
        env: stage
        app_team: image-builder
      exp_annotations:
        message: 'Slow burn rate: 35.83% of requests are slower than 30s'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"

- interval: 5m
  input_series:
  - series: image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}
    values: 0+9.89x5
  - series: image_builder_composer_worker_job_duration_seconds_count
    values: 5+10x5
  alert_rule_test:
  - eval_time: 1h
    alertname: WorkerDepsolveSlowResponse_SlowBurn
    exp_alerts: []
