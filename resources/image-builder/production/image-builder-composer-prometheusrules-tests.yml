---
$schema: /app-interface/prometheus-rule-test-1.yml

rule_files:
- /image-builder/production/image-builder-composer-prometheusrules.yml

evaluation_interval: 5m

tests:
# 2% composer error budget consumption / 13.44 burn rate
- interval: 5m
  input_series:
  - series: total_successful_compose_requests
    values: '2+2x4'
  - series: total_compose_requests
    values: '10+10x4'
  alert_rule_test:
  - eval_time: 10m
    alertname: ComposerErrors_2PercentBurn
    exp_alerts: []
  - eval_time: 15m
    alertname: ComposerErrors_2PercentBurn
    exp_alerts:
    - exp_labels:
        severity: high
        service: image-builder
        env: prod
        app_team: image-builder
      exp_annotations:
        message: "High burn rate: 2% of the period's compose error budget has been consumed"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
  - eval_time: 30m
    alertname: ComposerErrors_2PercentBurn
    exp_alerts: []

# 5% composer error budget consumption / 5.6 burn rate
- interval: 5m
  input_series:
  - series: total_successful_compose_requests
    values: '3+3x4'
  - series: total_compose_requests
    values: '10+10x4'
  alert_rule_test:
  - eval_time: 20m
    alertname: ComposerErrors_5PercentBurn
    exp_alerts: []
  - eval_time: 25m
    alertname: ComposerErrors_5PercentBurn
    exp_alerts:
    - exp_labels:
        severity: high
        service: image-builder
        env: prod
        app_team: image-builder
      exp_annotations:
        message: "High burn rate: 5% of the period's compose error budget has been consumed"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
  - eval_time: 1h20m
    alertname: ComposerErrors_5PercentBurn
    exp_alerts: []

# 10% composer error budget consumption / 3 or 1 burn rate
- interval: 5m
  input_series:
  - series: total_successful_compose_requests
    values: '3+3x4'
  - series: total_compose_requests
    values: '10+10x4'
  alert_rule_test:
  - eval_time: 1h5m
    alertname: ComposerErrors_10PercentBurn
    exp_alerts: []
  - eval_time: 1h10m
    alertname: ComposerErrors_10PercentBurn
    exp_alerts:
    - exp_labels:
        severity: info
        service: image-builder
        env: prod
        app_team: image-builder
      exp_annotations:
        message: "High burn rate: 10% of the period's compose error budget has been consumed"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
  - eval_time: 6h50m
    alertname: ComposerErrors_10PercentBurn
    exp_alerts: []
