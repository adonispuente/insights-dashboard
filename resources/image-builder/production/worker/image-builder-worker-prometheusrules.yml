---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: image-builder-worker
spec:
  groups:
  - name: image-builder.openshiftio.rules
    interval: 1m
    rules:
    # see https://osbuild.pages.redhat.com/internal-guides/image-builder-service/metrics/alerts.html
    # for a more detailed explanation and breakdown of the burn rate alerts
    - alert: WorkerBuildSlowResponse_FastBurn
      annotations:
        message: 'High burn rate: {{ $value | humanizePercentage }} of requests are slower than 26m'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"
      expr: |
        (
          image_builder_worker_build:latency_rate1h{latency="1536"} > (6.72*(1 - 0.95))
          and
          image_builder_worker_build:latency_rate5m{latency="1536"} > (6.72*(1 - 0.95))
        ) 
        or
        (
          image_builder_worker_build:latency_rate6h{latency="1536"} > (5.6*(1 - 0.95))
          and
          image_builder_worker_build:latency_rate30m{latency="1536"} > (5.6*(1 - 0.95))
        )
      labels:
        latency: "1536"
        severity: medium
        service: image-builder
        env:  prod
        app_team: image-builder
    - alert: WorkerBuildSlowResponse_SlowBurn
      annotations:
        message: 'Slow burn rate: {{ $value | humanizePercentage }} of requests are slower than 26m'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"
      expr: |
        (
          image_builder_worker_build:latency_rate1d{latency="1536"} > (2.8*(1 - 0.95))
          and
          image_builder_worker_build:latency_rate2h{latency="1536"} > (2.8*(1 - 0.95))
        )
        or
        (
          image_builder_worker_build:latency_rate3d{latency="1536"} > (2.8*(1 - 0.95))
          and
          image_builder_worker_build:latency_rate6h{latency="1536"} > (2.8*(1 - 0.95))
        )
      labels:
        latency: "1536"
        severity: info
        service: image-builder
        env:  prod
        app_team: image-builder
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type=~"osbuild:.*"}[5m]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type=~"osbuild:.*"}[5m]))
        )
      labels:
        latency: "1536"
      record: image_builder_worker_build:latency_rate5m
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type=~"osbuild:.*"}[30m]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type=~"osbuild:.*"}[30m]))
        )
      labels:
        latency: "1536"
      record: image_builder_worker_build:latency_rate30m
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type=~"osbuild:.*"}[1h]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type=~"osbuild:.*"}[1h]))
        )
      labels:
        latency: "1536"
      record: image_builder_worker_build:latency_rate1h
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type=~"osbuild:.*"}[2h]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type=~"osbuild:.*"}[2h]))
        )
      labels:
        latency: "1536"
      record: image_builder_worker_build:latency_rate2h
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type=~"osbuild:.*"}[6h]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type=~"osbuild:.*"}[6h]))
        )
      labels:
        latency: "1536"
      record: image_builder_worker_build:latency_rate6h
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type=~"osbuild:.*"}[1d]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type=~"osbuild:.*"}[1d]))
        )
      labels:
        latency: "1536"
      record: image_builder_worker_build:latency_rate1d
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="1536", type=~"osbuild:.*"}[3d]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type=~"osbuild:.*"}[3d]))
        )
      labels:
        latency: "1536"
      record: image_builder_worker_build:latency_rate3d
    # see https://osbuild.pages.redhat.com/internal-guides/image-builder-service/metrics/alerts.html
    # for a more detailed explanation and breakdown of the burn rate alerts
    - alert: WorkerDepsolveSlowResponse_FastBurn
      annotations:
        message: 'High burn rate: {{ $value | humanizePercentage }} of requests are slower than 30s'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"
      expr: |
        (
          image_builder_worker_depsolve:latency_rate1h{latency="32"} > (6.72*(1 - 0.95))
          and
          image_builder_worker_depsolve:latency_rate5m{latency="32"} > (6.72*(1 - 0.95))
        ) 
        or
        (
          image_builder_worker_depsolve:latency_rate6h{latency="32"} > (5.6*(1 - 0.95))
          and
          image_builder_worker_depsolve:latency_rate30m{latency="32"} > (5.6*(1 - 0.95))
        )
      labels:
        latency: "32"
        severity: medium
        service: image-builder
        env:  prod
        app_team: image-builder
    - alert: WorkerDepsolveSlowResponse_SlowBurn
      annotations:
        message: 'Slow burn rate: {{ $value | humanizePercentage }} of requests are slower than 30s'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"
      expr: |
        (
          image_builder_worker_depsolve:latency_rate1d{latency="32"} > (2.8*(1 - 0.95))
          and
          image_builder_worker_depsolve:latency_rate2h{latency="32"} > (2.8*(1 - 0.95))
        )
        or
        (
          image_builder_worker_depsolve:latency_rate3d{latency="32"} > (2.8*(1 - 0.95))
          and
          image_builder_worker_depsolve:latency_rate6h{latency="32"} > (2.8*(1 - 0.95))
        )
      labels:
        latency: "32"
        severity: info
        service: image-builder
        env:  prod
        app_team: image-builder
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}[5m]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count[5m]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate5m
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}[30m]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type="depsolve"}[30m]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate30m
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}[1h]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type="depsolve"}[1h]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate1h
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}[2h]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type="depsolve"}[2h]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate2h
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}[6h]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type="depsolve"}[6h]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate6h
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}[1d]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type="depsolve"}[1d]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate1d
    - expr: |
        1 - (
          sum(rate(image_builder_composer_worker_job_duration_seconds_bucket{le="32", type="depsolve"}[3d]))
          /
          sum(rate(image_builder_composer_worker_job_duration_seconds_count{type="depsolve"}[3d]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate3d
