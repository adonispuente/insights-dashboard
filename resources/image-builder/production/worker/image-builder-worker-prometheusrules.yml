---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: image-builder-worker
spec:
  groups:
  - name: image-builder.openshiftio.rules
    interval: 1m
    rules:
    # see https://osbuild.pages.redhat.com/internal-guides/image-builder-service/metrics/alerts.html
    # for a more detailed explanation and breakdown of the burn rate alerts
    - alert: WorkerBuildSlowResponse_FastBurn
      annotations:
        message: 'High burn rate: {{ $value | humanizePercentage }} of jobs are slower than 30m'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"
      expr: |
        (
          image_builder_worker_build:latency_rate1h{latency="1792"} > (6.72*(1 - 0.95))
          and
          image_builder_worker_build:latency_rate5m{latency="1792"} > (6.72*(1 - 0.95))
        ) 
        or
        (
          image_builder_worker_build:latency_rate6h{latency="1792"} > (5.6*(1 - 0.95))
          and
          image_builder_worker_build:latency_rate30m{latency="1792"} > (5.6*(1 - 0.95))
        )
      labels:
        latency: "1792"
        severity: medium
        service: image-builder
        env: prod
    - alert: WorkerBuildSlowResponse_SlowBurn
      annotations:
        message: 'Slow burn rate: {{ $value | humanizePercentage }} of jobs are slower than 30m'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"
      expr: |
        (
          image_builder_worker_build:latency_rate1d{latency="1792"} > (2.8*(1 - 0.95))
          and
          image_builder_worker_build:latency_rate2h{latency="1792"} > (2.8*(1 - 0.95))
        )
        or
        (
          image_builder_worker_build:latency_rate3d{latency="1792"} > (2.8*(1 - 0.95))
          and
          image_builder_worker_build:latency_rate6h{latency="1792"} > (2.8*(1 - 0.95))
        )
      labels:
        latency: "1792"
        severity: info
        service: image-builder
        env: prod
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="1792", type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[5m]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[5m]))
        )
      labels:
        latency: "1792"
      record: image_builder_worker_build:latency_rate5m
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="1792", type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[30m]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[30m]))
        )
      labels:
        latency: "1792"
      record: image_builder_worker_build:latency_rate30m
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="1792", type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[1h]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[1h]))
        )
      labels:
        latency: "1792"
      record: image_builder_worker_build:latency_rate1h
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="1792", type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[2h]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[2h]))
        )
      labels:
        latency: "1792"
      record: image_builder_worker_build:latency_rate2h
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="1792", type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[6h]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[6h]))
        )
      labels:
        latency: "1792"
      record: image_builder_worker_build:latency_rate6h
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="1792", type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[1d]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[1d]))
        )
      labels:
        latency: "1792"
      record: image_builder_worker_build:latency_rate1d
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="1792", type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[3d]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type=~"osbuild.*", status!="4xx", tenant="org-15885990"}[3d]))
        )
      labels:
        latency: "1792"
      record: image_builder_worker_build:latency_rate3d
    # see https://osbuild.pages.redhat.com/internal-guides/image-builder-service/metrics/alerts.html
    # for a more detailed explanation and breakdown of the burn rate alerts
    - alert: WorkerDepsolveSlowResponse_FastBurn
      annotations:
        message: 'High burn rate: {{ $value | humanizePercentage }} of jobs are slower than 30s'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"
      expr: |
        (
          image_builder_worker_depsolve:latency_rate1h{latency="32"} > (6.72*(1 - 0.9))
          and
          image_builder_worker_depsolve:latency_rate5m{latency="32"} > (6.72*(1 - 0.9))
        ) 
        or
        (
          image_builder_worker_depsolve:latency_rate6h{latency="32"} > (5.6*(1 - 0.9))
          and
          image_builder_worker_depsolve:latency_rate30m{latency="32"} > (5.6*(1 - 0.9))
        )
      labels:
        latency: "32"
        severity: medium
        service: image-builder
        env: prod
    - alert: WorkerDepsolveSlowResponse_SlowBurn
      annotations:
        message: 'Slow burn rate: {{ $value | humanizePercentage }} of jobs are slower than 30s'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderHighLatency.md"
      expr: |
        (
          image_builder_worker_depsolve:latency_rate1d{latency="32"} > (2.8*(1 - 0.9))
          and
          image_builder_worker_depsolve:latency_rate2h{latency="32"} > (2.8*(1 - 0.9))
        )
        or
        (
          image_builder_worker_depsolve:latency_rate3d{latency="32"} > (2.8*(1 - 0.9))
          and
          image_builder_worker_depsolve:latency_rate6h{latency="32"} > (2.8*(1 - 0.9))
        )
      labels:
        latency: "32"
        severity: info
        service: image-builder
        env: prod
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="32", type="depsolve", status!="4xx", tenant="org-15885990"}[5m]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type="depsolve", status!="4xx", tenant="org-15885990"}[5m]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate5m
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="32", type="depsolve", status!="4xx", tenant="org-15885990"}[30m]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type="depsolve", status!="4xx", tenant="org-15885990"}[30m]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate30m
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="32", type="depsolve", status!="4xx", tenant="org-15885990"}[1h]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type="depsolve", status!="4xx", tenant="org-15885990"}[1h]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate1h
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="32", type="depsolve", status!="4xx", tenant="org-15885990"}[2h]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type="depsolve", status!="4xx", tenant="org-15885990"}[2h]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate2h
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="32", type="depsolve", status!="4xx", tenant="org-15885990"}[6h]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type="depsolve", status!="4xx", tenant="org-15885990"}[6h]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate6h
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="32", type="depsolve", status!="4xx", tenant="org-15885990"}[1d]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type="depsolve", status!="4xx", tenant="org-15885990"}[1d]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate1d
    - expr: |
        1 - (
          sum(rate(image_builder_worker_job_duration_seconds_bucket{le="32", type="depsolve", status!="4xx", tenant="org-15885990"}[3d]))
          /
          sum(rate(image_builder_worker_job_duration_seconds_count{type="depsolve", status!="4xx", tenant="org-15885990"}[3d]))
        )
      labels:
        latency: "32"
      record: image_builder_worker_depsolve:latency_rate3d
    - alert: WorkerDepsolveErrors_FastBurn
      annotations:
        message: "High burn rate: {{ $value | humanizePercentage }} of depsolve jobs are failing"
        description: "{{ $value | humanizePercentage }} of depsolve jobs have failed over the past hour"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/WorkerBuildErrors.md"
      expr: |
        (
          sum(image_builder_worker_failed_depsolve_jobs:burnrate5m) > (13.44 * (1-0.95))
          and
          sum(image_builder_worker_failed_depsolve_jobs:burnrate1h) > (13.44 * (1-0.95))
        )
        or
        (
          sum(image_builder_worker_failed_depsolve_jobs:burnrate30m) > (5.6 * (1-0.95))
          and
          sum(image_builder_worker_failed_depsolve_jobs:burnrate6h) > (5.6 * (1-0.95))
        )
      for: 2m
      labels:
        severity: medium
        service: image-builder
        env: prod
    - alert: WorkerDepsolveErrors_SlowBurn
      annotations:
        message: "Slow burn rate: {{ $value | humanizePercentage }} of depsolve jobs are failing"
        description: "{{ $value | humanizePercentage }} of depsolve jobs have failed over the past day"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/WorkerBuildErrors.md"
      expr: |
        (
          sum(image_builder_worker_failed_depsolve_jobs:burnrate2h) > (2.8 * (1-0.95))
          and
          sum(image_builder_worker_failed_depsolve_jobs:burnrate1d) > (2.8 * (1-0.95))
        )
        or
        (
          sum(image_builder_worker_failed_depsolve_jobs:burnrate6h) > (1.00 * (1-0.95))
          and
          sum(image_builder_worker_failed_depsolve_jobs:burnrate3d) > (1.00 * (1-0.95))
        )
      for: 1h
      labels:
        severity: medium
        service: image-builder
        env: prod
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type="depsolve", status="5xx", tenant="org-15885990"}[1d]))
        /
        sum(rate(image_builder_worker_total_jobs{type="depsolve", tenant="org-15885990"}[1d]))
      record: image_builder_worker_failed_depsolve_jobs:burnrate1d
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type="depsolve", status="5xx", tenant="org-15885990"}[1h]))
        /
        sum(rate(image_builder_worker_total_jobs{type="depsolve", tenant="org-15885990"}[1h]))
      record: image_builder_worker_failed_depsolve_jobs:burnrate1h
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type="depsolve", status="5xx", tenant="org-15885990"}[2h]))
        /
        sum(rate(image_builder_worker_total_jobs{type="depsolve", tenant="org-15885990"}[2h]))
      record: image_builder_worker_failed_depsolve_jobs:burnrate2h
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type="depsolve", status="5xx", tenant="org-15885990"}[30m]))
        /
        sum(rate(image_builder_worker_total_jobs{type="depsolve", tenant="org-15885990"}[30m]))
      record: image_builder_worker_failed_depsolve_jobs:burnrate30m
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type="depsolve", status="5xx", tenant="org-15885990"}[3d]))
        /
        sum(rate(image_builder_worker_total_jobs{type="depsolve", tenant="org-15885990"}[3d]))
      record: image_builder_worker_failed_depsolve_jobs:burnrate3d
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type="depsolve", status="5xx", tenant="org-15885990"}[5m]))
        /
        sum(rate(image_builder_worker_total_jobs{type="depsolve", tenant="org-15885990"}[5m]))
      record: image_builder_worker_failed_depsolve_jobs:burnrate5m
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type="depsolve", status="5xx", tenant="org-15885990"}[6h]))
        /
        sum(rate(image_builder_worker_total_jobs{type="depsolve", tenant="org-15885990"}[6h]))
      record: image_builder_worker_failed_depsolve_jobs:burnrate6h
    - alert: WorkerBuildErrors_FastBurn
      annotations:
        message: "High burn rate: {{ $value | humanizePercentage }} of build jobs are failing"
        description: "{{ $value | humanizePercentage }} of build jobs have failed over the past hour"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/WorkerBuildErrors.md"
      expr: |
        (
          sum(image_builder_worker_failed_build_jobs:burnrate5m) > (13.44 * (1-0.95))
          and
          sum(image_builder_worker_failed_build_jobs:burnrate1h) > (13.44 * (1-0.95))
        )
        or
        (
          sum(image_builder_worker_failed_build_jobs:burnrate30m) > (5.6 * (1-0.95))
          and
          sum(image_builder_worker_failed_build_jobs:burnrate6h) > (5.6 * (1-0.95))
        )
      for: 2m
      labels:
        severity: medium
        service: image-builder
        env: prod
    - alert: WorkerBuildErrors_SlowBurn
      annotations:
        message: "Slow burn rate: {{ $value | humanizePercentage }} of build jobs are failing"
        description: "{{ $value | humanizePercentage }} of build jobs have failed over the past day"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/WorkerBuildErrors.md"
      expr: |
        (
          sum(image_builder_worker_failed_build_jobs:burnrate2h) > (2.8 * (1-0.95))
          and
          sum(image_builder_worker_failed_build_jobs:burnrate1d) > (2.8 * (1-0.95))
        )
        or
        (
          sum(image_builder_worker_failed_build_jobs:burnrate6h) > (1.00 * (1-0.95))
          and
          sum(image_builder_worker_failed_build_jobs:burnrate3d) > (1.00 * (1-0.95))
        )
      for: 1h
      labels:
        severity: medium
        service: image-builder
        env: prod
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", status="5xx", tenant="org-15885990"}[1d]))
        /
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", tenant="org-15885990"}[1d]))
      record: image_builder_worker_failed_build_jobs:burnrate1d
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", status="5xx", tenant="org-15885990"}[1h]))
        /
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", tenant="org-15885990"}[1h]))
      record: image_builder_worker_failed_build_jobs:burnrate1h
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", status="5xx", tenant="org-15885990"}[2h]))
        /
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", tenant="org-15885990"}[2h]))
      record: image_builder_worker_failed_build_jobs:burnrate2h
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", status="5xx", tenant="org-15885990"}[30m]))
        /
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", tenant="org-15885990"}[30m]))
      record: image_builder_worker_failed_build_jobs:burnrate30m
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", status="5xx", tenant="org-15885990"}[3d]))
        /
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", tenant="org-15885990"}[3d]))
      record: image_builder_worker_failed_build_jobs:burnrate3d
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", status="5xx", tenant="org-15885990"}[5m]))
        /
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", tenant="org-15885990"}[5m]))
      record: image_builder_worker_failed_build_jobs:burnrate5m
    - expr: |
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", status="5xx", tenant="org-15885990"}[6h]))
        /
        sum(rate(image_builder_worker_total_jobs{type=~"osbuild.*", tenant="org-15885990"}[6h]))
      record: image_builder_worker_failed_build_jobs:burnrate6h
    - alert: WorkerRequestErrors_2PercentBurn
      annotations:
        message: "High burn rate: {{ $value | humanizePercentage }} of worker requests are failing"
        description: "{{ $value | humanizePercentage }} of worker requests have failed over the past hour"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
      expr: |
        sum(image_builder_worker_total_failed_requests:burnrate5m) > (13.44 * (1-0.95))
        and
        sum(image_builder_worker_total_failed_requests:burnrate1h) > (13.44 * (1-0.95))
      for: 2m
      labels:
        severity: medium # will monitor for 7d and then update
        service: image-builder
        env: prod
    - alert: WorkerRequestErrors_5PercentBurn
      annotations:
        message: "High burn rate: {{ $value | humanizePercentage }} of worker requests are failing"
        description: "{{ $value | humanizePercentage }} of worker requests have failed over the past 6 hours"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
      expr: |
        sum(image_builder_worker_total_failed_requests:burnrate30m) > (5.6 * (1-0.95))
        and
        sum(image_builder_worker_total_failed_requests:burnrate6h) > (5.6 * (1-0.95))
      for: 15m
      labels:
        severity: medium # will monitor for 7d and then update
        service: image-builder
        env: prod
    - alert: WorkerRequestErrors_10PercentBurn
      annotations:
        message: "High burn rate: {{ $value | humanizePercentage }} of worker requests are failing"
        description: "{{ $value | humanizePercentage }} of worker requests have failed over the past day"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/console.redhat.com/app-sops/image-builder/ImageBuilderInternalErrors.md"
      expr: |
        (
          sum(image_builder_worker_total_failed_requests:burnrate2h) > (2.8 * (1-0.95))
          and
          sum(image_builder_worker_total_failed_requests:burnrate1d) > (2.8 * (1-0.95))
        )
        or
        (
          sum(image_builder_worker_total_failed_requests:burnrate6h) > (1.00 * (1-0.95))
          and
          sum(image_builder_worker_total_failed_requests:burnrate3d) > (1.00 * (1-0.95))
        )
      for: 1h
      labels:
        severity: info
        service: image-builder
        env: prod
    - expr: |
        sum(rate(image_builder_worker_request_count{code=~"5.*", subsystem="worker"}[1d]))
        /
        sum(rate(image_builder_worker_request_count{subsystem="worker"}[1d]))
      record: image_builder_worker_total_failed_requests:burnrate1d
    - expr: |
        sum(rate(image_builder_worker_request_count{code=~"5.*", subsystem="worker"}[1h]))
        /
        sum(rate(image_builder_worker_request_count{subsystem="worker"}[1h]))
      record: image_builder_worker_total_failed_requests:burnrate1h
    - expr: |
        sum(rate(image_builder_worker_request_count{code=~"5.*", subsystem="worker"}[2h]))
        /
        sum(rate(image_builder_worker_request_count{subsystem="worker"}[2h]))
      record: image_builder_worker_total_failed_requests:burnrate2h
    - expr: |
        sum(rate(image_builder_worker_request_count{code=~"5.*", subsystem="worker"}[30m]))
        /
        sum(rate(image_builder_worker_request_count{subsystem="worker"}[30m]))
      record: image_builder_worker_total_failed_requests:burnrate30m
    - expr: |
        sum(rate(image_builder_worker_request_count{code=~"5.*", subsystem="worker"}[3d]))
        /
        sum(rate(image_builder_worker_request_count{subsystem="worker"}[3d]))
      record: image_builder_worker_total_failed_requests:burnrate3d
    - expr: |
        sum(rate(image_builder_worker_request_count{code=~"5.*", subsystem="worker"}[5m]))
        /
        sum(rate(image_builder_worker_request_count{subsystem="worker"}[5m]))
      record: image_builder_worker_total_failed_requests:burnrate5m
    - expr: |
        sum(rate(image_builder_worker_request_count{code=~"5.*", subsystem="worker"}[6h]))
        /
        sum(rate(image_builder_worker_request_count{subsystem="worker"}[6h]))
      record: image_builder_worker_total_failed_requests:burnrate6h
  # record some expressions for the dashboards
  # specifically for burn rates and 28day windows
  - name: image-builder.openshiftio.expressions
    interval: 1m
    rules:
      # worker
      # record the targets first
      ## build success
      - record: image_builder_worker:build_success:slo_target
        expr: "0.95"
      - record: image_builder_worker:build_success:error_budget
        expr: "1 - image_builder_worker:build_success:slo_target"
      ## build duration
      - record: image_builder_worker:build_duration:slo_target
        expr: "0.95"
      - record: image_builder_worker:build_duration:error_budget
        expr: "1 - image_builder_worker:build_duration:slo_target"
      ## depsolve success
      - record: image_builder_worker:depsolve_success:slo_target
        expr: "0.95"
      - record: image_builder_worker:depsolve_success:error_budget
        expr: "1 - image_builder_worker:depsolve_success:slo_target"
      ## depsolve duration
      - record: image_builder_worker:depsolve_duration:slo_target
        expr: "0.95"
      - record: image_builder_worker:depsolve_duration:error_budget
        expr: "1 - image_builder_worker:depsolve_duration:slo_target"
      # record expressions
      ## build error rate & error budget
      - record: image_builder_worker:build_success:error_rate28d
        labels:
          env: "prod"
        expr: |
          (
            sum by (arch, tenant) (increase(image_builder_worker_total_jobs{type=~"osbuild.*", status="5xx"}[28d]))
            /
            sum by (arch, tenant) (increase(image_builder_worker_total_jobs{type=~"osbuild.*", status!="4xx"}[28d])) 
          ) OR on() vector(0) # set fallback value (no data means 0% error rate)
      - record: image_builder_worker:build_success:success_rate28d
        labels:
          env: "prod"
        expr: "1 - image_builder_worker:build_success:error_rate28d"
      - record: image_builder_worker:build_success:budget_consumed28d
        labels:
          env: "prod"
        expr: |
          # error rate / error budget
          image_builder_worker:build_success:error_rate28d
          / 
          ignoring (arch, env, tenant) group_left image_builder_worker:build_success:error_budget
      - record: image_builder_worker:build_success:budget_remaining28d
        labels:
          env: "prod"
        expr: |
          # 28 days * 24 hours * (error_budget - error_rate)
          28 * 24 * (
            - image_builder_worker:build_success:error_rate28d
            + ignoring (arch, env, tenant) group_left image_builder_worker:build_success:error_budget  
          )
      ## build duration & error budget
      - record: image_builder_worker:build_duration:error_rate28d
        labels:
          env: "prod"
        expr: |
          1 - (
            sum by (arch, tenant) (increase(image_builder_worker_job_duration_seconds_bucket{le="1792",type="osbuild"}[28d]))
            /
            sum by (arch, tenant) (increase(image_builder_worker_job_duration_seconds_count{type="osbuild"}[28d])) 
          ) OR on() vector(1)
      - record: image_builder_worker:build_duration:success_rate28d
        labels:
          env: "prod"
        expr: "1 - image_builder_worker:build_duration:error_rate28d"
      - record: image_builder_worker:build_duration:budget_consumed28d
        labels:
          env: "prod"
        expr: |
          # error rate / error budget
          image_builder_worker:build_duration:error_rate28d
          / 
          ignoring (arch, env, tenant) group_left image_builder_worker:build_duration:error_budget
      - record: image_builder_worker:build_duration:budget_remaining28d
        labels:
          env: "prod"
        expr: |
          # 28 days * 24 hours * (error_budget - error_rate)
          28 * 24 * (
            - image_builder_worker:build_duration:error_rate28d
            + ignoring (arch, env, tenant) group_left image_builder_worker:build_duration:error_budget  
          )
      ## depsolve error rate & error budget
      - record: image_builder_worker:depsolve_success:error_rate28d
        labels:
          env: "prod"
        expr: |
          (
            sum by (tenant) (increase(image_builder_worker_total_jobs{type="depsolve", status="5xx"}[28d]))
            /
            sum by (tenant) (increase(image_builder_worker_total_jobs{type="depsolve", status!="4xx"}[28d]))
          ) OR on() vector(0) # set fallback value (no data means 0% error rate)
      - record: image_builder_worker:depsolve_success:success_rate28d
        labels:
          env: "prod"
        expr: "1 - image_builder_worker:depsolve_success:error_rate28d"
      - record: image_builder_worker:depsolve_success:budget_consumed28d
        labels:
          env: "prod"
        expr: |
          # error rate / error budget
          image_builder_worker:depsolve_success:error_rate28d
          / 
          ignoring (env, tenant) group_left image_builder_worker:depsolve_success:error_budget
      - record: image_builder_worker:depsolve_success:budget_remaining28d
        labels:
          env: "prod"
        expr: |
          # 28 days * 24 hours * (error_budget - error_rate)
          28 * 24 * (
            - image_builder_worker:depsolve_success:error_rate28d
            + ignoring (env, tenant) group_left image_builder_worker:depsolve_success:error_budget  
          )
      ## depsolve duration & error budget
      - record: image_builder_worker:depsolve_duration:error_rate28d
        labels:
          env: "prod"
        expr: |
          1 - (
            sum by (tenant) (increase(image_builder_worker_job_duration_seconds_bucket{le="32",type="depsolve"}[28d]))
            /
            sum by (tenant) (increase(image_builder_worker_job_duration_seconds_count{type="depsolve"}[28d])) 
          ) OR on() vector(1)
      - record: image_builder_worker:depsolve_duration:success_rate28d
        labels:
          env: "prod"
        expr: "1 - image_builder_worker:depsolve_duration:error_rate28d"
      - record: image_builder_worker:depsolve_duration:budget_consumed28d
        labels:
          env: "prod"
        expr: |
          # error rate / error budget
          image_builder_worker:depsolve_duration:error_rate28d
          / 
          ignoring (env, tenant) group_left image_builder_worker:depsolve_duration:error_budget
      - record: image_builder_worker:depsolve_duration:budget_remaining28d
        labels:
          env: "prod"
        expr: |
          # 28 days * 24 hours * (error_budget - error_rate)
          28 * 24 * (
            - image_builder_worker:depsolve_duration:error_rate28d
            + ignoring (env, tenant) group_left image_builder_worker:depsolve_duration:error_budget  
          )
