$schema: /app-interface/prometheus-rule-test-1.yml
evaluation_interval: 1m

rule_files:
  - /stonesoup/argocd-control-plane/monitoring/alerting-rules.yml.j2

tests:
  # DegradedArgocdApp alert
  - interval: 1m
    input_series:

      # no app is degraded - shouldn't trigger alerts
      - series: 'argocd_app_info{health_status="Degraded", name="not-degraded-app", dest_namespace="not-degraded", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: _x9

      # an app is constantly degraded - should trigger alerts
      - series: 'argocd_app_info{health_status="Degraded", name="degraded-app", dest_namespace="degraded", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1x9

      # an app with some 1m degraded status - shouldn't trigger alerts
      - series: 'argocd_app_info{health_status="Degraded", name="degraded-1m-app", dest_namespace="degraded-1m", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1 _ _ _ 1 _ _ _ _ _

      # an app with a 4m degraded status - shouldn't trigger alerts
      - series: 'argocd_app_info{health_status="Degraded", name="degraded-4m-app", dest_namespace="degraded-4m", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: _ 1 1 1 1 _ _ _ _ _

      # an app is flapping every 1m - should trigger alerts triggers
      - series: 'argocd_app_info{health_status="Degraded", name="flapping-1m-app", dest_namespace="flapping-1m", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1 _ 1 _ 1 _ 1 _ 1 _

      # an app is flapping every 2m - should trigger alerts triggers
      - series: 'argocd_app_info{health_status="Degraded", name="flapping-2m-app", dest_namespace="flapping-2m", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1 _ _ 1 _ _ 1 _ _ 1

      # an app is in another health status which is not 'Degraded' - the rule shouldn't alert.
      - series: 'argocd_app_info{health_status="Progressing", name="progressing-app", dest_namespace="nothing-wrong", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1x9

    alert_rule_test:
      - eval_time: 5m
        alertname: DegradedArgocdApp
        exp_alerts:
          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: degraded
              health_status: Degraded
              name: degraded-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |
                Environment: {{{ env }}}
                Application: degraded-app
                Cluster: https://api.foo.openshiftapps.com:6443
                Health status Degraded.

          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: flapping-1m
              health_status: Degraded
              name: flapping-1m-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |
                Environment: {{{ env }}}
                Application: flapping-1m-app
                Cluster: https://api.foo.openshiftapps.com:6443
                Health status Degraded.

          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: flapping-2m
              health_status: Degraded
              name: flapping-2m-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |
                Environment: {{{ env }}}
                Application: flapping-2m-app
                Cluster: https://api.foo.openshiftapps.com:6443
                Health status Degraded.

  # ProgressingArgocdApp alert
  - interval: 1m
    input_series:
      # app was progessing and then Healthy for the last 5 min, should not alert
      - series: 'argocd_app_info{health_status="Progressing", name="Progressing-Healthy-5min-app", dest_namespace="Progressing-Healthy-5min", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1x14 _x4
      - series: 'argocd_app_info{health_status="Healthy", name="Progressing-Healthy-5min-app", dest_namespace="Progressing-Healthy-5min", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: _x14 1x4

  - interval: 1m
    input_series:
      # app is always progressing, should alert
      - series: 'argocd_app_info{health_status="Progressing", name="progressing-only-app", dest_namespace="Still-Progressing", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1x19
    alert_rule_test:
      - eval_time: 20m
        alertname: ProgressingArgocdApp
        exp_alerts:
          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: Still-Progressing
              health_status: Progressing
              name: progressing-only-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |
                Environment: {{{ env }}}
                Application: progressing-only-app
                Cluster: https://api.foo.openshiftapps.com:6443
                App progressing for too long.

  - interval: 1m
    input_series:
      # app was progessing and then Healthy for the last 3 min, should alert
      - series: 'argocd_app_info{health_status="Progressing", name="progressing-healthy-3min-app", dest_namespace="Progressing-Healthy-3min", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1x16 _ _ _
    alert_rule_test:
      - eval_time: 20m
        alertname: ProgressingArgocdApp
        exp_alerts:
          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: Progressing-Healthy-3min
              health_status: Progressing
              name: progressing-healthy-3min-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |
                Environment: {{{ env }}}
                Application: progressing-healthy-3min-app
                Cluster: https://api.foo.openshiftapps.com:6443
                App progressing for too long.

  - interval: 1m
    input_series:
      # the app is switching health states (flapping), alert should be triggered
      - series: 'argocd_app_info{health_status="Progressing", name="flapping-should-alert-app", dest_namespace="Flapping-Should-Alert", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: '_ 1 _ 1 1 _ 1 1 1 _ _ _ _ 1 _ 1 1 1 1 _'
    alert_rule_test:
      - eval_time: 20m
        alertname: ProgressingArgocdApp
        exp_alerts:
          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: Flapping-Should-Alert
              health_status: Progressing
              name: flapping-should-alert-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |
                Environment: {{{ env }}}
                Application: flapping-should-alert-app
                Cluster: https://api.foo.openshiftapps.com:6443
                App progressing for too long.

  - interval: 1m
    input_series:
      # app 1: Progressing all of the time, should alert
      - series: 'argocd_app_info{health_status="Progressing", name="Progressing_first-app", dest_namespace="Progressing_first", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1x19
      - series: 'argocd_app_info{health_status="Healthy", name="Progressing_first-app", dest_namespace="Progressing_first", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: _x19
      # app 2: Progressing for 17 minutes and then healthy for 3 minutes, should alert
      - series: 'argocd_app_info{health_status="Progressing", name="Progressing_second-app", dest_namespace="Progressing_second", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1x16 _ _ _
      - series: 'argocd_app_info{health_status="Healthy", name="Progressing_second-app", dest_namespace="Progressing_second", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: _x16 1 1 1
    alert_rule_test:
      - eval_time: 20m
        alertname: ProgressingArgocdApp
        exp_alerts:
          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: Progressing_first
              health_status: Progressing
              name: Progressing_first-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |
                Environment: {{{ env }}}
                Application: Progressing_first-app
                Cluster: https://api.foo.openshiftapps.com:6443
                App progressing for too long.

          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: Progressing_second
              health_status: Progressing
              name: Progressing_second-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |
                Environment: {{{ env }}}
                Application: Progressing_second-app
                Cluster: https://api.foo.openshiftapps.com:6443
                App progressing for too long.

