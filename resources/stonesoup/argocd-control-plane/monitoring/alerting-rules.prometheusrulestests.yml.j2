$schema: /app-interface/prometheus-rule-test-1.yml
evaluation_interval: 1m

rule_files:
  - /stonesoup/argocd-control-plane/monitoring/alerting-rules.yml.j2

tests:
  - interval: 1m
    input_series:

      # no argocd app is degraded
      - series: 'argocd_app_info{health_status="Degraded", name="first-test-app", dest_namespace="not-degraded", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: '0x15'

      # argocd has a degraded app
      - series: 'argocd_app_info{health_status="Degraded", name="second-test-app", dest_namespace="has-degraded", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: '1x15'

      # an app is flapping and alerts triggers
      - series: 'argocd_app_info{health_status="Degraded", name="third-test-app", dest_namespace="is-flapping", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1 _ 1 _ 1 _ 1 _ 1 _ 1 _ 1 _

      # an app is in another health status which is not 'Degraded' - the rule shouldn't alert.
      - series: 'argocd_app_info{health_status="Progressing", name="fourth-test-app", dest_namespace="nothing-wrong", dest_server="https://api.foo.openshiftapps.com:6443"}'
        values: 1x15

    promql_expr_test:
      - expr: |
          max_over_time(argocd_app_info{health_status="Degraded"}[5m]) == 1
        eval_time: 5m
        exp_samples:
          - labels: '{health_status="Degraded", name="second-test-app", dest_namespace="has-degraded", dest_server="https://api.foo.openshiftapps.com:6443"}'
            value: 1
          - labels: '{health_status="Degraded", name="third-test-app", dest_namespace="is-flapping", dest_server="https://api.foo.openshiftapps.com:6443"}'
            value: 1
    alert_rule_test:
      - eval_time: 5m
        alertname: DegradedArgocdApp
        exp_alerts:
          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: has-degraded
              health_status: Degraded
              name: second-test-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |-
                Environment: {{{ env }}}
                Application: second-test-app
                Cluster: https://api.foo.openshiftapps.com:6443
                Health status Degraded.

          - exp_labels:
              severity: medium
              dest_server: https://api.foo.openshiftapps.com:6443
              dest_namespace: is-flapping
              health_status: Degraded
              name: third-test-app
              env: "{{{ env }}}"
              team: stonesoup
            exp_annotations:
              message: |-
                Environment: {{{ env }}}
                Application: third-test-app
                Cluster: https://api.foo.openshiftapps.com:6443
                Health status Degraded.
