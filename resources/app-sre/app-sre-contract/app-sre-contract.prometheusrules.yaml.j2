---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: app-sre-contract
spec:
  groups:
  - name: contract-violations.rules
    rules:
    {{%- for app in query('/queries/apps.graphql') %}}
    {{%- if app.onboardingStatus in ('OnBoarded', 'InProgress', 'TransitionPeriod') %}}
    {{%- if "metadata_architecture_document" not in app.labels %}}
    # architectureDocument
    {{%- if not url(app.architectureDocument) %}}
    - alert: IncorrectMetadataArchitectureDocument
      annotations:
        dashboard: ""
        message: "We have identified that app {{{ app.name }}}, stored in app-interface under {{{ app.path }}} does not have a valid architectureDocument or the url provided is not available. The value we have found is {{{ app.architectureDocument }}}. Note that this URL can be inside and outside the VPN but must be publicly accessible (no authentication required)."
        runbook: "Please correct this piece of information, which is part of the acceptance criteria for keeping this application supported by app-sre."
        link_url: "https://gitlab.cee.redhat.com/app-sre/contract/-/blob/master/content/service/metadata.md"
      expr: |
        1
      for: 1d
      labels:
        service: app-sre-contract
        app: {{{ app.name }}}
        severity: medium
        {{%- if app.escalationPolicy.channels.jiraComponent %}}
        jiralert: {{{ app.escalationPolicy.channels.jiraBoard[0].name }}}/{{{ app.escalationPolicy.channels.jiraComponent }}}
        {{%- else %}}
        jiralert: {{{ app.escalationPolicy.channels.jiraBoard[0].name }}}
        {{%- endif %}}
    {{%- endif %}}
    {{%- endif %}}
    # end architectureDocument
    # sopsUrl
    {{%- if "metadata_sops_url" not in app.labels %}}
    {{%- if not url(app.sopsUrl) %}}
    - alert: IncorrectMetadataSOPsUrl
      annotations:
        dashboard: ""
        message: "We have identified that app {{{ app.name }}}, stored in app-interface under {{{ app.path }}} does not have a valid sopsUrl or the url provided is not available. The value we have found is {{{ app.sopsUrl }}}. Note that this URL can be inside and outside the VPN but must be publicly accessible (no authentication required)."
        runbook: "Please correct this piece of information, which is part of the acceptance criteria for keeping this application supported by app-sre."
        link_url: "https://gitlab.cee.redhat.com/app-sre/contract/-/blob/master/content/service/metadata.md"
      expr: |
        1
      for: 1d
      labels:
        service: app-sre-contract
        app: {{{ app.name }}}
        severity: medium
        {{%- if app.escalationPolicy.channels.jiraComponent %}}
        jiralert: {{{ app.escalationPolicy.channels.jiraBoard[0].name }}}/{{{ app.escalationPolicy.channels.jiraComponent }}}
        {{%- else %}}
        jiralert: {{{ app.escalationPolicy.channels.jiraBoard[0].name }}}
        {{%- endif %}}
    {{%- endif %}}
    {{%- endif %}}
    # end sopsUrl
    {{%- endif %}}
    {{%- endfor %}}
