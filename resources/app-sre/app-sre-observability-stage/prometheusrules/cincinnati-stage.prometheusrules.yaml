apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: cincinnati-stage
spec:
  groups:
  - name: cincinnati-stage
    rules:
    - alert: Cincinnati Graph Builder - No targets found - stage
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "No valid targets found for Cincinnati Graph builder. Either no pods are running or Prometheus was not able to scrape them"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: absent(up{job="cincinnati-graph-builder", namespace="cincinnati-staging"} == 1)
      for: 1m
      labels:
        severity: medium
    - alert: Cincinnati Policy Engine - No targets found - stage
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "No valid targets found for Cincinnati Policy engine. Either no pods are running or Prometheus was not able to scrape them"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: absent(up{job="cincinnati-policy-engine", namespace="cincinnati-staging"} == 1)
      for: 1m
      labels:
        severity: medium
    - alert: UpstreamScrapesHalted
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "Graph builder upstream scrapes are not functioning"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: rate(cincinnati_gb_graph_upstream_scrapes_total{job="cincinnati-graph-builder",namespace="cincinnati-production"}[5m]) == 0
      for: 15m
      labels:
        severity: medium
    - alert: UpstreamScrapeErrors
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "High error rate for Cincinnati Graph builder scrapes"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: rate(cincinnati_gb_graph_upstream_errors_total{job="cincinnati-graph-builder",namespace="cincinnati-production"}[5m]) != 0
      for: 15m
      labels:
        severity: medium
    - alert: CincinnatiReleaseCountDrift
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "Cincinnati: Number of releases fetched from upstream does not match number of final releases in graph"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: cincinnati_gb_graph_upstream_raw_releases{job="cincinnati-policy-engine", namespace="cincinnati-staging"} != cincinnati_gb_graph_final_releases{job="cincinnati-policy-engine", namespace="cincinnati-staging"}
      for: 1d
      labels:
        severity: medium
