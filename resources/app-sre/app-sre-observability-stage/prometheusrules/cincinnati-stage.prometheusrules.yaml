apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: cincinnati-stage
spec:
  groups:
  - name: cincinnati-stage
    rules:
    - alert: Cincinnati Graph Builder - No targets found - stage
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/cincinnati/sop/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "No valid targets found for Cincinnati Graph builder. Either no pods are running or Prometheus was not able to scrape them"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: absent(up{job="cincinnati-graph-builder", namespace="cincinnati-staging"} == 1)
      for: 1m
      labels:
        service: cincinnati
        severity: medium
    - alert: Cincinnati Policy Engine - No targets found - stage
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/cincinnati/sop/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "No valid targets found for Cincinnati policy-engine. Either no pods are running or Prometheus was not able to scrape them"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: absent(up{job="cincinnati-policy-engine", namespace="cincinnati-staging"} == 1)
      for: 1m
      labels:
        service: cincinnati
        severity: medium
    - alert: GBUpstreamScrapesHalted
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/cincinnati/sop/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "Cincinnati graph-builder upstream scrapes are not functioning"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: rate(cincinnati_gb_graph_upstream_scrapes_total{job="cincinnati-graph-builder",namespace="cincinnati-staging"}[5m]) == 0
      for: 15m
      labels:
        service: cincinnati
        severity: medium
    - alert: GBUpstreamScrapeErrors
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/cincinnati/sop/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "High error rate for Cincinnati graph-builder scrapes"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-staging/browse/pods"
      expr: rate(cincinnati_gb_graph_upstream_errors_total{job="cincinnati-graph-builder",namespace="cincinnati-staging"}[5m]) != 0
      for: 15m
      labels:
        service: cincinnati
        severity: medium
    - alert: PEUpstreamErrors
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/cincinnati/sop/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "Cincinnati policy-engine is receiving an high error rate from upstream graph-builder"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-production/browse/pods"
      expr: rate(cincinnati_pe_http_upstream_errors_total{job="cincinnati-policy-engine",namespace="cincinnati-staging"}[5m]) != 0
      for: 10m
      labels:
        service: cincinnati
        severity: high
    - alert: PEGraphResponseErrors
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/cincinnati/sop/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "High error rate (kind {{ $labels.kind  }}) for Cincinnati policy-engine graph endpoint"
        link_url: "https://console.app-sre.openshift.com/console/project/cincinnati-production/browse/pods"
      expr: rate(cincinnati_pe_v1_graph_response_errors_total{job="cincinnati-policy-engine",namespace="cincinnati-staging"}[5m]) != 0
      for: 10m
      labels:
        service: cincinnati
        severity: high
