apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: hive-stage
spec:
  groups:
  - name: hive-stage
    rules:
    - alert: HiveDown - stage
      annotations:
        message: "No targets found for Telemeter in namespace {{ $labels.namespace }}. Telemeter is down."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/telemeter/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
      expr: |
        absent(up{job="telemeter-server",namespace="telemeter-stage"} == 1)
      for: 15m
      labels:
        service: hive
        severity: high
    # - alert: UploadHandlerErrorsHigh - stage
    #   annotations:
    #     message: "{{ $label.client }} is returning errors for {{ $value }}% of requests."
    #     runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/telemeter/sop"
    #     dashboard: "https://grafana.app-sre.devshift.net"
    #   expr: |
    #     sum(http_requests_total{handler="upload",service="telemeter-server",job="telemeter-server",namespace="telemeter-stage",code=~"^(?:5..)$"}) without (instance,pod,job,code)
    #     /
    #     sum(http_requests_total{handler="upload",service="telemeter-server",job="telemeter-server",namespace="telemeter-stage"}) without (instance,pod,job,code) * 100 > 10
    #   for: 10m
    #   labels:
    #     service: telemeter
    #     severity: critical