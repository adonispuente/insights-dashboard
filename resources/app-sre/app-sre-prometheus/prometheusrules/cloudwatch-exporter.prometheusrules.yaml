apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: cloudwatch-exporter
spec:
  groups:
  - name: cloudwatch-exporter
    rules:
    - alert: CloudWatchScrapeError
      labels:
        severity: medium
      expr: cloudwatch_exporter_scrape_error{job="cloudwatch-exporter"} != 0
      annotations:
        summary: 'Failed to scrape cloudwatch exporter'
        identifier: '{{ $labels.instance }}'
        description: 'There was an error scraping metrics from the cloudwatch exporter.'
  - name: cloudwatch-exporter-s3.rules
    rules:
    - alert: SuddenIncreaseBytesUsed
      labels:
        severity: warning
      expr: delta(aws_s3_bucket_size_bytes_average{job="cloudwatch-exporter"}[1h]) > 1073741824 # 1GB delta
      annotations:
        summary: 'Bucket size has grown by over 200% within the last hour'
        identifier: '{{ $labels.instance }}'
        description: 'Bucket size has grown by over 200% within the last hour'
