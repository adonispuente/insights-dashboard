apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: hive-prod
spec:
  groups:
  - name: hive-prod
    rules:
    - alert: HiveDown - prod
      annotations:
        message: "No targets found for Hive in namespace {{ $labels.namespace }}. Hive is down."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/telemeter/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
      expr: |
        absent(up{job="hive-controllers-production"} == 1)
      for: 5m
      labels:
        service: hive
        severity: critical
    - alert: InstallJobHighDuration - prod
      annotations:
        message: "Time to start an install job is taking greater than 5 minutes"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/hive/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
      expr: |
        rate(hive_cluster_deployment_install_job_delay_seconds_sum{job="hive-controllers-production"}[48h]) 
        / 
        rate(hive_cluster_deployment_install_job_delay_seconds_count{job="hive-controllers-production"}[48h]) > 300
      for: 10m
      labels:
        service: hive
        severity: medium
    - alert: ClusterProvisioningTimeout - prod
      annotations:
        message: "Cluster installs taking taking greater than the SLO of 2 hours"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/telemeter/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
      expr: |
        (hive_cluster_deployment_provision_underway_seconds{job="hive-controllers-production",cluster_type="unspecified"}/3600) > 2
      for: 10m
      labels:
        service: hive
        severity: high
    - alert: ClusterDeprovisioningTimeout - prod
      annotations:
        message: "{{ $labels.cluster_deployment }} Cluster uninstalls taking {{ $value }} hours on average. SLO: 2 hours"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/telemeter/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
      expr: |
        (hive_cluster_deployment_deprovision_underway_seconds{job="hive-controllers-production"} / 3600 ) > 2
      for: 10m
      labels:
        service: hive
        severity: medium
    - alert: ControllerErrorsHigh - prod
      annotations:
        message: "Controller :{{ $value }} is reporting a high error rate"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/telemeter/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
      expr: |
        rate(controller_runtime_reconcile_errors_total{job="hive-controllers-production"}[15m]) > 1
      for: 10m
      labels:
        service: hive
        severity: critical
