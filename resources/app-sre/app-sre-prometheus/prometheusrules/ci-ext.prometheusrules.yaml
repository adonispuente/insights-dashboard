apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    prometheus: app-sre
    role: alert-rules
  name: ci-ext-alertrules
spec:
  groups:
  - name: ci-ext
    rules:
    - alert: JobFailTest
      labels:
        severity: test
      expr: default_jenkins_builds_last_build_result_ordinal{instance="ci.ext.devshift.net:80",jenkins_job="please-job-do-not-fail",job="jenkins_ext"} == 2 and default_jenkins_builds_last_build_result_ordinal{instance="ci.ext.devshift.net:80",jenkins_job="please-job-do-not-fail",job="jenkins_ext"} != -1
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    

    # Cincinnati
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-cincinnati-gh-build-master',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-cincinnati-gh-build-master',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: cincinnati
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-saas-cincinnati-cincinnati-saas-deploy',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-saas-cincinnati-cincinnati-saas-deploy',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: cincinnati
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    
    
    # Hive
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-hive-gh-build-master',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-hive-gh-build-master',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: hive
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    

    # Telemeter
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-telemeter-gh-build-master',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-telemeter-gh-build-master',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: telemeter
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-saas-telemeter-telemeter-saas-deploy',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-saas-telemeter-telemeter-saas-deploy',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: telemeter
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    

    # App-interface
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-validator-gh-build-master',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-validator-gh-build-master',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-server-gh-build-master',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-server-gh-build-master',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-reconcile-gh-build-master',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-reconcile-gh-build-master',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    

    # Vault
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-vault-manager-gh-build-master',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-vault-manager-gh-build-master',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: vault
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-fluentd-gh-build-master',job='jenkins_ext'} == 2 and default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-fluentd-gh-build-master',job='jenkins_ext'} != -1"
      labels:
        severity: medium
        service: vault
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"    
