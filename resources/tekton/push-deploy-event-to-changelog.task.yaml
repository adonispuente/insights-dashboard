apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: push-deploy-event-to-changelog
spec:
# need to mount serviceaccounttoken to be able to access the platform-changelog api
  params:
    - name: env_name
      type: string
    - name: app_name
      type: string
    - name: task_status
      type: string
  steps:
    - name: push-deploy-event-to-changelog
      env:
        - name: TOKEN
          valueFrom:
            secretKeyRef:
              name: tekton-oauth-token
              key: token
      image: {{ ubi8_ubi_minimal_image }}:{{ ubi8_ubi_minimal_image_tag }}
      resources:
        limits:
          cpu: 20m
          memory: 30Mi
        requests:
          cpu: 20m
          memory: 30Mi
      script: |
        #!/usr/bin/env bash
        timestamp=$(date -u --iso-8601=seconds)

        echo "Sending deploy event to platform changelog"
        echo "timestamp: $timestamp; status: ${params.task_status}; app: ${params.app_name}; env: ${params.env_name}"

        generate_post_data()
        {
          cat <<EOF
        {
          "timestamp": "$timestamp",
          "status": "${params.task_status}",
          "app": "${params.app_name}",
          "env": "${params.env_name}"
        }
        EOF
        }

        # TODO: Send the commit ref as well
        curl -X POST https://changelog.stage.devshift.net/api/v1/tekton -s --data "$(generate_post_data)" -H "Content-Type: application/json" -H "Authorization: Bearer ${TOKEN}"
