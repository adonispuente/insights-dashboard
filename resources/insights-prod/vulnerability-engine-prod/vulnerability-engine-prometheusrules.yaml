---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: vulnerability-engine-prod
spec:
  groups:
  - name: vulnerability-engine-prod
    rules:
    - alert: VulnerabilityEngine5xx
      expr: (sum(rate(api_3scale_gateway_api_status{exported_service="vulnerability", status="5xx"}[5m])) / sum(rate(api_3scale_gateway_api_status{exported_service="vulnerability"}[5m]))) * 100 > 10
      for: 5m
      labels:
        severity: info
        service: insights
        env: prod
        app_team: vulnerability
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/vUgt4Eumk/vulnerability-engine?orgId=1&refresh=1m"
        link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/vulnerability-engine-prod/deployments"
        message: "More than 10 % requests from vulnerability-engine-prod returned HTTP 5XX in last 5 minutes"
    - alert: VulnerabilityEngineKafkaLagEvents
      expr: sum(kafka_consumergroup_group_lag{group="vulnerability", topic="platform.inventory.events"}) > 20000
      for: 5m
      labels:
        severity: info
        service: insights
        env: prod
        app_team: vulnerability
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/vUgt4Eumk/vulnerability-engine?orgId=1&refresh=1m"
        link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/vulnerability-engine-prod/deployments"
        message: "vulnerability-engine-prod kafka consumer lag on platform.inventory.events topic is > 20000 messages"
    - alert: VulnerabilityEngineKafkaLagEngine
      expr: sum(kafka_consumergroup_group_lag{group="vulnerability", topic="platform.engine.results"}) > 20000
      for: 5m
      labels:
        severity: info
        service: insights
        env: prod
        app_team: vulnerability
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/vUgt4Eumk/vulnerability-engine?orgId=1&refresh=1m"
        link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/vulnerability-engine-prod/deployments"
        message: "vulnerability-engine-prod kafka consumer lag on platform.engine.results topic is > 20000 messages"
    - alert: VulnerabilityEngineKafkaLagEvaluatorUpload
      expr: sum(kafka_consumergroup_group_lag{group="vulnerability", topic="vulnerability.evaluator.upload"}) > 10000
      for: 5m
      labels:
        severity: info
        service: insights
        env: prod
        app_team: vulnerability
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/vUgt4Eumk/vulnerability-engine?orgId=1&refresh=1m"
        link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/vulnerability-engine-prod/deployments"
        message: "vulnerability-engine-prod kafka consumer lag on vulnerability.evaluator.upload topic is > 10000 messages"
    - alert: VulnerabilityEngineKafkaLagEvaluatorRecalc
      expr: sum(kafka_consumergroup_group_lag{group="vulnerability", topic="vulnerability.evaluator.recalc"}) > 500000
      for: 5m
      labels:
        severity: info
        service: insights
        env: prod
        app_team: vulnerability
      annotations:
        dashboard: "https://grafana.app-sre.devshift.net/d/vUgt4Eumk/vulnerability-engine?orgId=1&refresh=1m"
        link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/vulnerability-engine-prod/deployments"
        message: "vulnerability-engine-prod kafka consumer lag on vulnerability.evaluator.recalc topic is > 500000 messages"

