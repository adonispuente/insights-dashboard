---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: provisioning-prod

spec:
  groups:
  - name: provisioning-metrics-present
    rules:
    - alert: ProvisioningMetricsAbsent
      expr: |
        absent(up{service="provisioning",namespace="provisioning-prod"} == 1)
      labels:
        service: insights
        env: prod
        app_team: provisioning
        severity: medium
      annotations:
        message: "There are no metrics present for provisioning"

  - name: provisioning-reservation-success-rate
    rules:
    - alert: ProvisioningReservationSuccessRate
      expr: |
        sum(rate(provisioning_reservation_count{result="success"}[3h]))
        /
        sum(rate(provisioning_reservation_count[3h])) < 0.70
      for: 15m
      labels:
        service: insights
        env: prod
        app_team: provisioning
        severity: medium
      annotations:
        message: "Reservations success rate is high"
        dashboard: "https://grafana.app-sre.devshift.net/d/211/provisioning"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/provisioning/ProvisioningAvailabilityAlert.md"

  - name: provisioning-http-success-rate
    rules:
    - alert: ProvisioningHTTPSuccessRate
      expr: |
        (sum(rate(api_3scale_gateway_api_status{exported_service="provisioning",status="5xx"}[10m]))
        /
        sum(rate(api_3scale_gateway_api_status{exported_service="provisioning"}[10m]))) > 0.15
      for: 15m
      labels:
        service: insights
        env: prod
        app_team: provisioning
        severity: medium
      annotations:
        message: "REST API success rate (3scale) is high"
        dashboard: "https://grafana.app-sre.devshift.net/d/211/provisioning"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/provisioning/ProvisioningAvailabilityAlert.md"

  - name: provisioning-http-latency
    rules:
    - alert: ProvisioningHTTPLatency
      expr: |
        sum(rate(provisioning_http_request_duration_ms_bucket{code=~"2\\d\\d", le="200"}[10m]))
        /
        sum(rate(provisioning_http_request_duration_ms_count[10m])) < 0.85
      for: 15m
      labels:
        service: insights
        env: prod
        app_team: provisioning
        severity: medium
      annotations:
        message: "REST API latency is high"
        dashboard: "https://grafana.app-sre.devshift.net/d/211/provisioning"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/provisioning/ProvisioningHTTPLatencySLO.md"
