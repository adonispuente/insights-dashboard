---
$schema: /app-interface/prometheus-rule-test-1.yml
rule_files:
  - /insights-prod/provisioning-prod/provisioning.prometheusrules.yml
evaluation_interval: 1m

tests:
  - interval: 1m
    input_series:
      - series: 'up{namespace="provisioning-prod", service="provisioning-backend-api"}'
        values: 1+0x9 0+0x10
      - series: 'up{namespace="provisioning-prod", service="provisioning-backend-statuser"}'
        values: 1+0x9 0+0x10
      - series: 'up{namespace="provisioning-prod", service="provisioning-backend-worker"}'
        values: 1+0x9 0+0x10
    alert_rule_test:
      - eval_time: 5m
        alertname: MissingPodServingProvisioningService
        exp_alerts: []
      - eval_time: 12m
        alertname: MissingPodServingProvisioningService
        exp_alerts:
          - exp_labels:
              service: insights
              env: prod
              app_team: provisioning
              severity: high
            exp_annotations:
              message: One of the provisioning service pods is down
      - eval_time: 15m
        alertname: MissingPodServingProvisioningService
        exp_alerts:
          - exp_labels:
              service: insights
              env: prod
              app_team: provisioning
              severity: high
            exp_annotations:
              message: One of the provisioning service pods is down

  - interval: 1m
    input_series:
    - series: provisioning_reservations_24h_count{result="pending", provider="aws"}
      values: 1+0x30 1+1x30
    - series: provisioning_reservations_24h_count{provider="aws"}
      values: 1+1x30 1+1x30
    alert_rule_test:
    - eval_time: 30m
      alertname: ProvisioningAWSReservationProcessingRateLow
      exp_alerts:
    - eval_time: 60m
      alertname: ProvisioningAWSReservationProcessingRateLow
      exp_alerts:
        - exp_labels:
            service: insights
            env: prod
            app_team: provisioning
            severity: medium
          exp_annotations:
            message: "Reservations AWS processing rate is low"
            dashboard: "https://grafana.app-sre.devshift.net/d/211/provisioning"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/provisioning/ProvisioningProcessingRateAlert.md"

  - interval: 1m
    input_series:
    - series: provisioning_reservations_24h_count{result="pending", provider="azure"}
      values: 1+0x30 1+1x30
    - series: provisioning_reservations_24h_count{provider="azure"}
      values: 1+1x30 1+1x30
    alert_rule_test:
    - eval_time: 30m
      alertname: ProvisioningAzureReservationProcessingRateLow
      exp_alerts:
    - eval_time: 60m
      alertname: ProvisioningAzureReservationProcessingRateLow
      exp_alerts:
        - exp_labels:
            service: insights
            env: prod
            app_team: provisioning
            severity: medium
          exp_annotations:
            message: "Reservations Azure processing rate is low"
            dashboard: "https://grafana.app-sre.devshift.net/d/211/provisioning"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/provisioning/ProvisioningProcessingRateAlert.md"

  - interval: 1m
    input_series:
    - series: provisioning_reservations_24h_count{result="pending", provider="gcp"}
      values: 1+0x30 1+1x30
    - series: provisioning_reservations_24h_count{provider="gcp"}
      values: 1+1x30 1+1x30
    alert_rule_test:
    - eval_time: 30m
      alertname: ProvisioningGCPReservationProcessingRateLow
      exp_alerts:
    - eval_time: 60m
      alertname: ProvisioningGCPReservationProcessingRateLow
      exp_alerts:
        - exp_labels:
            service: insights
            env: prod
            app_team: provisioning
            severity: medium
          exp_annotations:
            message: "Reservations GCP processing rate is low"
            dashboard: "https://grafana.app-sre.devshift.net/d/211/provisioning"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/provisioning/ProvisioningProcessingRateAlert.md"

  - interval: 1m
    input_series:
    - series: api_3scale_gateway_api_status{exported_service="provisioning",status="5xx"}
      values: 1+0x30 1+1x30
    - series: api_3scale_gateway_api_status{exported_service="provisioning"}
      values: 1+1x61
    alert_rule_test:
    - eval_time: 30m
      alertname: ProvisioningHTTPSuccessRate
      exp_alerts:
    - eval_time: 60m
      alertname: ProvisioningHTTPSuccessRate
      exp_alerts:
        - exp_labels:
            service: insights
            env: prod
            app_team: provisioning
            severity: medium
          exp_annotations:
            message: "REST API success rate (3scale) is low"
            dashboard: "https://grafana.app-sre.devshift.net/d/211/provisioning"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/provisioning/ProvisioningAvailabilityAlert.md"

  - interval: 1m
    input_series:
    - series: provisioning_http_request_duration_ms_bucket{code="200", le="5000"}
      values: 1+1x30 0+0x30
    - series: provisioning_http_request_duration_ms_bucket{code="200", le="+Inf"}
      values: 1+1x61
    alert_rule_test:
    - eval_time: 30m
      alertname: ProvisioningHTTPLatency
      exp_alerts:
    - eval_time: 60m
      alertname: ProvisioningHTTPLatency
      exp_alerts:
        - exp_labels:
            service: insights
            env: prod
            app_team: provisioning
            severity: medium
          exp_annotations:
            message: "REST API latency is high"
            dashboard: "https://grafana.app-sre.devshift.net/d/211/provisioning"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/provisioning/ProvisioningHTTPLatencySLO.md"
