$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: insights-slo-sli-rules
  labels:
    prometheus: app-sre
    role: alert-rules
spec:
  groups:
  #### apicast-tests ####
  - name: apicast-tests-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: apicast-tests

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: apicast-tests

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: apicast-tests

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: apicast-tests

  #### approval ####
  - name: approval-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: approval

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: approval

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: approval

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: approval

  #### automation-hub ####
  - name: automation-hub-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: automation-hub

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: automation-hub

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: automation-hub

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: automation-hub

  #### catalog ####
  - name: catalog-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: catalog

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: catalog

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: catalog

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: catalog

  #### cloudigrade ####
  - name: cloudigrade-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: cloudigrade

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: cloudigrade

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: cloudigrade

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: cloudigrade

  #### compliance ####
  - name: compliance-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: compliance

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: compliance

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: compliance

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: compliance

  #### cost-management ####
  - name: cost-management-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: cost-management

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: cost-management

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: cost-management

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: cost-management

  #### drift ####
  - name: drift-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: drift

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: drift

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: drift

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: drift

    - record: service:custom:reqcount:drift
      expr: sum(increase(api_3scale_gateway_api_time_count{exported_service="drift"}[30d]))

    - record: service:custom:errate:drift
      expr: avg_over_time(service:sli:status_5xx:pctl5rate5m{exported_service="drift"}[30d])

    - record: service:custom:latency:drift
      expr: avg_over_time(service:helper:latency:drift[30d])

    - record: service:helper:latency:drift
      expr: service:custom:downtime:drift * 100 < bool service:constant:sli:pctlatency

    - record: service:custom:downtime:drift
      expr: 1 - (service:custom:uptime:drift)

    - record: service:custom:uptime:drift
      expr: sum(rate(api_3scale_gateway_api_time_bucket{le="4000.0",exported_service="drift"}[5m]))

  #### entitlements ####
  - name: entitlements-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: entitlements

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: entitlements

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: entitlements

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: entitlements

  #### historical-system-profiles ####
  - name: historical-system-profiles-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: historical-system-profiles

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: historical-system-profiles

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: historical-system-profiles

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: historical-system-profiles

  #### ingress ####
  - name: ingress-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: ingress

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: ingress

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: ingress

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: ingress

  #### insights ####
  - name: insights-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: insights

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: insights

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: insights

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: insights

  #### insights-results-aggregator ####
  - name: insights-results-aggregator-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: insights-results-aggregator

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: insights-results-aggregator

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: insights-results-aggregator

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: insights-results-aggregator

  #### inventory ####
  - name: inventory-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: inventory

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: inventory

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: inventory

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: inventory

  #### module-update-router ####
  - name: module-update-router-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: module-update-router

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: module-update-router

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: module-update-router

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: module-update-router

  #### patch ####
  - name: patch-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: patch

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: patch

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: patch

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: patch

  #### playbook-dispatcher ####
  - name: playbook-dispatcher-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: playbook-dispatcher

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "5"
      labels:
        exported_service: playbook-dispatcher

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "95"
      labels:
        exported_service: playbook-dispatcher

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "95"
      labels:
        exported_service: playbook-dispatcher

  #### policies ####
  - name: policies-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: policies

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: policies

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: policies

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: policies

  #### rbac ####
  - name: rbac-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: rbac

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: rbac

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: rbac

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: rbac

    - record: service:custom:reqcount:rbac
      expr: sum(abs(delta(django_http_requests_latency_including_middlewares_seconds_bucket{service="rbac", le="+Inf"}[30d])))

    - record: service:custom:errate:rbac
      expr: avg_over_time(service:sli:status_5xx:pctl5rate5m{exported_service="rbac"}[30d])

    - record: service:custom:latency:rbac
      expr: avg_over_time(service:helper:latency:rbac[30d])

    - record: service:helper:latency:rbac
      expr: service:custom:downtime:rbac * 100 < bool service:constant:sli:pctlatency

    - record: service:custom:downtime:rbac
      expr: 1 - (service:custom:uptime:rbac)

    - record: service:custom:uptime:rbac
      expr: sum(rate(django_http_requests_latency_including_middlewares_seconds_bucket{le="2.5",service="rbac"}[5m]))/sum(rate(django_http_requests_latency_including_middlewares_seconds_bucket{le="+Inf",service="rbac"}[5m]))

  #### receptor-controller ####
  - name: receptor-controller-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: receptor-controller

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: receptor-controller

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: receptor-controller

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: receptor-controller

  #### remediations ####
  - name: remediations-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: remediations

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: remediations

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: remediations

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: remediations

  #### rhsm-subscriptions ####
  - name: rhsm-subscriptions-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: rhsm-subscriptions

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: rhsm-subscriptions

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: rhsm-subscriptions

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: rhsm-subscriptions

  #### sources ####
  - name: sources-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: sources

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: sources

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: sources

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: sources

  #### subscriptions (yupana) ####
  - name: subscriptions-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: subscriptions

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: subscriptions

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: subscriptions

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: subscriptions

  #### system-baseline ####
  - name: system-baseline-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: system-baseline

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: system-baseline

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: system-baseline

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: system-baseline

  #### topological-inventory ####
  - name: topological-inventory-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: topological-inventory

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: topological-inventory

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: topological-inventory

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: topological-inventory

  #### tower-analytics ####
  - name: tower-analytics-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: tower-analytics

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: tower-analytics

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: tower-analytics

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: tower-analytics

  #### vulnerability ####
  - name: vulnerability-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: vulnerability

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: vulnerability

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: vulnerability

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: vulnerability

  #### xavier ####
  - name: xavier-sli
    rules:
    # Proportion of requests allowed to have 500 status in a given period
    - record: service:constant:sli:pcterror
      expr: "5"
      labels:
        exported_service: xavier

    # Proportion of requests allowed to be over latency threshold in a given period
    - record: service:constant:sli:pctlatency
      expr: "10"
      labels:
        exported_service: xavier

    # Proportion time that the SLI should be met for error SLI
    - record: service:constant:slo:pcterror
      expr: "90"
      labels:
        exported_service: xavier

    # Proportion time that the SLI should be met for latency SLI
    - record: service:constant:slo:pctlatency
      expr: "90"
      labels:
        exported_service: xavier

