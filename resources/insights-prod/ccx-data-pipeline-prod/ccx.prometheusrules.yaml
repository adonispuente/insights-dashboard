---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ccx-data-pipeline-prod
  labels:
    prometheus: app-sre
    role: alert-rules
spec:
  groups:
  - name: ccx-data-pipeline-prod
    rules:
      - alert: InsightsResultsAggregatorRestart
        expr: sum(increase(kube_pod_container_status_restarts_total{container="insights-results-aggregator"}[5m])) by (container) > 1
        for: 30m
        labels:
          severity: high
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/ruvKwhqWk/ccx-insights-results-aggregator"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
          message: "insights-results-aggregator pods are restarting permanently <!subteam^S043UGRST2L>"
          runbook: "https://ccx-docs.cloud.paas.psi.redhat.com/customer/sops/ira_restarting.html"
      - alert: InsightsResultsDBWriterRestart
        expr: sum(increase(kube_pod_container_status_restarts_total{container="insights-results-db-writer"}[5m])) by (container) > 1
        for: 30m
        labels:
          severity: high
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/C4vK5h2Wk/ccx-insights-results-db-writer"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
          message: "insights-results-db-writer pods are restarting permanently <!subteam^S043UGRST2L>"
      - alert: CCXDataPipelineKafkaLag
        expr: sum(kafka_consumergroup_group_lag{topic=~"(platform-mq-stage.|platform-mq-prod.)?platform.upload.announce",group="ccx_data_pipeline_app"}) by (group) > 500
        for: 10m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/jRluM4NMz/ccx-data-pipeline"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
          message: "Kafka lag for ccx-data-pipeline in platform.upload.announce topic exceeded 500 <!subteam^S043UGRST2L>"
          runbook: "https://ccx-docs.cloud.paas.psi.redhat.com/customer/sops/cdp_kafka_lag_gt_100.html"
      - alert: InsightsResultsDBWriterKafkaLag
        expr: sum(kafka_consumergroup_group_lag{topic=~"(platform-mq-stage.|platform-mq-prod.)?ccx.ocp.results", group="ccx_data_pipeline_app"}) by (topic) > 200
        for: 10m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/C4vK5h2Wk/ccx-insights-results-db-writer"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
          message: "Kafka lag for insights-results-db-writer in ccx.ocp.results topic exceeded 200 <!subteam^S043UGRST2L>"
          runbook: "https://ccx-docs.cloud.paas.psi.redhat.com/customer/sops/irdw_kafka_lag_gt_100.html"
      - alert: CCXSmartProxyDown
        expr: sum(up{service="ccx-smart-proxy"}) by (service) == 0
        for: 2m
        labels:
          severity: critical
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/5RvvwGqW0/ccx-smart-proxy"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
          message: "ccx-smart-proxy has been down for two minutes <!subteam^S043UGRST2L>"
      - alert: CCXInsightsContentServiceDown
        expr: sum(up{service="ccx-insights-content-service-prometheus-exporter"}) by (service) == 0
        for: 2m
        labels:
          severity: critical
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/i7kJG7vGz/ccx-insights-content-service"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
          message: "ccx-insights-content-service has been down for two minutes <!subteam^S043UGRST2L>"
      - alert: CCXDataPipelineDown
        expr: sum(up{service="ccx-data-pipeline-prometheus-exporter"}) by (service) == 0
        for: 2m
        labels:
          severity: critical
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          dashboard: "https://grafana.app-sre.devshift.net/d/jRluM4NMz/ccx-data-pipeline"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
          message: "ccx-data-pipeline backend service has been down for two minutes <!subteam^S043UGRST2L>"
      - alert: InsightsResultsAggregatorDown
        expr: sum(up{service="ccx-insights-results-aggregator-prometheus-exporter"}) by (service) == 0
        for: 2m
        labels:
          severity: critical
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          message: "insights-results-aggregator backend service has been down for two minutes <!subteam^S043UGRST2L>"
          dashboard: "https://grafana.app-sre.devshift.net/d/ruvKwhqWk/ccx-insights-results-aggregator"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
      - alert: CCXUpgradesDataEngDown
        expr: sum(up{service="ccx-upgrades-data-eng-svc"}) == 0
        for: 2m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          message: "ccx-upgrades-data-eng service has been down for two minutes <!subteam^S043UGRST2L>"
          dashboard: "https://grafana.app-sre.devshift.net/d/hFu11qbVz/ccx-upgrade-risks-predictions"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
      - alert: CCXUpgradesInferenceDown
        expr: sum(up{service="ccx-upgrades-inference-svc"}) == 0
        for: 2m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          message: "ccx-upgrades-inference service has been down for two minutes <!subteam^S043UGRST2L>"
          dashboard: "https://grafana.app-sre.devshift.net/d/hFu11qbVz/ccx-upgrade-risks-predictions"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
      - alert: CCXUpgradesDataEng500
        expr: increase(http_requests_total{service="ccx-upgrades-data-eng-svc", status="5xx"}[1m]) > 0
        for: 2m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          message: "ccx-upgrades-data-eng service returns too many 500 responses for endpoint {{ $labels.handler }} <!subteam^S043UGRST2L>"
          dashboard: "https://grafana.app-sre.devshift.net/d/hFu11qbVz/ccx-upgrade-risks-predictions"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
      - alert: CCXUpgradesInference500
        expr: increase(http_requests_total{service="ccx-upgrades-inference-svc", status="5xx"}[1m]) > 0
        for: 2m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          message: "ccx-upgrades-inference service returns too many 500 responses for endpoint {{ $labels.handler }} <!subteam^S043UGRST2L>"
          dashboard: "https://grafana.app-sre.devshift.net/d/hFu11qbVz/ccx-upgrade-risks-predictions"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
      - alert: CCXUpgradesDataEngTooSlow
        # TODO: Decrease this threashold once we are using production RHOBS, which is faster than stage RHOBS
        expr: avg by(handler)(rate(http_request_duration_seconds_sum{service="ccx-upgrades-data-eng-svc"}[5m]) / rate(http_request_duration_seconds_count{service="ccx-upgrades-data-eng-svc"}[5m])) > 5
        for: 2m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          message: "ccx-upgrades-data-eng service is taking too long to respond for endpoint {{ $labels.handler }} <!subteam^S043UGRST2L>"
          dashboard: "https://grafana.app-sre.devshift.net/d/hFu11qbVz/ccx-upgrade-risks-predictions"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
      - alert: CCXUpgradesInferenceTooSlow
        expr: avg by(handler)(rate(http_request_duration_seconds_sum{service="ccx-upgrades-inference-svc"}[5m]) / rate(http_request_duration_seconds_count{service="ccx-upgrades-inference-svc"}[5m])) > 2
        for: 2m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          message: "ccx-upgrades-inference service is taking too long to respond for endpoint {{ $labels.handler }} <!subteam^S043UGRST2L>"
          dashboard: "https://grafana.app-sre.devshift.net/d/hFu11qbVz/ccx-upgrade-risks-predictions"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
      - alert: CCXNotificationDBLowStorageSpace
        expr: aws_rds_free_storage_space_average{container="cloudwatch-exporter", dbinstance_identifier="ccx-notification-prod", namespace="app-sre-observability-production"} offset 10m < (40 * 1024^3)
        for: 30m
        labels:
          severity: high
          service: insights
          namespace: app-sre-observability-production
          app_team: ccx-data-pipeline
          env: prod
        annotations:
          message: "The current free storage space of DB instance {{ $labels.dbinstance_identifier }} is less than 20%."
          runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/aws/aws-rds-resources.md#rdsstoragelow"
          dashboard: "https://grafana.app-sre.devshift.net/d/AWSRDSdbi/aws-rds?orgId=1&var-datasource=AWS%20insights-prod&var-region=default&var-dbinstanceidentifier=ccx-notification-prod&from=now-7d&to=now"
      - alert: CCXUpgradesDataEngCacheFull
        expr: max (container_memory_working_set_bytes{container="ccx-upgrades-data-eng-instance"}) / min(kube_pod_container_resource_limits{resource="memory", container="ccx-upgrades-data-eng-instance"}) > 0.8
        for: 2m
        labels:
          severity: medium
          service: insights
          env: prod
          app_team: ccx-data-pipeline
        annotations:
          message: "ccx-upgrades-data-eng service memory usage is too high and will reach the limits. Probably the cache is growing too much <!subteam^S043UGRST2L>"
          dashboard: "https://grafana.app-sre.devshift.net/d/hFu11qbVz/ccx-upgrade-risks-predictions"
          link_url: "https://console-openshift-console.apps.crcp01ue1.o9m8.p1.openshiftapps.com/k8s/ns/ccx-data-pipeline-prod/deployments"
