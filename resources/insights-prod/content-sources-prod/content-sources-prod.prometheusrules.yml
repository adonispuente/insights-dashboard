---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: content-sources-prod
spec:
  groups:
    - name: content-sources-down
      rules:
        - alert: ContentSourcesBackendDown
          annotations:
            message: "content-sources-backend-service pod down for 5 minutes."
          expr: up{service="content-sources-backend-service", namespace="content-sources-prod"} == 0
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
    - name: content-sources-availability-prod
      rules:
        - alert: ContentSources5mto1hErrorBudgetBurn
          annotations:
            message: "High error budget burn in the last hour (error rate: {{ $value | humanizePercentage }})"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesAvailabilityAlert.md"
          expr: |
            sum(content_sources_availability_error_ratio:burnrate5m) > (13.44 * (1-0.95000))
            and
            sum(content_sources_availability_error_ratio:burnrate1h) > (13.44 * (1-0.95000))
          for: 2m
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
        - alert: ContentSources30mto6hErrorBudgetBurn
          annotations:
            message: "High error budget burn in the last 6 hours (error rate: {{ $value | humanizePercentage }})"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesAvailabilityAlert.md"
          expr: |
            sum(content_sources_availability_error_ratio:burnrate30m) > (5.6 * (1-0.95000))
            and
            sum(content_sources_availability_error_ratio:burnrate6h) > (5.6 * (1-0.95000))
          for: 15m
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
        - alert: ContentSources2hto1dErrorBudgetBurn
          annotations:
            message: "High error budget burn in the last day (error rate: {{ $value | humanizePercentage }})"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesAvailabilityAlert.md"
          expr: |
            sum(content_sources_availability_error_ratio:burnrate2h) > (2.8 * (1-0.95000))
            and
            sum(content_sources_availability_error_ratio:burnrate1d) > (2.8 * (1-0.95000))
          for: 1h
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
        - alert: ContentSources6hto3dErrorBudgetBurn
          annotations:
            message: "High error budget burn in the last 3 days (error rate: {{ $value | humanizePercentage }})"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesAvailabilityAlert.md"
          expr: |
            sum(content_sources_availability_error_ratio:burnrate6h) > (1.00 * (1-0.95000))
            and
            sum(content_sources_availability_error_ratio:burnrate3d) > (1.00 * (1-0.95000))
          for: 1m
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[1d]))
            /
            sum(rate(content_sources_http_status_histogram_count[1d]))
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_availability_error_ratio:burnrate1d
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[1h]))
            /
            sum(rate(content_sources_http_status_histogram_count[1h]))
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_availability_error_ratio:burnrate1h
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[2h]))
            /
            sum(rate(content_sources_http_status_histogram_count[2h]))
          labels:
            severity: medium
            app_team: content-sources
            service: insights
            env: prod
          record: content_sources_availability_error_ratio:burnrate2h
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[30m]))
            /
            sum(rate(content_sources_http_status_histogram_count[30m]))
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_availability_error_ratio:burnrate30m
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[3d]))
            /
            sum(rate(content_sources_http_status_histogram_count[3d]))
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_availability_error_ratio:burnrate3d
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[5m]))
            /
            sum(rate(content_sources_http_status_histogram_count[5m]))
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_availability_error_ratio:burnrate5m
        - expr: |
            sum(rate(content_sources_http_status_histogram_count{status="5xx"}[6h]))
            /
            sum(rate(content_sources_http_status_histogram_count[6h]))
          labels:
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_availability_error_ratio:burnrate6h
    - name: content-sources-latency-prod
      rules:
        - alert: ContentSourcesLatency5mto1hrOr30mto6hBudgetBurn
          annotations:
            message: 'High requests latency budget burn: {{ $value | humanizePercentage }} of requests slower than 500ms.'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesLatencyAlert.md"
          expr: |
            (
              content_sources_http_status_histogram_bucket:rate1h{latency="0.5"} > (13.44 * (1-0.90000))
              and
              content_sources_http_status_histogram_bucket:rate5m{latency="0.5"} > (13.44 * (1-0.90000))
            )
            or
            (
              content_sources_http_status_histogram_bucket:rate6h{latency="0.5"} > (5.6 * (1-0.90000))
              and
              content_sources_http_status_histogram_bucket:rate30m{latency="0.5"} > (5.6 * (1-0.90000))
            )
          labels:
            service: insights
            severity: medium
            latency: "0.5"
            app_team: content-sources
            env: prod
        - alert: ContentSourcesLatency2hto1dOr6hto3dBudgetBurn
          annotations:
            message: 'High requests latency budget burn: {{ $value | humanizePercentage }} of requests slower than 500ms.'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesLatencyAlert.md"
          expr: |
            (
              content_sources_http_status_histogram_bucket:rate1d{latency="0.5"} > (2.8 * (1-0.90000))
              and
              content_sources_http_status_histogram_bucket:rate2h{latency="0.5"} > (2.8 * (1-0.90000))
            )
            or
            (
              content_sources_http_status_histogram_bucket:rate3d{latency="0.5"} > (1 * (1-0.90000))
              and
              content_sources_http_status_histogram_bucket:rate6h{latency="0.5"} > (1 * (1-0.90000))
            )
          labels:
            service: insights
            severity: medium
            latency: "0.5"
            app_team: content-sources
            env: prod
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.5"}[5m]))
              /
              sum(rate(content_sources_http_status_histogram_count[5m]))
            )
          labels:
            latency: "0.5"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_http_status_histogram_bucket:rate5m
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.5"}[30m]))
              /
              sum(rate(content_sources_http_status_histogram_count[30m]))
            )
          labels:
            latency: "0.5"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_http_status_histogram_bucket:rate30m
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.5"}[1h]))
              /
              sum(rate(content_sources_http_status_histogram_count[1h]))
            )
          labels:
            latency: "0.5"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_http_status_histogram_bucket:rate1h
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.5"}[2h]))
              /
              sum(rate(content_sources_http_status_histogram_count[2h]))
            )
          labels:
            latency: "0.5"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_http_status_histogram_bucket:rate2h
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.5"}[6h]))
              /
              sum(rate(content_sources_http_status_histogram_count[6h]))
            )
          labels:
            latency: "0.5"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_http_status_histogram_bucket:rate6h
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.5"}[1d]))
              /
              sum(rate(content_sources_http_status_histogram_count[1d]))
            )
          labels:
            latency: "0.5"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_http_status_histogram_bucket:rate1d
        - expr: |
            1 - (
              sum(rate(content_sources_http_status_histogram_bucket{le="0.5"}[3d]))
              /
              sum(rate(content_sources_http_status_histogram_count[3d]))
            )
          labels:
            latency: "0.5"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_http_status_histogram_bucket:rate3d
    - name: content-sources-messaging-latency-prod
      rules:
        - alert: ContentSourcesMessageLatency5mto1hrOr30mto6hBudgetBurn
          annotations:
            message: 'High message latency budget burn for latency=3600 (current value: {{ $value }})'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesMessageLatencyAlert.md"
          expr: |
            (
              content_sources_message_latency_bucket:rate1h{latency="3600"} > (13.44*(1-.900000))
              and
              content_sources_message_latency_bucket:rate5m{latency="3600"} > (13.44*(1-.900000))
            )
            or
            (
              content_sources_message_latency_bucket:rate6h{latency="3600"} > (5.6*(1-.900000))
              and
              content_sources_message_latency_bucket:rate30m{latency="3600"} > (5.6*(1-.900000))
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
        - alert: ContentSourcesMessageLatency2hrto1dOr6hrto3dBudgetBurn
          annotations:
            message: 'High message latency budget burn for latency=3600 (current value: {{ $value }})'
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/console.redhat.com/app-sops/content-sources/ContentSourcesMessageLatencyAlert.md"
          expr: |
            (
              content_sources_message_latency_bucket:rate1d{latency="3600"} > (2.8*(1-.900000))
              and
              content_sources_message_latency_bucket:rate2h{latency="3600"} > (2.8*(1-.900000))
            )
            or
            (
              content_sources_message_latency_bucket:rate3d{latency="3600"} > (1-.900000)
              and
              content_sources_message_latency_bucket:rate6h{latency="3600"} > (1-.900000)
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
        - expr: |
            1 - (
              sum(rate(content_sources_message_latency_bucket{le="3600"}[5m]))
              /
              sum(rate(content_sources_message_latency_count[5m]))
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_message_latency_bucket:rate5m
        - expr: |
            1 - (
              sum(rate(content_sources_message_latency_bucket{le="3600"}[30m]))
              /
              sum(rate(content_sources_message_latency_count[30m]))
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_message_latency_bucket:rate30m
        - expr: |
            1 - (
              sum(rate(content_sources_message_latency_bucket{le="3600"}[1h]))
              /
              sum(rate(content_sources_message_latency_count[1h]))
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_message_latency_bucket:rate1h
        - expr: |
            1 - (
              sum(rate(content_sources_message_latency_bucket{le="3600"}[2h]))
              /
              sum(rate(content_sources_message_latency_count[2h]))
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_message_latency_bucket:rate2h
        - expr: |
            1 - (
              sum(rate(content_sources_message_latency_bucket{le="3600"}[6h]))
              /
              sum(rate(content_sources_message_latency_count[6h]))
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_message_latency_bucket:rate6h
        - expr: |
            1 - (
              sum(rate(content_sources_message_latency_bucket{le="3600"}[1d]))
              /
              sum(rate(content_sources_message_latency_count[1d]))
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_message_latency_bucket:rate1d
        - expr: |
            1 - (
              sum(rate(content_sources_message_latency_bucket{le="3600"}[3d]))
              /
              sum(rate(content_sources_message_latency_count[3d]))
            )
          labels:
            latency: "3600"
            service: insights
            severity: medium
            app_team: content-sources
            env: prod
          record: content_sources_message_latency_bucket:rate3d
