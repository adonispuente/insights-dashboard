# Temporary, see : https://issues.redhat.com/browse/APPSRE-1468
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-instance
data:
  alertmanager.yaml: >-
    {{% b64encode %}}
    # Alertmanager routing configuration
    global:
      resolve_timeout: 5m
      # Global Pagerduty URL
      pagerduty_url: https://pagerduty.example.com

      # Global slack configuration:
      slack_api_url: {{{ vault('app-interface/app-sre/app-sre-observability-production/alertmanager-integration', 'slack_api_url') }}}


    # The root route on which each incoming alert enters.
    route:
      # The labels by which incoming alerts are grouped together. For example,
      # multiple alerts coming in for cluster=A and alertname=LatencyHigh would
      # be batched into a single group.
      #
      # To aggregate by all possible labels use '...' as the sole label name.
      # This effectively disables aggregation entirely, passing through all
      # alerts as-is. This is unlikely to be what you want, unless you have
      # a very low alert volume or your upstream notification system performs
      # its own grouping. Example: group_by: [...]
      group_by: ['job', 'cluster', 'service']
      # When a new group of alerts is created by an incoming alert, wait at
      # least 'group_wait' to send the initial notification.
      # This way ensures that you get multiple alerts for the same group that start
      # firing shortly after another are batched together on the first
      # notification.
      group_wait: 30s
      # When the first notification was sent, wait 'group_interval' to send a batch
      # of new alerts that started firing for that group.
      group_interval: 5m
      # If an alert has successfully been sent, wait 'repeat_interval' to
      # resend them.
      repeat_interval: 24h
      # The default receiver; All alerts will be sent here if it doesn't match
      # any of the route trees below

      receiver: 'slack-clouddot-fedramp-alerts-stage'

      # All the above attributes are inherited by all child routes and can
      # overwritten on each.

      # The child route trees.
      routes:
      # This routes performs a regular expression match on alert labels to
      # catch alerts that are related to a list of services.
      - match_re:
          namespace: ".*\\b(stage|staging)\\b.*"
        receiver: slack-clouddot-fedramp-alerts-stage
        continue: true
      - match_re:
          environment: ".*\\b(stage|staging)\\b.*"
        receiver: slack-clouddot-fedramp-alerts-stage
        continue: true
      - match_re:
          env: ".*\\b(stage|staging)\\b.*"
        receiver: slack-clouddot-fedramp-alerts-stage
        continue: true

      # Insights
      - match:
          service: insights
        receiver: slack-clouddot-fedramp-alerts-stage
        # Also group alerts by affected service
        group_by: [alertname, cluster, job, service]
        routes:
        - match:
            app_team: remediations
          receiver: slack-team-clouddot-remediations
          continue: true
        - match:
            app_team: inventory
          receiver: slack-team-clouddot-inventory
          continue: true
        - match:
            app_team: patch
          receiver: slack-team-clouddot-patch
          continue: true
        - match:
            app_team: compliance
          receiver: slack-team-clouddot-compliance
          continue: true
        - match:
            app_team: drift
          receiver: slack-team-clouddot-drift
          continue: true
        - match:
            app_team: historical-system-profiles
          receiver: slack-team-clouddot-historical-system-profiles
          continue: true
        - match:
            app_team: yupana
          receiver: slack-team-clouddot-yupana
          continue: true
        - match:
            app_team: system-baseline
          receiver: slack-team-clouddot-system-baseline
          continue: true
        - match:
            app_team: vmaas
          receiver: slack-team-clouddot-vmaas
          continue: true
        - match:
            app_team: vulnerability
          receiver: slack-team-clouddot-vulnerability
          continue: true
        - match:
            app_team: platform
          receiver: slack-team-clouddot-platform-alert
          continue: true
        - match:
            app_team: data-pipeline
          receiver: slack-team-clouddot-data-pipeline
          continue: true
        - match:
            app_team: costmanagement
          receiver: slack-team-clouddot-costmanagement
          continue: true
        - match:
            app_team: costmanagement-staging
          receiver: slack-team-clouddot-costmanagement-staging
          continue: true
        - match:
            app_team: marketplace-processor
          receiver: slack-team-clouddot-marketplace-processor
          continue: true
        - match:
            app_team: automation-analytics
            env: stage
          receiver: slack-team-clouddot-automation-analytics
          continue: true
        - match:
            app_team: automation-analytics
            env: prod
          receiver: slack-team-clouddot-automation-analytics-prod
          continue: true
        - match:
            app_team: advisor
          receiver: slack-team-clouddot-advisor
          continue: true
        - match:
            app_team: automation-hub
          receiver: slack-team-clouddot-automation-hub
          continue: true
        - match:
            app_team: automation-services-catalog
          receiver: slack-team-clouddot-automation-hub
          continue: true
        - match:
            app_team: topo-sources
          receiver: slack-team-consoledot-sources
          continue: true
        - match:
            app_team: platform-data
          receiver: slack-team-clouddot-platform-data
          continue: true
        - match:
            app_team: policies
            env: stage
          receiver: slack-alerts-clouddot-policies-preprod
          continue: true
        - match:
            app_team: policies
            env: prod
          receiver: slack-alerts-clouddot-policies-prod
          continue: true
        - match:
            app_team: notifications
            env: stage
          receiver: slack-alerts-clouddot-notifications-preprod
          continue: true
        - match:
            app_team: notifications
            env: prod
          receiver: slack-alerts-clouddot-notifications-prod
          continue: true
        - match:
            env: stage
          receiver: slack-clouddot-fedramp-alerts-stage
        # Pagerduty disabled for now
        # - match:
        #     severity: critical
        #     env: prod
        #   receiver: pagerduty-cloud-redhat-com
        #   continue: true
        - match:
            env: prod
          receiver: slack-clouddot-fedramp-alerts

    inhibit_rules:
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'medium'
      # Apply inhibition if the alertname is the same.
      equal: ['alertname', 'cluster', 'service']

    templates:
    - '*.tmpl'
    - '/etc/alertmanager/configmaps/templates/*.tmpl'

    receivers:
    - name: slack-team-clouddot-remediations
      slack_configs:
      - channel: '#team-clouddot-remediations'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-platform-data
      slack_configs:
      - channel: '#team-clouddot-platform-data'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-inventory
      slack_configs:
      - channel: '#team-clouddot-inventory'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-patch
      slack_configs:
      - channel: '#team-clouddot-patch'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-compliance
      slack_configs:
      - channel: '#team-clouddot-compliance'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-drift
      slack_configs:
      - channel: '#team-clouddot-drift'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-historical-system-profiles
      slack_configs:
      - channel: '#team-clouddot-historical-system-profiles'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-yupana
      slack_configs:
      - channel: '#team-clouddot-yupana'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'


    - name: slack-team-clouddot-system-baseline
      slack_configs:
      - channel: '#team-clouddot-system-baseline'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'


    - name: slack-team-clouddot-vmaas
      slack_configs:
      - channel: '#team-clouddot-vmaas'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-vulnerability
      slack_configs:
      - channel: '#team-clouddot-vulnerability'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-clouddot-fedramp-alerts
      slack_configs:
      - channel: '#team-clouddot-fedramp-alert'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-clouddot-fedramp-alerts-stage
      slack_configs:
      - channel: '#team-clouddot-fedramp-alert-stage'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-platform-alert
      slack_configs:
      - channel: '#team-clouddot-platform-alert'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    - name: slack-team-clouddot-data-pipeline
      slack_configs:
      - channel: '#team-clouddot-data-pipeline'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Cost Management Slack Receiver
    - name: slack-team-clouddot-costmanagement
      slack_configs:
      - channel: '#cost-mgmt-prod-alerts'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Cost Management Slack Receiver
    - name: slack-team-clouddot-costmanagement-staging
      slack_configs:
      - channel: '#cost-mgmt-stage-alerts'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Topological Inventory & Sources Slack Receiver
    - name: slack-team-consoledot-sources
      slack_configs:
      - channel: '#team-consoledot-sources-alerts'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Automation Analytics Slack Receiver
    - name: slack-team-clouddot-automation-analytics
      slack_configs:
      - channel: '#team-clouddot-automation-analytics'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Automation Analytics Slack Receiver for PROD
    - name: slack-team-clouddot-automation-analytics-prod
      slack_configs:
      - channel: '#team-clouddot-automation-analytics-prod'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Advisor Slack Receiver
    - name: slack-team-clouddot-advisor
      slack_configs:
      - channel: '#team-clouddot-advisor'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Automation Hub Slack Receiver
    - name: slack-team-clouddot-automation-hub
      slack_configs:
      - channel: '#team-clouddot-automation-hub'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Automation Services Catalog Slack Receiver
    - name: slack-team-clouddot-automation-services-catalog
      slack_configs:
      - channel: '#team-clouddot-automation-services-catalog'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Marketplace Processor Slack Receiver
    - name: slack-team-clouddot-marketplace-processor
      slack_configs:
      - channel: '#team-clouddot-marketplace-processor'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Policies Processor Slack Receiver (Prod)
    - name: slack-alerts-clouddot-policies-prod
      slack_configs:
      - channel: '#alerts-clouddot-policies-prod'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Policies Processor Slack Receiver (PreProd)
    - name: slack-alerts-clouddot-policies-preprod
      slack_configs:
      - channel: '#alerts-clouddot-policies-preprod'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Notifications Processor Slack Receiver (Prod)
    - name: slack-alerts-clouddot-notifications-prod
      slack_configs:
      - channel: '#alerts-clouddot-notifications-prod'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'

    # Notifications Processor Slack Receiver (PreProd)
    - name: slack-alerts-clouddot-notifications-preprod
      slack_configs:
      - channel: '#alerts-clouddot-notifications-preprod'
        send_resolved: true
        username: 'app-sre-alerts ({{{ resource.namespace.cluster.name }}})'
        title: '{{ template "slack.default.title" . }}'
        icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
        color: '{{ template "slack.default.color" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
        - type: button
          text: 'Runbook :green_book:'
          url: '{{ (index .Alerts 0).Annotations.runbook }}'
        - type: button
          text: 'Query :mag:'
          url: '{{ (index .Alerts 0).GeneratorURL }}'
        - type: button
          text: 'Dashboard :grafana:'
          url: '{{ (index .Alerts 0).Annotations.dashboard }}'
        - type: button
          text: 'Alert Definition :git:'
          url: '{{ (index .Alerts 0).Annotations.html_url }}'
        - type: button
          text: 'Silence :no_bell:'
          url: '{{ template "__alert_silence_link" . }}'
        - type: button
          text: '{{ template "slack.default.link_button_text" . }}'
          url: '{{ .CommonAnnotations.link_url }}'
  
    # Pagerduty receivers
    - name: pagerduty-cloud-redhat-com
      pagerduty_configs:
      - send_resolved: true
        service_key: {{{ vault('app-interface/app-sre/app-sre-observability-production/alertmanager-integration', 'pagerduty_cloud_redhat_com_service_key')}}}
    {{% endb64encode %}}

  chat.tmpl: >-
    {{% b64encode %}}
    # This builds the silence URL.  We exclude the alertname in the range
    # to avoid the issue of having trailing comma separator (%2C) at the end
    # of the generated URL
    {{ define "__alert_silence_link" -}}
        {{ .ExternalURL }}/#/silences/new?filter=%7B
        {{- range .CommonLabels.SortedPairs -}}
            {{- if ne .Name "alertname" -}}
                {{- .Name }}%3D"{{- .Value -}}"%2C%20
            {{- end -}}
        {{- end -}}
        alertname%3D"{{ .CommonLabels.alertname }}"%7D
    {{- end }}


    {{ define "__alert_severity_prefix" -}}
        {{ if ne .Status "firing" -}}
        :green_apple:
        {{- else if eq .Labels.severity "critical" -}}
        :fire:
        {{- else if eq .Labels.severity "warning" -}}
        :warning:
        {{- else if eq .Labels.severity "medium" -}}
        :warning:
        {{- else if eq .Labels.severity "test" -}}
        :grey_exclamation:
        {{- else -}}
        :question:
        {{- end }}
    {{- end }}

    {{ define "__alert_severity_prefix_title" -}}
        {{ if ne .Status "firing" -}}
        :green_apple:
        {{- else if eq .Labels.severity "critical" -}}
        :fire:
        {{- else if eq .Labels.severity "warning" -}}
        :warning:
        {{- else if eq .Labels.severity "medium" -}}
        :warning:
        {{- else if eq .Labels.severity "test" -}}
        :grey_exclamation:
        {{- else -}}
        :question:
        {{- end }}
    {{- end }}

    {{ define "__single_message_title" }}{{ range .Alerts.Firing }}{{- if .Annotations.message }} {{ .Annotations.message }} {{- end }}{{ end }}{{ range .Alerts.Resolved }}{{- if .Annotations.message }} {{ .Annotations.message }} {{- end }}
    {{ end }}{{ end }}

    {{/* First line of Slack alerts */}}
    {{ define "slack.default.title" -}}Alert: {{ .CommonLabels.alertname }} [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if or (and (eq (len .Alerts.Firing) 1) (eq (len .Alerts.Resolved) 0)) (and (eq (len .Alerts.Firing) 0) (eq (len .Alerts.Resolved) 1)) }}{{ template "__single_message_title" . }}{{ end }}{{- end }}


    {{/* Color of Slack attachment (appears as line next to alert )*/}}
    {{ define "slack.default.color" -}}
        {{ if eq .Status "firing" -}}
            {{ if eq .CommonLabels.severity "test" -}}
                '#808080'
            {{ else if eq .CommonLabels.severity "warning" -}}
                warning
            {{ else if eq .CommonLabels.severity "medium" -}}
                warning
            {{- else if eq .CommonLabels.severity "critical" -}}
                danger
            {{- else -}}
                '#439FE0'
            {{- end -}}
        {{ else -}}
        good
        {{- end }}
    {{- end }}


    {{/* Emoji to display as user icon (custom emoji supported!) */}}
    {{ define "slack.default.icon_emoji" }}:prometheus:{{ end }}

    {{ define "slack.default.icon_url" }}https://avatars3.githubusercontent.com/u/3380462{{ end }}

    {{/* The text to display in the alert */}}
    {{/* define "slack.default.text" -}}{{ range .Alerts }}{{ if eq .Status "firing" -}}{{- if .Annotations.message }}{{ .Annotations.message }}{{- end }}{{- if .Annotations.description }}{{ .Annotations.description }}{{- end }}{{- end }}{{ if eq .Status "resolved" -}}{{- if .Annotations.message }}Resolved: {{ .Annotations.message }}{{- end }}{{- end }}{{- end }}{{- end */}}

    {{ define "slack.default.text" }}
    {{ if or (and (eq (len .Alerts.Firing) 1) (eq (len .Alerts.Resolved) 0)) (and (eq (len .Alerts.Firing) 0) (eq (len .Alerts.Resolved) 1)) }}
    {{ range .Alerts.Firing }}{{ .Annotations.link_url }}{{ end }}{{ range .Alerts.Resolved }}{{ .Annotations.link_url }}{{ end }}
    {{ range .Alerts.Firing }}{{ .Annotations.description }}{{ end }}{{ range .Alerts.Resolved }}{{ .Annotations.description }}{{ end }}
    {{ else }}
    {{ if gt (len .Alerts.Firing) 0 }}
    *Alerts Firing:*
    {{ range .Alerts.Firing }}- {{- if .Annotations.message }} {{ .Annotations.message }} {{- end }}{{- if .Annotations.link_url }}: {{ .Annotations.link_url }}{{- end }}
    {{ end }}{{ end }}
    {{ if gt (len .Alerts.Resolved) 0 }}
    *Alerts Resolved:*
    {{ range .Alerts.Resolved }}- {{- if .Annotations.message }} {{ .Annotations.message }} {{- end }}{{- if .Annotations.link_url }}: {{ .Annotations.link_url }}{{- end }}
    {{ end }}{{ end }}
    {{ end }}
    {{ end }}

    {{- /* If none of the below matches, send to #sd-app-sre-alert-test, and we
    can then assign the expected code_owner to the alert or map the code_owner
    to the correct channel */ -}}
    {{ define "__get_channel_for_code_owner" -}}
        {{- if eq . "app-sre" -}}
            sd-app-sre-alert
        {{- else if eq . "telemeter" -}}
            forum-monitoring
        {{- else -}}
            sd-app-sre-alert-test
        {{- end -}}
    {{- end }}

    {{- /* Select the channel based on the code_owner. We only expect to get
    into this template function if the code_owners label is present on an alert.
    This is to defend against us accidentally breaking the routing logic. */ -}}
    {{ define "slack.default.code_owner_channel" -}}
        {{- if .CommonLabels.code_owner }}
            {{ template "__get_channel_for_code_owner" .CommonLabels.code_owner }}
        {{- else -}}
            monitoring
        {{- end }}
    {{- end }}

    {{ define "slack.default.link_button_text" -}}
        {{- if .CommonAnnotations.link_text -}}
            {{- .CommonAnnotations.link_text -}}
        {{- else -}}
            Link
        {{- end }} :link:
    {{- end }}
    {{% endb64encode %}}
