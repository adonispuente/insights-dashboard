apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  labels:
    alertmanager: app-sre
    environment: {{environment}}
  name: app-sre
spec:
  version: {{version}}
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: alertmanager
              operator: In
              values:
              - app-sre
          namespaces:
          - {{resource.namespace.name}}
          topologyKey: kubernetes.io/hostname
        weight: 100
  containers:
  - args:
    - -provider=github
    - -http-address=:3000
    - -https-address=
    - -htpasswd-file=/etc/proxy/htpasswd/auth
    - -email-domain=*
    - -upstream=http://alertmanager-operated.{{resource.namespace.name}}.svc:9093
    - -github-org=app-sre
    - -github-team=app-sre-observability
    env:
    - name: OAUTH2_PROXY_CLIENT_ID
      valueFrom:
        secretKeyRef:
          key: client-id
          name: alertmanager-proxy-config
    - name: OAUTH2_PROXY_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          key: client-secret
          name: alertmanager-proxy-config
    - name: OAUTH2_PROXY_COOKIE_SECRET
      valueFrom:
        secretKeyRef:
          key: cookie-secret
          name: alertmanager-proxy-config
    image: quay.io/pusher/oauth2_proxy:v4.0.0
    imagePullPolicy: Always
    name: alertmanager-proxy
    ports:
    - containerPort: 3000
      name: http
      protocol: TCP
    readinessProbe:
      failureThreshold: 3
      periodSeconds: 10
      successThreshold: 1
      tcpSocket:
        port: http
      timeoutSeconds: 1
    volumeMounts:
    - mountPath: /etc/proxy/htpasswd
      name: secret-{{oauthProxySecretName}}
  externalUrl: {{externalUrl}}
  replicas: {{replicas}}
  secrets:
  - {{oauthProxySecretName}}
  securityContext: {}
  serviceAccountName: prometheus-k8s
  storage:
    volumeClaimTemplate:
      apiVersion: v1
      kind: PersistentVolumeClaim
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
        storageClassName: {{storageClassName}}
