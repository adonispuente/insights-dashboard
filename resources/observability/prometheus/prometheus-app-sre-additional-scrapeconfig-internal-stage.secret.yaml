apiVersion: v1
kind: Secret
metadata:
  name: prometheus-additional-scrape-config
  annotations:
    qontract.ignore_reconcile_time: "true"
data:
  prometheus-app-sre-additional.yaml:
    {{% b64encode %}}
    # Scraping external services
    # ci.int.devshift.net
    - job_name: 'jenkins_int'
      scrape_interval: 30s
      metrics_path: /prometheus
      basic_auth:
        username: {{{ vault('app-sre/ci-int/jjb-ini', 'username') }}}
        password: {{{ vault('app-sre/ci-int/jjb-ini', 'password') }}}
      static_configs:
      - targets: ['ci.int.devshift.net']
      scheme: https

    # Federation
    - job_name: federate-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"kube_pod_container_status_restarts_total"}'
        - '{__name__=~"kube_pod_info"}'
        - '{__name__=~"kube_pod_container_resource_limits"}'
        - '{__name__=~"kube_pod_status_ready"}'
        - '{__name__=~"kube_pod_container_status_ready"}'
        - '{__name__=~"kube_pod_container_resource_limits_cpu_cores"}'
        - '{__name__=~"kube_pod_container_resource_requests_cpu_cores"}'
        - '{__name__=~"kube_job_status_failed"}'
        - '{__name__=~"kube_replicationcontroller_status_ready_replicas"}'
        - '{__name__=~"kube_replicationcontroller_spec_replicas"}'
        - '{__name__=~"kube_pod_container_resource_limits_memory_bytes"}'
        - '{__name__=~"kube_pod_status_phase"}'
        - '{__name__=~"kube_deployment_status_replicas_available"}'
        - '{__name__=~"kube_pod_container_resource_requests_memory_bytes"}'
        - '{__name__=~"kube_pod_container_resource_requests"}'
        - '{__name__=~"kube_deployment_status_replicas_unavailable"}'
        - '{__name__=~"kube_node_labels"}'
        - '{__name__=~"kube_node_status_allocatable_memory_bytes"}'
        - '{__name__=~"kube_node_status_allocatable_cpu_cores"}'
        - '{__name__=~"kube_statefulset_status_replicas_updated"}'
        - '{__name__=~"kube_statefulset_status_replicas_ready"}'
        - '{__name__=~"kube_statefulset_status_replicas"}'
        - '{__name__=~"kube_resourcequota"}'
        - '{__name__=~"kube_pod_init_container_status_restarts_total"}'
        - '{__name__=~"kube_pod_container_status_last_terminated_reason"}'
        - '{__name__=~"node_namespace_pod:kube_pod_info:"}'
        - '{__name__=~"namespace:kube_pod_container_resource_requests_memory_bytes:sum"}'
        - '{__name__=~"namespace:kube_pod_container_resource_requests_cpu_cores:sum"}'
        - '{__name__=~"kube_pod_container_status_terminated_reason"}'
        - '{__name__=~"kube_persistentvolumeclaim_resource_requests_storage_bytes"}'
        - '{__name__=~":kube_persistentvolume_status_phase"}'
        - '{__name__=~":kube_job_status_succeeded"}'
        - '{__name__=~":kube_job_labels"}'
        - '{__name__=~":kube_deployment_status_replicas_updated"}'
        - '{__name__=~":kube_deployment_spec_replicas"}'
        - '{__name__=~":hive_kube_client_requests_total"}'
        - '{__name__=~":kube_pod_info_node_count:"}'
        - '{__name__=~"kube_node_status_allocatable"}'
        - '{__name__=~"kube_node_info"}'
        - '{__name__=~":job_cronjob:kube_job_status_start_time:max"}'
        - '{__name__=~"kube_persistentvolumeclaim_info"}'
        - '{__name__=~"kube_job_status_start_time"}'
        - '{__name__=~"namespace_cpu:kube_pod_container_resource_requests:sum"}'
        - '{__name__=~"namespace_cpu:kube_pod_container_resource_limits:sum"}'
        - '{__name__=~"kube_pod_resource_limit"}'
        - '{__name__=~"job_cronjob:kube_job_status_failed:sum"}'
        {{%- if is_tekton_cluster is defined and is_tekton_cluster %}}
        - '{__name__=~"tekton_pipelines_controller_pipelinerun_taskrun_duration_seconds"}'
        - '{__name__=~"tekton_pipelines_controller_pipelinerun_duration_seconds"}'
        {{%- endif %}}
      scrape_interval: 30s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      static_configs:
      - targets:
        - 'prometheus-k8s.openshift-monitoring.svc:9091'
    {{% endb64encode %}}
