apiVersion: v1
kind: Secret
metadata:
  name: prometheus-additional-scrape-config
data:
  prometheus-app-sre-additional.yaml:
    {{% b64encode %}}
    # Scraping external services
    # Hive
    ## Hive Integration
    - job_name: 'hive-aws-account-operator-integration'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['aws-account-operator-aws-account-operator.6943.hive-integration.openshiftapps.com']
    ## Hive Staging
    - job_name: 'hive-controllers-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.c39b.hive-stage.openshiftapps.com']
    - job_name: 'hive-aws-account-operator-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['aws-account-operator-aws-account-operator.c39b.hive-stage.openshiftapps.com']
    - job_name: 'hive-deadmanssnitch-operator-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['deadmanssnitch-operator-deadmanssnitch-operator.c39b.hive-stage.openshiftapps.com']
    - job_name: 'hive-pagerduty-operator-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['pagerduty-operator-pagerduty-operator.c39b.hive-stage.openshiftapps.com']
    - job_name: 'hive-certman-operator-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['certman-operator-certman-operator.c39b.hive-stage.openshiftapps.com']

    ## Hive Production
    - job_name: 'hive-controllers-production'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.a8df.hive-production.openshiftapps.com']
    - job_name: 'hive-aws-account-operator-production'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['aws-account-operator-aws-account-operator.a8df.hive-production.openshiftapps.com']
    - job_name: 'hive-pagerduty-operator-production'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['pagerduty-operator-pagerduty-operator.a8df.hive-production.openshiftapps.com']
    - job_name: 'hive-certman-operator-production'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['certman-operator-certman-operator.a8df.hive-production.openshiftapps.com']

    # ci.ext.devshift.net
    - job_name: 'jenkins_ext'
      scrape_interval: 30s
      metrics_path: /prometheus
      basic_auth:
        username: {{{ vault('app-sre/ci-ext/jjb-ini', 'username') }}}
        password: {{{ vault('app-sre/ci-ext/jjb-ini', 'password') }}}
      static_configs:
      - targets: ['ci.ext.devshift.net']

    # Production Red Hat SSO: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_sso'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        - https://sso.redhat.com/auth/realms/redhat-external/protocol/saml/clients/legacy-idp-servlets

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Production Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_prod'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # External dependencies
        - https://vault.devshift.net/
        - https://forge.api.openshift.io/health
        - https://recommender.api.openshift.io/api/v1
        - https://openshift.io
        - https://api.openshift.io/api/status
        - https://ci.centos.org/

        - https://stack-analytics-report.openshift.io/

        - https://registry.reg-aws.openshift.com/
        - https://recommender.api.prod-preview.openshift.io/api/v1

        # SSO
        - https://sso.openshift.io/auth/realms/fabric8/.well-known/openid-configuration

        # Customer-facing endpoints
        - https://api.openshift.com/
        - https://infogw.api.openshift.com
        - https://code.quarkus.io/
        - https://sentry.devshift.net/_health/

        # OSIO
        - https://console.dsaas.openshift.com/

        ## Quay.io
        - https://quay.io

        ## cloud.redhat.com (Red Hat Insights)
        - https://cloud.redhat.com

        ## codenvy.com - redirects traffic to che.openshift.io (by links, not a http 30x redirect yet)
        - https://codenvy.com

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Production OSIO 1a token: Blackbox exporter check - alert
    - job_name: 'blackbox_osio_1a_token'
      scrape_interval: 300s
      metrics_path: /probe
      params:
        module: [http_osio_1a]
      static_configs:
      - targets:
        # Starter cluster 1a endpoints
        - https://api.starter-us-east-1a.openshift.com/oapi/v1

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Production OSIO 1b token: Blackbox exporter check - alert
    - job_name: 'blackbox_osio_1b_token'
      scrape_interval: 300s
      metrics_path: /probe
      params:
        module: [http_osio_1b]
      static_configs:
      - targets:
        # Starter cluster 1b endpoints
        - https://api.starter-us-east-1b.openshift.com/oapi/v1

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Production OSIO 2 token: Blackbox exporter check - alert
    - job_name: 'blackbox_osio_2_token'
      scrape_interval: 300s
      metrics_path: /probe
      params:
        module: [http_osio_2]
      static_configs:
      - targets:
        # Starter cluster 2 endpoints
        - https://api.starter-us-east-2.openshift.com/oapi/v1

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Production OSIO 2a token: Blackbox exporter check - alert
    - job_name: 'blackbox_osio_2a_token'
      scrape_interval: 300s
      metrics_path: /probe
      params:
        module: [http_osio_2a]
      static_configs:
      - targets:
        # Starter cluster 2a endpoints
        - https://api.starter-us-east-2a.openshift.com/oapi/v1

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Production Routes: Blackbox exporter 2xx checks - warning
    - job_name: 'blackbox_2xx_prod_warning'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # External dependencies
        - https://mandrillapp.com/api/1.0/
        - https://github.com/

        # Starter cluster metrics endpoints
        - https://metrics.starter-us-east-1a.openshift.com/hawkular/metrics
        - https://metrics.starter-us-east-2a.openshift.com/hawkular/metrics
        - https://metrics.starter-us-east-2.openshift.com/hawkular/metrics
        - https://metrics.starter-us-east-1b.openshift.com/hawkular/metrics

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Staging Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_stage'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # Prod routes, but not managed by app-sre
        - https://www.openshift.com/
        - https://cloud.redhat.com/

        # All Staging routes
        - https://api.stage.openshift.com/
        - https://vault.stage.devshift.net/
        - https://console.dsaas-stg.openshift.com/
        - https://infogw.api.stage.openshift.com/
        - https://stage.code.quarkus.io/
        - https://api.prod-preview.openshift.io/api/status
        - https://forge.api.prod-preview.openshift.io/health
        - https://sso.prod-preview.openshift.io/auth/realms/fabric8/.well-known/openid-configuration

        - https://prod-preview.openshift.io/
        - https://stack-analytics-report.prod-preview.openshift.io/
        - https://sentry.stage.devshift.net/_health/

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    - job_name: 'blackbox_3xx_prod'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_3xx]
      static_configs:
      - targets:
          # External dependencies that redirect
          - https://cloud.openshift.com
          # SSO
          - https://sso.redhat.com
          - https://sso.redhat.com/legacy/idp
          # codenvy.io redirects to che.openshift.io
          - https://codenvy.io
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    - job_name: 'blackbox_exporter_ci_ext'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_ci_ext]
      static_configs:
      - targets:
          - https://ci.ext.devshift.net/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Telemeter Infogw endpoints
    # Uses custom blackbox exporter modules to validate beyond auth proxy

    - job_name: 'blackbox_exporter_infogw_data_prod'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [infogw-data]
      static_configs:
      - targets:
          - https://infogw-data.api.openshift.com/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    - job_name: 'blackbox_exporter_infogw_data_stage'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [infogw-data]
      static_configs:
      - targets:
          - https://infogw-data.api.stage.openshift.com/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter.app-sre-observability-production.svc.cluster.local:9115 # The blackbox exporter.

    # Federation
    - job_name: federate-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"kube_.*"}'
        - '{__name__=~"kubelet_volume_stats_.*"}'
        - '{__name__=~"container_cpu_usage_seconds_total"}'
        - '{__name__=~"container_memory_rss"}'
        - '{__name__=~"container_network_receive_bytes_total"}'
        - '{__name__=~"container_network_transmit_bytes_total"}'
        - '{__name__=~":kube_pod_info_node_count:"}'
        - '{__name__=~":node_cpu_saturation_load1:"}'
        - '{__name__=~":node_cpu_utilisation:avg1m"}'
        - '{__name__=~":node_disk_saturation:avg_irate"}'
        - '{__name__=~":node_disk_utilisation:avg_irate"}'
        - '{__name__=~":node_memory_MemFreeCachedBuffers:sum"}'
        - '{__name__=~":node_memory_MemTotal:sum"}'
        - '{__name__=~":node_memory_swap_io_bytes:sum_rate"}'
        - '{__name__=~":node_memory_utilisation:"}'
        - '{__name__=~"cluster:container_cpu_usage:ratio"}'
        - '{__name__=~"cluster:container_spec_cpu_shares:ratio"}'
        - '{__name__=~"cluster:memory_usage:ratio"}'
        - '{__name__=~"cluster:node_cpu:sum_rate5m"}'
        - '{__name__=~"cluster_quantile:apiserver_request_latencies:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_binding_latency:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_e2e_scheduling_latency:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_scheduling_algorithm_latency:histogram_quantile"}'
        - '{__name__=~"instance:node_cpu:rate:sum"}'
        - '{__name__=~"instance:node_cpu:ratio"}'
        - '{__name__=~"instance:node_filesystem_usage:sum"}'
        - '{__name__=~"instance:node_network_receive_bytes:rate:sum"}'
        - '{__name__=~"instance:node_network_transmit_bytes:rate:sum"}'
        - '{__name__=~"namespace:container_cpu_usage:sum"}'
        - '{__name__=~"namespace:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"namespace:container_memory_usage_bytes:sum"}'
        - '{__name__=~"namespace:container_spec_cpu_shares:sum"}'
        - '{__name__=~"namespace_name:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"namespace_name:container_memory_usage_bytes:sum"}'
        - '{__name__=~"namespace:kube_pod_container_resource_requests_cpu_cores:sum"}'
        - '{__name__=~"namespace:kube_pod_container_resource_requests_memory_bytes:sum"}'
        - '{__name__=~"namespace_pod_name_container_name:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"node:node_cpu_saturation_load1:"}'
        - '{__name__=~"node:node_cpu_utilisation:avg1m"}'
        - '{__name__=~"node:node_disk_saturation:avg_irate"}'
        - '{__name__=~"node:node_disk_utilisation:avg_irate"}'
        - '{__name__=~"node:node_filesystem_avail:"}'
        - '{__name__=~"node:node_filesystem_usage:"}'
        - '{__name__=~"node:node_memory_bytes_available:sum"}'
        - '{__name__=~"node:node_memory_bytes_total:sum"}'
        - '{__name__=~"node:node_memory_swap_io_bytes:sum_rate"}'
        - '{__name__=~"node:node_memory_utilisation:"}'
        - '{__name__=~"node:node_memory_utilisation:ratio"}'
        - '{__name__=~"node:node_memory_utilisation_2:"}'
        - '{__name__=~"node:node_num_cpu:sum"}'
        - '{__name__=~"node_namespace_pod:kube_pod_info:"}'
        - '{__name__=~"pod_name:container_cpu_usage:sum"}'
        - '{__name__=~"pod_name:container_fs_usage_bytes:sum"}'
        - '{__name__=~"pod_name:container_memory_usage_bytes:sum"}'
        - '{__name__=~"pod_name:container_spec_cpu_shares:sum"}'
        - '{__name__=~"container_memory_usage_bytes"}'
        - '{__name__=~"container_cpu_cfs_throttled_seconds_total"}'
        - '{__name__=~"container_memory_working_set_bytes"}'
        - '{__name__=~"haproxy_backend_connections_total"}'
        - '{__name__=~"haproxy_server_http_responses_total"}'
        - '{__name__=~"haproxy_server_http_average_response_latency_milliseconds"}'
        - '{__name__=~"es_cluster_status"}'
        - '{__name__=~"es_fs_path_free_bytes"}'
        - '{__name__=~"es_fs_path_total_bytes"}'
      scrape_interval: 30s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      static_configs:
      - targets:
        - 'prometheus-k8s.openshift-monitoring.svc:9091'
    - job_name: federate-starter-us-east-2-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"node_cpu"}'
        - '{__name__=~":node_memory_MemFreeCachedBuffers:sum"}'
        - '{__name__=~":node_memory_MemTotal:sum"}'
      scrape_interval: 60s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      # openshift-monitoring/prometheus-k8s
      bearer_token: {{{ vault('app-interface/app-sre/app-sre-observability-production/grafana/datasources', 'starter-us-east-2-cluster-prometheus') }}}
      static_configs:
      - targets:
        - 'prometheus-k8s-openshift-monitoring.8a09.starter-us-east-2.openshiftapps.com'
    - job_name: federate-starter-us-east-2a-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"node_cpu"}'
        - '{__name__=~":node_memory_MemFreeCachedBuffers:sum"}'
        - '{__name__=~":node_memory_MemTotal:sum"}'
      scrape_interval: 60s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      # openshift-monitoring/prometheus-k8s
      bearer_token: {{{ vault('app-interface/app-sre/app-sre-observability-production/grafana/datasources', 'starter-us-east-2a-cluster-prometheus') }}}
      static_configs:
      - targets:
        - 'prometheus-k8s-openshift-monitoring.b542.starter-us-east-2a.openshiftapps.com'
    - job_name: federate-starter-us-east-1a-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"node_cpu"}'
        - '{__name__=~":node_memory_MemFreeCachedBuffers:sum"}'
        - '{__name__=~":node_memory_MemTotal:sum"}'
      scrape_interval: 60s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      # openshift-monitoring/prometheus-k8s
      bearer_token: {{{ vault('app-interface/app-sre/app-sre-observability-production/grafana/datasources', 'starter-us-east-1a-cluster-prometheus') }}}
      static_configs:
      - targets:
        - 'prometheus-k8s-openshift-monitoring.9a6d.starter-us-east-1a.openshiftapps.com'
    - job_name: federate-starter-us-east-1b-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"node_cpu"}'
        - '{__name__=~":node_memory_MemFreeCachedBuffers:sum"}'
        - '{__name__=~":node_memory_MemTotal:sum"}'
      scrape_interval: 60s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      # openshift-monitoring/prometheus-k8s
      bearer_token: {{{ vault('app-interface/app-sre/app-sre-observability-production/grafana/datasources', 'starter-us-east-1b-cluster-prometheus') }}}
      static_configs:
      - targets:
        - 'prometheus-k8s-openshift-monitoring.4e1e.starter-us-east-1b.openshiftapps.com'
    - job_name: federate-hive-integration-cluster-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"haproxy_backend_connections_total"}'
        - '{__name__=~"haproxy_server_http_responses_total"}'
        - '{__name__=~"haproxy_server_http_average_response_latency_milliseconds"}'
        - '{__name__=~"kube_.*"}'
      scrape_interval: 60s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      # openshift-monitoring/prometheus-k8s
      bearer_token: {{{ vault('app-sre/creds/kube-configs/hive-integration', 'token') }}}
      static_configs:
      - targets:
        - 'prometheus-k8s-openshift-monitoring.6943.hive-integration.openshiftapps.com'
    - job_name: federate-hive-stage-cluster-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"haproxy_backend_connections_total"}'
        - '{__name__=~"haproxy_server_http_responses_total"}'
        - '{__name__=~"haproxy_server_http_average_response_latency_milliseconds"}'
        - '{__name__=~"kube_.*"}'
      scrape_interval: 60s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      # openshift-monitoring/prometheus-k8s
      bearer_token: {{{ vault('app-sre/creds/kube-configs/hive-stage', 'token') }}}
      static_configs:
      - targets:
        - 'prometheus-k8s-openshift-monitoring.c39b.hive-stage.openshiftapps.com'          
    - job_name: federate-hive-production-cluster-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"haproxy_backend_connections_total"}'
        - '{__name__=~"haproxy_server_http_responses_total"}'
        - '{__name__=~"haproxy_server_http_average_response_latency_milliseconds"}'
        - '{__name__=~"kube_.*"}'
      scrape_interval: 60s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      # openshift-monitoring/prometheus-k8s
      bearer_token: {{{ vault('app-sre/creds/kube-configs/hive-production', 'token') }}}
      static_configs:
      - targets:
        - 'prometheus-k8s-openshift-monitoring.a8df.hive-production.openshiftapps.com'        
    {{% endb64encode %}}
