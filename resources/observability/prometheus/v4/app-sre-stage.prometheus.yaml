apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: app-sre
spec:
  additionalAlertManagerConfigs:
    key: alertmanager-app-sre.yaml
    name: prometheus-additional-alertmanager-config
  additionalScrapeConfigs:
    key: prometheus-app-sre-additional.yaml
    name: prometheus-additional-scrape-config
  baseImage: quay.io/prometheus/prometheus
  externalLabels:
    cluster: {{clusterLabel}}
    environment: {{environment}}
  externalUrl: {{externalUrl}}
  replicas: 2
  retention: {{retention}}
  walCompression: {{walCompression}}
  ruleSelector:
    matchLabels:
      prometheus: app-sre
  secrets:
  - prometheus-auth-proxy
  securityContext: {}
  serviceAccountName: prometheus-k8s
  serviceMonitorSelector:
    matchLabels:
      prometheus: app-sre
  storage:
    volumeClaimTemplate:
      apiVersion: v1
      kind: PersistentVolumeClaim
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: {{pvSize}}
        storageClassName: gp2
  version: {{version}}
  containers:
  - args:
    - -provider=github
    - -http-address=:3000
    - -https-address=
    - -htpasswd-file=/etc/proxy/htpasswd/auth
    - -email-domain=*
    - -upstream=http://prometheus-app-sre.openshift-customer-monitoring.svc:9090
    - -github-org=app-sre
    - -github-team=app-sre-observability
    env:
    - name: OAUTH2_PROXY_CLIENT_ID
      valueFrom:
        secretKeyRef:
          key: client-id
          name: prometheus-auth-proxy
    - name: OAUTH2_PROXY_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          key: client-secret
          name: prometheus-auth-proxy
    - name: OAUTH2_PROXY_COOKIE_SECRET
      valueFrom:
        secretKeyRef:
          key: cookie-secret
          name: prometheus-auth-proxy
    image: quay.io/pusher/oauth2_proxy:v4.0.0
    imagePullPolicy: Always
    name: prometheus-proxy
    ports:
    - containerPort: 3000
      name: http
      protocol: TCP
    readinessProbe:
      failureThreshold: 3
      periodSeconds: 10
      successThreshold: 1
      tcpSocket:
        port: http
      timeoutSeconds: 1
    volumeMounts:
    - mountPath: /etc/proxy/htpasswd
      name: secret-prometheus-auth-proxy
