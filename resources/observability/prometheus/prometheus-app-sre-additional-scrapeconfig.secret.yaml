apiVersion: v1
kind: Secret
metadata:
  name: prometheus-app-sre-additional-scrapeconfig
data:
  prometheus-app-sre-additional.yaml:
    {{% b64encode %}}
    # Scraping external services
    # Hive
    ## Hive Integration
    - job_name: 'hive-aws-account-operator-integration'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['aws-account-operator-aws-account-operator.6943.hive-integration.openshiftapps.com']
    ## Hive Staging
    - job_name: 'hive-controllers-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.c39b.hive-stage.openshiftapps.com']
    - job_name: 'hive-aws-account-operator-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['aws-account-operator-aws-account-operator.c39b.hive-stage.openshiftapps.com']
    - job_name: 'hive-deadmanssnitch-operator-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['deadmanssnitch-operator-deadmanssnitch-operator.c39b.hive-stage.openshiftapps.com']
    - job_name: 'hive-pagerduty-operator-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['pagerduty-operator-pagerduty-operator.c39b.hive-stage.openshiftapps.com']
    - job_name: 'hive-certman-operator-stage'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['certman-operator-certman-operator.c39b.hive-stage.openshiftapps.com']

    ## Hive Production
    - job_name: 'hive-controllers-production'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.a8df.hive-production.openshiftapps.com']
    - job_name: 'hive-aws-account-operator-production'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['aws-account-operator-aws-account-operator.a8df.hive-production.openshiftapps.com']

    # ci.ext.devshift.net
    - job_name: 'jenkins_ext'
      scrape_interval: 30s
      metrics_path: /prometheus
      basic_auth:
        username: {{{ vault('app-sre/ci-ext/jjb-ini', 'username') }}}
        password: {{{ vault('app-sre/ci-ext/jjb-ini', 'password') }}}
      static_configs:
      - targets: ['ci.ext.devshift.net']

    # Production Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_prod'
      scheme: https
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # External dependencies
        - https://zabbix.devshift.net:9443/zabbix
        - https://developers.redhat.com/
        - https://vault.devshift.net/
        - https://forge.api.openshift.io/health
        - https://recommender.api.openshift.io/api/v1
        - https://openshift.io
        - https://api.openshift.io/api/status
        - https://mandrillapp.com/api/1.0/
        - https://ci.centos.org/

        # Starter cluster metrics endpoints
        - https://metrics.starter-us-east-1a.openshift.com/hawkular/metrics
        - https://metrics.starter-us-east-2a.openshift.com/hawkular/metrics
        - https://metrics.starter-us-east-2.openshift.com/hawkular/metrics
        - https://metrics.starter-us-east-1b.openshift.com/hawkular/metrics

        - https://developers.redhat.com/auth/realms/rhd
        - https://stack-analytics-report.openshift.io/

        - https://zabbix.codenvycorp.com/
        - https://registry.reg-aws.openshift.com/
        - https://recommender.api.prod-preview.openshift.io/api/v1

        # SSO
        - https://sso.redhat.com/auth/realms/redhat-external/protocol/saml/clients/legacy-idp-servlets
        - https://sso.openshift.io/auth/realms/fabric8/.well-known/openid-configuration
        - https://sso.prod-preview.openshift.io/auth/realms/fabric8/.well-known/openid-configuration

        # OSD cluster consoles
        - https://console.app-sre.openshift.com/

        # Customer-facing endpoints
        - https://api.openshift.com/
        - https://try.openshift.com/
        - https://infogw.api.openshift.com
        - https://code.quarkus.io/

        # OSIO
        - https://console.dsaas.openshift.com/

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter-app-sre-exporters.1061.app-sre.openshiftapps.com # The blackbox exporter.

    # Staging Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_stage'
      scheme: https
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # Prod routes, but not managed by app-sre
        - https://www.openshift.com/
        - https://cloud.redhat.com/

        # All Staging routes
        - https://api.stage.openshift.com/
        - https://console.app-sre-stage.openshift.com/
        - https://vault.stage.devshift.net/
        - https://console.dsaas-stg.openshift.com/
        - https://infogw.api.stage.openshift.com/
        - https://stage.code.quarkus.io/
        - https://api.prod-preview.openshift.io/api/status
        - https://forge.api.prod-preview.openshift.io/health

        - https://errortracking.prod-preview.openshift.io/_health/
        - https://prod-preview.openshift.io/
        - https://stack-analytics-report.prod-preview.openshift.io/

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter-app-sre-exporters.1061.app-sre.openshiftapps.com # The blackbox exporter.

    - job_name: 'blackbox_3xx_prod'
      scheme: https
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_3xx]
      static_configs:
      - targets:
          # External dependencies that redirect
          - http://try.openshift.com
          - https://cloud.openshift.com
          # SSO
          - https://sso.redhat.com
          - https://sso.redhat.com/legacy/idp
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter-app-sre-exporters.1061.app-sre.openshiftapps.com # The blackbox exporter.

    - job_name: 'blackbox_exporter_ci_ext'
      scheme: https
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_ci_ext]
      static_configs:
      - targets:
          - https://ci.ext.devshift.net/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter-app-sre-exporters.1061.app-sre.openshiftapps.com # The blackbox exporter.

    - job_name: 'blackbox_http_body_content_try_openshift_com'
      scheme: https
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_body_content_try_openshift_com]
      static_configs:
      - targets:
          - http://try.openshift.com
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter-app-sre-exporters.1061.app-sre.openshiftapps.com # The blackbox exporter.


    # Telemeter Infogw endpoints
    # Uses custom blackbox exporter modules to validate beyond auth proxy

    - job_name: 'blackbox_exporter_infogw_data_prod'
      scheme: https
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [infogw-data]
      static_configs:
      - targets:
          - https://infogw-data.api.openshift.com/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter-app-sre-exporters.1061.app-sre.openshiftapps.com # The blackbox exporter.

    - job_name: 'blackbox_exporter_infogw_data_stage'
      scheme: https
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [infogw-data]
      static_configs:
      - targets:
          - https://infogw-data.api.stage.openshift.com/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter-app-sre-exporters.1061.app-sre.openshiftapps.com # The blackbox exporter.

    # Federation
    - job_name: federate-app-sre-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"kube_.*"}'
        - '{__name__=~"kubelet_volume_stats_.*"}'
        - '{__name__=~"container_cpu_usage_seconds_total"}'
        - '{__name__=~"container_memory_rss"}'
        - '{__name__=~"container_network_receive_bytes_total"}'
        - '{__name__=~"container_network_transmit_bytes_total"}'
        - '{__name__=~":kube_pod_info_node_count:"}'
        - '{__name__=~":node_cpu_saturation_load1:"}'
        - '{__name__=~":node_cpu_utilisation:avg1m"}'
        - '{__name__=~":node_disk_saturation:avg_irate"}'
        - '{__name__=~":node_disk_utilisation:avg_irate"}'
        - '{__name__=~":node_memory_MemFreeCachedBuffers:sum"}'
        - '{__name__=~":node_memory_MemTotal:sum"}'
        - '{__name__=~":node_memory_swap_io_bytes:sum_rate"}'
        - '{__name__=~":node_memory_utilisation:"}'
        - '{__name__=~"cluster:container_cpu_usage:ratio"}'
        - '{__name__=~"cluster:container_spec_cpu_shares:ratio"}'
        - '{__name__=~"cluster:memory_usage:ratio"}'
        - '{__name__=~"cluster:node_cpu:sum_rate5m"}'
        - '{__name__=~"cluster_quantile:apiserver_request_latencies:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_binding_latency:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_e2e_scheduling_latency:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_scheduling_algorithm_latency:histogram_quantile"}'
        - '{__name__=~"instance:node_cpu:rate:sum"}'
        - '{__name__=~"instance:node_cpu:ratio"}'
        - '{__name__=~"instance:node_filesystem_usage:sum"}'
        - '{__name__=~"instance:node_network_receive_bytes:rate:sum"}'
        - '{__name__=~"instance:node_network_transmit_bytes:rate:sum"}'
        - '{__name__=~"namespace:container_cpu_usage:sum"}'
        - '{__name__=~"namespace:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"namespace:container_memory_usage_bytes:sum"}'
        - '{__name__=~"namespace:container_spec_cpu_shares:sum"}'
        - '{__name__=~"namespace_name:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"namespace_name:container_memory_usage_bytes:sum"}'
        - '{__name__=~"namespace_name:kube_pod_container_resource_requests_cpu_cores:sum"}'
        - '{__name__=~"namespace_name:kube_pod_container_resource_requests_memory_bytes:sum"}'
        - '{__name__=~"namespace_pod_name_container_name:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"node:node_cpu_saturation_load1:"}'
        - '{__name__=~"node:node_cpu_utilisation:avg1m"}'
        - '{__name__=~"node:node_disk_saturation:avg_irate"}'
        - '{__name__=~"node:node_disk_utilisation:avg_irate"}'
        - '{__name__=~"node:node_filesystem_avail:"}'
        - '{__name__=~"node:node_filesystem_usage:"}'
        - '{__name__=~"node:node_memory_bytes_available:sum"}'
        - '{__name__=~"node:node_memory_bytes_total:sum"}'
        - '{__name__=~"node:node_memory_swap_io_bytes:sum_rate"}'
        - '{__name__=~"node:node_memory_utilisation:"}'
        - '{__name__=~"node:node_memory_utilisation:ratio"}'
        - '{__name__=~"node:node_memory_utilisation_2:"}'
        - '{__name__=~"node:node_num_cpu:sum"}'
        - '{__name__=~"node_namespace_pod:kube_pod_info:"}'
        - '{__name__=~"pod_name:container_cpu_usage:sum"}'
        - '{__name__=~"pod_name:container_fs_usage_bytes:sum"}'
        - '{__name__=~"pod_name:container_memory_usage_bytes:sum"}'
        - '{__name__=~"pod_name:container_spec_cpu_shares:sum"}'
        - '{__name__=~"container_memory_usage_bytes"}'
        - '{__name__=~"container_cpu_cfs_throttled_seconds_total"}'
        - '{__name__=~"container_memory_working_set_bytes"}'
      scrape_interval: 30s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      static_configs:
      - targets:
        - 'prometheus-k8s-with-affinity.openshift-monitoring.svc:9091'
    - job_name: federate-starter-us-east-2-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"node_cpu"}'
        - '{__name__=~":node_memory_MemFreeCachedBuffers:sum"}'
        - '{__name__=~":node_memory_MemTotal:sum"}'
      scrape_interval: 60s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      bearer_token: 86hW_MApfiO33OHM_stg7vm8qU3lEW7EZxU2okEGNZE
      static_configs:
      - targets:
        - 'prometheus-k8s-openshift-monitoring.8a09.starter-us-east-2.openshiftapps.com'
    {{% endb64encode %}}
