apiVersion: v1
kind: Secret
metadata:
  name: prometheus-additional-scrape-config
  annotations:
    qontract.ignore_reconcile_time: "true"
data:
  prometheus-app-sre-additional.yaml:
    {{% b64encode %}}
    # Scraping external services
    # Hive

    ## hive-stage-01
    - job_name: 'hive-controllers-hive-stage-01'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hive-stage-01.n1u3.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: staging
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/stage.yml
      - target_label: shard_status
        replacement: active

    ## hives02ue1
    - job_name: 'hive-controllers-hives02ue1'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hives02ue1.j5l5.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: staging
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/stage.yml
      - target_label: shard_status
        replacement: active

    ## hivep01ue1
    - job_name: 'hive-controllers-hivep01ue1'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hivep01ue1.b6s7.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: production
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/production.yml
      - target_label: shard_status
        replacement: active

    ## hivep02ue1
    - job_name: 'hive-controllers-hivep02ue1'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hivep02ue1.p0r5.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: production
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/production.yml
      - target_label: shard_status
        replacement: active

    ## hivep03uw1
    - job_name: 'hive-controllers-hivep03uw1'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hivep03uw1.o2y3.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: production
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/production.yml
      - target_label: shard_status
        replacement: maintenance

    ## hivep04ew2
    - job_name: 'hive-controllers-hivep04ew2'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hivep04ew2.byo5.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: production
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/production.yml
      - target_label: shard_status
        replacement: active

    ## hivep05ue1
    - job_name: 'hive-controllers-hivep05ue1'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hivep05ue1.pfj0.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: production
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/production.yml
      - target_label: shard_status
        replacement: active

    ## hivep06uw2
    - job_name: 'hive-controllers-hivep06uw2'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hivep06uw2.bjee.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: production
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/production.yml
      - target_label: shard_status
        replacement: active

    ## hivep07ue2
    - job_name: 'hive-controllers-hivep07ue2'
      scrape_interval: 60s
      metrics_path: /metrics
      static_configs:
      - targets: ['hive-controllers-metrics-hive.apps.hivep07ue2.vvyl.p1.openshiftapps.com']
      metric_relabel_configs:
      - source_labels: [__name__]
        regex: '^rest_client_.*'
        action: drop
      relabel_configs:
      - source_labels: [__address__]
        regex: (.*)
        separator: ;
        target_label: appsre_env
        replacement: production
        action: replace
      # This `shard_status` label should match the actual hive shard status from data/services/ocm/shared-resources/production.yml
      - target_label: shard_status
        replacement: maintenance

    # Scrape config for RHOSAK stage
    - job_name: "ocm-production-consoledot-kafka-crcs02ue1"
      static_configs:
      - targets: ["api.openshift.com"]
      scheme: "https"
      metrics_path: {{{ vault('insights/secrets/insights-stage/strimzi-stage/metrics', 'metrics_path', 2) }}}
      oauth2:
        client_id: {{{ vault('insights/secrets/insights-stage/strimzi-stage/metrics', 'client_id', 2) }}}
        client_secret: {{{ vault('insights/secrets/insights-stage/strimzi-stage/metrics', 'client_secret', 2) }}}
        token_url: {{{ vault('insights/secrets/insights-stage/strimzi-stage/metrics', 'token_url', 2) }}}

    # ci.ext.devshift.net
    - job_name: 'jenkins_ext'
      scrape_interval: 30s
      metrics_path: /prometheus
      basic_auth:
        username: {{{ vault('app-sre/ci-ext/jjb-ini', 'username') }}}
        password: {{{ vault('app-sre/ci-ext/jjb-ini', 'password') }}}
      static_configs:
      - targets: ['ci.ext.devshift.net']

    # Production Red Hat SSO: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_sso'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        - https://sso.redhat.com/auth/realms/redhat-external/.well-known/openid-configuration

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    # Production Routes: Blackbox exporter 2xx checks - critical severity
    - job_name: 'blackbox_2xx_prod_critical'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        ## codenvy.com - redirects traffic to che.openshift.io (by links, not a http 30x redirect yet)
        - https://codenvy.com

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    # Staging Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_stage'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # Prod routes, but not managed by app-sre
        - https://www.openshift.com/

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    - job_name: 'blackbox_3xx_prod'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_3xx]
      static_configs:
      - targets:
          # SSO
          - https://sso.redhat.com
          # codenvy.io redirects to che.openshift.io
          - https://codenvy.io
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    - job_name: 'blackbox_exporter_ci_ext'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_ci_ext]
      static_configs:
      - targets:
          - https://ci.ext.devshift.net/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    # Devfile.io prod Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_devfile_2xx_prod'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # External dependencies
        - https://registry.devfile.io/health
        - https://devfile.io/

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.
    
    # Devfile.io stage Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_devfile_2xx_stage'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # Stage devfile routes
        - https://registry.stage.devfile.io/health

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    # Devfile.io redirect Routes: Blackbox exporter 3xx checks
    - job_name: 'blackbox_devfile_3xx_prod'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [http_3xx]
      static_configs:
      - targets:
          # Devfile.io URls that redirect
          - https://docs.devfile.io

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    # Telemeter Infogw endpoints
    # Uses custom blackbox exporter modules to validate beyond auth proxy

    - job_name: 'blackbox_exporter_infogw_prod'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [infogw-prod]
      static_configs:
      - targets:
          - https://infogw-data.api.openshift.com/
          - https://infogw-proxy.api.openshift.com/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    - job_name: 'blackbox_exporter_infogw_stage'
      scrape_interval: 10s
      metrics_path: /probe
      params:
        module: [infogw-stage]
      static_configs:
      - targets:
          - https://infogw-data.api.stage.openshift.com/
          - https://infogw-proxy.api.stage.openshift.com/
      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.
    
    # Staging Unleash Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_unleash_stage'
      scrape_interval: 30s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # All Staging routes
        - https://app-interface.unleash.stage.devshift.net/
        - https://insights-stage.unleash.devshift.net/
        - https://insights-perf.unleash.devshift.net/
        - https://managed-services.unleash.stage.devshift.net/
        - https://ocm-integration.unleash.devshift.net/
        - https://ocm-stage.unleash.devshift.net/

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    # Production Unleash Routes: Blackbox exporter 2xx checks
    - job_name: 'blackbox_2xx_unleash_production'
      scrape_interval: 30s
      metrics_path: /probe
      params:
        module: [http_2xx]
      static_configs:
      - targets:
        # All Production routes
        - https://app-interface.unleash.devshift.net/
        - https://insights.unleash.devshift.net/
        - https://managed-services.unleash.devshift.net/
        - https://ocm.unleash.devshift.net/

      relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{{ blackbox_exporter_svc_url }}} # The blackbox exporter.

    - job_name: quay_domain_expiration_production
      scrape_interval: 10s
      metrics_path: /probe
      relabel_configs:
        - source_labels: [__address__]
          target_label: __param_target
        - target_label: __address__
          replacement: {{{ domain_exporter_svc_url }}} # Domain exporter.
      static_configs:
        - targets:
          - quay.io

    - job_name: appsre_domain_expiration_production
      scrape_interval: 10s
      metrics_path: /probe
      relabel_configs:
        - source_labels: [__address__]
          target_label: __param_target
        - target_label: __address__
          replacement: {{{ domain_exporter_svc_url }}} # Domain exporter.
      static_configs:
        - targets:
          - devshift.net

    - job_name: ci_ext_jenkins_slaves
      scheme: http
      scrape_interval: 20s
      scrape_timeout: 20s
      metrics_path: /metrics
      static_configs:
        - targets:
          - 192.168.18.10:9100
          - 192.168.18.11:9100
          - 192.168.18.12:9100
          - 192.168.18.14:9100
          - 192.168.18.15:9100
          - 192.168.18.16:9100
          - 192.168.18.17:9100
          - 192.168.18.18:9100

    - job_name: ci_ext_jenkins_controller
      scheme: http
      scrape_interval: 20s
      scrape_timeout: 20s
      metrics_path: /metrics
      static_configs:
        - targets:
          - 192.168.17.10:9100

    - job_name: ci_ext_bastion_node
      scheme: http
      scrape_interval: 20s
      scrape_timeout: 20s
      metrics_path: /metrics
      static_configs:
        - targets:
          - 192.168.19.10:9100

    # Federation
    - job_name: federate-cluster-monitoring-prometheus
      honor_labels: true
      params:
        match[]:
        - '{__name__=~"kube_.*"}'
        - '{__name__=~"kubelet_volume_stats_.*"}'
        - '{__name__=~"container_cpu_usage_seconds_total"}'
        - '{__name__=~"container_memory_rss"}'
        - '{__name__=~"container_network_receive_bytes_total"}'
        - '{__name__=~"container_network_transmit_bytes_total"}'
        - '{__name__=~":kube_pod_info_node_count:"}'
        - '{__name__=~":node_cpu_saturation_load1:"}'
        - '{__name__=~":node_cpu_utilisation:avg1m"}'
        - '{__name__=~":node_disk_saturation:avg_irate"}'
        - '{__name__=~":node_disk_utilisation:avg_irate"}'
        - '{__name__=~":node_memory_MemFreeCachedBuffers:sum"}'
        - '{__name__=~":node_memory_MemTotal:sum"}'
        - '{__name__=~":node_memory_swap_io_bytes:sum_rate"}'
        - '{__name__=~":node_memory_utilisation:"}'
        - '{__name__=~"cluster:container_cpu_usage:ratio"}'
        - '{__name__=~"cluster:container_spec_cpu_shares:ratio"}'
        - '{__name__=~"cluster:memory_usage:ratio"}'
        - '{__name__=~"cluster:node_cpu:sum_rate5m"}'
        - '{__name__=~"cluster_quantile:apiserver_request_latencies:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_binding_latency:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_e2e_scheduling_latency:histogram_quantile"}'
        - '{__name__=~"cluster_quantile:scheduler_scheduling_algorithm_latency:histogram_quantile"}'
        - '{__name__=~"instance:node_cpu:rate:sum"}'
        - '{__name__=~"instance:node_cpu:ratio"}'
        - '{__name__=~"instance:node_filesystem_usage:sum"}'
        - '{__name__=~"instance:node_network_receive_bytes:rate:sum"}'
        - '{__name__=~"instance:node_network_transmit_bytes:rate:sum"}'
        - '{__name__=~"namespace:container_cpu_usage:sum"}'
        - '{__name__=~"namespace:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"namespace:container_memory_usage_bytes:sum"}'
        - '{__name__=~"namespace:container_spec_cpu_shares:sum"}'
        - '{__name__=~"namespace_name:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"namespace_name:container_memory_usage_bytes:sum"}'
        - '{__name__=~"namespace:kube_pod_container_resource_requests_cpu_cores:sum"}'
        - '{__name__=~"namespace:kube_pod_container_resource_requests_memory_bytes:sum"}'
        - '{__name__=~"namespace_pod_name_container_name:container_cpu_usage_seconds_total:sum_rate"}'
        - '{__name__=~"node:node_cpu_saturation_load1:"}'
        - '{__name__=~"node:node_cpu_utilisation:avg1m"}'
        - '{__name__=~"node:node_disk_saturation:avg_irate"}'
        - '{__name__=~"node:node_disk_utilisation:avg_irate"}'
        - '{__name__=~"node:node_filesystem_avail:"}'
        - '{__name__=~"node:node_filesystem_usage:"}'
        - '{__name__=~"node:node_memory_bytes_available:sum"}'
        - '{__name__=~"node:node_memory_bytes_total:sum"}'
        - '{__name__=~"node:node_memory_swap_io_bytes:sum_rate"}'
        - '{__name__=~"node:node_memory_utilisation:"}'
        - '{__name__=~"node:node_memory_utilisation:ratio"}'
        - '{__name__=~"node:node_memory_utilisation_2:"}'
        - '{__name__=~"node:node_num_cpu:sum"}'
        - '{__name__=~"node_namespace_pod:kube_pod_info:"}'
        - '{__name__=~"pod_name:container_cpu_usage:sum"}'
        - '{__name__=~"pod_name:container_fs_usage_bytes:sum"}'
        - '{__name__=~"pod_name:container_memory_usage_bytes:sum"}'
        - '{__name__=~"pod_name:container_spec_cpu_shares:sum"}'
        - '{__name__=~"container_memory_usage_bytes"}'
        - '{__name__=~"container_cpu_cfs_throttled_seconds_total"}'
        - '{__name__=~"container_memory_working_set_bytes"}'
        - '{__name__=~"haproxy_backend_connections_total"}'
        - '{__name__=~"haproxy_backend_http_responses_total"}'
        - '{__name__=~"haproxy_server_http_responses_total"}'
        - '{__name__=~"es_cluster_status"}'
        - '{__name__=~"es_fs_path_free_bytes"}'
        - '{__name__=~"es_fs_path_total_bytes"}'
        - '{__name__=~"openshift_clusterresourcequota_.*"}'
        - '{__name__=~"csv_abnormal"}'
        - '{__name__=~"console_url"}'
        {{%- if is_tekton_cluster is defined and is_tekton_cluster %}}
        - '{__name__=~"tekton_pipelines_controller_pipelinerun_taskrun_duration_seconds"}'
        - '{__name__=~"tekton_pipelines_controller_pipelinerun_duration_seconds"}'
        {{%- endif %}}
      scrape_interval: 30s
      scrape_timeout: 10s
      metrics_path: /federate
      scheme: https
      tls_config:
        insecure_skip_verify: true
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
      static_configs:
      - targets:
        - 'prometheus-k8s.openshift-monitoring.svc:9091'


    # jiralert-stage
    - job_name: 'jiralert_stage'
      scrape_interval: 30s
      metrics_path: /metrics
      scheme: https
      basic_auth:
        username: {{{ vault('app-sre/creds/jiralert/stage/basic-auth', 'username') }}}
        password: {{{ vault('app-sre/creds/jiralert/stage/basic-auth', 'password') }}}
      static_configs:
      - targets: ['jiralert.app-sre-stage.devshift.net']

    # jiralert-prod
    - job_name: 'jiralert_prod'
      scrape_interval: 30s
      metrics_path: /metrics
      scheme: https
      basic_auth:
        username: {{{ vault('app-sre/creds/jiralert/prod/basic-auth', 'username') }}}
        password: {{{ vault('app-sre/creds/jiralert/prod/basic-auth', 'password') }}}
      static_configs:
      - targets: ['jiralert.app-sre.devshift.net']
    {{% endb64encode %}}
    
