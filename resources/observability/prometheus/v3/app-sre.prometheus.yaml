apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: app-sre
spec:
  additionalScrapeConfigs:
    key: prometheus-app-sre-additional.yaml
    name: prometheus-app-sre-additional-scrapeconfig
  alerting:
    alertmanagers:
    - name: alertmanager-operated
      namespace: {{resource.namespace.name}}
      port: web
      scheme: http
  baseImage: quay.io/prometheus/prometheus
  version: {{version}}
  containers:
  - args:
    - -provider=github
    - -http-address=:3000
    - -https-address=
    - -htpasswd-file=/etc/proxy/htpasswd/auth
    - -email-domain=*
    - -upstream=http://prometheus-app-sre.{{resource.namespace.name}}.svc:9090
    - -github-org=app-sre
    - -github-team=app-sre-observability
    env:
    - name: OAUTH2_PROXY_CLIENT_ID
      valueFrom:
        secretKeyRef:
          key: client-id
          name: prometheus-proxy-config
    - name: OAUTH2_PROXY_CLIENT_SECRET
      valueFrom:
        secretKeyRef:
          key: client-secret
          name: prometheus-proxy-config
    - name: OAUTH2_PROXY_COOKIE_SECRET
      valueFrom:
        secretKeyRef:
          key: cookie-secret
          name: prometheus-proxy-config
    image: quay.io/pusher/oauth2_proxy:v4.0.0
    imagePullPolicy: Always
    name: prometheus-proxy
    ports:
    - containerPort: 3000
      name: http
      protocol: TCP
    readinessProbe:
      failureThreshold: 3
      periodSeconds: 10
      successThreshold: 1
      tcpSocket:
        port: http
      timeoutSeconds: 1
    volumeMounts:
    - mountPath: /etc/proxy/htpasswd
      name: secret-app-sre-observability-htpasswd
  externalUrl: {{externalUrl}}
  externalLabels:
    cluster: {{clusterLabel}}
    environment: {{environment}}
  replicas:  {{replicas}}
  retention: {{retention}}
  ruleSelector:
    matchLabels:
      prometheus: app-sre
  secrets:
  - app-sre-observability-htpasswd
  securityContext: {}
  serviceAccountName: prometheus-k8s
  serviceMonitorSelector:
    matchLabels:
      prometheus: app-sre
  storage:
    volumeClaimTemplate:
      apiVersion: v1
      kind: PersistentVolumeClaim
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: {{pvSize}}
        storageClassName: gp2-encrypted
