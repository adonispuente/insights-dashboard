apiVersion: v1
data:
  jiralert.tmpl: >-
    {{% b64encode %}}

    {{ define "jira.summary" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " | printf "%.242s" }}{{ end }}
    {{ define "jira.description" }}{{ $numAlerts := len .Alerts.Firing }}
    {{ if gt $numAlerts 20 }}
    *The contents of this ticket were truncated because they would exceed the character limit for a description in Jira.*

    There are really {{ $numAlerts }} alerts triggering. It may be possible to see the full list of alerts by clicking the *Source* link on one of the alerts below, or by following the links provided in *Annotations* for more information.
    ----
    {{ end }}
    {{ range $index, $element := .Alerts.Firing }}
    {{ if lt $index 20 }}
    {{ if .Annotations.message }}*Alert{{ if gt $numAlerts 1 }}[{{ $index }}]{{ end }}:* {{ .Annotations.message }}
    {{ end }}
    Annotations:
    {{ range .Annotations.SortedPairs }}
    {{- if ne .Name "message" }} - {{ .Name }} = {{ .Value }}{{ println }}{{ end -}}
    {{ end }}
    Labels:
    {{ range .Labels.SortedPairs }} - {{ .Name }} = {{ .Value }}
    {{ end }}
    Source: [Prometheus|{{ .GeneratorURL }}]
    {{ println }}
    ----
    {{ end }}
    {{ end }}
    *Note:* This issue was generated automatically by the AppSRE team. Moving this issue to a different project will result in the ticket being recreated in the current project. If you believe that this issue was created in the incorrect project, please [reach out to AppSRE|https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/FAQ.md#contacting-appsre].
    {{ end }}


    {{% endb64encode %}}

  jiralert.yml: >-
    {{% b64encode %}}
    # Global defaults, applied to all receivers where not explicitly overridden. Optional.
    defaults:
      # API access fields.
      api_url: {{{ vault('app-sre/creds/app-sre-jira-bot', 'url') }}}
      personal_access_token: {{{ vault('app-sre/creds/app-sre-jira-bot', 'token') }}}

      issue_type: Task
      priority: Major
      reopen_state: "To Do"

      # Don't reopen issues with this state. Optional
      # we don't have this in the ASIC project currently
      wont_fix_resolution: "Won't Fix"

      summary: '{{ template "jira.summary" . }}'
      description: '{{ template "jira.description" . }}'

      # reopen_duration: issues that were closed for...
      # - shorter than `reopen_duration` will be: reopened
      # - longer than `reopen_duration` will be: recreated as a new issue
      # ðŸ˜¡ ACTUALLY the default is: 0d -> always create new issue
      reopen_duration: 30d

    # Receiver definitions. At least one must be defined.
    # every key in `defaults` can be overridden here
    receivers:
      # Must match the Alertmanager receiver name. Required.
      {{%- for jira_board in query('/queries/jira_boards.graphql') %}}
      {{%- for sev_prio_map in jira_board.severityPriorityMappings.mappings %}}
      - name: jiralert-{{{ jira_board.name }}}-{{{ sev_prio_map.severity }}}
        project: {{{ jira_board.name }}}
        priority: {{{ sev_prio_map.priority }}}
        add_group_labels: true
      {{%- endfor %}}
      {{%- endfor %}}

    # File containing template definitions. Required.
    template: jiralert.tmpl
    {{% endb64encode %}}

kind: Secret
metadata:
  name: jiralert-config
  annotations:
    # This will cause updates to this configMap to cycle deployments that use it
    qontract.recycle: "true"
    qontract.ignore_reconcile_time: "true"
