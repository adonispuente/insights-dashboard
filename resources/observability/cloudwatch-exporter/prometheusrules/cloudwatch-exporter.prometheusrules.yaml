---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: cloudwatch-exporter
spec:
  groups:
  - name: cloudwatch-exporter.rules
    rules:
    - alert: CloudWatchExporterScrapeError
      labels:
        service: app-sre-observability
        severity: medium
      expr: cloudwatch_exporter_scrape_error{job=~"cloudwatch-exporter.*"} != 0
      for: 5m
      annotations:
        message: 'There was an error scraping metrics from the cloudwatch exporter.'
        runbook: "https://github.com/rhobs/configuration/tree/main/docs/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
    - alert: CloudWatchExporterScrapeDuration
      labels:
        service: app-sre-observability
        severity: warning
      expr: cloudwatch_exporter_scrape_duration_seconds{job=~"cloudwatch-exporter.*"} >= 25
      for: 5m
      annotations:
        message: 'Cloudwatch exporter took more than 25 seconds to scrape AWS Cloudwatch.'
        runbook: "https://github.com/rhobs/configuration/tree/main/docs/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
    - alert: CloudWatchExporterTargetFlapping
      labels:
        service: app-sre-observability
        severity: critical
      expr: changes(up{job=~"cloudwatch-exporter.*"}[15m]) > 4
      for: 1m
      annotations:
        message: "Cloudwatch exporter target is flapping"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/app-sre/sop/prometheus-target-flapping.md"
        dashboard: "https://grafana.app-sre.devshift.net"
  - name: cloudwatch-exporter-rds.rules
    rules:
    - alert: RDSLowStorageSpace
      labels:
        service: app-sre-observability
        severity: warning
      expr: aws_rds_free_storage_space_average{job=~"cloudwatch-exporter.*",dbinstance_identifier!~".*-(?:stage|staging|integration).*"} offset 10m < (1 * 1024^3)
      for: 30m
      annotations:
        message: 'The current free storage space of DB instance {{ $labels.dbinstance_identifier }} is under 1 GB.'
        runbook: "https://github.com/rhobs/configuration/tree/main/docs/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
    - alert: RDSPredictOutOfStorage
      labels:
        service: app-sre-observability
        severity: high
      expr: predict_linear(aws_rds_free_storage_space_average{dbinstance_identifier!~".*-(?:stage|staging|integration).*"}[1h], 3600 * 9) < 0
      for: 1h
      annotations:
        message: 'DB instance {{ $labels.dbinstance_identifier }} storage will be full within 8 hours.'
        runbook: "https://github.com/rhobs/configuration/tree/main/docs/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
  - name: cloudwatch-exporter-ec2.rules
    rules:
    - alert: EC2HighCPUUtilization
      labels:
        service: app-sre-observability
        severity: warning
      expr: aws_ec2_cpuutilization_average{job=~"cloudwatch-exporter.*"} offset 10m > 85
      for: 60m
      annotations:
        message: 'Average CPU utilization of EC2 instance {{ $labels.instance_id }} above 85% for over 1 hour.'
        runbook: "https://github.com/rhobs/configuration/tree/main/docs/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
