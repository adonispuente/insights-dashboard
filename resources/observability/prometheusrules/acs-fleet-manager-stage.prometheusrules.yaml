---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: acs-fleet-manager-stage
spec:
  groups:
    - name: acs-fleet-manager-stage
      rules:
        - alert: ACS Fleet Manager down - stage
          annotations:
            message: "No instances found for ACS Fleet Manager on stage. ACS Fleet Manager is down."
            dashboard: "https://grafana.stage.devshift.net/d/D1C839d82/acs-fleet-manager?orgId=1"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-down"
          expr: |
            absent(up{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"} == 1)
          for: 15m
          labels:
            service: acs-fleet-manager
            severity: high
            namespace: acs-fleet-manager-stage

        # SLO Availability p99
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: ACS Fleet Manager returning 5xx error budget burn 5m to 1h - stage
          annotations:
            message: "High error budget burn of returning 5xx error codes for acs-fleet-manager-stage (current value: {{ $value }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-availability"
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate5m{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}) > (13.44 * (1-0.99000))
            and
            sum(haproxy_backend_http_responses_total:burnrate1h{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}) > (13.44 * (1-0.99000))
          for: 2m
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
            severity: medium
        - alert: ACS Fleet Manager returning 5xx error budget burn 30m to 6h - stage
          annotations:
            message: "High error budget burn of returning 5xx error codes for acs-fleet-manager-stage (current value: {{ $value }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-availability"
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate30m{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}) > (5.60 * (1-0.99000))
            and
            sum(haproxy_backend_http_responses_total:burnrate6h{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}) > (5.60 * (1-0.99000))
          for: 15m
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
            severity: medium
        - alert: ACS Fleet Manager returning 5xx error budget burn 2h to 1d - stage
          annotations:
            message: "High error budget burn of returning 5xx error codes for acs-fleet-manager-stage (current value: {{ $value }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-availability"
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate2h{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}) > (2.80 * (1-0.99000))
            and
            sum(haproxy_backend_http_responses_total:burnrate1d{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}) > (2.80 * (1-0.99000))
          for: 1h
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
            severity: medium
        - alert: ACS Fleet Manager returning 5xx error budget burn 6h to 3d - stage
          annotations:
            message: "High error budget burn of returning 5xx error codes for acs-fleet-manager-stage (current value: {{ $value }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-availability"
          expr: |
            sum(haproxy_backend_http_responses_total:burnrate6h{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}) > (1.00 * (1-0.99000))
            and
            sum(haproxy_backend_http_responses_total:burnrate3d{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}) > (1.00 * (1-0.99000))
          for: 3h
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
            severity: medium
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage",code=~"5.."}[1d]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}[1d]))
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate1d
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage",code=~"5.."}[1h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}[1h]))
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate1h
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage",code=~"5.."}[2h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}[2h]))
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate2h
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage",code=~"5.."}[30m]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}[30m]))
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate30m
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage",code=~"5.."}[3d]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}[3d]))
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate3d
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage",code=~"5.."}[5m]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}[5m]))
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate5m
        - expr: |
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage",code=~"5.."}[6h]))
            /
            sum(rate(haproxy_backend_http_responses_total{route="acs-fleet-manager",exported_namespace="acs-fleet-manager-stage"}[6h]))
          labels:
            service: acs-fleet-manager
            exported_namespace: acs-fleet-manager-stage
            route: acs-fleet-manager
          record: haproxy_backend_http_responses_total:burnrate6h

        # SLO API Latency p90 < 100ms
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: ACS Fleet Manager Latency p90 < 100ms 30m to 6h budget burn - stage
          annotations:
            message: "High 1h/6h requests latency budget burn for ACS Fleet Manager API p90 (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-latency"
          expr: |
            latencytarget:api_inbound_request_duration:rate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="0.1"} > (5.6*(1 - 0.90000))
            and
            latencytarget:api_inbound_request_duration:rate30m{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="0.1"} > (5.6*(1 - 0.90000))
          labels:
            service: acs-fleet-manager
            latency: "0.1"
            quantile: "90"
            namespace: acs-fleet-manager-stage
            severity: high
        - alert: ACS Fleet Manager Latency p90 < 100ms 6h to 3d budget burn - stage
          annotations:
            message: "High 1d/3d requests latency budget burn for ACS Fleet Manager API p90 (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-latency"
          expr: |
            (
              latencytarget:api_inbound_request_duration:rate1d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="0.1"} > (2.8*(1 - 0.90000))
              and
              latencytarget:api_inbound_request_duration:rate2h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="0.1"} > (2.8*(1 - 0.90000))
            )
            or
            (
              latencytarget:api_inbound_request_duration:rate3d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="0.1"} > (1*(1 - 0.90000))
              and
              latencytarget:api_inbound_request_duration:rate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="0.1"} > (1*(1 - 0.90000))
            )
          labels:
            service: acs-fleet-manager
            latency: "0.1"
            quantile: "90"
            namespace: acs-fleet-manager-stage
            severity: high
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="0.1",code!~"5.."}[5m]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[5m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate5m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="0.1",code!~"5.."}[30m]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[30m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate30m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="0.1",code!~"5.."}[1h]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[1h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate1h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="0.1",code!~"5.."}[2h]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[2h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate2h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="0.1",code!~"5.."}[6h]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[6h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate6h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="0.1",code!~"5.."}[1d]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[1d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate1d
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="0.1",code!~"5.."}[3d]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[3d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "0.1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate3d

        # SLO API Latency p99 < 1s
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: ACS Fleet Manager Latency p99 < 1s 30m to 6h budget burn - stage
          annotations:
            message: "High 6h requests latency budget burn for ACS Fleet Manager API p99 (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-latency"
          expr: |
            latencytarget:api_inbound_request_duration:rate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="1"} > (5.6*(1-0.99000))
            and
            latencytarget:api_inbound_request_duration:rate30m{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="1"} > (5.6*(1-0.99000))
          labels:
            service: acs-fleet-manager
            latency: "1"
            quantile: "99"
            namespace: acs-fleet-manager-stage
            severity: high
        - alert: ACS Fleet Manager Latency p99 < 1s 6h to 3d budget burn - stage
          annotations:
            message: "High 1d/3d requests latency budget burn for ACS Fleet Manager API p99 (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-latency"
          expr: |
            (
              latencytarget:api_inbound_request_duration:rate1d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="1"} > (2.8*(1-0.99000))
              and
              latencytarget:api_inbound_request_duration:rate2h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="1"} > (2.8*(1-0.99000))
            )
            or
            (
              latencytarget:api_inbound_request_duration:rate3d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="1"} > (1*(1-0.99000))
              and
              latencytarget:api_inbound_request_duration:rate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="1"} > (1*(1-0.99000))
            )
          labels:
            service: acs-fleet-manager
            latency: "1"
            quantile: "99"
            namespace: acs-fleet-manager-stage
            severity: high
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="1",code!~"5.."}[5m]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[5m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate5m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="1",code!~"5.."}[30m]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[30m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate30m
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="1",code!~"5.."}[1h]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[1h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate1h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="1",code!~"5.."}[2h]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[2h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate2h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="1",code!~"5.."}[6h]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[6h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate6h
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="1",code!~"5.."}[1d]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[1d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate1d
        - expr: |
            1 - (
              sum(rate(api_inbound_request_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="1",code!~"5.."}[3d]))
              /
              sum(rate(api_inbound_request_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage"}[3d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "1"
            namespace: acs-fleet-manager-stage
          record: latencytarget:api_inbound_request_duration:rate3d

        # SLO Correctness (Create) p95
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: ACS Fleet Manager Central Creation 30m to 6h budget burn - stage
          annotations:
            message: "High 6h error budget burn for ACS Fleet Manager create Central operations (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-provisioning-correctness"
          expr: |
            sum(acs_fleet_manager_central_operations:burnrate30m{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}) > (5.60 * (1-0.95000))
            and
            sum(acs_fleet_manager_central_operations:burnrate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}) > (5.60 * (1-0.95000))
          for: 15m
          labels:
            service: acs-fleet-manager
            namespace: acs-fleet-manager-stage
            operation: create
            severity: high
        - alert: ACS Fleet Manager Central Creation 2h to 1d budget burn - stage
          annotations:
            message: "High 1d error budget burn for ACS Fleet Manager create Central operations (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-provisioning-correctness"
          expr: |
            sum(acs_fleet_manager_central_operations:burnrate2h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}) > (2.80 * (1-0.95000))
            and
            sum(acs_fleet_manager_central_operations:burnrate1d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}) > (2.80 * (1-0.95000))
          for: 1h
          labels:
            service: acs-fleet-manager
            namespace: acs-fleet-manager-stage
            operation: create
            severity: high
        - alert: ACS Fleet Manager Central Creation 6h to 3d budget burn - stage
          annotations:
            message: "High 3d error budget burn for ACS Fleet Manager create Central operations (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-provisioning-correctness"
          expr: |
            sum(acs_fleet_manager_central_operations:burnrate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}) > (1.00 * (1-0.95000))
            and
            sum(acs_fleet_manager_central_operations:burnrate3d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}) > (1.00 * (1-0.95000))
          for: 3h
          labels:
            service: acs-fleet-manager
            namespace: acs-fleet-manager-stage
            operation: create
            severity: high
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[1d]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[1d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: create
          record: acs_fleet_manager_central_operations:burnrate1d
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[1h]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[1h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: create
          record: acs_fleet_manager_central_operations:burnrate1h
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[2h]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[2h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: create
          record: acs_fleet_manager_central_operations:burnrate2h
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[30m]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[30m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: create
          record: acs_fleet_manager_central_operations:burnrate30m
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[3d]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[3d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: create
          record: acs_fleet_manager_central_operations:burnrate3d
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[5m]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[5m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: create
          record: acs_fleet_manager_central_operations:burnrate5m
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[6h]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="create"}[6h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: create
          record: acs_fleet_manager_central_operations:burnrate6h

        # SLO Correctness (Delete) p95
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: ACS Fleet Manager Central Deletion 30m to 6h budget burn - stage
          annotations:
            message: "High 6h error budget burn for ACS Fleet Manager delete Central operations (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-deletion-correctness"
          expr: |
            sum(acs_fleet_manager_central_operations:burnrate30m{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}) > (5.60 * (1-0.95000))
            and
            sum(acs_fleet_manager_central_operations:burnrate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}) > (5.60 * (1-0.95000))
          for: 15m
          labels:
            service: acs-fleet-manager
            namespace: acs-fleet-manager-stage
            operation: delete
            severity: high
        - alert: ACS Fleet Manager Central Deletion 2h to 1d budget burn - stage
          annotations:
            message: "High 1d error budget burn for ACS Fleet Manager delete Central operations (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-deletion-correctness"
          expr: |
            sum(acs_fleet_manager_central_operations:burnrate2h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}) > (2.80 * (1-0.95000))
            and
            sum(acs_fleet_manager_central_operations:burnrate1d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}) > (2.80 * (1-0.95000))
          for: 1h
          labels:
            service: acs-fleet-manager
            namespace: acs-fleet-manager-stage
            operation: delete
            severity: high
        - alert: ACS Fleet Manager Central Deletion 6h to 3d budget burn - stage
          annotations:
            message: "High 3d error budget burn for ACS Fleet Manager delete Central operations (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-deletion-correctness"
          expr: |
            sum(acs_fleet_manager_central_operations:burnrate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}) > (1.00 * (1-0.95000))
            and
            sum(acs_fleet_manager_central_operations:burnrate3d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}) > (1.00 * (1-0.95000))
          for: 3h
          labels:
            service: acs-fleet-manager
            namespace: acs-fleet-manager-stage
            operation: delete
            severity: high
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[1d]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[1d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: delete
          record: acs_fleet_manager_central_operations:burnrate1d
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[1h]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[1h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: delete
          record: acs_fleet_manager_central_operations:burnrate1h
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[2h]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[2h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: delete
          record: acs_fleet_manager_central_operations:burnrate2h
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[30m]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[30m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: delete
          record: acs_fleet_manager_central_operations:burnrate30m
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[3d]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[3d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: delete
          record: acs_fleet_manager_central_operations:burnrate3d
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[5m]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[5m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: delete
          record: acs_fleet_manager_central_operations:burnrate5m
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_central_operations_success_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[6h]))
              /
              sum(rate(acs_fleet_manager_central_operations_total_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",operation="delete"}[6h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
            operation: delete
          record: acs_fleet_manager_central_operations:burnrate6h

        # SLO Creation Latency p90 < 60m
        # Based on burn rate alerts from https://sre.google/workbook/alerting-on-slos/#5-multiple-burn-rate-alerts
        - alert: ACS Fleet Manager Central Creation Latency 30m to 6h budget burn - stage
          annotations:
            message: "High 6h Central creation p90 latency budget burn for ACS Fleet Manager (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-provisioning-latency"
          expr: |
            latencytarget:acs_fleet_manager_worker_central_duration:rate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="3600",jobType="central_create"} > (5.6*(1-0.90000))
            and
            latencytarget:acs_fleet_manager_worker_central_duration:rate30m{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="3600",jobType="central_create"} > (5.6*(1-0.90000))
          labels:
            service: acs-fleet-manager
            latency: "3600"
            quantile: "90"
            namespace: acs-fleet-manager-stage
            jobType: central_create
            severity: high
        - alert: ACS Fleet Manager Central Creation Latency 1d or 3d budget burn - stage
          annotations:
            message: "High 1d/3d Central creation p90 latency budget burn for ACS Fleet Manager (current value: {{ $value | humanize }})"
            dashboard: "https://grafana.stage.devshift.net/d/T2kek3H9a/acs-fleet-manager-slos?orgId=1&from=now-28d&to=now"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-provisioning-latency"
          expr: |
            (
              latencytarget:acs_fleet_manager_worker_central_duration:rate1d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="3600",jobType="central_create"} > (2.8*(1-0.90000))
              and
              latencytarget:acs_fleet_manager_worker_central_duration:rate2h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="3600",jobType="central_create"} > (2.8*(1-0.90000))
            )
            or
            (
              latencytarget:acs_fleet_manager_worker_central_duration:rate3d{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="3600",jobType="central_create"} > (1*(1-0.90000))
              and
              latencytarget:acs_fleet_manager_worker_central_duration:rate6h{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",latency="3600",jobType="central_create"} > (1*(1-0.90000))
            )
          labels:
            service: acs-fleet-manager
            latency: "3600"
            quantile: "90"
            namespace: acs-fleet-manager-stage
            jobType: central_create
            severity: high
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_worker_central_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="3600",jobType="central_create"}[5m]))
              /
              sum(rate(acs_fleet_manager_worker_central_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",jobType="central_create"}[5m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "3600"
            namespace: acs-fleet-manager-stage
            jobType: central_create
          record: latencytarget:acs_fleet_manager_worker_central_duration:rate5m
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_worker_central_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="3600",jobType="central_create"}[30m]))
              /
              sum(rate(acs_fleet_manager_worker_central_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",jobType="central_create"}[30m]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "3600"
            namespace: acs-fleet-manager-stage
            jobType: central_create
          record: latencytarget:acs_fleet_manager_worker_central_duration:rate30m
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_worker_central_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="3600",jobType="central_create"}[1h]))
              /
              sum(rate(acs_fleet_manager_worker_central_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",jobType="central_create"}[1h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "3600"
            namespace: acs-fleet-manager-stage
            jobType: central_create
          record: latencytarget:acs_fleet_manager_worker_central_duration:rate1h
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_worker_central_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="3600",jobType="central_create"}[2h]))
              /
              sum(rate(acs_fleet_manager_worker_central_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",jobType="central_create"}[2h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "3600"
            namespace: acs-fleet-manager-stage
            jobType: central_create
          record: latencytarget:acs_fleet_manager_worker_central_duration:rate2h
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_worker_central_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="3600",jobType="central_create"}[6h]))
              /
              sum(rate(acs_fleet_manager_worker_central_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",jobType="central_create"}[6h]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "3600"
            namespace: acs-fleet-manager-stage
            jobType: central_create
          record: latencytarget:acs_fleet_manager_worker_central_duration:rate6h
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_worker_central_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="3600",jobType="central_create"}[1d]))
              /
              sum(rate(acs_fleet_manager_worker_central_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",jobType="central_create"}[1d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "3600"
            namespace: acs-fleet-manager-stage
            jobType: central_create
          record: latencytarget:acs_fleet_manager_worker_central_duration:rate1d
        - expr: |
            1 - (
              sum(rate(acs_fleet_manager_worker_central_duration_bucket{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",le="3600",jobType="central_create"}[3d]))
              /
              sum(rate(acs_fleet_manager_worker_central_duration_count{job="fleet-manager-metrics",namespace="acs-fleet-manager-stage",jobType="central_create"}[3d]))
            )
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            latency: "3600"
            namespace: acs-fleet-manager-stage
            jobType: central_create
          record: latencytarget:acs_fleet_manager_worker_central_duration:rate3d

    - name: acs-fleet-manager-reconciler
      rules:
        - expr: |
            sum by (worker_type) (rate(acs_fleet_manager_reconciler_failure_count[5m]))
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
          record: reconciler:acs_fleet_manager_reconciler_failures:rate5m
        - alert: ACS Fleet Manager reconciler failure
          annotations:
            message: "The reconciler of type {{ $labels.worker_type }} failed with a rate of {{ $value }}/s over the last 15 minutes."
            dashboard: "https://grafana.stage.devshift.net/d/D1C839d82/acs-fleet-manager?orgId=1"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-reconciler-failure"
          expr: |
            reconciler:acs_fleet_manager_reconciler_failures:rate5m > 0
          for: 15m
          labels:
            service: acs-fleet-manager
            severity: critical
            team: acs
            namespace: acs-fleet-manager-stage

        - expr: |
            max by (worker_type) (acs_fleet_manager_reconciler_duration_in_seconds)
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
          record: reconciler:acs_fleet_manager_reconciler_duration_in_seconds:max
        - alert: ACS Fleet Manager reconciler long duration
          annotations:
            message: "The maximum reconciler duration was {{ $value | humanizeDuration }} over the last 15 minutes."
            dashboard: "https://grafana.stage.devshift.net/d/D1C839d82/acs-fleet-manager?orgId=1"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-fleet-manager-reconciler-long-duration"
          expr: |
            reconciler:acs_fleet_manager_reconciler_duration_in_seconds:max > 30
          for: 15m
          labels:
            service: acs-fleet-manager
            severity: medium
            namespace: acs-fleet-manager-stage
    - name: acs-fleet-manager-request-timeout
      rules:
        - expr: |
            sum(acs_fleet_manager_central_timeout_total_count or vector(0))
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
          record: acs_fleet_manager_sum_central_timeouts
        - expr: |
            rate(acs_fleet_manager_sum_central_timeouts[20m])
          labels:
            service: acs-fleet-manager
            job: fleet-manager-metrics
            namespace: acs-fleet-manager-stage
          record: acs_fleet_manager_central_timeouts:rate20m
        - alert: ACS Fleet Manager central request timeout
          annotations:
            message: "Central request reached a timeout."
            dashboard: "https://grafana.prod.devshift.net/d/D1C839d82/acs-fleet-manager?orgId=1"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/tree/master/docs/acs-fleet-manager/sop#acs-central-timeout"
          expr: |
            acs_fleet_manager_central_timeouts:rate20m > 0
          for: 15m
          labels:
            service: acs-fleet-manager
            severity: medium
            team: acs
            namespace: acs-fleet-manager-stage
