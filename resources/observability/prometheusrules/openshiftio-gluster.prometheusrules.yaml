---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: openshiftio-gluster
spec:
  groups:
  - name: gluster.openshiftio.rules
    interval: 1m
    rules:
    # Node - system
    - alert: OSIOGlusterNodeCPUBusy
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        400 - (
          avg_over_time(zabbix_impersonator_pcp_kernel_all_cpu_idle[60m]) * 0.1
        ) > 300
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} CPU busy > 75%'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodecpubusy"
        dashboard: ""
    - alert: OSIOGlusterNodeMemoryAvailable
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        zabbix_impersonator_pcp_mem_util_available < 4194304
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} memory available < 4GB'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodememoryavailable"
        dashboard: ""

    # Node - disk
    - alert: OSIOGlusterNodeDiskOps
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        avg_over_time(zabbix_impersonator_pcp_disk_dev_read[15m]) > 2000
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} disk iops > 2000'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodediskops"
        dashboard: ""
    - alert: OSIOGlusterNodeDiskBytes
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        avg_over_time(zabbix_impersonator_pcp_disk_dev_read_bytes[15m]) > 80000000
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} disk bytes/sec > 80Mbps'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodediskbytes"
        dashboard: ""
    
    # Node - network
    - alert: OSIOGlusterNodeInterfaceInBytes
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        avg_over_time(zabbix_impersonator_pcp_network_interface_in_bytes[30m]) > 80000000
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} high network inbound traffic'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodeinterfaceinbytes"
        dashboard: ""
    - alert: OSIOGlusterNodeInterfaceOutBytes
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        avg_over_time(zabbix_impersonator_pcp_network_interface_out_bytes[30m]) > 80000000
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} high network inbound traffic'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodeinterfaceoutbytes"
        dashboard: ""
    - alert: OSIOGlusterNodeInterfaceInDrops
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        avg_over_time(zabbix_impersonator_pcp_network_interface_in_drops[30m]) > 1
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} network interface has dropped packets for inbound traffic'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodeinterfaceindrops"
        dashboard: ""
    - alert: OSIOGlusterNodeInterfaceOutDrops
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        avg_over_time(zabbix_impersonator_pcp_network_interface_out_drops[30m]) > 1
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} network interface has dropped packets for outbound traffic'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodeinterfaceoutdrops"
        dashboard: ""
    - alert: OSIOGlusterNodeInterfaceInErrors
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        avg_over_time(zabbix_impersonator_pcp_network_interface_in_errors[30m]) > 1
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} network interface has dropped packets for inbound traffic'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodeinterfaceinerrors"
        dashboard: ""
    - alert: OSIOGlusterNodeInterfaceOutErrors
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        avg_over_time(zabbix_impersonator_pcp_network_interface_out_errors[30m]) > 1
      for: 5m
      annotations:
        message: 'Gluster node {{$labels.zabbix_sender_hostname}} network interface has dropped packets for outbound traffic'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglusternodeinterfaceouterrors"
        dashboard: ""

    # Volume - Pool
    - alert: OSIOGlusterVolumePoolUsedWarning
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        (zabbix_impersonator_pcp_dmthin_pool_data_used / zabbix_impersonator_pcp_dmthin_pool_data_total * 100) > 80
      for: 5m
      annotations:
        message: 'Gluster volume pool {{$labels.device}} used > 80 %'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglustervolumepoolused"
        dashboard: ""
    - alert: OSIOGlusterVolumePoolUsedCritical
      labels:
        service: osio-gluster
        severity: critical
      expr: |
        (zabbix_impersonator_pcp_dmthin_pool_data_used / zabbix_impersonator_pcp_dmthin_pool_data_total * 100) > 95
      for: 5m
      annotations:
        message: 'Gluster volume pool {{$labels.device}} used > 95 %'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglustervolumepoolused"
        dashboard: ""
    - alert: OSIOGlusterVolumePoolMetadataUsedWarning
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        (zabbix_impersonator_pcp_dmthin_pool_metadata_used / zabbix_impersonator_pcp_dmthin_pool_metadata_total * 100) > 80
      for: 5m
      annotations:
        message: 'Gluster volume pool {{$labels.device}} metadata used > 80 %'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglustervolumepoolmetadataused"
        dashboard: ""
    - alert: OSIOGlusterVolumePoolMetadataUsedCritical
      labels:
        service: osio-gluster
        severity: critical
      expr: |
        (zabbix_impersonator_pcp_dmthin_pool_metadata_used / zabbix_impersonator_pcp_dmthin_pool_metadata_total * 100) > 95
      for: 5m
      annotations:
        message: 'Gluster volume pool {{$labels.device}} metadata used > 95 %'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglustervolumepoolmetadataused"
        dashboard: ""

    # Volume - filesystem
    - alert: OSIOGlusterVolumeFilesystemUsedWarning
      labels:
        service: osio-gluster
        severity: warning
      expr: |
        zabbix_impersonator_pcp_filesys_full > 80
      for: 5m
      annotations:
        message: 'Gluster volume filesystem {{$labels.device}} used > 80 %'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglustervolumefilesystemused"
        dashboard: ""
    - alert: OSIOGlusterVolumeFilesystemUsedCritical
      labels:
        service: osio-gluster
        severity: critical
      expr: |
        zabbix_impersonator_pcp_filesys_full > 95
      for: 5m
      annotations:
        message: 'Gluster volume filesystem {{$labels.device}} used > 95 %'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/openshiftio/sop/index.md#osioglustervolumefilesystemused"
        dashboard: ""
