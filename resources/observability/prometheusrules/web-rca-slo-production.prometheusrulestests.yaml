---
$schema: /app-interface/prometheus-rule-test-1.yml

rule_files:
  - /observability/prometheusrules/web-rca-slo-production.prometheusrules.yaml

evaluation_interval: 1m

tests:
  - interval: 1m
    input_series:
      # 0m  - 30m   all good
      # 30m - 60m   5% of requests degraded to 2le bucket
      # 60m - 90m   10% of requests degraded to 2le bucket
      - series: 'api_inbound_request_duration_bucket{job="web-rca-metrics",namespace="web-rca-production",le="1",code="200"}'
        values: '0+1x30   31+19x30  601+18x30'
      - series: 'api_inbound_request_duration_bucket{job="web-rca-metrics",namespace="web-rca-production",le="2",code="200"}'
        values: '0+1x30   31+1x30   61+2x30'
      - series: 'api_inbound_request_duration_count{job="web-rca-metrics",namespace="web-rca-production"}'
        values: '0+1x30   31+20x30  631+20x30'
    alert_rule_test:
      - eval_time: 30m
        alertname: Latency5mto1hor30mto6hBudgetBurn
        exp_alerts: [ ]
      - eval_time: 60m
        alertname: Latency5mto1hor30mto6hBudgetBurn
        exp_alerts: [ ]
      - eval_time: 90m
        alertname: Latency5mto1hor30mto6hBudgetBurn
        exp_alerts:
          - exp_labels:
              alertname: Latency5mto1hor30mto6hBudgetBurn
              job: web-rca-metrics
              latency: 1
              namespace: web-rca-production
              quantile: 99
              service: web-rca
              severity: critical
            exp_annotations:
              message: "High requests latency budget burn for namespace=web-rca-production,job=web-rca-metrics,latency=1 (current value: {{ $value }})"
              runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/web-rca/sops/web-rca-latency.md"
  - interval: 1m
    input_series:
      # 0m    - 60m   all good
      # 60m   - 120m  1% of requests degraded to 2le bucket
      # 120m  - 150m  3% of requests degraded to 2le bucket
      - series: 'api_inbound_request_duration_bucket{job="web-rca-metrics",namespace="web-rca-production",le="1",code="200"}'
        values: '0+1x60   61+99x60    6001+97x30'
      - series: 'api_inbound_request_duration_bucket{job="web-rca-metrics",namespace="web-rca-production",le="2",code="200"}'
        values: '0+1x60   61+1x60     121+3x30'
      - series: 'api_inbound_request_duration_count{job="web-rca-metrics",namespace="web-rca-production"}'
        values: '0+1x60   61+100x60   6061+100x30'
    alert_rule_test:
      - eval_time: 60m
        alertname: Latency2hto1dor6hto3dBudgetBurn
        exp_alerts: [ ]
      - eval_time: 120m
        alertname: Latency2hto1dor6hto3dBudgetBurn
        exp_alerts: [ ]
      - eval_time: 150m
        alertname: Latency2hto1dor6hto3dBudgetBurn
        exp_alerts:
          - exp_labels:
              alertname: Latency2hto1dor6hto3dBudgetBurn
              job: web-rca-metrics
              latency: 1
              namespace: web-rca-production
              quantile: 99
              service: web-rca
              severity: warning
            exp_annotations:
              message: "High requests latency budget burn for namespace=web-rca-production,job=web-rca-metrics,latency=1 (current value: {{ $value }})"
              runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/managed-services/sop#kas-fleet-manager-latency"
