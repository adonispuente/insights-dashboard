---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: ocm-managed-services-{{{environment}}}
spec:
  groups:
  - name: ocm-managed-services-{{{environment}}}
    rules:
    # managed services traffic can come from the outside (router) or from internal OCM services
    # Internal traffic is measured from the outbound traffic of any envoy proxy that has
    # a properly configured label. This label is something to check in the future.
    # OR on() vector(0) is used to make sure non-existing metrics are added as 0 constant vectors
    # If we don't do this, Prometheus will not add the two vectors and will return empty.
    # This can happen if there's no traffic from the router or envoy.
    - record: status_class_5xx:http_requests_total:rate5m
      expr: |
        sum(rate(haproxy_backend_http_responses_total{route="service-mgmt",exported_namespace="uhc-{{{environment}}}",code="5xx"}[5m])) OR on() vector(0)
        +
        sum(rate(envoy_cluster_upstream_rq{envoy_cluster_name="ocm-managed-services",envoy_response_code=~"^5..",namespace="uhc-{{{environment}}}"}[5m])) OR on() vector(0)
      labels:
        service: ocm-managed-services
        namespace: uhc-{{{environment}}}
    - record: all:http_requests_total:rate5m
      expr: |
        sum(rate(haproxy_backend_http_responses_total{route="service-mgmt",exported_namespace="uhc-{{{environment}}}"}[5m])) OR on() vector(0)
        +
        sum(rate(envoy_cluster_upstream_rq{envoy_cluster_name="ocm-managed-services",namespace="uhc-{{{environment}}}"}[5m])) OR on() vector(0)
      labels:
        service: ocm-managed-services
        namespace: uhc-{{{environment}}}
    - alert: OCM Managed Services Latency High - {{{environment}}}
      annotations:
        message: "OCM Managed Services in namespace uhc-{{{environment}}} 50th percentile latency is greater than 2s. Current value: {{ $value | humanize }}"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/uhc/sop/ocm-managed-services.md"
      expr: |
        histogram_quantile(0.50, sum(rate(api_inbound_request_duration_bucket{namespace="uhc-{{{environment}}}",service="ocm-managed-services-metrics"}[1m])) by (le)) > 2
      for: 10m
      labels:
        service:  ocm-managed-services
        severity: medium
    - alert: OCM Managed Services 5xx Errors High - {{{environment}}}
      annotations:
        message: "OCM Managed Services is returning code 5xx for {{ $value | humanize }}% of requests."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/uhc/sop/ocm-managed-services.md"
      expr: |
        100 * status_class_5xx:http_requests_total:rate5m{service="ocm-managed-services",namespace="uhc-{{{environment}}}"}
              /
              all:http_requests_total:rate5m{service="ocm-managed-services",namespace="uhc-{{{environment}}}"}
        > 5
      for: 10m
      labels:
        service: ocm-managed-services
        severity: {{{severity_500_errors}}}
        namespace: uhc-{{{environment}}}
    - alert: OCM Managed Services DOWN - {{{environment}}}
      annotations:
        message: "No targets found for OCM Managed Services in namespace uhc-{{{environment}}}. OCM Managed Services service is down."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/uhc/sop/ocm-managed-services.md"
      expr: |
        absent(up{job="ocm-managed-services-metrics",namespace="uhc-{{{environment}}}"} == 1)
      for: 5m
      labels:
        service: ocm-managed-services
        severity: {{{severity_oms_down}}}
