---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: mas-sso-slo-availability-stage
spec:
  groups:
      - name: mas-sso-slo-availability-stage
        rules:
          - alert: ManagedSSOAPI1hErrorBudgetBurn
            annotations:
              message: 'High 5m to 1h error budget burn for MAS SSO (current value: {{ $value | printf "%.2f" }})'
              dashboard: "https://grafana.stage.devshift.net/d/nzxiqJQMk/mas-sso-monitoring?orgId=1"
              runbook: ""
            expr: |
              sum(haproxy_backend_http_responses_total:burnrate5m{route="keycloak",exported_namespace="mas-sso-stage"}) > (14.40 * (1-0.99000)) #0.144
              and
              sum(haproxy_backend_http_responses_total:burnrate1h{route="keycloak",exported_namespace="mas-sso-stage"}) > (14.40 * (1-0.99000))
            for: 2m
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
              severity: info
          - alert: ManagedSSOAPI6hErrorBudgetBurn
            annotations:
              message: 'High 6h error budget burn for MAS SSO (current value: {{ $value | printf "%.2f" }})'
              dashboard: "https://grafana.stage.devshift.net/d/nzxiqJQMk/mas-sso-monitoring?orgId=1"
              runbook: ""
            expr: |
              sum(haproxy_backend_http_responses_total:burnrate30m{route="keycloak",exported_namespace="mas-sso-stage"}) > (6.00 * (1-0.99000))#0.06
              and
              sum(haproxy_backend_http_responses_total:burnrate6h{route="keycloak",exported_namespace="mas-sso-stage"}) > (6.00 * (1-0.99000))
            for: 15m
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
              severity: info
          - alert: ManagedSSOAPI1dErrorBudgetBurn
            annotations:
              message: 'High 1d error budget burn for MAS SSO (current value: {{ $value | printf "%.2f" }})'
              dashboard: "https://grafana.stage.devshift.net/d/nzxiqJQMk/mas-sso-monitoring?orgId=1"
              runbook: ""
            expr: |
              sum(haproxy_backend_http_responses_total:burnrate2h{route="keycloak",exported_namespace="mas-sso-stage"}) > (3.00 * (1-0.99000)) #0.03
              and
              sum(haproxy_backend_http_responses_total:burnrate1d{route="keycloak",exported_namespace="mas-sso-stage"}) > (3.00 * (1-0.99000))
            for: 1h
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
              severity: info
          - alert: ManagedSSOAPI3dErrorBudgetBurn
            annotations:
              message: 'High 3d error budget burn for MAS SSO (current value: {{ $value | printf "%.2f" }})'
              dashboard: "https://grafana.stage.devshift.net/d/nzxiqJQMk/mas-sso-monitoring?orgId=1"
              runbook: ""
            expr: |
              sum(haproxy_backend_http_responses_total:burnrate6h{route="keycloak",exported_namespace="mas-sso-stage"}) > (1.00 * (1-0.99000)) #0.01
              and
              sum(haproxy_backend_http_responses_total:burnrate3d{route="keycloak",exported_namespace="mas-sso-stage"}) > (1.00 * (1-0.99000))
            for: 3h
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
              severity: info
          - expr: |
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage",code="5xx"}[1d]))
              /
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage"}[1d]))
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
            record: haproxy_backend_http_responses_total:burnrate1d
          - expr: |
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage",code="5xx"}[1h]))
              /
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage"}[1h]))
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
            record: haproxy_backend_http_responses_total:burnrate1h
          - expr: |
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage",code="5xx"}[2h]))
              /
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage"}[2h]))
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
            record: haproxy_backend_http_responses_total:burnrate2h
          - expr: |
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage",code="5xx"}[30m]))
              /
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage"}[30m]))
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
            record: haproxy_backend_http_responses_total:burnrate30m
          - expr: |
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage",code="5xx"}[3d]))
              /
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage"}[3d]))
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
            record: haproxy_backend_http_responses_total:burnrate3d
          - expr: |
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage",code="5xx"}[5m]))
              /
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage"}[5m]))
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
            record: haproxy_backend_http_responses_total:burnrate5m
          - expr: |
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage",code="5xx"}[6h]))
              /
              sum(rate(haproxy_backend_http_responses_total{route="keycloak",exported_namespace="mas-sso-stage"}[6h]))
            labels:
              service: mas-sso
              route: keycloak
              exported_namespace: mas-sso-stage
            record: haproxy_backend_http_responses_total:burnrate6h
