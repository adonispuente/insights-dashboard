---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    prometheus: app-sre
    role: alert-rules
  name: ci-int-alertrules
spec:
  groups:
  # Alerting for Jenkins jobs
  - name: jenkins-jobs.rules
    rules:
    # Hive team jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-hive-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: hive
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net/d/hivemetrics/hive-metrics"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # AppSRE jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='jenkins-slaves-cleanup',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: ci-int
      annotations:
        runbook: "https://gitlab.cee.redhat.com/dtsd/housekeeping/blob/master/docs/ci/ci-int/ci-int.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-app-interface-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: critical
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/app-interface-build-master-failure.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-app-interface-gl-periodic-job-app-interface-reporter',job='jenkins_int'} > 0"
      labels:
        severity: high
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      # `> 1` to avoid alerts on UNSTABLE (https://jira.coreos.com/browse/APPSRE-1280)
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-app-interface-gl-periodic-job-e2e-tests',job='jenkins_int'} > 1"
      labels:
        severity: high
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/app-interface-e2e-tests-debug.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='gitkeeper-run',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/push-saas-metrics.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    # RHEL ci-int nodes subscription
    - alert: RHEL7Subscription
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='jenkins-node-rhel7-check',job='jenkins_int'} > 0"
      for: 130m
      labels:
        severity: high
        service: ci-int
      annotations:
        summary: "{% raw %}RHEL7 subscription isn't valid (instance {{ $labels.instance }}){% endraw %}"
        message: "{% raw %}RHEL7 subscription has problems, docker builds aren't possible{% endraw %}"
    - alert: RHEL8Subscription
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='jenkins-node-rhel8-check',job='jenkins_int'} > 0"
      for: 130m
      labels:
        severity: high
        service: ci-int
      annotations:
        summary: "{% raw %}RHEL8 subscription isn't valid (instance {{ $labels.instance }}){% endraw %}"
        message: "{% raw %}RHEL8 subscription has problems, docker builds aren't possible{% endraw %}"

    # ClusterImageSets jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='clusterimageset-run',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/clusterimagesets.md"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # UHC jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-clusters-service-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        email: service-development-a
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-gateway-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-portal-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='uhc-api-test-production-provision',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='uhc-api-test-staging-provision',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='uhc-cluster-cleaner-staging',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        email: service-development-a
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-portal-gl-cloud-redhat-com-push-insights-beta',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        email: service-development-a
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-portal-gl-cloud-redhat-com-push-insights-stable',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        email: service-development-a
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # UHC team SD-B jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-uhc-account-manager-gl-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        channel: service-development-b
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='service-ocm-resources-ocm-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: uhc
        channel: service-development-b
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "@ocm-resources {{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # Cincinnati team jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-cincinnati-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: cincinnati
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net/d/cincinnati/cincinnati"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # SREP team jenkins job alerts
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-aws-account-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
        link_url: "https://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-certman-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-pagerduty-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-deadmanssnitch-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-dedicated-admin-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-configure-alertmanager-operator-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job='openshift-managed-cluster-config-gh-build-master',job='jenkins_int'} > 0"
      labels:
        severity: medium
        service: srep
        channel: team-srep-alert
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build failure"
