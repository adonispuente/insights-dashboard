---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: configuration-anomaly-detection-stage
spec:
  groups:
    - name: srep-configuration-anomaly-pipeline-detection
      rules:
        - alert: CADPipelineFailure
          expr: |
            sum(kube_pod_status_phase{namespace="configuration-anomaly-detection-stage", phase="Failed"} == 1) by (pod) unless sum(kube_pod_status_phase{namespace="configuration-anomaly-detection-stage", phase="Failed"} offset 5m) by (pod) > 0
          labels:
            service: srep-cad
            severity: medium
          annotations:
            message: 'CAD stage pipeline failed: {{ $labels.pod }}'
            logs_url: 'https://grafana.app-sre.devshift.net/explore?orgId=1&left=%7B%22datasource%22:%22P1A97A9592CB7F392%22,%22queries%22:%5B%7B%22id%22:%22%22,%22region%22:%22us-east-1%22,%22namespace%22:%22%22,%22refId%22:%22A%22,%22datasource%22:%7B%22type%22:%22cloudwatch%22,%22uid%22:%22P1A97A9592CB7F392%22%7D,%22queryMode%22:%22Logs%22,%22logGroupNames%22:%5B%22app-sre-stage-01.configuration-anomaly-detection-stage%22%5D,%22logGroups%22:%5B%5D,%22expression%22:%22fields%20message%5Cn%7C%20filter%20kubernetes.pod_name%20%3D%20%5C%22{{ $labels.pod }}%5C%22%22,%22statsGroups%22:%5B%5D%7D%5D,%22range%22:%7B%22from%22:%22now-2d%22,%22to%22:%22now%22%7D%7D'
            runbook: 'https://github.com/openshift/ops-sop/blob/master/v4/troubleshoot/configuration-anomaly-detection.md'