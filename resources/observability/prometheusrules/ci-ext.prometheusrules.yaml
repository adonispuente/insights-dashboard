---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  creationTimestamp: null
  labels:
    prometheus: app-sre
    role: alert-rules
  name: ci-ext-alertrules
spec:
  groups:
  # Check if ci.ext is present
  - name: jenkins-job-presence.rules
    rules:
    - alert: JenkinsDown
      labels:
        severity: critical-fts
        service: ci-ext
      expr: absent(up{job="jenkins_ext"} == 1)
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/app-sre/sop/jenkins.md#jenkinsdown"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "Jenkins scrape failed for {{ $labels.instance }} for the last 5 minutes. Jenkins is down."
        link_url: "http://ci.ext.devshift.net/"
    # Node exporter down. We add the Jenkins scrape condition to avoid multiple alerts on node down.
    - alert: JenkinsControllerNodeExporterDown
      expr: up{job="ci_ext_jenkins_controller"} == 0 and on() up{job="jenkins_ext"} == 1
      for: 5m
      labels:
        severity: critical-fts
        service: ci-ext
      annotations:
        message: "Node exporter for {{ $labels.instance }} has been down for more than 5 minutes."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/JenkinsControllerNodeExporterDown.md"
    - alert: JenkinsExecutorQueueLengthGrowing
      expr: deriv(default_jenkins_executors_queue_length{label !~ "^i-.{17}$"}[5m]) > 0
      for: 30m  # let's leave ASG time to handle the node unavailable case
      labels:
        severity: critical-fts
        service: ci-ext
      annotations:
        message: "Executor queue length for {{ $labels.label }} has been growing for the last 30 minutes."
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/JenkinsExecutorQueueLengthGrowing.md"

  # Alerting on health of Jenkins system
  - name: jenkins-system.rules
    rules:
    - alert: JenkinsHealthCheck
      labels:
        severity: critical-fts
        service: ci-ext
      expr: jenkins_health_check_score < 1
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md#jenkinshealthcheck"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.instance }}: Jenkins health degraded"
        link_url: "http://{{ $labels.instance }}"
    - alert: JenkinsNodeOffline
      labels:
        severity: critical-fts
        service: ci-ext
      expr: jenkins_node_offline_value > 1
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md#jenkinsnodeoffline"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.instance }}: One or more Jenkins nodes are offline"
        link_url: "http://{{ $labels.instance }}"
    - alert: JenkinsJvmMemoryStarvation
      labels:
        severity: critical-fts
        service: ci-ext
      expr: (vm_memory_total_max{job="jenkins_ext"} - vm_memory_total_used{job="jenkins_ext"}) / vm_memory_total_max{job="jenkins_ext"} * 100.0 < 10
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/sop/jenkins.md#jenkinsjvmmemorystarvation"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.instance }}: Less than 10% memory available more than 5 minutes"
        link_url: "http://{{ $labels.instance }}"

  # Alerting on health of Jenkins Web
  - name: jenkins-web.rules
    rules:
    # We need this recording rule until someone works on https://github.com/jenkinsci/prometheus-plugin/issues/100
    - record: jenkins:http_responseCodes_total
      expr: sum({__name__=~"http_responseCodes_.*"}) by (instance)
    - alert: JenkinsWebForbidden
      labels:
        severity: medium
        service: ci-ext
      expr: |
        sum(rate(http_responseCodes_forbidden_total{instance="ci.ext.devshift.net:80"}[5m]))
        /
        sum(rate(jenkins:http_responseCodes_total{instance="ci.ext.devshift.net:80"}[5m])) * 100 > 10
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.instance }}: Jenkins server is returning 403 for {{ $value }}% of requests"
        link_url: "http://{{ $labels.instance }}"
    - alert: JenkinsWebNotFound
      labels:
        severity: medium
        service: ci-ext
      expr: |
        sum(rate(http_responseCodes_notFound_total{instance="ci.ext.devshift.net:80"}[5m]))
        /
        sum(rate(jenkins:http_responseCodes_total{instance="ci.ext.devshift.net:80"}[5m])) * 100 > 10
      for: 5m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.instance }}: Jenkins server is returning 404 for {{ $value }}% of requests"
        link_url: "http://{{ $labels.instance }}"
    - alert: JenkinsWebServerError
      labels:
        severity: critical-fts
        service: ci-ext
      expr: |
        sum(rate(http_responseCodes_serverError_total{instance="ci.ext.devshift.net:80"}[5m]))
        /
        sum(rate(jenkins:http_responseCodes_total{instance="ci.ext.devshift.net:80"}[5m])) * 100 > 5
      for: 2m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.instance }}: Jenkins server is returning serverError for {{ $value }}% of requests"
        link_url: "http://{{ $labels.instance }}"
    - alert: JenkinsWebServiceUnavailable
      labels:
        severity: critical-fts
        service: ci-ext
      expr: |
        sum(rate(http_responseCodes_serviceUnavailable_total{instance="ci.ext.devshift.net:80"}[5m]))
        /
        sum(rate(jenkins:http_responseCodes_total{instance="ci.ext.devshift.net:80"}[5m])) * 100 > 5
      for: 2m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.instance }}: Jenkins server is returning serviceUnavailable for {{ $value }}% of requests"
        link_url: "http://{{ $labels.instance }}"

  # Alerting for Jenkins jobs
  - name: jenkins-jobs.rules
    rules:
     # Assisted-installer
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-assisted-service-gh-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: assisted-installer
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # Image Builder
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'osbuild-osbuild-composer-gh-build-main-packer',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: image-builder
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # Cincinnati
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-cincinnati-gh-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: cincinnati
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # Hive
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-hive-ghs-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: hive
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # Telemeter
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'openshift-telemeter-gh-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: telemeter
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-saas-telemeter-telemeter-saas-deploy',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: telemeter
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # App-interface
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-validator-gh-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-server-gh-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-qontract-reconcile-gh-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: app-interface
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # Vault
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-vault-manager-gh-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: vault
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"
    - alert: JenkinsLastBuildFailed
      expr: "default_jenkins_builds_last_build_result_ordinal{jenkins_job=~'app-sre-fluentd-gh-build-master',job='jenkins_ext'} > 0"
      labels:
        severity: medium
        service: vault
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/app-sre/"
        dashboard: "https://grafana.app-sre.devshift.net"
        message: "{{ $labels.jenkins_job }} Jenkins job latest build has failed."
        link_url: "http://{{ $labels.instance }}/job/{{ $labels.jenkins_job }}"

    # Recording Rules
    - expr: |
        max by (instance, device) ((node_filesystem_size_bytes{job=~"ci_ext.*",fstype=~"ext[234]|btrfs|xfs|zfs"}
        - node_filesystem_avail_bytes{job=~"ci_ext.*",fstype=~"ext[234]|btrfs|xfs|zfs"})
        / node_filesystem_size_bytes{job=~"ci_ext.*",fstype=~"ext[234]|btrfs|xfs|zfs"})
      record: 'node:node_filesystem_usage:'
    - expr: |
        max by (instance, device) (node_filesystem_avail_bytes{job=~"ci_ext.*",fstype=~"ext[234]|btrfs|xfs|zfs"} / node_filesystem_size_bytes{job=~"ci_ext.*",fstype=~"ext[234]|btrfs|xfs|zfs"})
      record: 'node:node_filesystem_avail:'

    # Alerting rules
    - alert: CriticalMemoryUsage
      expr: '(1 - ((node_memory_MemFree_bytes{job=~"ci_ext.*"} + node_memory_Buffers_bytes{job=~"ci_ext.*"} + node_memory_Cached_bytes{job=~"ci_ext.*"} + node_memory_SReclaimable_bytes{job=~"ci_ext.*"}) / node_memory_MemTotal_bytes{job=~"ci_ext.*"})) * 100 > 98'
      for: 5m
      labels:
        severity: critical-fts
        service: ci-ext
      annotations:
        message: "{{ $labels.instance }} has Critical Memory Usage more than 5 minutes."
        summary: "Instance {{ $labels.instance }} has Critical Memory Usage"
    - alert: OutOfMemory
      expr: (node_memory_MemFree_bytes{job=~"ci_ext.*"} + node_memory_Cached_bytes{job=~"ci_ext.*"} + node_memory_Buffers_bytes{job=~"ci_ext.*"} + node_memory_SReclaimable_bytes{job=~"ci_ext.*"}) / node_memory_MemTotal_bytes{job=~"ci_ext.*"} * 100 < 10
      for: 30m
      labels:
        severity: high
        service: ci-ext
      annotations:
        summary: "Out of memory (instance {{ $labels.instance }})"
        message: "Node memory is filling up (< 10% left)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"
    - alert: PredictNodeDiskFull
      annotations:
        message: "Device {{ $labels.device }} of node {{ $labels.instance }} will be full within the next 2 hours."
      expr: |
        (node:node_filesystem_usage: > 0.85) and (predict_linear(node:node_filesystem_avail:[30m], 3600 * 2) < 0)
      for: 10m
      labels:
        severity: critical-fts
        service: ci-ext
    - alert: PredictNodeDiskFull
      annotations:
        message: "Device {{ $labels.device }} of node {{ $labels.instance }} will be full within the next 24 hours."
      expr: |
        (node:node_filesystem_usage: > 0.85) and (predict_linear(node:node_filesystem_avail:[6h], 3600 * 24) < 0)
      for: 30m
      labels:
        severity: high
        service: ci-ext
    - alert: UnusualNetworkThroughputIn
      expr: sum by (instance) (irate(node_network_receive_bytes_total{job=~"ci_ext.*"}[2m])) / 1024 / 1024 > 100
      for: 30m
      labels:
        severity: high
        service: ci-ext
      annotations:
        summary: "Unusual network throughput in (instance {{ $labels.instance }})"
        message: "Host network interfaces are probably receiving too much data (> 100 MB/s)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"
    - alert: UnusualNetworkThroughputOut
      expr: sum by (instance) (irate(node_network_transmit_bytes_total{job=~"ci_ext.*"}[2m])) / 1024 / 1024 > 100
      for: 30m
      labels:
        severity: high
        service: ci-ext
      annotations:
        summary: "Unusual network throughput out (instance {{ $labels.instance }})"
        message: "Host network interfaces are probably sending too much data (> 100 MB/s)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"
    - alert: OutOfInodes
      expr: node_filesystem_files_free{job=~"ci_ext.*",mountpoint ="/"} / node_filesystem_files{job=~"ci_ext.*",mountpoint ="/"} * 100 < 10
      for: 30m
      labels:
        severity: high
        service: ci-ext
      annotations:
        summary: "Out of inodes (instance {{ $labels.instance }})"
        message: "Disk is almost running out of available inodes (< 10% left)\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"
    - alert: CpuLoad
      expr: node_load15 / (count without (cpu, mode) (node_cpu_seconds_total{job=~"ci_ext.*",mode="system"})) > 5
      for: 30m
      labels:
        severity: high
        service: ci-ext
      annotations:
        summary: "CPU load (instance {{ $labels.instance }})"
        message: "CPU load (15m) is high\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"
