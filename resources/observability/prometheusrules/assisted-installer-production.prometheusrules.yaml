---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: assisted-installer
spec:
  groups:
    - name: assisted-installer_alerts
      rules:
        - alert: Assisted Installer - Service Is Down - Production
          annotations:
            message: "SERVICE IS DOWN"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-service-is-down"
          expr: absent(up{job="assisted-service",namespace="assisted-installer-production"} == 1)
          for: 5m
          labels:
            severity: medium #FIXME: update to critical once we go GA
            service: assisted-installer
        - alert: Assisted Installer - Cluster Installation Failed - Production
          annotations:
            dashboard: "https://grafana.app-sre.devshift.net/d/assisted-installer-cluster-overview/cluster-overview?orgId=1&from=now-1h&to=now&var-datasource=app-sre-prod-04-prometheus&var-clusterId={{ $labels.clusterId }}"
            message: "An attempt to install Openshift {{ $labels.openshiftVersion }} on cluster {{ $labels.clusterId }} has failed"
            runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-cluster-installation"
            redhat_cloud_url: "https://cloud.redhat.com/openshift/assisted-installer/clusters/{{ $labels.clusterId }}"
            kibana_url: "https://kibana-openshift-logging.apps.app-sre-prod-04.i5h0.p1.openshiftapps.com/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-24h,mode:quick,to:now))&_a=(columns:!(_source),interval:auto,query:'{{ $labels.clusterId }}',sort:!('@timestamp',desc))"
            logs_url: "http://logs-collector.usersys.redhat.com/#/"
          expr: sum(increase(service_assisted_installer_cluster_installation_seconds_count{result="error"}[10m])) by (clusterId, openshiftVersion) > 0
          labels:
            severity: medium
            service: assisted-installer
