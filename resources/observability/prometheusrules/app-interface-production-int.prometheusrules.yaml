$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: app-interface-alerts
spec:
  groups:
  - name: app-interface-e2e-tests-create-namespace-cronjob
    rules:
    - alert: E2ETestCreateNamespaceJobFailed
      annotations:
        message: Job e2e-tests-create-namespace failed to complete in app-interface-production.
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/app-interface-e2e-tests-debug.md"
      expr: |
        sum(kube_job_status_failed{job_name=~"e2e-tests-create-namespace.*",namespace="app-interface-production"})
        - sum(kube_job_status_failed{job_name=~"e2e-tests-create-namespace.*",namespace="app-interface-production"} offset 12h)
        > 0
      labels:
        service: app-interface
        severity: high
  - name: app-interface-e2e-tests-dedicated-admin-rolebindings-cronjob
    rules:
    - alert: E2ETestDedicatedAdminRolebindingsJobFailed
      annotations:
        message: Job e2e-tests-dedicated-admin-rolebindings failed to complete in app-interface-production.
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/app-interface-e2e-tests-debug.md"
      expr: |
        sum(kube_job_status_failed{job_name=~"e2e-tests-dedicated-admin-rolebindings.*",namespace="app-interface-production"})
        - sum(kube_job_status_failed{job_name=~"e2e-tests-dedicated-admin-rolebindings.*",namespace="app-interface-production"} offset 12h)
        > 0
      labels:
        service: app-interface
        severity: high
  - name: app-interface-e2e-tests-default-project-labels-cronjob
    rules:
    - alert: E2ETestDefaultProjectLabelsJobFailed
      annotations:
        message: Job e2e-tests-default-project-labels failed to complete in app-interface-production.
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/app-interface-e2e-tests-debug.md"
      expr: |
        sum(kube_job_status_failed{job_name=~"e2e-tests-default-project-labels.*",namespace="app-interface-production"})
        - sum(kube_job_status_failed{job_name=~"e2e-tests-default-project-labels.*",namespace="app-interface-production"} offset 12h)
        > 0
      labels:
        service: app-interface
        severity: high
  - name: app-interface-e2e-tests-default-network-policies-cronjob
    rules:
    - alert: E2ETestDefaultNetworkPoliciesFailed
      annotations:
        message: Job e2e-tests-default-network-policies failed to complete in app-interface-production.
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/app-interface-e2e-tests-debug.md"
      expr: |
        sum(kube_job_status_failed{job_name=~"e2e-tests-default-network-policies.*",namespace="app-interface-production"})
        - sum(kube_job_status_failed{job_name=~"e2e-tests-default-network-policies.*",namespace="app-interface-production"} offset 12h)
        > 0
      labels:
        service: app-interface
        severity: high
  - name: qontract-reconcile
    interval: 1m
    rules:
    - alert: QontractReconcileError
      labels:
        service: app-interface
        severity: critical-fts
        jiralert: ASIC
      expr: qontract_reconcile_last_run_status > 0
      for: 1h
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/app-sre/sop/app-interface-integrations-flow-and-failure-scenarios.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/Integrations/integrations"
        message: "Integration: {{ $labels.integration }} (shard {{ $labels.shard_id }}) has failed with exit code {{ $value }}"
        link_url: ""
    - alert: QontractReconcileIntegrationStuck
      labels:
        service: app-interface
        severity: high
        jiralert: ASIC
      expr: sum(increase(qontract_reconcile_execution_counter_total[2h])) by (integration, shard_id) == 0
      for: 1m
      annotations:
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/app-sre/sop/app-interface-integrations-flow-and-failure-scenarios.md"
        dashboard: "https://grafana.app-sre.devshift.net/d/Integrations/integrations"
        message: "Integration: {{ $labels.integration }} (shard {{ $labels.shard_id }}) has been stuck for 2 hours"
        link_url: ""
