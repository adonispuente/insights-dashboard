---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: qontract-reconcile-time-to-reconcile
spec:
  groups:
  - name: SLOs-qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds
    rules:
#    - alert: LatencyBudgetBurn
#      annotations:
#        message: 'High requests latency budget burn for namespace={{{ namespace }}},latency=1200.0 (current value: {{ $value }})'
#      expr: |
#        (
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate1h{namespace="{{{ namespace }}}",latency="1200.0"} > (14.4*5/100)
#          and
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate5m{namespace="{{{ namespace }}}",latency="1200.0"} > (14.4*5/100)
#        )
#        or
#        (
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate6h{namespace="{{{ namespace }}}",latency="1200.0"} > (6*5/100)
#          and
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate30m{namespace="{{{ namespace }}}",latency="1200.0"} > (6*5/100)
#        )
#      labels:
#        latency: "1200.0"
#        namespace: {{{ namespace }}}
#        severity: {{{ severity }}}
#    - alert: LatencyBudgetBurn
#      annotations:
#        message: 'High requests latency budget burn for namespace={{{ namespace }}},latency=1200.0 (current value: {{ $value }})'
#      expr: |
#        (
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate1d{namespace="{{{ namespace }}}",latency="1200.0"} > (3*5/100)
#          and
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate2h{namespace="{{{ namespace }}}",latency="1200.0"} > (3*5/100)
#        )
#        or
#        (
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate3d{namespace="{{{ namespace }}}",latency="1200.0"} > (5/100)
#          and
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate6h{namespace="{{{ namespace }}}",latency="1200.0"} > (5/100)
#        )
#      labels:
#        latency: "1200.0"
#        namespace: {{{ namespace }}}
#        severity: warning
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_bucket{namespace="{{{ namespace }}}",le="1200.0"}[5m]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_count{namespace="{{{ namespace }}}"}[5m]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate5m
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_bucket{namespace="{{{ namespace }}}",le="1200.0"}[30m]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_count{namespace="{{{ namespace }}}"}[30m]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate30m
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_bucket{namespace="{{{ namespace }}}",le="1200.0"}[1h]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_count{namespace="{{{ namespace }}}"}[1h]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate1h
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_bucket{namespace="{{{ namespace }}}",le="1200.0"}[2h]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_count{namespace="{{{ namespace }}}"}[2h]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate2h
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_bucket{namespace="{{{ namespace }}}",le="1200.0"}[6h]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_count{namespace="{{{ namespace }}}"}[6h]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate6h
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_bucket{namespace="{{{ namespace }}}",le="1200.0"}[1d]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_count{namespace="{{{ namespace }}}"}[1d]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate1d
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_bucket{namespace="{{{ namespace }}}",le="1200.0"}[3d]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds_count{namespace="{{{ namespace }}}"}[3d]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit_seconds:rate3d
