## SLO objective: 95% of reconciliation time under 20 minutes (1200s)
## Calculations from formulas in https://sre.google/workbook/alerting-on-slos/
---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: qontract-reconcile-time-to-reconcile
spec:
  groups:
  - name: SLOs-qontract_reconcile_function_elapsed_seconds_since_bundle_commit
    rules:
     # out of budget in ~50 hours
     # burn rate of 14.4 over 1h is consuming 2% of the 30d error budget
     # burn rate of 14.4 over 5m is consuming 0.17% of the 30d error budget
     # out of budget in ~120 hours
     # burn rate of 6 over 6h is consuming 5% of the 30d error budget
     # burn rate of 6 over 30m is consuming 0.42% of the 30d error budget
#    - alert: LatencyBudgetBurn
#      annotations:
#        message: 'High requests latency budget burn for namespace={{{ namespace }}},latency=1200.0 (current value: {{ $value }})'
#      expr: |
#        (
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate1h{namespace="{{{ namespace }}}",latency="1200.0"} > (14.4*5/100)
#          and
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate5m{namespace="{{{ namespace }}}",latency="1200.0"} > (14.4*5/100)
#        )
#        or
#        (
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate6h{namespace="{{{ namespace }}}",latency="1200.0"} > (6*5/100)
#          and
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate30m{namespace="{{{ namespace }}}",latency="1200.0"} > (6*5/100)
#        )
#      labels:
#        latency: "1200.0"
#        namespace: {{{ namespace }}}
#        severity: {{{ severity }}}
     # out of budget in 10 days
     # burn rate of 3 over 1d is consuming 10% of the 30d error budget
     # burn rate of 3 over 2h is consuming 0.83% of the 30d error budget
     # out of budget in 30 days
     # burn rate of 1 over 3d is consuming 10% of the 30d error budget
     # burn rate of 1 over 6h is consuming 0.83% of the 30d error budget
#    - alert: LatencyBudgetBurn
#      annotations:
#        message: 'High requests latency budget burn for namespace={{{ namespace }}},latency=1200.0 (current value: {{ $value }})'
#      expr: |
#        (
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate1d{namespace="{{{ namespace }}}",latency="1200.0"} > (3*5/100)
#          and
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate2h{namespace="{{{ namespace }}}",latency="1200.0"} > (3*5/100)
#        )
#        or
#        (
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate3d{namespace="{{{ namespace }}}",latency="1200.0"} > (1*5/100)
#          and
#          latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate6h{namespace="{{{ namespace }}}",latency="1200.0"} > (1*5/100)
#        )
#      labels:
#        latency: "1200.0"
#        namespace: {{{ namespace }}}
#        severity: warning
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_bucket{namespace="{{{ namespace }}}",le="1200.0"}[5m]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_count{namespace="{{{ namespace }}}"}[5m]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate5m
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_bucket{namespace="{{{ namespace }}}",le="1200.0"}[30m]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_count{namespace="{{{ namespace }}}"}[30m]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate30m
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_bucket{namespace="{{{ namespace }}}",le="1200.0"}[1h]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_count{namespace="{{{ namespace }}}"}[1h]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate1h
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_bucket{namespace="{{{ namespace }}}",le="1200.0"}[2h]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_count{namespace="{{{ namespace }}}"}[2h]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate2h
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_bucket{namespace="{{{ namespace }}}",le="1200.0"}[6h]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_count{namespace="{{{ namespace }}}"}[6h]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate6h
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_bucket{namespace="{{{ namespace }}}",le="1200.0"}[1d]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_count{namespace="{{{ namespace }}}"}[1d]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate1d
    - expr: |
        1 - (
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_bucket{namespace="{{{ namespace }}}",le="1200.0"}[3d]))
          /
          sum(rate(qontract_reconcile_function_elapsed_seconds_since_bundle_commit_count{namespace="{{{ namespace }}}"}[3d]))
        )
      labels:
        latency: "1200.0"
        namespace: {{{ namespace }}}
      record: latencytarget:qontract_reconcile_function_elapsed_seconds_since_bundle_commit:rate3d
