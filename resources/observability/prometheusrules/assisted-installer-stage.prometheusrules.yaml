---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: assisted-installer
spec:
  groups:


  # generated from https://promtools.dev/alerts/errors
  - name: SLOs-haproxy_backend_http_responses_total
    rules:
    - alert: ErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=assisted-service,exported_namespace=assisted-installer-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-low-availability"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate5m{route="assisted-service",exported_namespace="assisted-installer-stage"}) > (14.40 * (1-0.85000))
        and
        sum(haproxy_backend_http_responses_total:burnrate1h{route="assisted-service",exported_namespace="assisted-installer-stage"}) > (14.40 * (1-0.85000))
      for: 2m
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
        severity: high
    - alert: ErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=assisted-service,exported_namespace=assisted-installer-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-low-availability"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate30m{route="assisted-service",exported_namespace="assisted-installer-stage"}) > (6.00 * (1-0.85000))
        and
        sum(haproxy_backend_http_responses_total:burnrate6h{route="assisted-service",exported_namespace="assisted-installer-stage"}) > (6.00 * (1-0.85000))
      for: 15m
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
        severity: high
    - alert: ErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=assisted-service,exported_namespace=assisted-installer-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-low-availability"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate2h{route="assisted-service",exported_namespace="assisted-installer-stage"}) > (3.00 * (1-0.85000))
        and
        sum(haproxy_backend_http_responses_total:burnrate1d{route="assisted-service",exported_namespace="assisted-installer-stage"}) > (3.00 * (1-0.85000))
      for: 1h
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
        severity: high
    - alert: ErrorBudgetBurn
      annotations:
        message: 'High error budget burn for route=assisted-service,exported_namespace=assisted-installer-stage (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-low-availability"
      expr: |
        sum(haproxy_backend_http_responses_total:burnrate6h{route="assisted-service",exported_namespace="assisted-installer-stage"}) > (1.00 * (1-0.85000))
        and
        sum(haproxy_backend_http_responses_total:burnrate3d{route="assisted-service",exported_namespace="assisted-installer-stage"}) > (1.00 * (1-0.85000))
      for: 3h
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
        severity: high
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage",code="5xx"}[1d]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage"}[1d]))
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
      record: haproxy_backend_http_responses_total:burnrate1d
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage",code="5xx"}[1h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage"}[1h]))
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
      record: haproxy_backend_http_responses_total:burnrate1h
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage",code="5xx"}[2h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage"}[2h]))
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
      record: haproxy_backend_http_responses_total:burnrate2h
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage",code="5xx"}[30m]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage"}[30m]))
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
      record: haproxy_backend_http_responses_total:burnrate30m
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage",code="5xx"}[3d]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage"}[3d]))
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
      record: haproxy_backend_http_responses_total:burnrate3d
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage",code="5xx"}[5m]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage"}[5m]))
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
      record: haproxy_backend_http_responses_total:burnrate5m
    - expr: |
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage",code="5xx"}[6h]))
        /
        sum(rate(haproxy_backend_http_responses_total{route="assisted-service",exported_namespace="assisted-installer-stage"}[6h]))
      labels:
        service: assisted-installer
        exported_namespace: assisted-installer-stage
        route: assisted-service
      record: haproxy_backend_http_responses_total:burnrate6h


  # generated from https://promtools.dev/alerts/latency
  - name: SLOs-http_request_duration_seconds
    rules:
    - alert: LatencyBudgetBurn
      annotations:
        message: 'High requests latency budget burn for endpoint=assisted-svc,namespace=assisted-installer-stage,latency=1 (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-high-latency"
      expr: |
        (
          latencytarget:http_request_duration_seconds:rate1h{endpoint="assisted-svc",namespace="assisted-installer-stage",latency="1"} > (14.4*0.1)
          and
          latencytarget:http_request_duration_seconds:rate5m{endpoint="assisted-svc",namespace="assisted-installer-stage",latency="1"} > (14.4*0.1)
        )
        or
        (
          latencytarget:http_request_duration_seconds:rate6h{endpoint="assisted-svc",namespace="assisted-installer-stage",latency="1"} > (6*0.1)
          and
          latencytarget:http_request_duration_seconds:rate30m{endpoint="assisted-svc",namespace="assisted-installer-stage",latency="1"} > (6*0.1)
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
        severity: high
    - alert: LatencyBudgetBurn
      annotations:
        message: 'High requests latency budget burn for endpoint=assisted-svc,namespace=assisted-installer-stage,latency=1 (current value: {{ $value }})'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-high-latency"
      expr: |
        (
          latencytarget:http_request_duration_seconds:rate1d{endpoint="assisted-svc",namespace="assisted-installer-stage",latency="1"} > (3*0.1)
          and
          latencytarget:http_request_duration_seconds:rate2h{endpoint="assisted-svc",namespace="assisted-installer-stage",latency="1"} > (3*0.1)
        )
        or
        (
          latencytarget:http_request_duration_seconds:rate3d{endpoint="assisted-svc",namespace="assisted-installer-stage",latency="1"} > (0.1)
          and
          latencytarget:http_request_duration_seconds:rate6h{endpoint="assisted-svc",namespace="assisted-installer-stage",latency="1"} > (0.1)
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
        severity: high
    - expr: |
        1 - (
          sum(rate(http_request_duration_seconds_bucket{endpoint="assisted-svc",namespace="assisted-installer-stage",le="1",code!~"5.."}[5m]))
          /
          sum(rate(http_request_duration_seconds_count{endpoint="assisted-svc",namespace="assisted-installer-stage"}[5m]))
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
      record: latencytarget:http_request_duration_seconds:rate5m
    - expr: |
        1 - (
          sum(rate(http_request_duration_seconds_bucket{endpoint="assisted-svc",namespace="assisted-installer-stage",le="1",code!~"5.."}[30m]))
          /
          sum(rate(http_request_duration_seconds_count{endpoint="assisted-svc",namespace="assisted-installer-stage"}[30m]))
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
      record: latencytarget:http_request_duration_seconds:rate30m
    - expr: |
        1 - (
          sum(rate(http_request_duration_seconds_bucket{endpoint="assisted-svc",namespace="assisted-installer-stage",le="1",code!~"5.."}[1h]))
          /
          sum(rate(http_request_duration_seconds_count{endpoint="assisted-svc",namespace="assisted-installer-stage"}[1h]))
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
      record: latencytarget:http_request_duration_seconds:rate1h
    - expr: |
        1 - (
          sum(rate(http_request_duration_seconds_bucket{endpoint="assisted-svc",namespace="assisted-installer-stage",le="1",code!~"5.."}[2h]))
          /
          sum(rate(http_request_duration_seconds_count{endpoint="assisted-svc",namespace="assisted-installer-stage"}[2h]))
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
      record: latencytarget:http_request_duration_seconds:rate2h
    - expr: |
        1 - (
          sum(rate(http_request_duration_seconds_bucket{endpoint="assisted-svc",namespace="assisted-installer-stage",le="1",code!~"5.."}[6h]))
          /
          sum(rate(http_request_duration_seconds_count{endpoint="assisted-svc",namespace="assisted-installer-stage"}[6h]))
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
      record: latencytarget:http_request_duration_seconds:rate6h
    - expr: |
        1 - (
          sum(rate(http_request_duration_seconds_bucket{endpoint="assisted-svc",namespace="assisted-installer-stage",le="1",code!~"5.."}[1d]))
          /
          sum(rate(http_request_duration_seconds_count{endpoint="assisted-svc",namespace="assisted-installer-stage"}[1d]))
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
      record: latencytarget:http_request_duration_seconds:rate1d
    - expr: |
        1 - (
          sum(rate(http_request_duration_seconds_bucket{endpoint="assisted-svc",namespace="assisted-installer-stage",le="1",code!~"5.."}[3d]))
          /
          sum(rate(http_request_duration_seconds_count{endpoint="assisted-svc",namespace="assisted-installer-stage"}[3d]))
        )
      labels:
        service: assisted-installer
        latency: "1"
        namespace: assisted-installer-stage
      record: latencytarget:http_request_duration_seconds:rate3d


  - name: assisted-installer_alerts
    rules:
      - alert: Assisted Installer - Service Is Down - Stage
        annotations:
          message: "SERVICE IS DOWN"
          runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-service-is-down"
        expr: absent(up{job="assisted-service",namespace="assisted-installer-stage"} == 1)
        for: 5m
        labels:
          severity: high
          service: assisted-installer
      - alert: Assisted Installer - Version Upgrade Failure - Stage
        annotations:
          message: "Assisted Installer service is failing to upgrade its version."
          runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-version-upgrade-failed"
        expr: count(up{job="assisted-service",namespace="assisted-installer-stage"}) < 3
        for: 5m
        labels:
          severity: info
          service: assisted-installer
      # Detects not ready pods. Matches only pods for assisted-service deployment and
      # assisted-image-service statefulset
      - alert: Assisted Installer - Pod not ready
        annotations:
          message: Assisted Installer Pod {{ $labels.pod }} on namespace {{ $labels.namespace }} not ready
          runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-service-is-down"
        # get minimum value for time window. This will ensure that we get constantly "not ready" status
        # when alerting
        expr: min(kube_pod_status_ready{namespace=~"assisted-installer-(stage|integration)",pod=~"(assisted-image-service-[0-9]+|assisted-service-[0-9a-z]{9}-[0-9a-z]{5})",condition="false"}) by (pod, namespace) + min(kube_pod_status_ready{namespace=~"assisted-installer-(stage|integration)",pod=~"(assisted-image-service-[0-9]+|assisted-service-[0-9a-z]{9}-[0-9a-z]{5})",condition="unknown"}) by (pod, namespace) > 0
        for: 3m
        labels:
          severity: info
          service: assisted-installer
      - alert: Assisted Installer - Memory usage is above 90%
        annotations:
          message: Assisted Installer Pod {{ $labels.pod }} on namespace {{ $labels.namespace }} usages is above 90%({{ $value }})
        expr: sum(container_memory_working_set_bytes{namespace="assisted-installer-stage", container="assisted-service"}) by (pod, namespace) / sum(kube_pod_container_resource_limits{namespace="assisted-installer-stage", container="assisted-service", resource="memory"}) BY (pod, namespace) * 100 > 90
        for: 1m
        labels:
          severity: warning
          service: assisted-installer
      - alert: Assisted Installer - Memory usage is above 80%
        annotations:
          message: Assisted Installer Pod {{ $labels.pod }} on namespace {{ $labels.namespace }} usages is above 80%({{ $value }})
        expr: sum(container_memory_working_set_bytes{namespace="assisted-installer-stage", container="assisted-service"}) by (pod, namespace) / sum(kube_pod_container_resource_limits{namespace="assisted-installer-stage", container="assisted-service", resource="memory"}) BY (pod, namespace) * 100 > 80
        for: 1m
        labels:
          severity: info
          service: assisted-installer
      - alert: Assisted Installer - CPU usage is above 90%
        annotations:
          message: Assisted Installer Container CPU usages (pod {{ $labels.pod }}, namespace {{ $labels.namespace }}) is above 90%({{ $value | printf "%.2f" }}%)
        expr: rate(container_cpu_usage_seconds_total{namespace="assisted-installer-stage", container="assisted-service"}[90s]) * 100 > 90
        labels:
          severity: warning
          service: assisted-installer

      - alert: Assisted Installer - Service is crashing
        annotations:
          message: Assisted Installer container '{{ $labels.container }}' of pod '{{ $labels.pod }}' is crashing
        expr: |
          sum(increase(kube_pod_container_status_restarts_total{namespace="assisted-installer-stage",pod=~"^assisted-service-.*$"}[10m]))
          by (pod,container)
          >= 2
        for: 1m
        labels:
          severity: warning
          service: assisted-installer
