---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: hive-{{{appsre_env}}}-capacity
spec:
  groups:
  - name: hive-{{{appsre_env}}}-capacity
    rules:
    - expr: |
        sum (hive_cluster_deployments{age_lt="+Inf",appsre_env="{{{appsre_env}}}",shard_status="active"}) / (count(count by (instance) (hive_cluster_deployments{age_lt="+Inf",appsre_env="{{{appsre_env}}}",shard_status="active"})) * {{{max_clusters_per_shard}}})
      labels:
        appsre_env: {{{appsre_env}}}
      record: hive:global_capacity_used:percent
    - expr: |
        sum by (instance) (hive_cluster_deployments{age_lt="+Inf",appsre_env="{{{appsre_env}}}"}) / {{{max_clusters_per_shard}}}
      labels:
        appsre_env: {{{appsre_env}}}
      record: hive:shard_capacity_used:percent
