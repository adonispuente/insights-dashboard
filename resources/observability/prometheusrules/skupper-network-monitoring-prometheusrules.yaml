---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: skupper-network-monitoring-prometheusrules
spec:
  groups:
  - name: skupper-network-monitoring-rules
    rules:
    - alert: 'Skupper Network - X509ExporterReadErrors'
      expr: delta(x509_read_errors[15m]) > 0
      for: 5m
      labels:
        service: skupper-network-monitoring
        severity: high
      annotations:
        message: Increasing read errors for x509-certificate-exporter
        description: Over the last 15 minutes, this x509-certificate-exporter instance has experienced errors reading certificate files or querying the Kubernetes API. This could be caused by a misconfiguration if triggered when the exporter starts.
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/skupper-network-monitoring/sop/X509ExporterReadErrors.md"

    - alert: 'Skupper Network - CertificateError'
      expr: x509_cert_error{secret_name=~"skupper.*"} > 0
      for: 15m
      labels:
        service: skupper-network-monitoring
        severity: critical
      annotations:
        message: Certificate cannot be decoded
        description: Certificate could not be decoded in Kubernetes secret "{{ $labels.secret_namespace }}/{{ $labels.secret_name }}"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/skupper-network-monitoring/sop/CertificateError.md"

    - alert: 'Skupper Network - CertificateExpiration'
      expr: ((x509_cert_not_after{secret_name=~"skupper.*"} - time()) / 86400) < 14
      for: 15m
      labels:
        service: skupper-network-monitoring
        severity: high
      annotations:
        message: Certificate is about to expire
        description: Certificate for "{{ $labels.subject_CN }}" is about to expire in Kubernetes secret "{{ $labels.secret_namespace }}/{{ $labels.secret_name }}"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/tree/master/docs/skupper-network-monitoring/sop/CertificateExpiration.md"
