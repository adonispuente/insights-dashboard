# <!subteam^S01T3MZGJ9M> is @edge-cloud-team
# https://api.slack.com/reference/surfaces/formatting#mentioning-groups
---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: assisted-installer-events
spec:
  groups:
  - name: assisted-installer-events_alerts
    rules:
    - alert: Assisted Installer Events - Too many restarts - Production
      annotations:
        message: "Too many restarts for assisted-installer-events pod <!subteam^S01T3MZGJ9M>"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-events-is-down"
      expr: increase(kube_pod_container_status_restarts_total{container="assisted-events-scrape"}[15m]) > 0
      for: 30m
      labels:
          severity: info
          service: assisted-installer

    - alert: Assisted Installer Events - No CPU activity detected - Production
      annotations:
        message: "Assisted Installer Events - No CPU activity in the last hour detected for pod {{ $labels.pod }} <!subteam^S01T3MZGJ9M>"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-events-no-cpu-activity"
      expr: sum(increase(container_cpu_usage_seconds_total{container="assisted-events-scrape"}[1h])) by (pod) == 0
      for: 15m
      labels:
          severity: info
          service: assisted-installer

    - alert: Assisted Installer Events - Assisted service events ingestion greatly reduced - Production
      annotations:
        message: "Assisted Installer Events - Assisted service events ingestion greatly reduced for index .events (CCX export) <!subteam^S01T3MZGJ9M>"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#assisted-installer-events-ingestion-reduced"
      expr: ((increase(assisted_installer_events_max_event_id{namespace="assisted-installer-production"}[1h]) + 1) / on (namespace) (sum(increase(elasticsearch_indices_shards_docs{index=".events",primary="true"}[1h])) by (namespace) + 1)) > 2
      for: 4h
      labels:
          severity: info
          service: assisted-installer

    - alert: Assisted Installer Opensearch - Opensearch (production) disk is getting full
      annotations:
        message: "Assisted Installer Opensearch - Opensearch (production) disk is getting full (node {{ $labels.name }} is {{ $value }}% full) <!subteam^S01T3MZGJ9M>"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#opensearch-disk-filling-up"
      expr: elasticsearch_filesystem_data_size_bytes{es_data_node="true",namespace="assisted-installer-production"} / (elasticsearch_filesystem_data_size_bytes{es_data_node="true",namespace="assisted-installer-production"} + elasticsearch_filesystem_data_available_bytes{es_data_node="true",namespace="assisted-installer-production"}) * 100 > 70
      for: 30m
      labels:
          severity: warning
          service: assisted-installer

    - alert: Assisted Installer Opensearch - Opensearch (production) disk is above watermark
      annotations:
        message: "Assisted Installer Opensearch - Opensearch (production) disk is above watermark (node {{ $labels.name }} is {{ $value }}% full) <!subteam^S01T3MZGJ9M>"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#opensearch-disk-filling-up"
      expr: elasticsearch_filesystem_data_size_bytes{es_data_node="true",namespace="assisted-installer-production"} / (elasticsearch_filesystem_data_size_bytes{es_data_node="true",namespace="assisted-installer-production"} + elasticsearch_filesystem_data_available_bytes{es_data_node="true",namespace="assisted-installer-production"}) * 100 > 80
      for: 15m
      labels:
          severity: warning
          service: assisted-installer

    - alert: Assisted Installer Kafka - Kafka broker disk is running out of available space
      annotations:
        message: "Assisted Installer Kafka {{ $labels.cluster_name }} - Kafka broker {{ $labels.broker_id }} disk is running out of available space ({{ $value }}% used) <!subteam^S01T3MZGJ9M>"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#kafka-broker-disk-is-running-out-of-available-space"
        dashboard: "https://grafana.app-sre.devshift.net/d/V4mSz6j4k/assisted-installer-kafka?orgId=1&var-datasource=app-sre-prod-01-prometheus&from=now-3h&to=now"
      expr: max(aws_kafka_kafka_data_logs_disk_used_maximum{cluster_name=~"assisted-installer.*"}) by (cluster_name, broker_id) > 70 <= 90
      for: 10m
      labels:
          severity: warning
          service: assisted-installer

    - alert: Assisted Installer Kafka - Kafka broker disk is running out of available space
      annotations:
        message: "Assisted Installer Kafka {{ $labels.cluster_name }} - Kafka broker {{ $labels.broker_id }} disk is running out of available space ({{ $value }}% used) <!subteam^S01T3MZGJ9M>"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#kafka-broker-disk-is-running-out-of-available-space"
        dashboard: "https://grafana.app-sre.devshift.net/d/V4mSz6j4k/assisted-installer-kafka?orgId=1&var-datasource=app-sre-prod-01-prometheus&from=now-3h&to=now"
      expr: max(aws_kafka_kafka_data_logs_disk_used_maximum{cluster_name=~"assisted-installer.*"}) by (cluster_name, broker_id) > 90
      for: 10m
      labels:
          severity: high
          service: assisted-installer

    - alert: Assisted Installer Kafka - Offset lag is too high
      annotations:
        message: "Assisted Installer Kafka {{ $labels.cluster_name }} - Consumer group {{ $labels.consumer_group }} offset lag has been high for the last 4h, now reaching {{ $value }} <!subteam^S01T3MZGJ9M>"
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/-/blob/master/docs/assisted-installer/sop#kafka-offset-lag-is-too-high"
        dashboard: "https://grafana.app-sre.devshift.net/d/V4mSz6j4k/assisted-installer-kafka?orgId=1&var-datasource=app-sre-prod-01-prometheus&from=now-3h&to=now"
      expr: max(aws_kafka_max_offset_lag_maximum{cluster_name=~"assisted-installer.*",consumer_group!~"^amazon.*"}) by (cluster_name, consumer_group) > 1500
      for: 4h
      labels:
          severity: warning
          service: assisted-installer
