---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: openshift-logging-production
spec:
  groups:
  - name: openshift-logging-production.rules
    rules:
    - alert: ElasticsearchStatusCritical
      labels:
        severity: medium
      # Cluster status is RED. See https://github.com/vvanholl/elasticsearch-prometheus-exporter/issues/169
      expr: max(es_cluster_status) by (namespace) == 2
      for: 5m
      annotations:
        message: 'Elasticsearch server in namespace {{$labels.namespace}} has been down for 5 minutes'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/openshift-logging-alarms.md"
        dashboard: "https://grafana.app-sre.devshift.net"
    - alert: ElasticsearchNoSpaceWithin48h
      labels:
        severity: medium
      expr: predict_linear(es_fs_path_free_bytes[1h], 24*3600) < 0
      for: 10m
      annotations:
        message: 'Elasticsearch server in namespace {{$labels.namespace}} on node {{$labels.node}} will be out of disk space within 48h'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/openshift-logging-alarms.md"
        dashboard: "https://grafana.app-sre.devshift.net"
    - alert: ElasticsearchLowAvailableSpace
      labels:
        severity: medium
      expr: 100 * sum(es_fs_path_free_bytes) by (namespace) / sum(es_fs_path_total_bytes) by (namespace) < 10
      for: 10m
      annotations:
        message: 'Elasticsearch server in namespace {{$labels.namespace}} is running out of space'
        runbook: "https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/openshift-logging-alarms.md"
        dashboard: "https://grafana.app-sre.devshift.net"
