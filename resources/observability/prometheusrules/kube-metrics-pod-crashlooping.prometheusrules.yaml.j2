---
$schema: /openshift/prometheus-rule-1.yml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    prometheus: app-sre
    role: alert-rules
  name: kube-metrics-pod-crashlooping
spec:
  groups:
  - name: kubernetes-metrics-pod-crashlooping
    rules:
    {{%- for cluster in query('/queries/cluster-namespace-onboarding-status.graphql', name=resource.namespace.cluster.name) %}}
    {{%- for namespace in cluster.namespaces %}}
    {{%- if not namespace.name.startswith('openshift-') or namespace.name == "openshift-customer-monitoring" %}}
    {{%- if namespace.app.onboardingStatus == 'OnBoarded' %}}
    {{%- if "kube_metrics_pod_crashlooping_alert" not in namespace.app.labels %}}
    - alert: KubePodCrashLooping
      expr: 'rate(kube_pod_container_status_restarts_total{job="kube-state-metrics",namespace="{{{ namespace.name }}}"}[5m]) * 60 * 5 > 0'
      annotations:
        message: ({{{ cluster.name }}}/{{ $labels.namespace }}) Pod {{ $labels.pod }} ({{ $labels.container }}) is restarting {{ printf "%.2f" $value }} times / 5 minutes.
        runbook: https://gitlab.cee.redhat.com/service/app-interface/blob/master/docs/app-sre/sop/kubernetes/KubePodCrashLooping.md
      for: 15m
      labels:
        service: openshift
        severity: high
    {{%- endif %}}
    {{%- endif %}}
    {{%- endif %}}
    {{%- endfor %}}
    {{%- endfor %}}
