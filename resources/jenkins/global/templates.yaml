# Runs build_deploy.sh (polling if required) and deploys to staging
#
# vars required in the GitHub job definition:
# - gh_org: GitHub org
# - gh_repo: GitHub repo
#
# vars required in the GitLab job definition:
# - gl_group: GitLab group
# - gl_project: GitLab repo
#
# optional vars
# - kube_cluster: cluster name
# - kube_namespace: Namespace to deploy to
# - saasherder_context: saasherder context declared in config.yaml
# - saasherder_services: space separated list of saasherder service names
# - saas_git: saas herder repo uri, should be public
# - image_pattern: Regex of the image path to check against
# - quay_org: name of the quay organisation
#
# optional secrets:
# The secret 'app-sre/creds/kube-configs/{kube_cluster}' must exist.
# The secret 'app-sre/quay/{quay_org}-push' must exist, with `user`, `token` and `config.json` keys.
- job-template:
    id: 'gh-build-master'
    name: '{gh_org}-{gh_repo}-gh-build-{branch}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *kube_config
        - *quay_secret_push
        - *app_sre_bot_push_token
    <<: *gh_build_master

- job-template:
    id: 'gl-build-master'
    name: '{gl_group}-{gl_project}-gl-build-{branch}'
    wrappers:
      - timeout_wrapper:
          timeout: '{timeout}'
      - vault-secrets:
          <<: *vault_defaults
          secrets:
          - *kube_config
          - *quay_secret_push
          - *app_sre_bot_push_token
    <<: *gl_build_master

- job-template:
    id: gh-build-master-with-upstream
    name: '{gh_org}-{gh_repo}-gh-build-{branch}-upstream-{upstream}'
    upstream: ''
    branch: master
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *kube_config
        - *quay_secret_push
        - *app_sre_bot_push_token
    triggers:
    - reverse:
        jobs: '{upstream}'
        results: 'success'
    <<: *gh_build_master

- job-template:
    id: gl-build-master-with-upstream
    name: '{gl_group}-{gl_project}-gl-build-{branch}-upstream-{upstream}'
    upstream: ''
    branch: master
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *kube_config
        - *quay_secret_push
        - *app_sre_bot_push_token
    triggers:
    - reverse:
        jobs: '{upstream}'
        results: 'success'
    <<: *gl_build_master

# PR check job
#
# vars required in the GitHub job definition:
# - gh_org: GitHub org
# - gh_repo: GitHub repo
#
# vars required in the GitLab job definition:
# - gl_group: GitLab group
# - gl_project: GitLab repo
#
# optional vars:
# - pr_check_script_path: the command to run. Defaults to `./pr_check.sh`

- job-template:
    id: 'gh-pr-check'
    name: '{gh_org}-{gh_repo}-gh-pr-check'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *3scale_api
    <<: *gh_pr_check

- job-template:
    id: 'gl-pr-check'
    name: '{gl_group}-{gl_project}-gl-pr-check'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *3scale_api
    <<: *gl_pr_check


# Timed Job
#
# required vars:
# - cron_expression: cron expression
#
# vars required in the GitHub job definition:
# - gh_org: GitHub org
# - gh_repo: GitHub repo
#
# vars required in the GitLab job definition:
# - gl_group: GitLab group
# - gl_project: GitLab repo
#
# optional vars:
# - ci_cmd: the command to run. Defaults to `./run.sh`
- job-template:
    id: 'gh-timed'
    name: '{gh_org}-{gh_repo}-timed'
    <<: *gh_timed

- job-template:
    id: 'gl-timed'
    name: '{gl_group}-{gl_project}-timed'
    <<: *gl_timed

# Runs build_tag.sh (polling if required)
#
# vars required in the GitHub job definition:
# - gh_org: GitHub org
# - gh_repo: GitHub repo
- job-template:
    id: 'gh-build-tag'
    name: '{gh_org}-{gh_repo}-gh-build-tag'
    <<: *gh_build_tag
