- defaults:
    <<: *local_defaults
    name: global
    label: none
    disable: 'false'
    display-name: '[{label}] {display_name}'
    image_pattern: ''
    kube_namespace: 'error_no_ns'
    oc: '$SSH_CMD oc --server="$KUBE_SERVER" --token="$KUBE_TOKEN" -n {kube_namespace}'
    # saasherder_image: "quay.io/openshiftio/saasherder:17f2f4a"
    # replace the above line if quay.io is down
    saasherder_image: "gcr.io/app-sre/saasherder:17f2f4a"
    saasherder_context: ''
    saas_env: ''
    saasherder: 'docker run {saasherder_options} {saasherder_image} --context "{saasherder_context}" --environment "{saas_env}"'
    saasherder_check_image: "docker run {saasherder_options} -e SKOPEO_USER=$QUAY_USER -e SKOPEO_PASS=$QUAY_TOKEN -v ~/.docker/config.json:/root/docker.json:z -e AUTH_FILE=/root/docker.json --entrypoint '' {saasherder_image} python /scripts/check_image.py"
    saasherder_object_blacklist: 'Route,Secret,ConfigMap,ServiceAccount'
    saasherder_object_whitelist: 'Deployment,DeploymentConfig,Service,ConfigMap,Role,RoleBinding,ServiceAccount,CronJob,StatefulSet'
    saasherder_object_validate: 'Deployment,DeploymentConfig'
    saasherder_validate_max_attempts: '20'
    description: |
        [{label}] {display_name}
        Managed by App-Interface https://gitlab.cee.redhat.com/service/app-interface
    timeout: 30
    concurrent_build: false
    # manifest_bouncer_image: 'quay.io/app-sre/manifest-bouncer:d3e5cbf'
    # replace the above line if quay.io is down
    manifest_bouncer_image: 'gcr.io/app-sre/manifest-bouncer:d3e5cbf'
    manifest_bouncer_cmd: 'docker run --rm -i {manifest_bouncer_image} {manifest_bouncer_options} -'
    success_note_url_path: ''
    failure_note_url_path: ''
    unstable_note_url_path: ''
    days_to_keep: 90
    num_to_keep: 200
    white_list_target_branches: 'master'
    quay_org: app-sre
    include_path: ''
    slack_channel_notification: '#sd-app-sre-info'
    slack_notify_start: False
    # openshift_saas_deploy_image: 'quay.io/app-sre/qontract-reconcile:16db0fe'
    # replace the above line if quay.io is down
    openshift_saas_deploy_image: 'gcr.io/app-sre/qontract-reconcile:16db0fe'

- wrapper:
    name: timeout_wrapper
    wrappers:
      - timestamps
      - timeout:
          timeout: '{timeout}'
          timeout-var: 'BUILD_TIMEOUT'
          fail: true
          type: no-activity

- vault_defaults: &vault_defaults
    name: 'vault_defaults'
    vault-url: 'https://vault.devshift.net'
    credentials-id: 'vault-creds'

- gitlab_message_defaults: &gitlab_message_defaults
    name: 'gitlab_message_defaults'
    success_note_url_path: '{success_note_url_path}'
    failure_note_url_path: '{failure_note_url_path}'
    unstable_note_url_path: '{unstable_note_url_path}'

#### Macros

# The 'retry' macro takes a 'cmd' parameter and will
# run that command 'n' times or until it is successful
# 'n' defaults to 5
- builder:
    name: retry
    builders:
     - shell: |
        attempt=1
        max_attempts={n}
        while [ $attempt -le $max_attempts ]; do
            (
                {cmd}
            )

            [ $? -eq 0 ] && break

            if [ $attempt -lt $max_attempts ]; then
                sleep $attempt
                attempt=$[$attempt+1]
            else
                exit 1
            fi
        done
