- defaults:
    <<: *local_defaults
    name: global
    label: none
    disable: 'false'
    display-name: '[{label}] {display_name}'
    description: |
        [{label}] {display_name}
        Managed by App-Interface https://gitlab.cee.redhat.com/service/app-interface
    timeout: 30
    concurrent_build: false
    failure_only: false
    success_note: true
    success_note_url_path: ''
    failure_note: true
    failure_note_url_path: ''
    unstable_note: true
    unstable_note_url_path: ''
    days_to_keep: 90
    num_to_keep: 200
    branch: master
    white_list_target_branches: '{branch}'
    quay_org: app-sre
    include_path: ''
    trigger_exclude_path: ''
    trigger_include_path: ''
    qontract_reconcile_image_tag: '6e31378'
    qontract_reconcile_image: 'quay.io/app-sre/qontract-reconcile:{qontract_reconcile_image_tag}'
    # replace the above line if quay.io is down
    # qontract_reconcile_image: 'gcr.io/app-sre/qontract-reconcile:{qontract_reconcile_image_tag}'

- wrapper:
    name: timeout_wrapper
    wrappers:
      - timestamps
      - timeout:
          timeout: '{timeout}'
          timeout-var: 'BUILD_TIMEOUT'
          fail: true
          type: no-activity

- gitlab_message_defaults: &gitlab_message_defaults
    name: 'gitlab_message_defaults'
    failure_only: '{failure_only}'
    success_note: '{success_note}'
    success_note_url_path: '{success_note_url_path}'
    failure_note: '{failure_note}'
    failure_note_url_path: '{failure_note_url_path}'
    unstable_note: '{unstable_note}'
    unstable_note_url_path: '{unstable_note_url_path}'

#### Macros

# The 'retry' macro takes a 'cmd' parameter and will
# run that command 'n' times or until it is successful
# 'n' defaults to 5
- builder:
    name: retry
    builders:
      - shell: |
          attempt=1
          max_attempts={n}
          while [ $attempt -le $max_attempts ]; do
            (
              {cmd}
            )
            [ $? -eq 0 ] && break

            if [ $attempt -lt $max_attempts ]; then
                sleep $attempt
                attempt=$[$attempt+1]
            else
                exit 1
            fi
          done
