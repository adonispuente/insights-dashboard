- job-template:
    id: 'gl-pr-check-app-interface'
    name: '{gl_group}-{gl_project}-gl-pr-check'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *reconcile_toml
        - *vault_manager_creds
        - *push_gateway_basic_auth
        - *app_interface_state
        - *github_api
        - *app_interface_unleash
        - *gitlab_pr_submitter
    success_note_url_path: 'app-interface_20JSON_20validation'
    num_to_keep: 5000
    publishers:
    - gitlab_message:
        <<: *gitlab_message_defaults
    - gitlab-notifier
    - archive:
        artifacts: 'temp/reports/**'
    - html-publisher:
        name: "app-interface JSON validation"
        dir: "temp/reports/"
        files: "index.html"
        keep-all: true
        allow-missing: true
        link-to-last-build: true
    <<: *gl_pr_check

- job-template:
    id: 'gl-build-master-app-interface'
    name: '{gl_group}-{gl_project}-gl-build-{branch}{job_type}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *app_interface_s3
        - *app_interface_basic_auth
        - *push_gateway_basic_auth
    publishers:
    - archive:
        artifacts: 'reports/**'
    - gitlab-notifier:
        name: '{display_name}'
    - slack:
        room: '{slack_channel_notification}'
        notify-start: False
        notify-success: True
        notify-failure: True
        notify-repeated-failure: True
    <<: *gl_build_master

- job-template:
    id: 'gl-periodic-job-app-interface'
    name: '{gl_group}-{gl_project}-gl-periodic-job-{job_type}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *reconcile_toml
        - *gitlab_pr_submitter
        - *vault_manager_creds
        - *app_interface_basic_auth
        - *push_gateway_basic_auth
        - *github_api
        - *app_interface_state
        - *app_interface_cloudwatch
        - *app_interface_unleash
    publishers:
    - archive:
        artifacts: 'reports/**'
    - post-tasks:
      - matches:
        - log-text: ""
          operator: AND
        script: |
          set +x
          LOG_DIR=logs
          source ./hack/runners.sh
          send_log >/dev/null
    <<: *gl_timed


# qontract-reconcile-with-upstream
# ---------------------
# parameters to be passed to job
# integrations: names of integrations to run seperated by a space
# upstream: name of job to build after
- job-template:
    id: 'qontract-reconcile-with-upstream'
    name: 'qontract-reconcile-with-upstream-{job_type}'
    upstream: empty
    triggers:
    - reverse:
        jobs: '{upstream}'
        results: 'success'
    wrappers:
    - timestamps
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *reconcile_toml
        - *github_api
        - *app_interface_state
        - *app_interface_unleash
    <<: *qontract_reconcile


# qontract-reconcile-timed
# ---------------------
# parameters to be passed to job
# integrations: names of integrations to run seperated by a space
# options: options to pass to integrations
- job-template:
    id: 'qontract-reconcile-timed'
    name: 'qontract-reconcile-timed-{job_type}'
    num_to_keep: 10000
    days_to_keep: 15
    triggers:
    - timed: |
        {cron_expression}
    wrappers:
    - timestamps
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *reconcile_toml
        - *github_api
        - *app_interface_state
        - *app_interface_unleash
    <<: *qontract_reconcile


- job-template:
    id: 'app-interface-output-run'
    job_name: 'app-interface-output-run'
    name: '{job_name}'
    wrappers:
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *reconcile_toml
    publishers:
    - git:
        push-merge: false
        push-only-if-success: true
        branches:
        - branch:
            name: "master"
    cron_expression: H/10 * * * *
    <<: *gl_timed

