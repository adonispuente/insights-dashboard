- job-template:
    id: 'uhc-integration-tests'
    name: 'uhc-integration-tests-{environment}'
    node: '{node}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *uhc_integration_tests
    build_deploy_script_path: './run_integration_tests.sh'
    upstream: ''
    triggers:
    - reverse:
        jobs: '{upstream}'
        results: 'success'
    publishers:
    - junit:
        results: '**/**/junit.xml'
        test-stability: true
        claim-build: true
        measurement-plots: true
        flaky-test-reports: true
        junit-attachments: true
    <<: *gl_build_master

- job-template:
    id: 'ocm-integration-full-cycle-tests'
    name: 'ocm-integration-full-cycle-tests-{environment}'
    node: '{node}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *uhc_integration_tests
    publishers:
    - junit:
        results: '**/**/fullcycle_junit.xml'
        test-stability: true
        claim-build: true
        measurement-plots: true
        flaky-test-reports: true
        junit-attachments: true
    <<: *gl_build_master

- job-template:
    id: 'ocm-portal-deploy'
    name: 'ocm-portal-deploy-{mode}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *uhc_insights_platform
    builders:
    - shell: |
        #!/bin/bash
        set -e
        ./push_to_insights.sh {mode}
    <<: *gl_build_master

- job-template:
    id: 'ocm-pr-check-selenium'
    name: '{gl_group}-{gl_project}-pr-check-selenium'
    environment: staging
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *ocm_selenium_tests
        - *quay_secret_pull
    - ansicolor
    publishers:
    - archive:
        artifacts: '*.log, run/output/embedded_files/**'
        allow-empty: 'true'
    - junit:
        results: 'run/output/junit-report/*.xml'
        test-stability: true
        claim-build: true
        measurement-plots: true
        flaky-test-reports: true
        junit-attachments: true
        allow-empty-results: true
    - gitlab_message:
        <<: *gitlab_message_defaults
    - gitlab-notifier
    <<: *gl_pr_check

- job-template:
    id: 'ocm-pr-check'
    name: '{gl_group}-{gl_project}-ocm-pr-check'
    environment: production
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *app_interface_basic_auth
        - *ocm_sandbox
        - *quay_secret_ocm_clusters_service_sandbox_admin
        - *ocm_resources_job_secret
        - *ocm_resources_sentry_dsn
        - *api_tests_oc_login_token
        - *api_tests_sentry_dsn
    html_publisher_dir: 'no_such_dir'
    publishers:
    - archive:
        artifacts: 'logs/**'
        allow-empty: 'true'
    - junit:
        results: '**/junit.xml'
        test-stability: true
        claim-build: true
        measurement-plots: true
        flaky-test-reports: true
        junit-attachments: true
        allow-empty-results: true
    - html-publisher:
        name: "Integration test coverage report"
        dir: "{html_publisher_dir}"
        files: "coverage.html"
        keep-all: true
        allow-missing: true
        link-to-last-build: true
    - cobertura:
        report-file: "coverage.xml"
        only-stable: "true"
        fail-no-reports: "false"
        fail-unhealthy: "false"
        fail-unstable: "false"
        health-auto-update: "false"
        stability-auto-update: "false"
        zoom-coverage-chart: "true"
        source-encoding: "Big5"
        targets:
          - files:
              healthy: 10
              unhealthy: 20
              failing: 30
          - method:
              healthy: 50
              unhealthy: 40
              failing: 30
    - gitlab_message:
        <<: *gitlab_message_defaults
    - gitlab-notifier
    - workspace-cleanup
    <<: *gl_pr_check

- job-template:
    id: 'ocm-build-master'
    name: '{gl_group}-{gl_project}-ocm-build-{branch}'
    environment: production
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *app_interface_basic_auth
        - *ocm_sandbox
        - *quay_secret_ocm_clusters_service_sandbox_admin
        - *ocm_resources_job_secret
        - *ocm_resources_sentry_dsn
        - *api_tests_oc_login_token
        - *api_tests_sentry_dsn
    <<: *gl_build_master

- job-template:
    id: 'ocm-build-master-timed-stage'
    name: '{gl_group}-{gl_project}-ocm-build-{branch}-timed-{environment}'
    environment: stage
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *app_interface_basic_auth
        - *ocm_sandbox
        - *quay_secret_ocm_clusters_service_sandbox_admin
        - *ocm_resources_job_secret
        - *ocm_resources_sentry_dsn
    ci_cmd: ./periodic_check.sh uhc-stage
    cron_expression: '0 */8 * * *'
    <<: *gl_timed

- job-template:
    id: 'ocm-build-master-timed-production'
    name: '{gl_group}-{gl_project}-ocm-build-{branch}-timed-{environment}'
    environment: production
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *app_interface_basic_auth
        - *ocm_sandbox
        - *quay_secret_ocm_clusters_service_sandbox_admin
        - *ocm_resources_job_secret
        - *ocm_resources_sentry_dsn
    ci_cmd: ./periodic_check.sh uhc-production
    cron_expression: '0 */8 * * *'
    <<: *gl_timed


- job-template:
    id: 'ocm-api-tests-timed'
    name: 'ocm-api-tests-{environment}-{tests}'
    tests: 'readonly'
    node: '{label}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *ocm_resources_job_secret
        - *api_tests_oc_login_token
        - *api_tests_sentry_dsn
    ci_cmd: ./periodic_check.sh
    cron_expression: '0 */6 * * *'
    upstream: ''
    triggers:
    - reverse:
        jobs: '{upstream}'
        results: 'success'
    publishers:
    - workspace-cleanup
    <<: *gl_timed

- job-template:
    id: 'ocm-build-image'
    name: '{gl_group}-{gl_project}-ocm-build-image'
    environment: production
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *quay_secret_push
        - *api_tests_sentry_dsn
    <<: *gl_build_master
