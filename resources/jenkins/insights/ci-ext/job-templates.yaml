- base_templates:
    name: insights-base-templates

    gpg_verify: &gpg_verify
        shell: |
            # Load GPG keys from app-interface
            python3 -m venv .
            source bin/activate
            pip3 install graphqlclient
            curl -LO https://raw.githubusercontent.com/RedHatInsights/gpg-verify/master/import_gpg.py
            python3 import_gpg.py

            echo '#!/bin/sh
            exec gpg --no-default-keyring --keyring=$PWD/git.gpg "$@"' > gitgpg
            chmod +x gitgpg
            git config gpg.program $PWD/gitgpg
            git verify-commit $ghprbActualCommit

            if [ $? != 0 ]; then
                echo "GPG signature either not present or not trusted"
                exit 1
            fi


- job-template:
    id: 'insights-operator-gh-pr-check'
    name: '{gh_org}-{gh_repo}-pr-check'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
        - *insights_minikube_ssh_key
        - *insightsdroid_github
    publishers:
    - junit:
        results: 'artifacts/junit-*.xml'
    - archive:
        artifacts: 'artifacts/**/*'
    <<: *gh_pr_check
    builders:
    - *gpg_verify
    - *pr_check
    - *stack_analysis


- job-template:
    id: 'insights-gh-pr-check'
    name: '{gh_org}-{gh_repo}-pr-check'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
        - *insightsdroid_github
    publishers:
    - junit:
        results: 'artifacts/junit-*.xml'
    - archive:
        artifacts: 'artifacts/**/*'
    scm:
    - git:
        url: 'git@github.com:{gh_org}/{gh_repo}.git'
        credentials-id: '{github_ssh_credentials}'
        skip-tag: true
        refspec: '+refs/pull/*:refs/remotes/origin/pr/*'
        branches:
        - '${{ghprbActualCommit}}'
        merge:
            remote: origin
            branch: '{branch}'
        git-config-name: "AppSRE"
        git-config-email: "sd-app-sre@redhat.com"
        included-regions:
        - '{include_path}'
        prune: true
        clean:
            before: true
        wipe-workspace: true
    <<: *gh_pr_check

- job-template:
    id: 'insights-gh-build-master'
    name: '{gh_org}-{gh_repo}-gh-build-{branch}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
    <<: *gh_build_master


- job-template:
    id: 'insights-deploy-ephemeral'
    name: '{name}-ephemeral'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
    parameters:
    - string:
        name: APP_NAME
        default: automation-hub
        description: "(REQUIRED) name of app-sre 'application' folder this component lives in"
    - string:
        name: COMPONENT_NAME
        default: automation-hub
        description: "(REQUIRED) name of app-sre 'resourceTemplate' in deploy.yaml for this component"
    - string:
        name: IMAGE
        default: "quay.io/cloudservices/automation-hub-galaxy-ng"
        description: "(REQUIRED) image location on quay"
    - string:
        name: COMPONENTS
        default: ""
        description: "(optional, default: all) space separated components to deploy"
    - string:
        name: COMPONENTS_W_RESOURCES
        default: "all"
        description: "(optional, default: none) space separated components which should preserve resource settings"
    - string:
        name: DEPLOY_TIMEOUT
        default: ""
        description: "(optional, default: 300) bonfire deployment timeout parameter in seconds"
    - string:
        name: GIT_COMMIT_INPUT
        default: 7a70ff118ad599cb29503d56c8caf8e550ecb5fc
        description: "(REQUIRED) full git commit hash of the version being tested"
    - string:
        name: IMAGE_TAG_INPUT
        default: 7a70ff1
        description: "(optional, default matches GIT_COMMIT_INPUT) image tag for the version being tested"
    - choice:
        name: RESERVATION_DURATION
        choices:
          - 1
          - 2
        description: "Number of hours to reserve the environment for"
    builders:
    - shell: |
        #!/bin/bash

        echo "Job started by user: $BUILD_USER, id: $BUILD_USER_ID"

        CICD_URL=https://raw.githubusercontent.com/RedHatInsights/bonfire/master/cicd
        curl -s "$CICD_URL/bootstrap.sh" > .cicd_bootstrap.sh
        source .cicd_bootstrap.sh

        export GIT_COMMIT=$GIT_COMMIT_INPUT
        if [ ! -z "$IMAGE_TAG_INPUT" ]; then
            export IMAGE_TAG=$(echo $GIT_COMMIT_INPUT | head -c7)
        else
            export IMAGE_TAG=$IMAGE_TAG_INPUT
        fi

        # source $CICD_ROOT/deploy_ephemeral_env.sh
        source $CICD_ROOT/_common_deploy_logic.sh
        export NAMESPACE=$(bonfire namespace reserve -d $RESERVATION_DURATION)

        echo "Deploying $APP_NAME to $NAMESPACE"

        bonfire deploy \
            $APP_NAME \
            --source=appsre \
            --ref-env insights-stage \
            --set-template-ref $COMPONENT_NAME=$GIT_COMMIT \
            --set-image-tag $IMAGE=$IMAGE_TAG \
            --namespace $NAMESPACE \
            --timeout $DEPLOY_TIMEOUT \
            $COMPONENTS_ARG \
            $COMPONENTS_RESOURCES_ARG \
            --set-parameter "$COMPONENT_NAME/IMPORTER_JOB_NAMESPACE=$NAMESPACE"
