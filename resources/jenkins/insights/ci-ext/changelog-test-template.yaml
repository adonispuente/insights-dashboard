- job-template:
    id: 'insights-platform-changelog-test-build-master'
    name: '{gh_org}-{gh_repo}-test-gh-build-{branch}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
        - *platform_changelog_stage_jenkins_jobs_sa_token
    builders:
    - shell: |
        #!/bin/bash
        echo "Send a curl request to changelog.stage.devshift.net"
        #
        # desired data from the jenkins job:
        # - app name (as defined here in app-interface)
        # - "project" name (as defined here in app-interface)
        # - repo
        # - branch merged from
        # - branch merged to (monitored branch, master or main)
        # - merged by
        # - PR title and URL
        # - PR number
        # - data on each commmit:
        #   - **commit ref**
        #   - commit message
        #   - commit timestamps
        #   - commit author info (name, email, username)

        echo 'Environment variables:'
        echo '---------------------------------------------------------'
        printenv
        echo '---------------------------------------------------------'

        echo 'Git commit info:'
        echo $GIT_URL
        echo $GIT_COMMIT

        echo '---------------------------------------------------------'

        echo 'Building merge info for changelog.stage.devshift.net'

        commit=$GIT_COMMIT
        repo=$GIT_URL

        merge_info='{{"tenant": "{label}", "app": "{app_name}", "project": "{name}", "repo": "${{repo}}", "commits": "${{commit}}"}}'

        echo $merge_info

        echo '---------------------------------------------------------'
        echo 'Sending to changelog.stage.devshift.net'

        curl -X POST https://changelog.stage.devshift.net/api/v1/github -s --data "$merge_info" -H "Content-Type: application/json" -H 'Authorization: Bearer $PLATFORM_CHANGELOG_TOKEN'

        echo '---------------------------------------------------------'
        echo 'Done'
    <<: *gh_build_master
