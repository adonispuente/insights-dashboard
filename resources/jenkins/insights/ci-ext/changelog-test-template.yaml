- base_templates:
    name: insights-ci-ext-base-templates

    gpg_verify: &gpg_verify
        shell: |
            # Load GPG keys from app-interface
            python3 -m venv .
            source bin/activate
            pip3 install graphqlclient
            curl -LO https://raw.githubusercontent.com/RedHatInsights/gpg-verify/master/import_gpg.py
            python3 import_gpg.py

            echo '#!/bin/sh
            exec gpg --no-default-keyring --keyring=$PWD/git.gpg "$@"' > gitgpg
            chmod +x gitgpg
            git config gpg.program $PWD/gitgpg
            git verify-commit $ghprbActualCommit

            if [ $? != 0 ]; then
                echo "GPG signature either not present or not trusted"
                exit 1
            fi

          
- job-template:
    id: 'insights-platform-changelog-test-build-master'
    name: '{gh_org}-{gh_repo}-test-gh-build-{branch}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
        - *platform_changelog_stage_jenkins_jobs_sa_token
    <<: *gh_build_master
    shell: |
        #!/bin/bash
        echo "Send a curl request to changelog.stage.devshift.net"
        #
        # desired data from the jenkins job:
        # - app name (as defined here in app-interface)
        # - "project" name (as defined here in app-interface)
        # - repo
        # - branch merged from
        # - branch merged to (monitored branch, master or main)
        # - merged by
        # - PR title and URL
        # - PR number
        # - data on each commmit:
        #   - **commit ref**
        #   - commit message
        #   - commit timestamps
        #   - commit author info (name, email, username)

        echo 'env'
        echo '---------------------------------------------------------'
        # printenv
        echo '---------------------------------------------------------'

        echo 'Building merge info for changelog.stage.devshift.net'

        merge_info='{{"tenant": "${label}", "app": "${app_name}", "project": "${name}", "repo": "$GIT_URL", "commits": "$GIT_COMMIT"}}'

        echo $merge_info

        curl -X POST https://changelog.stage.devshift.net/api/v1/github -s --data "$(merge_info)" -H "Content-Type: application/json" -H 'Authorization: Bearer $PLATFORM_CHANGELOG_TOKEN'
