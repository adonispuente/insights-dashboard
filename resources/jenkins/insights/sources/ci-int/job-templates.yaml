- job-template:
    id: 'insights-sources-sonarqube-scan'
    name: '{gh_org}-{gh_repo}-sonarqube-scan'
    status_context: "SonarQube scan"
    branch: "master"
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *insightsdroid_github
        - *quay_api_token
        - *insights_sources_sonarqube_cli_url
        - *insights_sources_sonarqube_token
        - *insights_sources_sonarqube_report_url
        - *insights_sources_rh_it_root_ca_cert_url
    pr_check_script_path: './scripts/sonarqube.bash'
    publishers:
    - junit:
        results: 'artifacts/junit-*.xml'
    - archive:
        artifacts: 'artifacts/**/*'
    <<: *gh_properties
    scm:
    - git:
        url: 'git@github.com:{gh_org}/{gh_repo}.git'
        credentials-id: '{github_ssh_credentials}'
        skip-tag: true
        refspec: '+refs/pull/*:refs/remotes/origin/pr/*'
        branches:
        - '${{ghprbActualCommit}}'
        merge:
            remote: origin
            branch: '{branch}'
        git-config-name: "AppSRE"
        git-config-email: "sd-app-sre@redhat.com"
        included-regions:
        - '{include_path}'
        prune: true
        clean:
            before: true
        wipe-workspace: true
    triggers:
        - github-pull-request:
            cron: '* * * * *'
            github-hooks: false
            permit-all: false
            trigger-phrase: '(?ms).*^(\[test\]|\/retest|\/lgtm|\/lgtm cancel|\/hold|\/hold cancel)\s*$.*'
            org-list:
            - '{gh_org}'
            allow-whitelist-orgs-as-admins: true
            status-context: '{status_context}'
            error-status: 'Scan failed.'
            failure-status: 'Scan failed.'
            success-status: 'Scan succeeded.'
            white-list-target-branches:
            - '{white_list_target_branches}'
    <<: *pr_check_template

- job-template:
    id: 'insights-sources-sonarqube-scan-master'
    name: '{gh_org}-{gh_repo}-sonarqube-scan-{branch}'
    build_deploy_script_path: './scripts/sonarqube.bash'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
        - *insights_sources_sonarqube_cli_url
        - *insights_sources_sonarqube_token
        - *insights_sources_sonarqube_report_url
        - *insights_sources_rh_it_root_ca_cert_url
    <<: *gh_build_master
