- job-template:
    id: 'insights-gl-pr-check'
    name: '{gl_group}-{gl_project}-pr-check'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *insightsdroid_github
        - *quay_api_token
        - *sonarqube_token
    publishers:
    - junit:
        results: 'artifacts/junit-*.xml'
    - archive:
        artifacts: 'artifacts/**/*'
    - gitlab_message:
        <<: *gitlab_message_defaults
    - gitlab-notifier:
        name: '{name}'
        mark-unstable-as-success: false
    <<: *gl_pr_check

- job-template:
    id: 'insights-gl-smoke-test'
    name: '{gl_group}-{gl_project}-smoke-test-{branch}'
    wrappers:
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *insightsdroid_github
        - *quay_api_token
        - *quay_secret_push
    builders:
    - shell: './smoke_test.sh'
    publishers:
    - junit:
        results: 'artifacts/junit-*.xml'
    - archive:
        artifacts: 'artifacts/**/*'
    - slack:
        room: '{slack_channel_notification}'
        notify-start: false
        notify-success: false
        notify-failure: true
        notify-repeated-failure: true
    <<: *gl_timed

- job-template:
    id: 'insights-gl-smoke-test-dev'
    name: '{gl_group}-{gl_project}-smoke-test-dev-{branch}'
    wrappers:
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *insightsdroid_github
        - *quay_api_token
        - *quay_secret_push
    builders:
    - shell: './smoke_test.sh'
    publishers:
    - junit:
        results: 'artifacts/junit-*.xml'
    - archive:
        artifacts: 'artifacts/**/*'
    <<: *gl_timed

- job-template:
    id: 'insights-gl-build-master'
    name: '{gl_group}-{gl_project}-gl-build-{branch}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
    <<: *gl_build_master

- job-template:
    id: 'insights-gl-build-cypress-image'
    name: '{gl_group}-{gl_project}-gl-build-{branch}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
    <<: *gl_build_master

- job-template:
    id: 'insights-ephemeral-namespace-reconciler'
    name: 'insights-ephemeral-namespace-reconciler'
    wrappers:
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
    <<: *gh_timed

- job-template:
    id: 'insights-deploy-notifier'
    name: 'insights-deploy-notifier'
    concurrent: true
    gl_group: insights-platform
    gl_project: cicd-common
    branch: master
    wrappers:
    - timeout_wrapper:
        timeout: 60
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *app_sre_ci_trigger_jobs_bot
        # TODO: add secrets for POST'ing to ibutsu and creating a grafana annotation
    triggers:
    - reverse:
        jobs: '{obj:upstream_saas_jobs}'
        result: 'success'
    builders:
    - shell: './deploy_notifier.sh'
    <<: *gl_checkout

- job-template:
    id: 'insights-saas-templates-sync'
    name: 'insights-saas-templates-sync'
    branch: master
    gl_group: insights-platform
    gl_project: saas-templates
    ci_cmd: './ci.sh'
    wrappers:
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *gitlab_token
        - *app_sre_bot_push_token
        - *insightsdroid_github
    <<: *gl_timed

- job-template:
    id: 'insights-engine-gl-pr-check'
    name: '{gl_group}-{gl_project}-pr-check'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *prodsec_rules_build_token
        - *insightsdroid_github
        - *quay_api_token
    publishers:
    - junit:
        results: 'artifacts/junit-*.xml'
    - archive:
        artifacts: 'artifacts/**/*'
    - gitlab_message:
        <<: *gitlab_message_defaults
    - gitlab-notifier:
        name: '{name}'
        mark-unstable-as-success: false
    <<: *gl_pr_check

- job-template:
    id: 'insights-engine-gl-build-master'
    name: '{gl_group}-{gl_project}-gl-build-{branch}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *prodsec_rules_build_token
        - *quay_api_token
    <<: *gl_build_master

- job-template:
    id: 'insights-gh-build-master'
    name: '{gh_org}-{gh_repo}-gh-build-{branch}'
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *quay_api_token
    <<: *gh_build_master

- job-template:
    id: 'insights-gh-pr-check'
    name: '{gh_org}-{gh_repo}-pr-check'
    status_context: "ci.int.devshift.net PR build"
    branch: "master"
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *insightsdroid_github
        - *quay_api_token
    publishers:
    - junit:
        results: 'artifacts/junit-*.xml'
    - archive:
        artifacts: 'artifacts/**/*'
    <<: *gh_properties
    scm:
    - git:
        url: 'git@github.com:{gh_org}/{gh_repo}.git'
        credentials-id: '{github_ssh_credentials}'
        skip-tag: true
        refspec: '+refs/pull/*:refs/remotes/origin/pr/*'
        branches:
        - '${{ghprbActualCommit}}'
        merge:
            remote: origin
            branch: '{branch}'
        git-config-name: "AppSRE"
        git-config-email: "sd-app-sre@redhat.com"
        included-regions:
        - '{include_path}'
        prune: true
        clean:
            before: true
        wipe-workspace: true
    triggers:
        - github-pull-request:
            cron: '* * * * *'
            github-hooks: false
            permit-all: false
            trigger-phrase: '(?ms).*^(\[test\]|\/retest|\/lgtm|\/lgtm cancel|\/hold|\/hold cancel)\s*$.*'
            org-list:
            - '{gh_org}'
            allow-whitelist-orgs-as-admins: true
            status-context: '{status_context}'
            white-list-target-branches:
            - '{white_list_target_branches}'
        - github-pull-request:
            cron: '* * * * *'
            github-hooks: false
            permit-all: false
            trigger-phrase: '(?ms).*^(\[bueller\]|\s*$.*'
            org-list:
            - '{gh_org}'
            allow-whitelist-orgs-as-admins: true
            status-context: |
                MMMMWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
                MMMWNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNWWWNWWNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNWMMMM
                MMWO::::::::::::::::::::::::::::::::::;;;;::::::ccldxdooc:;,''';:;,,,,,,,''''.'',,,;;',,;,,;:::::::::::::::::::::::::::::::::;;;;;;;;;;;;;;;;;:;l0NWWM
                MMWx'.........................................,;:clooc;'..                         ...  .'......................................................,ok0XW
                MMWx'......................................',;;:c:;,'...                             ...........................................................'coxKN
                MMWx'....................................',,,'''...                                      ....''...'.............................................':okKW
                MMWx'...................................,;;,;cc,......     ...'''''''''...                   .....'.............................................':okKW
                MMWx'..................................',;;;;,;;,'..''.  .;ldxxxxxxxkkkkxxddolc;,'..             ...............................................':okKW
                MMWx'..................................,:c:;::c:;,,,,'...ck00000KKKKKKXXXNNWWNNK00Odc,..          ..............................................':okKW
                MMWx'................................,;;:clooc;;:cc;;;::lx0KXXXXXKKKXXXXNWWMMWWWNNNXK0Okdl'        .............................................':okKW
                MMWx'................................,;cloddoc:;:c;;clclk0XXNXXXXXKKKKXXNNWWWWWNNNNNNXXXXXKd'         ..........................................':okKW
                MMWx'................................,:ldxkkxoc:cc:colcoOKXXNXXXKKKKKKXXNNNNNNNNNXXXXXXKXXXX0l.      ...........................................':okKW
                MMWx'...............................'coxO0Oxoololllc::cdOXXNNXXKKKXXXXXXXXXXXNNXXXXKKK00KXXKK0o.     ..........'','.....'.......................':okKW
                MMWx'.............................';lkOOOOkxdolc::cc,':kKNNNNXXXXXXXXNNNNXXXXXKXXXXXKK00000OOOOl.    ...''''''',;c:'...'''......................':okKW
                MMWx'............................,loodddooollll:,;c:',d0XXXXXNXXK0OkxollloddxO000KKKKKKXXXK0Oxkd'     ...'''',,,;lc,'''''.......................':okKW
                MMWx'...........................'::;clcc;'.':cc:,;,,,l0XXXXKK0xoc:,.......'',cxO00000OkxddxOKOkx;      ..'''',,,;ll:,''''''''...................':okKW
                MMWx'.'',,;;,'........',;::;'...,,',,,,,'.'';;,;;''':xkdl:cc:;,,:oxdc;;;,''',;lxkOOOkdc,'..':xOx:.    ...'',,,,',cl:,''''''''...................':okKW
                MMWk::cllc:;,''''''',:llc:;,''''.. .......'.';;,'..,olccccc:;lo,.;c:;:lolccc:::loddol:,'...  .;c;..   ..''''''''':lc,....''''''''............''',:okKW
                MMM0ddlc:;,'''''''':odo:,'','',,..;cll:'..,'.... ..:oxxxdc:lldkdl:;:;;ll;,:cll:lddl;''''''...  ...'  ';;,''','''';ll;''''',;;,''''''...',;;:cc:::coxKW
                MMWk:::::c:::;;,,':ddl,',,,,,;l:,lc;:dkd;';,..''':xOOOOko',cclccc:'...,clol:c:',:c;....,cl;........ .,clc;'','''.,loc,'',,,:cc,.'','',cloolc:;;;:cokKW
                MMWk,',,;;;;::ccccldo;,,,,,',:l:cc:lddodo:;;'',,:xKXXXXXx,oxlc::c;.  .,,,,:coo'.... ..,;coc;:l,....';,,;:c;,',''''cdl,'',,;cdd;'',,',:lc:;,'''',;cokKW
                MMWx,''',,,''',:lllll:;,,'''',;cdcckkdxkkdlc,',;d0XXXXXXx;oOkxolcc:;;,',;clddlcdOx;.:llc,;;:cc;....,l:..,c:,'''''':xd;'',,;oko;'''',:c:,'''''''',coxKW
                MMWk,''''',,;:cll:,,:cc:;;;;''.;llxkxkdccoddddxkO0KXXXXX0c:OKOkxxolllooodxdl::kXWWKo:,;l,  .'ll::;.,c,.,:c;'..''..;dxc'.'';dxl,....,c:,...''....,:oxKW
                MMWk,';:cccllc:;,''..'''''''...':okdc:,,;ok00kO00000KKXXKOllk0OOkddxkO00Oo:;l0XNWWWO:,;;'.'';c. ...';'.;,'........'lxl'...':l:'....'::,'........':okKW
                MMWk,',;;;;,''..................,oxxolclxxkK0kO00000000OOOOxdollooxxxxdl::xOKXXNNWNOc:clc:,';,......,.............':do,.....'........,;;;,,,,,'.':okKW
                MMWk,''''''......................;dxkkddxddxkkOOO0OO0Okkkkkkkkxdolcc::::cokO0KXXNNNx,:lclllodo;'...,'..............',;'..................'',,,'.':okKW
                MMWk,''''''...''''''.............':odxkkxoloxxkOOOOO0OOOkkkkOOOkkxxdolcokO0KKKXXXXKd,'cdxxkkko;,'';'............................................':okKW
                MMWx,'''''...,:lollc:;,.........',;ldxkO0kooxkkOOOkkOO00OOOOOOOkxxdlllokkdc::d0Okxxo::;:lodooc:;'''.............................................':okKW
                MMWk,'''....'cddl;;;:cl:;'..',;:cc:;:ok0OxddxkkOOOOOOO0000OOOkkxdollooooc,...,locccccccllcc::;'.................................................':okKN
                MMM0c'......;ldl,....';clc,.'cxxl;..,coO0kxxkkkOOOOOOOOO0OOOkxddooodxkxoodllc:;;,,:cccllcllcc;,,,............'..................................':okKN
                MMWKd;.....,cdo,.......':ol,,oOd;...'clloocoxkkkOOOOOOOOOOkxxdddddxxxkkxddlcc:;:cloollooollcc::cl:'........':l:'................................':okKN
                MMM0dc'....,lxc'........'coc:dkl'....:l:.;odxxkxxOOOOOkkkOkxddddodddkkkxdoc::::cloddooooolc:;'.';:,'''.....,ldl,..............................',;cox0W
                MMW0do;'...'cdc'.........:olcdd:.....,cc':Okdxkxxkkkkkkkkkkdollccclooolloollcllcclodolooolcc,.....'';:,....;lll:,..........................',,,,,cox0W
                MMWkloc'....;ol,........,cl::od;......:l;lOkddxxxxxkxxxxkkdoc:;,;;;;,'....',,,;:cclllooolcoo;......':l;...,cl;:lc'...........................,;'':ox0N
                MMWk:od:'...':lc,......,cl:';do,......,cld0Ododxxxxxxddxxdlc:cclllllllc,......'',;:cloolccdkl'.....':o:'.':l:',oo;...........................;:'.:okKN
                MMWx;ldl,....',:::;,,;:cc;..,:;'......';cx0Okolodxxxxddddocccloolc:::::ccc:::::;,,,:lllc;,cdl'......,cl:;;c:'.'cdc'................... .....'c:..:ox0N
                MMWx',c:,.......';:::::;'...............,x0kkdlloddxxddddolllllcc:;,.....',,,,;::;;:ccc;'..,,........,:c:;,'...;ol,..................  ..',;cdl:;cokKN
                MMWx'..................................':k0Okxdollodddddddoodddoolc;'.......'',:::::::;'.......................;oo,..................  ...';ldc',:oxKN
                MMWx'...............................'cc'cO0Okxdolllllllloooodxxxxdollcc::::::;;;;;;;;:,........................;ol,..................      .:l;..:okKN
                MMWx'...............................ok,.l00Okxxoolccc:::cllooooooddoooooooooolc:;;:;;::,....';::,'.............;lc'.................       .:o:..:okKN
                MMWx'............................';oXx.;OK00O0K00Oxl::;cxd::dkoc:cokOOOOkoccccddc:;,.':::l:;clcccc:lddool,...;oxkxc'.''';looc'.......    ...;oc,,coxKW
                MMWx'...........................:llOWXcc0K00O0NN00N0l:,lKO;,kXo,,,dNKdddl:;;;cOXo'...':cdXOol;',cokXN0kkdc::cON0dkKd'':dKklo0O,. ....    ...'ll,':okKW
                MMWx'.........................,lo:lKWWXOk000O0XXOOXKo::oKk;,xXo...lXOc:;....';OXc....;lcoX0o;..':coKKdooc;;;:kXo'lXk,,:c:..cKO,.  ..      ...cl,.:okKW
                MMWx'.......................'cdxl,dNNNWWXK0OO0NNXXNKdccdX0c:kXl...lXKddl,',;;l0Xl...,cc,lXKo,.':c;:0Xxdo;....dN00Xk;.,;'.,k0o'.......  ..  .'cc,':okKW
                MMWx.....................';codooc;xNNNNWWWNKO0NXkxKNOolxX0olONo...lXx,',;:cloONXl..;cc'.cXKo;;cc,.;0O'..''...dXddXx'.,:,.:kl';cc:;'..      ..''..:okKW
                MMWx................',;:lddxdodol,lXNNNWWWWWNNWNKKNXkddxKX0OX0c'.'oXKkxkxdk0KXWNOdxOo,.'dNN000Ol..:0Xkxkdc;,,xNd;oKOccoolkXk:cc;'...       ......:okKW
                MMWx..........',:cccloxxxkxxxdxxo,,kNNNNNWWWWWWWWX0xdddxxkkxo:'',:oxxxxOKKXXXXklodxxl,'';xK0xol,..:kOkkkxl:,;dx;..:c,,lo:;c;..,;;;;,'...   ..   .:okKW
                MMMx....',:codxxkxoloddddxxxkkkxd:.;OXNNNNNWWWWNNNK0kdooool:::cccc:::lx0KKKKXK:..,;;,,;:;coo;.....:ol;,,'...'::,......:o;..... ....,::,..    ....:okKW
                MMWk;:ldkOOOkxxxddooddddddddxxdddl;':kKKXXXXNNNNNXXXX0kdlc:::::ccodxk000OO0KKk'.';;::;:::cclllc:,'';cc:;,'...,ccc,'...;oc'...........,;'........':okKN
                MMMWXKOxdollllllllllllllllllllllllccclooooodddddddoodoooolcccccccoooooooloodol::cccccccclccllloolcc:cccccc::::cclccc::cll::::::::::::cc:::::::::ccoxKN
                MMMMWN0kddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddooddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddxOKW
                MMMMMWNK0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000KNW
            white-list-target-branches:
            - '{white_list_target_branches}'
    <<: *pr_check_template

- job-template:
    id: 'insights-deploy-ephemeral'
    description: 'To 1) reserve and deploy an Insight app to ephemeral cluster 2) release namespaces the user has reserved. For additional documentation and usage instructions please see: https://docs.google.com/document/d/1f6D1ZwE40QuyoqsfuXpqPlCqOVwssGNEwr-iGDOYvVY/'
    name: '{name}-ephemeral'
    node: '{node}'
    ci_cmd: ./ephemeral.sh
    gl_group: insights-platform
    gl_project: cicd-common
    app_name: ""
    ui_ref: ""
    component_name: ""
    image: ""
    git_commit: ""
    image_tag: ""
    components: ""
    components_w_resources: ""
    deploy_timeout: ""
    additional_arg: ""
    post_deployment_script: ""
    verbose: false
    wrappers:
    - timeout_wrapper:
        timeout: '{timeout}'
    - ansicolor
    - build-user-vars
    - vault-secrets:
        <<: *vault_defaults
        secrets:
        - *insights_ephemeral_oc_login
        - *app_interface_creds
        - *insights_rh_registry_pull_secret
        - *quay_secret_push
        - *insightsdroid_github
    <<: *gl_checkout
    parameters:
    - bool:
        name: RELEASE_NAMESPACE
        default: false
        description: "(optional) Release a previously reserved namespace. Selecting this will not deploy anything"
    - string:
        name: NAMESPACE
        default: ""
        description: "(REQUIRED only if RELEASE_NAMESPACE=true) Namespace number to release. E.g. if the namepace is ephemeral-01, please enter: 01. Enter 'all' to release all of current user's"
    - string:
        name: APP_NAME
        default: '{app_name}'
        description: "(REQUIRED) name of app-sre 'application' folder this component lives in"
    - bool:
        name: INCLUDE_UI
        default: {obj:include_ui}
        description: "(optional) if selected, UI will be deployed as well"
    - string:
        name: UI_REF
        default: '{ui_ref}'
        description: "(optional, default: prod-beta) git ref of the component's UI deployment repo to deploy front-end assets from. Only used if INCLUDE_UI is also true."
    - string:
        name: COMPONENT_NAME
        default: '{component_name}'
        description: "(REQUIRED) name of app-sre 'resourceTemplate' in deploy.yaml for this component"
    - string:
        name: IMAGE
        default: '{image}'
        description: "(REQUIRED) image location on quay"
    - string:
        name: GIT_COMMIT_INPUT
        default: '{git_commit}'
        description: "(REQUIRED) full git commit hash of the version being tested"
    - string:
        name: IMAGE_TAG_INPUT
        default: '{image_tag}'
        description: "(optional, default matches short GIT_COMMIT_INPUT) image tag for the version being tested"
    - string:
        name: COMPONENTS
        default: '{components}'
        description: "(optional, default: all) space separated components to deploy"
    - string:
        name: COMPONENTS_W_RESOURCES
        default: '{components_w_resources}'
        description: "(optional, default: none) space separated components which should preserve resource settings"
    - string:
        name: DEPLOY_TIMEOUT
        default: '{deploy_timeout}'
        description: "(optional, default: 300) bonfire deployment timeout parameter in seconds"
    - string:
        name: ADDITIONAL_ARG
        default: '{additional_arg}'
        description: "(optional, default: none) additional arguments passed to the bonfire deployment"
    - string:
        name: POST_DEPLOYMENT_SCRIPT
        default: '{post_deployment_script}'
        description: "(optional, default: none) a post deployment script to run from the cicd-common/app_scripts directory."
    - choice:
        name: RESERVATION_DURATION
        choices:
          - "1"
          - "2"
          - "4"
          - "12"
          - "24"
          - "72"
        description: "Number of hours for which the ephemeral namespace is reserved"
    - bool:
        name: VERBOSE
        default: {obj:verbose}
        description: "(optional) if selected, the job's console output will be verbose"
    builders:
    - shell:
        command: "{ci_cmd}"
