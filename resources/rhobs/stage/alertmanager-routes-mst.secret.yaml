apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  annotations:
    qontract.recycle: "true"
data:
  alertmanager.yaml: >-
    {{% b64encode %}}
    global:
      resolve_timeout: 5m
      slack_api_url: {{{ vault('app-sre/integrations-input/alertmanager-integration', 'slack_api_url') }}}
    receivers:
    - name: default
    - name: slack-monitoring-alerts-stage
      slack_configs:
        - send_resolved: true
          http_config: {}
          channel: '#team-monitoring-alert-stage'
          username: app-sre-alerts (app-sre-stage-01)
          color: '{{ template "slack.default.color" . }}'
          title: '{{ template "slack.default.title" . }}'
          title_link: '{{ template "slack.default.titlelink" . }}'
          pretext: '{{ template "slack.default.pretext" . }}'
          text: '{{ template "slack.default.text" . }}'
          footer: '{{ template "slack.default.footer" . }}'
          fallback: '{{ template "slack.default.fallback" . }}'
          callback_id: '{{ template "slack.default.callbackid" . }}'
          icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
          icon_url: '{{ template "slack.default.iconurl" . }}'
          actions:
            - type: button
              text: 'Runbook :green_book:'
              url: '{{ (index .Alerts 0).Annotations.runbook }}'
            - type: button
              text: 'Query :mag:'
              url: '{{ (index .Alerts 0).GeneratorURL }}'
            - type: button
              text: 'Dashboard :grafana:'
              url: '{{ (index .Alerts 0).Annotations.dashboard }}'
            - type: button
              text: 'Alert Definition :git:'
              url: '{{ (index .Alerts 0).Annotations.html_url }}'
            - type: button
              text: 'Silence :no_bell:'
              url: '{{ template "__alert_silence_link" . }}'
            - type: button
              text: '{{ template "slack.default.link_button_text" . }}'
              url: '{{ .CommonAnnotations.link_url }}'
    route:
      group_interval: 5m
      group_wait: 30s
      receiver: default
      repeat_interval: 12h
      routes:
      - matchers:
        - tenant_id = 0fc2b00e-201b-4c17-b9f2-19d91adc4fd2
        receiver: slack-monitoring-alerts-stage
    {{% endb64encode %}}
