apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  annotations:
    qontract.recycle: "true"
data:
  alertmanager.yaml: >-
    {{% b64encode %}}
    global:
      resolve_timeout: 5m
      slack_api_url: {{{ vault('app-sre/integrations-input/alertmanager-integration', 'slack_api_url') }}}
    receivers:
    - name: default
    - name: slack-monitoring-alerts
      slack_configs:
        - send_resolved: true
          channel: '#team-monitoring-alert'
          username: 'observatorium-alertmanager ({{{ resource.namespace.cluster.name }}})'
          color: '{{ template "slack.default.color" . }}'
          title: '{{ template "slack.default.title" . }}'
          title_link: '{{ template "slack.default.titlelink" . }}'
          text: '{{ template "slack.default.text" . }}'
          fallback: '{{ template "slack.default.fallback" . }}'
          icon_emoji: '{{ template "slack.default.icon_emoji" . }}'
          icon_url: '{{ template "slack.default.icon_url" . }}'
          actions:
            - type: button
              text: 'Runbook :green_book:'
              url: '{{ (index .Alerts 0).Annotations.runbook }}'
            - type: button
              text: 'Query :mag:'
              url: '{{ (index .Alerts 0).GeneratorURL }}'
            - type: button
              text: 'Dashboard :grafana:'
              url: '{{ (index .Alerts 0).Annotations.dashboard }}'
            - type: button
              text: 'Alert Definition :git:'
              url: '{{ (index .Alerts 0).Annotations.html_url }}'
            - type: button
              text: 'Silence :no_bell:'
              url: '{{ template "__alert_silence_link" . }}'
            - type: button
              text: '{{ template "slack.default.link_button_text" . }}'
              url: '{{ .CommonAnnotations.link_url }}'
    
    - name: pagerduty-srep-hypershift-af-south-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'af-south-1', 1) }}}

    - name: pagerduty-srep-hypershift-ap-east-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ap-east-1', 1) }}}

    - name: pagerduty-srep-hypershift-ap-northeast-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ap-northeast-1', 1) }}}

    - name: pagerduty-srep-hypershift-ap-northeast-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ap-northeast-2', 1) }}}

    - name: pagerduty-srep-hypershift-ap-northeast-3
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ap-northeast-3', 1) }}}

    - name: pagerduty-srep-hypershift-ap-south-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ap-south-1', 1) }}}

    - name: pagerduty-srep-hypershift-ap-southeast-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ap-southeast-1', 1) }}}

    - name: pagerduty-srep-hypershift-ap-southeast-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ap-southeast-2', 1) }}}

    - name: pagerduty-srep-hypershift-ap-southeast-3
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ap-southeast-3', 1) }}}

    - name: pagerduty-srep-hypershift-ca-central-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'ca-central-1', 1) }}}

    - name: pagerduty-srep-hypershift-eu-central-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'eu-central-1', 1) }}}

    - name: pagerduty-srep-hypershift-eu-north-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'eu-north-1', 1) }}}

    - name: pagerduty-srep-hypershift-eu-south-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'eu-south-1', 1) }}}

    - name: pagerduty-srep-hypershift-eu-west-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'eu-west-1', 1) }}}

    - name: pagerduty-srep-hypershift-eu-west-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'eu-west-2', 1) }}}

    - name: pagerduty-srep-hypershift-eu-west-3
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'eu-west-3', 1) }}}

    - name: pagerduty-srep-hypershift-me-central-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'me-central-1', 1) }}}

    - name: pagerduty-srep-hypershift-me-south-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'me-south-1', 1) }}}

    - name: pagerduty-srep-hypershift-sa-east-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'sa-east-1', 1) }}}

    - name: pagerduty-srep-hypershift-us-east-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'us-east-1', 1) }}}

    - name: pagerduty-srep-hypershift-us-east-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'us-east-2', 1) }}}

    - name: pagerduty-srep-hypershift-us-west-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'us-west-1', 1) }}}

    - name: pagerduty-srep-hypershift-us-west-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-oncall', 'us-west-2', 1) }}}

    # Silent alerting receivers
    - name: pagerduty-srep-hypershift-silent-af-south-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'af-south-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ap-east-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ap-east-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ap-northeast-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ap-northeast-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ap-northeast-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ap-northeast-2', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ap-northeast-3
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ap-northeast-3', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ap-south-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ap-south-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ap-southeast-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ap-southeast-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ap-southeast-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ap-southeast-2', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ap-southeast-3
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ap-southeast-3', 1) }}}

    - name: pagerduty-srep-hypershift-silent-ca-central-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'ca-central-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-eu-central-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'eu-central-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-eu-north-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'eu-north-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-eu-south-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'eu-south-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-eu-west-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'eu-west-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-eu-west-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'eu-west-2', 1) }}}

    - name: pagerduty-srep-hypershift-silent-eu-west-3
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'eu-west-3', 1) }}}

    - name: pagerduty-srep-hypershift-silent-me-central-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'me-central-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-me-south-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'me-south-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-sa-east-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'sa-east-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-us-east-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'us-east-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-us-east-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'us-east-2', 1) }}}

    - name: pagerduty-srep-hypershift-silent-us-west-1
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'us-west-1', 1) }}}

    - name: pagerduty-srep-hypershift-silent-us-west-2
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'us-west-2', 1) }}}
    
    - name: pagerduty-srep-hypershift-silent-default
      pagerduty_configs:
        - routing_key: {{{ vault('osd-sre/osd-hypershift-silent-test', 'default', 2) }}}

    # Inhibit rules for hypershift 
    #   Stage cluster inhibits
    inhibit_rules:
      - source_matchers: [alertname="SilenceAlerts", tenant_id="0c8fdeba-3488-43bb-95ee-ca57ba5aaaa7"]
        target_matchers: [severity=~"warning|critical", tenant_id="0c8fdeba-3488-43bb-95ee-ca57ba5aaaa7"]
        equal: [tenant_id, _id]
      - source_matchers: [alertname="SilenceAlerts", tenant_id="0c8fdeba-3488-43bb-95ee-ca57ba5aaaa7"]
        target_matchers: [severity=~"warning|critical", tenant_id="0c8fdeba-3488-43bb-95ee-ca57ba5aaaa7"]
        equal: [tenant_id, namespace]
      - source_matchers: [alertname="SilenceAlerts", tenant_id="5cbac548-1546-438e-ba85-ff2c73b81afc"]
        target_matchers: [severity=~"warning|critical", tenant_id="5cbac548-1546-438e-ba85-ff2c73b81afc"]
        equal: [tenant_id, _id]
      - source_matchers: [alertname="SilenceAlerts", tenant_id="5cbac548-1546-438e-ba85-ff2c73b81afc"]
        target_matchers: [severity=~"warning|critical", tenant_id="5cbac548-1546-438e-ba85-ff2c73b81afc"]
        equal: [tenant_id, namespace]

    route:
      group_interval: 5m
      group_wait: 30s
      receiver: default
      repeat_interval: 12h
      routes:
      - match:
          tenant_id: 0fc2b00e-201b-4c17-b9f2-19d91adc4fd2
        receiver: slack-monitoring-alerts

      # This is a template to silence alerts
      # - match:
      #     <TODO: selector for silent alerts>
      #     tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
      #     region: af-south-1
      #   receiver: pagerduty-srep-hypershift-silent-af-south-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: af-south-1
        receiver: pagerduty-srep-hypershift-af-south-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ap-east-1
        receiver: pagerduty-srep-hypershift-ap-east-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ap-northeast-1
        receiver: pagerduty-srep-hypershift-ap-northeast-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ap-northeast-2
        receiver: pagerduty-srep-hypershift-ap-northeast-2

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ap-northeast-3
        receiver: pagerduty-srep-hypershift-ap-northeast-3

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ap-south-1
        receiver: pagerduty-srep-hypershift-ap-south-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ap-southeast-1
        receiver: pagerduty-srep-hypershift-ap-southeast-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ap-southeast-2
        receiver: pagerduty-srep-hypershift-ap-southeast-2

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ap-southeast-3
        receiver: pagerduty-srep-hypershift-ap-southeast-3

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: ca-central-1
        receiver: pagerduty-srep-hypershift-ca-central-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: eu-central-1
        receiver: pagerduty-srep-hypershift-eu-central-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: eu-north-1
        receiver: pagerduty-srep-hypershift-eu-north-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: eu-south-1
        receiver: pagerduty-srep-hypershift-eu-south-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: eu-west-1
        receiver: pagerduty-srep-hypershift-eu-west-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: eu-west-2
        receiver: pagerduty-srep-hypershift-eu-west-2

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: eu-west-3
        receiver: pagerduty-srep-hypershift-eu-west-3

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: me-central-1
        receiver: pagerduty-srep-hypershift-me-central-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: me-south-1
        receiver: pagerduty-srep-hypershift-me-south-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: sa-east-1
        receiver: pagerduty-srep-hypershift-sa-east-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: us-east-1
        receiver: pagerduty-srep-hypershift-us-east-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: us-east-2
        receiver: pagerduty-srep-hypershift-us-east-2

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: us-west-1
        receiver: pagerduty-srep-hypershift-us-west-1

      - match:
          tenant_id: 5cbac548-1546-438e-ba85-ff2c73b81afc
          region: us-west-2
        receiver: pagerduty-srep-hypershift-us-west-2
          
      # silence all alerts from hypershift staging
      - match:
          tenant_id: 0c8fdeba-3488-43bb-95ee-ca57ba5aaaa7
        receiver: pagerduty-srep-hypershift-silent-default
        group_by: [alertname, severity, namespace, _id]
    templates:
      - '*.tmpl'
    {{% endb64encode %}}
  slack.tmpl: >-
    {{% b64encode %}}
    # This builds the silence URL.  We exclude the alertname in the range
    # to avoid the issue of having trailing comma separator (%2C) at the end
    # of the generated URL
    {{ define "__alert_silence_link" -}}
        {{ .ExternalURL }}/#/silences/new?filter=%7B
        {{- range .CommonLabels.SortedPairs -}}
            {{- if ne .Name "alertname" -}}
                {{- .Name }}%3D"{{- .Value -}}"%2C%20
            {{- end -}}
        {{- end -}}
        alertname%3D"{{ .CommonLabels.alertname }}"%7D
    {{- end }}
    
    {{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver | urlquery }}{{ end }}
    {{ define "slack.default.titlelink" }}{{ template "__alertmanagerURL" . }}{{ end }}
    
    {{ define "__single_message_title" }}{{ range .Alerts.Firing }}{{- if .Annotations.message }} {{ .Annotations.message }} {{- end }}{{ end }}{{ range .Alerts.Resolved }}{{- if .Annotations.message }} {{ .Annotations.message }} {{- end }}
    {{ end }}{{ end }}
    
    {{/* First line of Slack alerts */}}
    {{ define "slack.default.title" -}}Alert: {{ .CommonLabels.alertname }} [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if or (and (eq (len .Alerts.Firing) 1) (eq (len .Alerts.Resolved) 0)) (and (eq (len .Alerts.Firing) 0) (eq (len .Alerts.Resolved) 1)) }}{{ template "__single_message_title" . }}{{ end }}{{- end }}
    
    {{ define "slack.default.fallback" }}{{ template "slack.default.title" . }} | {{ template "slack.default.titlelink" . }}{{ end }}
    
    {{/* Color of Slack attachment (appears as line next to alert )*/}}
    {{ define "slack.default.color" -}}
        {{ if eq .Status "firing" -}}
            {{ if eq .CommonLabels.severity "test" -}}
                '#808080'
            {{ else if eq .CommonLabels.severity "warning" -}}
                warning
            {{ else if eq .CommonLabels.severity "medium" -}}
                warning
            {{- else if eq .CommonLabels.severity "critical" -}}
                danger
            {{- else -}}
                '#439FE0'
            {{- end -}}
        {{ else -}}
        good
        {{- end }}
    {{- end }}
    
    {{/* Emoji to display as user icon (custom emoji supported!) */}}
    {{ define "slack.default.icon_emoji" }}:prometheus:{{ end }}
    
    {{ define "slack.default.icon_url" }}https://avatars3.githubusercontent.com/u/3380462{{ end }}
    
    {{/* The text to display in the alert */}}
    {{/* define "slack.default.text" -}}{{ range .Alerts }}{{ if eq .Status "firing" -}}{{- if .Annotations.message }}{{ .Annotations.message }}{{- end }}{{- if .Annotations.description }}{{ .Annotations.description }}{{- end }}{{- end }}{{ if eq .Status "resolved" -}}{{- if .Annotations.message }}Resolved: {{ .Annotations.message }}{{- end }}{{- end }}{{- end }}{{- end */}}
    
    {{ define "slack.default.text" }}
    {{ if or (and (eq (len .Alerts.Firing) 1) (eq (len .Alerts.Resolved) 0)) (and (eq (len .Alerts.Firing) 0) (eq (len .Alerts.Resolved) 1)) }}
    {{ range .Alerts.Firing }}{{ .Annotations.link_url }}{{ end }}{{ range .Alerts.Resolved }}{{ .Annotations.link_url }}{{ end }}
    {{ range .Alerts.Firing }}{{ .Annotations.description }}{{ end }}{{ range .Alerts.Resolved }}{{ .Annotations.description }}{{ end }}
    {{ else }}
    {{ if gt (len .Alerts.Firing) 0 }}
    *Alerts Firing:*
    {{ range .Alerts.Firing }}- {{- if .Annotations.message }} {{ .Annotations.message }} {{- end }}{{- if .Annotations.link_url }}: {{ .Annotations.link_url }}{{- end }}
    {{ end }}{{ end }}
    {{ if gt (len .Alerts.Resolved) 0 }}
    *Alerts Resolved:*
    {{ range .Alerts.Resolved }}- {{- if .Annotations.message }} {{ .Annotations.message }} {{- end }}{{- if .Annotations.link_url }}: {{ .Annotations.link_url }}{{- end }}
    {{ end }}{{ end }}
    {{ end }}
    {{ end }}
    
    {{ define "slack.default.link_button_text" -}}
        {{- if .CommonAnnotations.link_text -}}
            {{- .CommonAnnotations.link_text -}}
        {{- else -}}
            Link
        {{- end }} :link:
    {{- end }}
    {{% endb64encode %}}
